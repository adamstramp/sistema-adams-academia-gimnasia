<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ADAMS - Academia de Gimnasia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%);
            min-height: 100vh;
            color: #333;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 20px;
        }
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.3em;
            opacity: 0.9;
        }
        .nav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .nav-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        .nav-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            border-color: #9c27b0;
        }
        .nav-card.active {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
            transform: translateY(-5px);
        }
        .nav-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
            display: block;
        }
        .nav-card h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }
        .nav-card p {
            opacity: 0.8;
            font-size: 0.95em;
        }
        .content-area {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            min-height: 600px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.3);
        }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .form-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e3f2fd;
            display: none;
        }
        .form-section.show {
            display: block;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #9c27b0;
            box-shadow: 0 0 0 3px rgba(156, 39, 176, 0.1);
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
        }
        .table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .table tr:hover {
            background: #f8f9ff;
        }
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        .status-activo {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.status-inactivo {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}
.status-baja {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .notification.show {
            transform: translateX(0);
        }
        .notification.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        .notification.error {
            background: linear-gradient(135deg, #dc3545, #fd7e14);
        }
        .welcome-screen {
            text-align: center;
            padding: 100px 20px;
            color: #666;
        }
        .tabs-container {
            margin: 20px 0;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
        }
        .tab {
            padding: 15px 25px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            flex: 1;
            text-align: center;
        }
        .tab.active {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
        }
        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            border-top: none;
        }
        .tab-pane {
            display: none;
        }
        .tab-pane.active {
            display: block;
        }
        .horario-assignment {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .horario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .horario-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e3f2fd;
        }
        .nomina-summary {
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }
        .nomina-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .nomina-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2em;
        }
.pago-card {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        .recargo-alert {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        .producto-card {
            background: white;
            border: 2px solid #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .pago-resumen {
            background: #f8f9fa;
            border: 2px solid #9c27b0;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        .metodo-pago {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .metodo-pago:hover {
            border-color: #9c27b0;
            background: #f8f9ff;
        }
        .metodo-pago.selected {
            border-color: #9c27b0;
            background: linear-gradient(135deg, #9c27b0, #e91e63);
            color: white;
        }
.monto-editable {
            background: #fff3cd !important;
            border: 2px solid #ffc107 !important;
            font-weight: bold;
        }
        .condonacion-section {
            background: #e8f5e8;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        .toggle-edicion {
            background: linear-gradient(135deg, #ffc107, #ff8f00);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        .recibo-preview {
            background: white;
            border: 2px solid #333;
            padding: 30px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-line;
        }
        @media (max-width: 768px) {
            .nav-grid {
                grid-template-columns: 1fr;
            }
            .content-area {
                padding: 20px;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .tabs {
                flex-direction: column;
            }
        }
        @media (max-width: 1200px) {
    /* Gr√°ficos en una columna en pantallas medianas */
    .stats-grid + div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    } 
    /* Mejorar visualizaci√≥n de gr√°ficos en tablets */
    #contenedor-grafico-disciplinas,
    #contenedor-grafico-horarios {
        margin-bottom: 25px;
    }
}
/* Expandir la regla existente de 768px */
@media (max-width: 768px) {
    .nav-grid {
        grid-template-columns: 1fr;
    }
    .content-area {
        padding: 20px;
    }
    .form-row {
        grid-template-columns: 1fr;
    }
    .tabs {
        flex-direction: column;
    }  
    /* NUEVAS REGLAS PARA GR√ÅFICOS */
    #contenedor-grafico-disciplinas,
    #contenedor-grafico-horarios {
        margin-bottom: 15px;
    }
    /* Hacer scroll horizontal m√°s f√°cil en m√≥viles */
    div[style*="overflow-x: auto"] {
        padding-left: 10px !important;
        padding-right: 10px !important;
    }
    /* Ajustar tama√±o de barras en m√≥viles */
    div[style*="min-width: 90px"] {
        min-width: 70px !important;
    }
    div[style*="min-width: 65px"] {
        min-width: 50px !important;
    }
}
        /* NUEVOS ESTILOS PARA RECIBOS MEJORADOS */
.recibo-carta {
    background: white;
    width: 21cm;
    min-height: 29.7cm;
    margin: 0 auto;
    padding: 1.5cm;
    font-family: 'Arial', sans-serif;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
    position: relative;
    font-size: 13px;
}
.recibo-header {
    text-align: center;
    border-bottom: 3px solid #9c27b0;
    padding-bottom: 15px;
    margin-bottom: 15px;
}
.logo-section {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
}
.logo-placeholder {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #9c27b0, #e91e63);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    font-weight: bold;
}
.academia-title {
    font-size: 28px;
    font-weight: bold;
    color: #9c27b0;
    margin: 0;
}
.academia-subtitle {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}
.recibo-info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}
.info-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #9c27b0;
}
.info-title {
    font-size: 16px;
    font-weight: bold;
    color: #9c27b0;
    margin-bottom: 15px;
    text-transform: uppercase;
}
.info-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 1px dotted #ddd;
}
.info-label {
    font-weight: 600;
    color: #333;
}
.info-value {
    color: #666;
}
.detalle-pago {
    background: #fff;
    border: 2px solid #9c27b0;
    border-radius: 10px;
    padding: 15px;
    margin: 15px 0;
}
.detalle-title {
    font-size: 18px;
    font-weight: bold;
    color: #9c27b0;
    text-align: center;
    margin-bottom: 20px;
    text-transform: uppercase;
}
.concepto-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
}
.concepto-item:last-child {
    border-bottom: none;
    font-weight: bold;
    font-size: 18px;
    background: #f0f8ff;
    margin: 10px -10px -10px -10px;
    padding: 15px 20px;
    border-radius: 5px;
}
.total-section {
    background: linear-gradient(135deg, #9c27b0, #e91e63);
    color: white;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    margin: 15px 0;
}
.total-amount {
    font-size: 32px;
    font-weight: bold;
    margin: 10px 0;
}
.footer-recibo {
    text-align: center;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid #9c27b0;
}
.contacto-info {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 20px 0;
    font-size: 12px;
}
.contacto-item {
    text-align: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}
.agradecimiento {
    font-size: 14px;
    color: #666;
    font-style: italic;
    margin-top: 20px;
}
.modal-recibo {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow-y: auto;
    padding: 20px;
}
.modal-content {
    background: white;
    border-radius: 15px;
    padding: 20px;
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
}
.botones-recibo {
    text-align: center;
    margin: 20px 0;
    gap: 15px;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
}
@media print {
    body { 
        background: white !important; 
        margin: 0 !important;
        padding: 0 !important;
    }   
    .modal-recibo { 
        position: static !important; 
        background: white !important; 
        z-index: auto !important;
    }
    .recibo-carta { 
        box-shadow: none !important; 
        margin: 0 !important; 
        padding: 20px !important;
    }
    /* OCULTAR TODOS LOS BOTONES Y ELEMENTOS DE INTERFAZ */
    button { display: none !important; }
    .btn { display: none !important; }
    input[type="button"] { display: none !important; }
    input[type="submit"] { display: none !important; }
    .modal-content button { display: none !important; }
    .botones-recibo { display: none !important; }
        /* OCULTAR EL LOGO PLACEHOLDER ESPEC√çFICAMENTE */
    .logo-placeholder { display: none !important; visibility: hidden !important; }
        /* OCULTAR ELEMENTOS DENTRO DEL RECIBO */
    .recibo-carta button { display: none !important; }
    .recibo-carta .btn { display: none !important; }
    .recibo-carta input { display: none !important; }
    .recibo-carta select { display: none !important; }
    .recibo-carta textarea { display: none !important; }
        /* OCULTAR ELEMENTOS DENTRO DEL PDF */
    #recibo-para-pdf button { display: none !important; }
    #recibo-para-pdf .btn { display: none !important; }
    #recibo-para-pdf input { display: none !important; }
    #recibo-para-pdf select { display: none !important; }
        /* OCULTAR CUALQUIER ELEMENTO QUE CONTENGA SOLO "A" */
    div:only-child:contains("A") { display: none !important; }
        /* FORZAR SOLO EL CONTENIDO VISIBLE */
    .recibo-header,
    .recibo-info,
    .detalle-pago,
    .total-section,
    .footer-recibo,
    .contacto-info,
    .agradecimiento {
        display: block !important;
        visibility: visible !important;
    }
}
@page {
    size: A4;
    margin: 1cm;
}
@page {
    size: A4;
    margin: 1cm;
}
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 id="header-nombre-academia">Academia de Gimnasia ADAMS</h1>
            <p>Sistema Integral de Gesti√≥n Deportiva</p>
        </header>
        <nav class="nav-grid">
            <div class="nav-card active" onclick="cambiarSeccion('dashboard', this)">
                <span class="nav-card-icon">üìä</span>
                <h3>Dashboard</h3>
                <p>Resumen general y estad√≠sticas clave</p>
            </div>
            <div class="nav-card" onclick="cambiarSeccion('estudiantes', this)">
    <span class="nav-card-icon">üë•</span>
    <h3>Alumnos</h3>
    <p>Registro y gesti√≥n completa de alumnos</p>
</div>
            <div class="nav-card" onclick="cambiarSeccion('entrenadores', this)">
                <span class="nav-card-icon">üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
                <h3>Entrenadores</h3>
                <p>Gesti√≥n de staff y control de n√≥mina</p>
            </div>
            <div class="nav-card" onclick="cambiarSeccion('pagos', this)">
                <span class="nav-card-icon">üí∞</span>
                <h3>Pagos</h3>
                <p>Control de colegiaturas y productos</p>
            </div>
            <div class="nav-card" onclick="cambiarSeccion('asistencias', this)">
                <span class="nav-card-icon">‚úÖ</span>
                <h3>Asistencias</h3>
                <p>Control diario de presencias</p>
            </div>
            <div class="nav-card" onclick="cambiarSeccion('reportes', this)">
                <span class="nav-card-icon">üìà</span>
                <h3>Reportes</h3>
                <p>An√°lisis y estad√≠sticas avanzadas</p>
            </div>
            <div class="nav-card" onclick="cambiarSeccion('configuracion', this)">
                <span class="nav-card-icon">‚öôÔ∏è</span>
                <h3>Configuraci√≥n</h3>
                <p>Ajustes y personalizaci√≥n del sistema</p>
            </div>
        </nav>
        <main class="content-area">
            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <h2>üìä Dashboard - Academia ADAMS</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-estudiantes">0</div>
                        <div class="stat-label">Alumnos Activos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-entrenadores">4</div>
                        <div class="stat-label">Entrenadores</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ingresos-mes">$0</div>
                        <div class="stat-label">Ingresos del Mes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="estudiantes-pendientes">0</div>
                        <div class="stat-label">Pagos Pendientes</div>
                    </div>
                </div>
                <!-- AGREGAR AQU√ç -->
<div style="margin: 30px 0; text-align: center; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
    <h3 style="color: white; margin-bottom: 20px;">üìä Exportar Reportes</h3>
    <button class="btn btn-success" onclick="exportarListaEstudiantes()" style="margin-right: 10px; margin-bottom: 10px;">
        üìä Exportar Lista de Estudiantes
    </button>
    <button class="btn btn-primary" onclick="exportarReporteFinanciero()" style="margin-right: 10px; margin-bottom: 10px;">
        üí∞ Exportar Reporte Financiero
    </button>
</div>
                <div style="margin-bottom: 30px;">
                    <h3>üö® Alertas Importantes</h3>
                    <div id="alertas-container">
                        <p style="color: #666; text-align: center; padding: 20px;">No hay alertas pendientes</p>
                    </div>
                </div>
            </section>
            <!-- Estudiantes -->
           <section id="estudiantes" class="section">
   <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2>üë• Gesti√≥n de Alumnos</h2>
    <div style="display: flex; gap: 10px; align-items: center;">
        <button class="btn btn-primary" onclick="mostrarFormularioEstudiante()">
            ‚ûï Nuevo Alumno
        </button>
        <button class="btn btn-success" onclick="mostrarCargaMasiva()">
            üìÅ Carga Masiva Excel
        </button>
    </div>
</div>
    <!-- FILTROS DE B√öSQUEDA PARA ESTUDIANTES -->
    <div class="form-section show" style="margin-bottom: 20px;">
        <h4 style="color: #9c27b0; margin-bottom: 15px;">üîç Filtros de B√∫squeda</h4>
        <div class="form-row">
            <div class="form-group">
                <label>Buscar por nombre (alumno o tutor)</label>
                <input type="text" id="filtro-nombre-estudiante" 
                       placeholder="Escribe nombre del estudiante o tutor..." 
                       onkeyup="filtrarEstudiantes()" 
                       style="background: white;">
            </div>
            <div class="form-group">
                <label>Filtrar por disciplina</label>
                <select id="filtro-disciplina-estudiante" onchange="filtrarEstudiantes()">
                    <option value="">Todas las disciplinas</option>
                    <option value="gimnasia">Gimnasia</option>
                    <option value="parkour">Parkour</option>
                    <option value="box">Box</option>
                </select>
            </div>
            <div class="form-group">
                <label>Filtrar por estatus</label>
                <select id="filtro-estatus-estudiante" onchange="filtrarEstudiantes()">
                    <option value="">Todos los estatus</option>
                    <option value="activo">Activos</option>
                    <option value="inactivo">Inactivos</option>
                    <option value="baja">Dados de baja</option>
                </select>
            </div>
            <div class="form-group" style="display: flex; align-items: end;">
                <button class="btn btn-secondary" onclick="limpiarFiltrosEstudiantes()" style="margin-top: 10px;">
                    üîÑ Limpiar Filtros
                </button>
            </div>
        </div>
        <div style="text-align: center; margin-top: 10px;">
            <small style="color: #666;">Mostrando <span id="contador-estudiantes-filtrados">0</span> de <span id="contador-estudiantes-total">0</span> estudiantes</small>
        </div>
    </div>
                <!-- Formulario -->
                <div id="formulario-estudiante" class="form-section">
                    <h3>üìù Registro de Nuevo Alumno</h3>
                    <form id="form-estudiante" onsubmit="guardarEstudiante(event)">                      
                        <h4 style="color: #9c27b0; margin: 25px 0 15px 0;">Informaci√≥n Personal</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre Completo *</label>
                                <input type="text" id="nombre" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha de Nacimiento *</label>
                                <input type="date" id="fecha-nacimiento">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>CURP (Opcional)</label>
                                <input type="text" id="curp" maxlength="18">
                            </div>
                            <div class="form-group">
                                <label>Nombre del Tutor *</label>
                                <input type="text" id="tutor">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tel√©fono *</label>
                                <input type="tel" id="telefono">
                            </div>
                            <div class="form-group">
                                <label>Correo Electr√≥nico</label>
                                <input type="email" id="email">
                            </div>
                        </div>
                        <h4 style="color: #9c27b0; margin: 25px 0 15px 0;">Informaci√≥n Deportiva</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Disciplinas *</label>
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="disc-gimnasia" value="gimnasia">
                                        <label for="disc-gimnasia">Gimnasia</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="disc-parkour" value="parkour">
                                        <label for="disc-parkour">Parkour</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="disc-box" value="box">
                                        <label for="disc-box">Box</label>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Colegiatura Mensual</label>
                                <input type="number" id="colegiatura" value="900" min="0" step="0.01">
                            </div>
                        </div>
                        <!-- Secci√≥n de Horarios M√∫ltiples -->
                        <div class="horario-assignment">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <label><strong>Horarios de Entrenamiento *</strong></label>
                                <button type="button" class="btn btn-primary btn-small" onclick="agregarHorarioEstudiante()">
                                    + Agregar Horario
                                </button>
                            </div>
                            <div id="horarios-container-estudiante">
                                <div class="horario-card">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>D√≠a</label>
                                            <select class="dia-select">
                                                <option value="">Seleccionar d√≠a...</option>
                                                <option value="lunes">Lunes</option>
                                                <option value="martes">Martes</option>
                                                <option value="miercoles">Mi√©rcoles</option>
                                                <option value="jueves">Jueves</option>
                                                <option value="viernes">Viernes</option>
                                                <option value="sabado">S√°bado</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>Hora de Inicio</label>
                                            <input type="time" class="hora-inicio" value="15:00">
                                        </div>
                                        <div class="form-group">
                                            <label>Hora de Fin</label>
                                            <input type="time" class="hora-fin" value="16:00">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-small" onclick="eliminarHorarioEstudiante(this)" disabled>
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <h4 style="color: #9c27b0; margin: 25px 0 15px 0;">Informaci√≥n Financiera</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>¬øEs hermano de otro estudiante?</label>
                                <select id="es-hermano">
                                    <option value="no">No</option>
                                    <option value="si">S√≠</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Porcentaje de Beca (%)</label>
                                <input type="number" id="beca" value="0" min="0" max="100">
                            </div>
                            <div class="form-group">
    <label>Estatus del Estudiante</label>
    <select id="estatus-estudiante">
    <option value="activo">üü¢ Activo</option>
    <option value="inactivo">üü° Inactivo</option>
    <option value="pendiente">üü† Pendiente</option>
    <option value="baja">üî¥ Baja</option>
</select>
</div>
                        </div>
                        <div style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-secondary" onclick="ocultarFormularioEstudiante()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" style="margin-left: 10px;">
                                üíæ Guardar Alumno
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Tabla de Estudiantes -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Edad</th>
                                <th>Disciplinas</th>
                                <th>Horarios</th>
                                <th>Estado</th>
                                <th>Colegiatura</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-estudiantes">
                            <tr>
                                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                                    No hay estudiantes registrados. ¬°Registra el primero!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
            <!-- Entrenadores -->
            <section id="entrenadores" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>üèãÔ∏è‚Äç‚ôÇÔ∏è Gesti√≥n de Entrenadores</h2>
                    <button class="btn btn-primary" onclick="mostrarFormularioEntrenador()">
                        ‚ûï Nuevo Entrenador
                    </button>
                </div>
                <div class="tabs-container">
                    <div class="tabs">
                        <button class="tab active" onclick="cambiarTab('lista-entrenadores', this)">üìã Lista de Entrenadores</button>
                        <button class="tab" onclick="cambiarTab('asignacion-horarios', this)">‚è∞ Asignaci√≥n de Horarios</button>
                        <button class="tab" onclick="cambiarTab('nomina-semanal', this)">üí∞ N√≥mina Semanal</button>
                        <button class="tab" onclick="cambiarTab('asistencias-entrenadores', this)">‚úÖ Control de Asistencias</button>
                    </div>
                    <div class="tab-content">
                        <!-- Lista de Entrenadores -->
                        <div id="lista-entrenadores" class="tab-pane active">
                            <!-- Formulario de Nuevo Entrenador -->
                            <div id="formulario-entrenador" class="form-section">
                                <h3>üìù Registro de Nuevo Entrenador</h3>
                                <form id="form-entrenador" onsubmit="guardarEntrenador(event)">                                
                                    <h4 style="color: #9c27b0; margin: 25px 0 15px 0;">Informaci√≥n Personal</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Nombre Completo *</label>
                                            <input type="text" id="entrenador-nombre" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Tel√©fono *</label>
                                            <input type="tel" id="entrenador-telefono" required>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Correo Electr√≥nico *</label>
                                            <input type="email" id="entrenador-email" required>
                                        </div>
                                        <div class="form-group">
                                            <label>Fecha de Contrataci√≥n *</label>
                                            <input type="date" id="entrenador-fecha-contratacion" required>
                                        </div>
                                    </div>
                                    <h4 style="color: #9c27b0; margin: 25px 0 15px 0;">Informaci√≥n Profesional</h4>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Disciplinas que Imparte *</label>
                                            <div class="checkbox-group">
                                                <div class="checkbox-item">
                                                    <input type="checkbox" id="ent-disc-gimnasia" value="gimnasia">
                                                    <label for="ent-disc-gimnasia">Gimnasia</label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <input type="checkbox" id="ent-disc-parkour" value="parkour">
                                                    <label for="ent-disc-parkour">Parkour</label>
                                                </div>
                                                <div class="checkbox-item">
                                                    <input type="checkbox" id="ent-disc-box" value="box">
                                                    <label for="ent-disc-box">Box</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Tarifa por Hora (MXN) *</label>
                                            <input type="number" id="entrenador-tarifa" required min="10" max="900" step="5" value="90">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label>Certificaciones y T√≠tulos</label>
                                            <textarea id="entrenador-certificaciones" rows="3" placeholder="Ej. Certificado Nacional de Gimnasia, Instructor de Parkour Nivel 2..."></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Nivel de Experiencia</label>
                                            <select id="entrenador-experiencia" required>
                                                <option value="">Seleccionar nivel...</option>
                                                <option value="principiante">Principiante (0-2 a√±os)</option>
                                                <option value="intermedio">Intermedio (2-5 a√±os)</option>
                                                <option value="avanzado">Avanzado (5-10 a√±os)</option>
                                                <option value="experto">Experto (10+ a√±os)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div style="margin-top: 30px; text-align: right;">
                                        <button type="button" class="btn btn-secondary" onclick="ocultarFormularioEntrenador()">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-primary" style="margin-left: 10px;">
                                            üíæ Guardar Entrenador
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <!-- Tabla de Entrenadores -->
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Disciplinas</th>
                                            <th>Experiencia</th>
                                            <th>Tarifa/Hora</th>
                                            <th>Contacto</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-entrenadores">
                                        <tr>
                                            <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                                                Cargando entrenadores...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Asignaci√≥n de Horarios -->
                        <div id="asignacion-horarios" class="tab-pane">
                            <h3>‚è∞ Asignaci√≥n de Horarios por Entrenador</h3>                           
                            <div class="form-section show">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Seleccionar Entrenador</label>
                                        <select id="select-entrenador-horario" onchange="cargarHorariosEntrenador()">
                                            <option value="">Seleccionar entrenador...</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="display: none;">
                                        <label>Disciplina a Asignar</label>
                                        <select id="select-disciplina-horario">
                                            <option value="">Seleccionar disciplina...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="horarios-entrenador-container">
                                <p style="text-align: center; color: #666; padding: 40px;">
                                    Selecciona un entrenador para ver sus horarios asignados
                                </p>
                            </div>
                            <div class="horario-assignment" id="nuevo-horario-section" style="display: none;">
                                <h4>‚ûï Asignar Nuevo Horario</h4>
                                <div class="horario-grid">
                                    <div class="horario-card">
                                        <div class="form-row">
                                            <div class="form-group">
                                <label>Disciplina *</label>
                                <select id="nuevo-horario-disciplina">
                                    <option value="">Seleccionar disciplina...</option>
                                    <option value="gimnasia">Gimnasia</option>
                                    <option value="parkour">Parkour</option>
                                    <option value="box">Box</option>
                                </select>
                            </div>
                                            <div class="form-group">
                                                <label>D√≠a de la Semana</label>
                                                <select id="nuevo-horario-dia">
                                                    <option value="">Seleccionar d√≠a...</option>
                                                    <option value="lunes">Lunes</option>
                                                    <option value="martes">Martes</option>
                                                    <option value="miercoles">Mi√©rcoles</option>
                                                    <option value="jueves">Jueves</option>
                                                    <option value="viernes">Viernes</option>
                                                    <option value="sabado">S√°bado</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label>Hora de Inicio</label>
                                                <input type="time" id="nuevo-horario-inicio" value="15:00">
                                            </div>
                                            <div class="form-group">
                                                <label>Hora de Fin</label>
                                                <input type="time" id="nuevo-horario-fin" value="16:00">
                                            </div>
                                        </div>
                                        <div class="form-row">
    <div class="form-group">
        <label>Capacidad M√°xima de Estudiantes</label>
        <input type="number" id="nuevo-horario-capacidad" value="10" min="1" max="20">
    </div>
    <div class="form-group">
        <label>Grupo/Nivel</label>
        <input type="text" id="nuevo-horario-grupo" placeholder="Ej. Principiantes, Avanzados, Competencia">
    </div>
</div>
<div class="form-row">
    <div class="form-group">
        <label>Grupos que Maneja (selecciona hasta 2)</label>
        <div class="checkbox-group">
            <div class="checkbox-item">
                <input type="checkbox" id="grupo-A" value="A">
                <label for="grupo-A">Grupo A</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="grupo-B" value="B">
                <label for="grupo-B">Grupo B</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="grupo-C" value="C">
                <label for="grupo-C">Grupo C</label>
            </div>
            <div class="checkbox-item">
                <input type="checkbox" id="grupo-D" value="D">
                <label for="grupo-D">Grupo D</label>
            </div>
        </div>
        <small style="color: #666;">El entrenador puede manejar hasta 2 grupos simult√°neamente</small>
    </div>
</div>
                                        <button class="btn btn-primary" onclick="asignarNuevoHorario()">
                                            üíæ Asignar Horario
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- N√≥mina Semanal -->
                        <div id="nomina-semanal" class="tab-pane">
                            <h3>üí∞ N√≥mina Semanal de Entrenadores</h3>                           
                            <div class="form-section show">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Semana de Pago</label>
                                        <input type="week" id="semana-nomina" onchange="calcularNomina()">
                                    </div>
                                    <div class="form-group">
                                        <label>Estado de N√≥mina</label>
                                        <select id="estado-nomina">
                                            <option value="pendiente">Pendiente</option>
                                            <option value="pagada">Pagada</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="calcularNomina()">
                                    üîÑ Actualizar C√°lculos
                                </button>
                            </div>
                            <div id="nomina-container">
                                <div class="nomina-summary">
                                    <h4>üìä Resumen de N√≥mina Semanal</h4>
                                    <div class="nomina-row">
                                        <span>Total de Horas Trabajadas:</span>
                                        <span id="total-horas">0 horas</span>
                                    </div>
                                    <div class="nomina-row">
                                        <span>Total a Pagar:</span>
                                        <span id="total-pagar">$0.00</span>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Entrenador</th>
                                                <th>Horas Trabajadas</th>
                                                <th>Tarifa/Hora</th>
                                                <th>Subtotal</th>
                                                <th>Estado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla-nomina">
                                            <tr>
                                                <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                                                    Selecciona una semana para calcular la n√≥mina
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Asistencias de Entrenadores -->
                        <div id="asistencias-entrenadores" class="tab-pane">
                            <h3>‚úÖ Control de Asistencias de Entrenadores</h3>                           
                            <div class="form-section show">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Fecha</label>
                                        <input type="date" id="fecha-asistencia-entrenador" onchange="cargarAsistenciasEntrenadores()">
                                    </div>
                                    <div class="form-group">
                                        <label>Horario</label>
                                        <select id="horario-asistencia-entrenador" onchange="cargarAsistenciasEntrenadores()">
                                            <option value="">Todos los horarios</option>
                                            <option value="15:00-16:00">15:00 - 16:00</option>
                                            <option value="16:00-17:00">16:00 - 17:00</option>
                                            <option value="17:00-18:00">17:00 - 18:00</option>
                                            <option value="18:00-19:00">18:00 - 19:00</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="guardarAsistenciasEntrenadores()">
                                    üíæ Guardar Asistencias
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Entrenador</th>
                                            <th>Disciplina</th>
                                            <th>Horario</th>
                                            <th>Asistencia</th>
                                            <th>Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-asistencias-entrenadores">
                                        <tr>
                                            <td colspan="5" style="text-align: center; color: #666; padding: 40px;">
                                                Selecciona una fecha para registrar asistencias
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Otros m√≥dulos -->
            <!-- M√≥dulo de Pagos -->
            <section id="pagos" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2>üí∞ Gesti√≥n de Pagos</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
    <button class="btn btn-primary" onclick="mostrarFormularioPago()">
        üí≥ Registrar Pago
    </button>
    <button class="btn btn-secondary" onclick="mostrarFormularioEstadoCuenta()" style="font-size: 12px;">
        üìä Estado de Cuenta
    </button>
</div>
                </div>
                <div class="tabs-container">
                    <div class="tabs">
                        <button class="tab active" onclick="cambiarTab('registro-pagos', this)">üí≥ Registro de Pagos</button>
                        <button class="tab" onclick="cambiarTab('productos-uniformes', this)">üëï Productos y Uniformes</button>
                        <button class="tab" onclick="cambiarTab('control-morosidad', this)">‚ö†Ô∏è Control de Morosidad</button>
                        <button class="tab" onclick="cambiarTab('reportes-financieros', this)">üìä Reportes Financieros</button>
                    </div>
                    <div class="tab-content">
                        <!-- Registro de Pagos -->
                        <div id="registro-pagos" class="tab-pane active">
                            <!-- Formulario de Pago -->
                            <div id="formulario-pago" class="form-section">
                                <h3>üí≥ Registrar Nuevo Pago</h3>
                                <form id="form-pago" onsubmit="procesarPago(event)">                                   
                                    <div class="form-row">
                        <div class="form-group">
                            <label>Seleccionar Alumno *</label>
                            <select id="pago-estudiante" onchange="cargarDatosEstudiante()" required>
                                <option value="">Seleccionar estudiante...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Fecha del Pago *</label>
                            <input type="date" id="fecha-pago-manual" required>
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Fecha en que realmente se realiz√≥ el pago
                            </small>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Agregar Concepto</label>
<div style="display: flex; gap: 10px; align-items: center;">
    <select id="concepto-temporal" onchange="mostrarCamposConcepto()" style="flex: 1;">
        <option value="">Seleccionar concepto...</option>
        <!-- Se llena din√°micamente desde JavaScript -->
    </select>
    <button type="button" class="btn btn-secondary btn-small" onclick="abrirGestionConceptos()">
        Gestionar
    </button>
</div>
                        </div>
                    </div>
                                    <!-- Informaci√≥n del Estudiante -->
                                    <div id="info-estudiante-pago" style="display: none;" class="pago-card">
                                        <h4>üìã Informaci√≥n del Estudiante</h4>
                                        <div id="estudiante-detalles"></div>
                                    </div>
                                    <!-- Campos temporales para agregar conceptos -->
                                    <div id="campos-concepto-temporal" style="display: none;" class="form-section">
                                        <h4 id="titulo-concepto">Agregar Concepto</h4>
                                        <div id="campos-dinamicos"></div>
                                        <div style="text-align: right; margin-top: 15px;">
                                            <button type="button" class="btn btn-secondary" onclick="cancelarConcepto()">Cancelar</button>
                                            <button type="button" class="btn btn-primary" onclick="agregarConceptoAlCarrito()" style="margin-left: 10px;">
                                                ‚ûï Agregar al Carrito
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Carrito de Conceptos -->
                                    <div id="carrito-conceptos" style="display: none;" class="pago-resumen">
                                        <h4>üõí Conceptos del Pago</h4>
                                        <div id="lista-conceptos"></div>
                                        <div style="text-align: right; border-top: 2px solid #9c27b0; padding-top: 15px; margin-top: 15px;">
                                            <div style="font-size: 24px; font-weight: bold; color: #9c27b0;">
                                                TOTAL: $<span id="total-carrito">0.00</span>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- M√©todo de Pago -->
                                    <div id="seccion-metodo-pago" style="display: none;">
                                        <h5 style="margin-top: 20px;">üí≥ M√©todo de Pago</h5>
                                        <div class="metodo-pago" onclick="seleccionarMetodo('efectivo')">
                                            <input type="radio" name="metodo-pago" value="efectivo" id="metodo-efectivo">
                                            <label for="metodo-efectivo">üíµ Efectivo</label>
                                        </div>
                                        <div class="metodo-pago" onclick="seleccionarMetodo('transferencia')">
                                            <input type="radio" name="metodo-pago" value="transferencia" id="metodo-transferencia">
                                            <label for="metodo-transferencia">üè¶ Transferencia Bancaria</label>
                                        </div>
                                        <div class="metodo-pago" onclick="seleccionarMetodo('tarjeta')">
                                            <input type="radio" name="metodo-pago" value="tarjeta" id="metodo-tarjeta">
                                            <label for="metodo-tarjeta">üí≥ Tarjeta de Cr√©dito/D√©bito</label>
                                        </div>
                                        <div class="form-row" style="margin-top: 20px;">
                                            <div class="form-group">
                                                <label>Monto Recibido</label>
                                                <input type="number" id="monto-recibido" step="0.01" min="0" onchange="calcularCambio()">
                                            </div>
                                            <div class="form-group">
                                                <label>Cambio a Entregar</label>
                                                <input type="text" id="cambio-entregar" readonly style="background: #f0f0f0; font-weight: bold;">
                                            </div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 30px; text-align: right;">
                                        <button type="button" class="btn btn-secondary" onclick="ocultarFormularioPago()">
                                            Cancelar
                                        </button>
                                        <button type="submit" class="btn btn-success" style="margin-left: 10px;">
                                            üí∞ Procesar Pago
                                        </button>
                                    </div>
                                </form>
                            </div>
                            <!-- Formulario de Estado de Cuenta -->
<div id="formulario-estado-cuenta" class="form-section">
    <h3>üìä Generar Estado de Cuenta</h3>
    <form id="form-estado-cuenta" onsubmit="generarEstadoCuenta(event)">
        <div class="form-row">
            <div class="form-group">
                <label>Seleccionar Estudiante *</label>
                <select id="estudiante-estado-cuenta" required>
                    <option value="">Seleccionar estudiante...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Per√≠odo del Estado de Cuenta</label>
                <select id="periodo-estado-cuenta" onchange="toggleFechasPersonalizadas()">
                    <option value="mes-actual">Mes Actual</option>
                    <option value="mes-anterior">Mes Anterior</option>
                    <option value="trimestre">√öltimo Trimestre</option>
                    <option value="semestre">√öltimo Semestre</option>
                    <option value="a√±o">A√±o Actual</option>
                    <option value="personalizado">Per√≠odo Personalizado</option>
                </select>
            </div>
        </div>
        
        <!-- Fechas personalizadas -->
        <div id="fechas-personalizadas-estado" class="form-row" style="display: none;">
            <div class="form-group">
                <label>Fecha de Inicio *</label>
                <input type="date" id="fecha-inicio-estado">
            </div>
            <div class="form-group">
                <label>Fecha de Fin *</label>
                <input type="date" id="fecha-fin-estado">
            </div>
        </div>
        
        <div style="margin-top: 30px; text-align: right;">
            <button type="button" class="btn btn-secondary" onclick="ocultarFormularioEstadoCuenta()">
                Cancelar
            </button>
            <button type="submit" class="btn btn-success" style="margin-left: 10px;">
                üìÑ Generar Estado de Cuenta PDF
            </button>
        </div>
    </form>
</div>
                            <!-- Filtros de Pagos -->
<div class="form-section show" style="margin-bottom: 20px;">
    <h4 style="color: #9c27b0; margin-bottom: 15px;">üîç Filtros de B√∫squeda de Pagos</h4>
    <div class="form-row">
        <div class="form-group">
            <label>Buscar por estudiante</label>
            <input type="text" id="filtro-estudiante-pago" 
                   placeholder="Nombre del estudiante..." 
                   onkeyup="filtrarPagos()" 
                   style="background: white;">
        </div>
        <div class="form-group">
            <label>Filtrar por concepto</label>
            <select id="filtro-concepto-pago" onchange="filtrarPagos()">
                <option value="">Todos los conceptos</option>
                <option value="colegiatura">Colegiaturas</option>
                <option value="inscripcion">Inscripciones</option>
                <option value="reinscripcion">Reinscripciones</option>
                <option value="producto">Productos</option>
            </select>
        </div>
        <div class="form-group">
            <label>Filtrar por m√©todo</label>
            <select id="filtro-metodo-pago" onchange="filtrarPagos()">
                <option value="">Todos los m√©todos</option>
                <option value="efectivo">Efectivo</option>
                <option value="transferencia">Transferencia</option>
                <option value="tarjeta">Tarjeta</option>
            </select>
        </div>
        <div class="form-group" style="display: flex; align-items: end;">
            <button class="btn btn-secondary" onclick="limpiarFiltrosPagos()" style="margin-top: 10px;">
                üîÑ Limpiar Filtros
            </button>
        </div>
    </div>
    <div style="text-align: center; margin-top: 10px;">
        <small style="color: #666;">Mostrando <span id="contador-pagos-filtrados">0</span> de <span id="contador-pagos-total">0</span> pagos</small>
    </div>
</div>
<!-- Historial de Pagos -->
<div class="table-container">
    <h3>üìã Historial de Pagos</h3>
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Estudiante</th>
                                            <th>Concepto</th>
                                            <th>Monto</th>
                                            <th>M√©todo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-pagos">
                                        <tr>
                                            <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                                                No hay pagos registrados
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Productos y Uniformes -->
                        <div id="productos-uniformes" class="tab-pane">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3>üëï Gesti√≥n de Productos y Uniformes</h3>
                                <button class="btn btn-primary" onclick="mostrarFormularioProducto()">
                                    ‚ûï Agregar Producto
                                </button>
                            </div>
                            <!-- Formulario de Producto -->
                            <div id="formulario-producto" class="form-section">
    <h4>üì¶ Nuevo Producto</h4>
    <form id="form-producto" onsubmit="guardarProducto(event)">
        <div class="form-row">
            <div class="form-group">
                <label>Nombre del Producto *</label>
                <input type="text" id="producto-nombre" required>
            </div>
            <div class="form-group">
                <label>Precio *</label>
                <input type="number" id="producto-precio" required min="0" step="0.01">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Categor√≠a *</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="producto-categoria" style="flex: 1;" required>
                        <option value="">Seleccionar categor√≠a...</option>
                    </select>
                    <button type="button" class="btn btn-secondary btn-small" onclick="abrirGestionCategorias()">
                        Gestionar
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Descripci√≥n</label>
                <textarea id="producto-descripcion" rows="3"></textarea>
            </div>
        </div>
        <!-- Control de tallas -->
        <div class="form-row">
            <div class="form-group">
                <label>
                    <input type="checkbox" id="producto-requiere-tallas" onchange="toggleSistemaTallas()">
                    Este producto requiere control de tallas
                </label>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Activa esta opci√≥n para productos como uniformes, playeras, etc.
                </small>
            </div>
        </div>
        <!-- Secci√≥n de tallas (oculta por defecto) -->
        <div id="seccion-tallas" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 15px 0;">
            <h5>üëï Configuraci√≥n de Tallas</h5>
            <div class="form-row">
                <div class="form-group">
                    <label>Tallas disponibles (separadas por comas)</label>
                    <input type="text" id="tallas-personalizadas" 
                           placeholder="Ejemplo: XS, S, M, L, XL o 6, 8, 10, 12, 14 o 28, 30, 32, 34"
                           onchange="generarCamposTallasPersonalizadas()">
                    <small style="color: #666;">Escribe las tallas que manejar√° este producto</small>
                </div>
            </div>           
            <div id="inventario-tallas">
                <p style="color: #666; text-align: center; padding: 20px;">
                    Define las tallas arriba para configurar el inventario
                </p>
            </div>
        </div>
        <!-- Para productos sin tallas -->
        <div id="inventario-simple" style="display: block;">
            <div class="form-group">
                <label>Cantidad en inventario</label>
                <input type="number" id="inventario-cantidad" min="0" value="0" step="1">
                <small style="color: #666;">Para productos que no requieren tallas como bebidas, dulces, etc.</small>
            </div>
        </div>
        <div style="margin-top: 20px; text-align: right;">
            <button type="button" class="btn btn-secondary" onclick="ocultarFormularioProducto()">
                Cancelar
            </button>
            <button type="submit" class="btn btn-primary" style="margin-left: 10px;">
                üíæ Guardar Producto
            </button>
        </div>
    </form>
</div>
                            <!-- Lista de Productos -->
                            <div id="productos-container">
                                <div class="table-container">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Producto</th>
                                                <th>Categor√≠a</th>
                                                <th>Precio</th>
                                                <th>Stock Total</th>
                                                <th>Tallas Disponibles</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tabla-productos">
                                            <tr>
                                                <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                                                    No hay productos registrados
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <!-- Control de Morosidad -->
                        <div id="control-morosidad" class="tab-pane">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h3>‚ö†Ô∏è Control de Morosidad</h3>
    <button class="btn btn-success" onclick="enviarRecordatoriosMasivos()">
        üì± WhatsApp Masivo
    </button>
</div>                           
                            <div class="stats-grid">
                                <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                                    <div class="stat-number" id="total-morosos">0</div>
                                    <div class="stat-label">Alumnos Morosos</div>
                                </div>
                                <div class="stat-card" style="background: linear-gradient(135deg, #f44336, #d32f2f);">
                                    <div class="stat-number" id="total-adeudo">$0</div>
                                    <div class="stat-label">Adeudo Total</div>
                                </div>
                                <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #e91e63);">
                                    <div class="stat-number" id="inactivos-por-pago">0</div>
                                    <div class="stat-label">Inactivos por Pago</div>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Estudiante</th>
                                            <th>√öltimo Pago</th>
                                            <th>D√≠as de Atraso</th>
                                            <th>Monto Adeudado</th>
                                            <th>Recargos</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-morosidad">
                                        <tr>
                                            <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                                                Calculando morosidad...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Reportes Financieros -->
                        <div id="reportes-financieros" class="tab-pane">
                            <h3>üìä Reportes Financieros</h3>                           
                            <div class="form-section show">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Per√≠odo de Reporte</label>
                                        <select id="periodo-reporte" onchange="generarReporteFinanciero()">
                                            <option value="mes-actual">Mes Actual</option>
                                            <option value="mes-anterior">Mes Anterior</option>
                                            <option value="trimestre">√öltimo Trimestre</option>
                                            <option value="semestre">√öltimo Semestre</option>
                                            <option value="a√±o">A√±o Actual</option>
                                            <option value="personalizado">Per√≠odo Personalizado</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Tipo de Reporte</label>
                                        <select id="tipo-reporte" onchange="generarReporteFinanciero()">
                                            <option value="general">Reporte General</option>
                                            <option value="ingresos">Solo Ingresos</option>
                                            <option value="por-concepto">Por Concepto</option>
                                            <option value="por-estudiante">Por Estudiante</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- Campos para per√≠odo personalizado -->
<div id="campos-periodo-personalizado" class="form-row" style="display: none; margin-top: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
    <div class="form-group">
        <label>Fecha de Inicio *</label>
        <input type="date" id="fecha-inicio-personalizada" onchange="validarFechasPersonalizadas()">
    </div>
    <div class="form-group">
        <label>Fecha de Fin *</label>
        <input type="date" id="fecha-fin-personalizada" onchange="validarFechasPersonalizadas()">
    </div>
    <div class="form-group" style="display: flex; align-items: end;">
        <button type="button" class="btn btn-primary" onclick="aplicarPeriodoPersonalizado()" id="btn-aplicar-personalizado" disabled>
            üìÖ Aplicar Per√≠odo
        </button>
    </div>
</div>
                                <button class="btn btn-success" onclick="exportarReporte()">
                                    üìÑ Exportar a PDF
                                </button>
                            </div>
                            <div id="reporte-container">
                                <div class="pago-resumen">
                                    <h4>üí∞ Resumen Financiero</h4>
                                    <div id="resumen-financiero">
                                        <p>Selecciona un per√≠odo para generar el reporte</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="asistencias" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>‚úÖ Control de Asistencias</h2>
        <button class="btn btn-primary" onclick="mostrarFormularioClaseMuestra()">
            ‚ûï Clase de Muestra
        </button>
    </div>
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('asistencias-diarias', this)">üìÖ Asistencias Diarias</button>
            <button class="tab" onclick="cambiarTab('clases-muestra', this)">üéØ Clases de Muestra</button>
            <button class="tab" onclick="cambiarTab('reportes-asistencia', this)">üìä Reportes de Asistencia</button>
        </div>
        <div class="tab-content">
            <!-- Asistencias Diarias -->
            <div id="asistencias-diarias" class="tab-pane active">
                <div class="form-section show">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Asistencia</label>
                            <input type="date" id="fecha-asistencia" onchange="cargarAsistenciasDia()">
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Disciplina</label>
                            <select id="filtro-disciplina" onchange="cargarAsistenciasDia()">
                                <option value="">Todas las disciplinas</option>
                                <option value="gimnasia">Gimnasia</option>
                                <option value="parkour">Parkour</option>
                                <option value="box">Box</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filtrar por Horario</label>
                            <select id="filtro-horario" onchange="cargarAsistenciasDia()">
                                <option value="">Todos los horarios</option>
                                <option value="15:00-16:00">15:00 - 16:00</option>
                                <option value="16:00-17:00">16:00 - 17:00</option>
                                <option value="17:00-18:00">17:00 - 18:00</option>
                                <option value="18:00-19:00">18:00 - 19:00</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: right; margin: 15px 0;">
                        <button class="btn btn-success" onclick="guardarAsistenciasDelDia()">
                            üíæ Guardar Asistencias y Clases Muestra
                        </button>
                        <button class="btn btn-secondary" onclick="marcarTodosPresentes()" style="margin-left: 10px;">
                            ‚úÖ Marcar Todos Presentes
                        </button>
                    </div>
                </div>
                <!-- Container para mostrar las asistencias organizadas -->
                <div id="asistencias-container">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <h4>üìÖ Selecciona una fecha</h4>
                        <p>Elige una fecha para ver los horarios y grupos programados</p>
                    </div>
                </div>
            </div>
            <!-- Clases de Muestra -->
            <div id="clases-muestra" class="tab-pane">
                <!-- Formulario de Clase de Muestra -->
                <div id="formulario-clase-muestra" class="form-section">
                    <h3>üéØ Agendar Clase de Muestra</h3>
                    <form id="form-clase-muestra" onsubmit="guardarClaseMuestra(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre del Prospecto *</label>
                                <input type="text" id="muestra-nombre" required placeholder="Nombre completo">
                            </div>
                            <div class="form-group">
                                <label>Edad (Opcional)</label>
                                <input type="number" id="muestra-edad" min="3" max="50" placeholder="Edad">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tel√©fono de Contacto</label>
                                <input type="tel" id="muestra-telefono" placeholder="Tel√©fono del tutor/prospecto">
                            </div>
                            <div class="form-group">
                                <label>Disciplina de Inter√©s *</label>
                                <select id="muestra-disciplina" required onchange="cargarHorariosMuestra()">
                                    <option value="">Seleccionar disciplina...</option>
                                    <option value="gimnasia">Gimnasia</option>
                                    <option value="parkour">Parkour</option>
                                    <option value="box">Box</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha de la Clase *</label>
                                <input type="date" id="muestra-fecha" required onchange="cargarHorariosMuestra()">
                            </div>
                            <div class="form-group">
                                <label>Horario Disponible *</label>
                                <select id="muestra-horario" required>
                                    <option value="">Seleccionar horario...</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Observaciones</label>
                                <textarea id="muestra-observaciones" rows="3" placeholder="Informaci√≥n adicional sobre el prospecto o sus intereses..."></textarea>
                            </div>
                        </div>
                        <div style="margin-top: 30px; text-align: right;">
                            <button type="button" class="btn btn-secondary" onclick="ocultarFormularioClaseMuestra()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" style="margin-left: 10px;">
                                üéØ Agendar Clase de Muestra
                            </button>
                        </div>
                    </form>
                </div>
                <!-- Lista de Clases de Muestra -->
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>üìã Clases de Muestra Programadas</h3>
                        <div>
                            <select id="filtro-periodo-muestra" onchange="filtrarClasesMuestra()">
                                <option value="todas">Todas las clases</option>
                                <option value="pendientes">Solo pendientes</option>
                                <option value="realizadas">Solo realizadas</option>
                                <option value="convertidas">Convertidas a inscripci√≥n</option>
                            </select>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Prospecto</th>
                                <th>Disciplina</th>
                                <th>Fecha y Hora</th>
                                <th>Contacto</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-clases-muestra">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                                    No hay clases de muestra programadas
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Reportes de Asistencia -->
            <div id="reportes-asistencia" class="tab-pane">
                <div class="form-section show">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>üìä Generar Reportes de Asistencia</h3>
                        <button class="btn btn-success" onclick="exportarReporteAsistencia()">
                            üìÑ Exportar a PDF
                        </button>
                    </div>                   
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Reporte</label>
                            <select id="tipo-reporte-asistencia" onchange="manejarCambioTipoReporte()">
                                <option value="general">Reporte General</option>
                                <option value="por-estudiante">Por Estudiante</option>
                                <option value="por-grupo">Por Grupo</option>
                                <option value="por-entrenador">Por Entrenador</option>
                                <option value="por-disciplina">Por Disciplina</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Per√≠odo</label>
                            <select id="periodo-reporte-asistencia" onchange="generarReporteAsistencia()">
                                <option value="semana-actual">Semana Actual</option>
                                <option value="mes-actual">Mes Actual</option>
                                <option value="mes-anterior">Mes Anterior</option>
                                <option value="personalizado">Per√≠odo Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group" id="selector-estudiante" style="display: none;">
    <label>Seleccionar Estudiante</label>
    <select id="estudiante-especifico">
        <option value="">Todos los estudiantes</option>
    </select>
</div>
                        <div class="form-group" id="fechas-personalizadas" style="display: none;">
                            <label>Desde - Hasta</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="fecha-desde">
                                <input type="date" id="fecha-hasta">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Container para mostrar el reporte -->
                <div id="reporte-asistencia-container">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <p>Selecciona los par√°metros del reporte para generar estad√≠sticas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
            <!-- M√ìDULO DE REPORTES AVANZADOS -->
<section id="reportes" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h2>üìà Reportes y Estad√≠sticas Avanzadas</h2>
        <div>
            <button class="btn btn-secondary" onclick="exportarReportesCompletos()" style="margin-bottom: 10px;">
    üìÑ Exportar Reporte Completo
</button>
            <button class="btn btn-primary" onclick="actualizarTodosLosReportes()">
                üîÑ Actualizar Datos
            </button>
        </div>
    </div>
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('estadisticas-generales', this)">üìä Estad√≠sticas Generales</button>
            <button class="tab" onclick="cambiarTab('analisis-tendencias', this)">üìà An√°lisis de Tendencias</button>
            <button class="tab" onclick="cambiarTab('retencion-estudiantes', this)">üë• Retenci√≥n de Estudiantes</button>
            <button class="tab" onclick="cambiarTab('productividad-entrenadores', this)">üèãÔ∏è‚Äç‚ôÇÔ∏è Productividad Entrenadores</button>
            <button class="tab" onclick="cambiarTab('proyecciones-financieras', this)">üí∞ Proyecciones Financieras</button>
        </div>
        <div class="tab-content">
            <!-- Estad√≠sticas Generales -->
            <div id="estadisticas-generales" class="tab-pane active">
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                        <div class="stat-number" id="reporte-total-estudiantes">0</div>
                        <div class="stat-label">Alumnos Totales</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #2196f3, #1976d2);">
                        <div class="stat-number" id="reporte-estudiantes-activos">0</div>
                        <div class="stat-label">Alumnos Activos</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                        <div class="stat-number" id="reporte-ocupacion">0%</div>
                        <div class="stat-label">Nivel de Ocupaci√≥n</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #e91e63);">
                        <div class="stat-number" id="reporte-ingresos-totales">$0</div>
                        <div class="stat-label">Ingresos Totales</div>
                    </div>
                </div>
                <!-- Gr√°ficos de Distribuci√≥n -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px;">
    <div id="contenedor-grafico-disciplinas">
        <canvas id="grafico-disciplinas" style="display: none;"></canvas>
        <div id="tabla-disciplinas"></div>
    </div>
    <div id="contenedor-grafico-horarios">
        <canvas id="grafico-horarios" style="display: none;"></canvas>
        <div id="tabla-horarios"></div>
    </div>
</div>
                <!-- Resumen Financiero R√°pido -->
                <div class="table-container">
                    <h3>üí∞ Resumen Financiero del Mes</h3>
                    <div id="resumen-financiero-rapido"></div>
                </div>
            </div>
            <!-- An√°lisis de Tendencias -->
            <div id="analisis-tendencias" class="tab-pane">
                <h3>üìà An√°lisis de Tendencias</h3>                
                <div class="form-section show">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Per√≠odo de An√°lisis</label>
                            <select id="periodo-tendencias" onchange="generarAnalisisTendencias()">
                                <option value="6-meses">√öltimos 6 Meses</option>
                                <option value="1-a√±o">√öltimo A√±o</option>
                                <option value="2-a√±os">√öltimos 2 A√±os</option>
                                <option value="todo">Todo el Historial</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tipo de An√°lisis</label>
                            <select id="tipo-tendencia" onchange="generarAnalisisTendencias()">
                                <option value="ingresos">Tendencia de Ingresos</option>
                                <option value="estudiantes">Crecimiento de Estudiantes</option>
                                <option value="disciplinas">Popularidad por Disciplinas</option>
                                <option value="asistencias">Tendencia de Asistencias</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="container-analisis-tendencias">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <p>Selecciona los par√°metros para generar el an√°lisis de tendencias</p>
                    </div>
                </div>
            </div>
            <!-- Retenci√≥n de Estudiantes -->
            <div id="retencion-estudiantes" class="tab-pane">
                <h3>üë• An√°lisis de Retenci√≥n de Estudiantes</h3>                
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                        <div class="stat-number" id="tasa-retencion">0%</div>
                        <div class="stat-label">Tasa de Retenci√≥n Global</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                        <div class="stat-number" id="tiempo-promedio">0</div>
                        <div class="stat-label">Meses Promedio de Permanencia</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f44336, #d32f2f);">
                        <div class="stat-number" id="estudiantes-riesgo">0</div>
                        <div class="stat-label">Alumnos en Riesgo</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #2196f3, #1976d2);">
                        <div class="stat-number" id="nuevos-mes">0</div>
                        <div class="stat-label">Nuevos este Mes</div>
                    </div>
                </div>
                <div class="table-container">
                    <h4>üìã An√°lisis Detallado de Retenci√≥n</h4>
                    <div id="tabla-retencion"></div>
                </div>
                <div class="table-container" style="margin-top: 20px;">
                    <h4>‚ö†Ô∏è Estudiantes en Riesgo de Abandono</h4>
                    <div id="tabla-riesgo-abandono"></div>
                </div>
            </div>
            <!-- Productividad de Entrenadores -->
            <div id="productividad-entrenadores" class="tab-pane">
                <h3>üèãÔ∏è‚Äç‚ôÇÔ∏è An√°lisis de Productividad de Entrenadores</h3>
                <div class="table-container">
                    <h4>üìä M√©tricas por Entrenador</h4>
                    <div id="tabla-productividad-entrenadores"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                    <div class="table-container">
                        <h4>üëë Top Entrenadores por Retenci√≥n</h4>
                        <div id="ranking-entrenadores-retencion"></div>
                    </div>
                    <div class="table-container">
                        <h4>üí∞ Top Entrenadores por Ingresos</h4>
                        <div id="ranking-entrenadores-ingresos"></div>
                    </div>
                </div>
            </div>
            <!-- Proyecciones Financieras -->
            <div id="proyecciones-financieras" class="tab-pane">
                <h3>üí∞ Proyecciones Financieras</h3>
                <div class="form-section show">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Horizonte de Proyecci√≥n</label>
                            <select id="horizonte-proyeccion" onchange="generarProyeccionesFinancieras()">
                                <option value="3-meses">Pr√≥ximos 3 Meses</option>
                                <option value="6-meses">Pr√≥ximos 6 Meses</option>
                                <option value="1-a√±o">Pr√≥ximo A√±o</option>
                                <option value="2-a√±os">Pr√≥ximos 2 A√±os</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Escenario</label>
                            <select id="escenario-proyeccion" onchange="generarProyeccionesFinancieras()">
                                <option value="conservador">Conservador (-10%)</option>
                                <option value="realista">Realista (tendencia actual)</option>
                                <option value="optimista">Optimista (+20%)</option>
                                <option value="pesimista">Pesimista (-25%)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="stats-grid" style="margin-bottom: 30px;">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                        <div class="stat-number" id="proyeccion-ingresos">$0</div>
                        <div class="stat-label">Ingresos Proyectados</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #2196f3, #1976d2);">
                        <div class="stat-number" id="proyeccion-estudiantes">0</div>
                        <div class="stat-label">Alumnos Proyectados</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                        <div class="stat-number" id="proyeccion-ocupacion">0%</div>
                        <div class="stat-label">Ocupaci√≥n Proyectada</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #9c27b0, #e91e63);">
                        <div class="stat-number" id="crecimiento-proyectado">0%</div>
                        <div class="stat-label">Crecimiento Proyectado</div>
                    </div>
                </div>
                <div id="container-proyecciones">
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <p>Selecciona los par√°metros para generar las proyecciones financieras</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
           <section id="configuracion" class="section">
    <h2>‚öôÔ∏è Configuraci√≥n del Sistema</h2>
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" onclick="cambiarTab('config-general', this)">üè´ Informaci√≥n General</button>
            <button class="tab" onclick="cambiarTab('config-financiera', this)">üí∞ Configuraci√≥n Financiera</button>
            <button class="tab" onclick="cambiarTab('config-disciplinas', this)">ü§∏‚Äç‚ôÄÔ∏è Disciplinas</button>
            <button class="tab" onclick="cambiarTab('config-horarios', this)">‚è∞ Horarios</button>
            <button class="tab" onclick="cambiarTab('config-sistema', this)">üîß Sistema</button>
        </div>
        <div class="tab-content">
            <!-- Informaci√≥n General -->
            <div id="config-general" class="tab-pane active">
                <div class="form-section show">
                    <h3>üè´ Informaci√≥n de la Academia</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de la Academia</label>
                            <input type="text" id="config-nombre-academia" value="Academia de Gimnasia ADAMS">
                        </div>
                        <div class="form-group">
                            <label>Direcci√≥n</label>
                            <input type="text" id="config-direccion" value="Six Flags Hurricane Harbor Oaxtepec, Morelos">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel√©fono Principal</label>
                            <input type="tel" id="config-telefono" value="5610488668">
                        </div>
                        <div class="form-group">
                            <label>Email de Contacto</label>
                            <input type="email" id="config-email" value="contacto@academiaadams.com">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Instagram</label>
                            <input type="text" id="config-instagram" value="academiadegimnasiaolmpicaadams">
                        </div>
                        <div class="form-group">
                            <label>WhatsApp</label>
                            <input type="tel" id="config-whatsapp" value="5610488668">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="guardarConfiguracionGeneral()">
                        üíæ Guardar Informaci√≥n General
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n Financiera -->
            <div id="config-financiera" class="tab-pane">
                <div class="form-section show">
                    <h3>üí∞ Configuraci√≥n de Precios</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Colegiatura Base Mensual ($)</label>
                            <input type="number" id="config-colegiatura" value="900" min="100" step="50">
                        </div>
                        <div class="form-group">
                            <label>Costo de Inscripci√≥n/Reinscripci√≥n ($)</label>
                            <input type="number" id="config-inscripcion" value="500" min="100" step="50">
                        </div>
                    </div>
                    
                    <h3>üìÖ Configuraci√≥n de Recargos</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Recargo por pago del d√≠a 6-10 (%)</label>
                            <input type="number" id="config-recargo1" value="10" min="0" max="50">
                        </div>
                        <div class="form-group">
                            <label>Recargo por pago del d√≠a 11-15 (%)</label>
                            <input type="number" id="config-recargo2" value="15" min="0" max="50">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>D√≠a de corte para inactividad</label>
                            <input type="number" id="config-dia-corte" value="16" min="10" max="31">
                        </div>
                        <div class="form-group">
                            <label>Descuento por hermanos (%)</label>
                            <input type="number" id="config-descuento-hermanos" value="10" min="0" max="50">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="guardarConfiguracionFinanciera()">
                        üíæ Guardar Configuraci√≥n Financiera
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n de Disciplinas -->
            <div id="config-disciplinas" class="tab-pane">
                <div class="form-section show">
                    <h3>ü§∏‚Äç‚ôÄÔ∏è Gesti√≥n de Disciplinas</h3>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4>Disciplinas Actuales</h4>
                        <button class="btn btn-primary" onclick="agregarNuevaDisciplina()">
                            ‚ûï Agregar Disciplina
                        </button>
                    </div>
                    
                    <div id="lista-disciplinas">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                    
                    <!-- Formulario para nueva disciplina -->
                    <div id="form-nueva-disciplina" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4>‚ûï Nueva Disciplina</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre de la Disciplina</label>
                                <input type="text" id="nueva-disciplina-nombre" placeholder="Ej: Acrobacia, Danza, etc.">
                            </div>
                            <div class="form-group">
                                <label>Descripci√≥n (Opcional)</label>
                                <input type="text" id="nueva-disciplina-descripcion" placeholder="Breve descripci√≥n...">
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-secondary" onclick="cancelarNuevaDisciplina()">Cancelar</button>
                            <button class="btn btn-primary" onclick="guardarNuevaDisciplina()" style="margin-left: 10px;">
                                ‚úÖ Guardar Disciplina
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuraci√≥n de Horarios -->
            <div id="config-horarios" class="tab-pane">
                <div class="form-section show">
                    <h3>‚è∞ Configuraci√≥n de Horarios</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Hora de Apertura</label>
                            <input type="time" id="config-hora-apertura" value="15:00">
                        </div>
                        <div class="form-group">
                            <label>Hora de Cierre</label>
                            <input type="time" id="config-hora-cierre" value="19:00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Duraci√≥n est√°ndar de clase (minutos)</label>
                            <input type="number" id="config-duracion-clase" value="60" min="30" max="180" step="15">
                        </div>
                        <div class="form-group">
                            <label>Capacidad m√°xima por entrenador</label>
                            <input type="number" id="config-capacidad-entrenador" value="10" min="5" max="25">
                        </div>
                    </div>
                    
                    <h4>üìÖ D√≠as de Operaci√≥n</h4>
                    <div class="checkbox-group" style="margin: 15px 0;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-lunes" checked>
                            <label for="dia-lunes">Lunes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-martes" checked>
                            <label for="dia-martes">Martes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-miercoles" checked>
                            <label for="dia-miercoles">Mi√©rcoles</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-jueves" checked>
                            <label for="dia-jueves">Jueves</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-viernes" checked>
                            <label for="dia-viernes">Viernes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-sabado" checked>
                            <label for="dia-sabado">S√°bado</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="dia-domingo">
                            <label for="dia-domingo">Domingo</label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="guardarConfiguracionHorarios()">
                        üíæ Guardar Configuraci√≥n de Horarios
                    </button>
                </div>
            </div>

            <!-- Configuraci√≥n del Sistema -->
            <div id="config-sistema" class="tab-pane">
                <div class="form-section show">
                    <h3>üîß Configuraci√≥n del Sistema</h3>
                    
                    <h4>üíæ Respaldos y Datos</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Exportar todos los datos</label>
                            <button class="btn btn-success" onclick="exportarDatos()">
                                üìÅ Descargar Respaldo Completo
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Importar datos</label>
                            <input type="file" id="importar-archivo" accept=".json" onchange="importarDatos(this)">
                        </div>
                    </div>
                    
                    <h4>üóëÔ∏è Limpieza de Datos</h4>
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin: 15px 0;">
                        <p><strong>‚ö†Ô∏è Zona de Peligro</strong></p>
                        <p>Estas acciones no se pueden deshacer. Aseg√∫rate de tener un respaldo antes de continuar.</p>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="limpiarDatos('asistencias')" style="margin: 5px;">
                                üóëÔ∏è Limpiar Asistencias Antiguas
                            </button>
                            <button class="btn btn-danger" onclick="limpiarDatos('pagos')" style="margin: 5px;">
                                üóëÔ∏è Limpiar Pagos Antiguos
                            </button>
                            <button class="btn btn-danger" onclick="resetearSistema()" style="margin: 5px;">
                                üîÑ Resetear Sistema Completo
                            </button>
                        </div>
                    </div>
                    
                    <h4>‚ÑπÔ∏è Informaci√≥n del Sistema</h4>
                    <h4>üîí Sistema de Backups Autom√°ticos</h4>
<div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 10px; padding: 15px; margin: 15px 0;">
    <div class="form-row">
        <div class="form-group">
            <label>Estado del Sistema</label>
            <div style="font-weight: bold; color: #2e7d32;">
                ‚úÖ Backups autom√°ticos activos
            </div>
        </div>
        <div class="form-group">
            <label>√öltimo backup</label>
            <div id="ultimo-backup-fecha">Calculando...</div>
        </div>
    </div>
    <div class="form-row">
        <div class="form-group">
            <label>Pr√≥ximo backup autom√°tico</label>
            <div id="proximo-backup-fecha">Calculando...</div>
        </div>
        <div class="form-group">
            <button class="btn btn-primary" onclick="crearBackupManualAhora()">
                üì¶ Crear Backup Manual
            </button>
        </div>
    </div>
    <div style="margin-top: 15px;">
        <label>
            <input type="checkbox" id="habilitar-backup-diario" checked onchange="toggleBackupDiario(this.checked)">
            Habilitar backups diarios autom√°ticos (2:00 AM)
        </label><br>
        <label style="margin-top: 10px; display: block;">
            <input type="checkbox" id="habilitar-backup-cerrar" checked onchange="toggleBackupAlCerrar(this.checked)">
            Crear backup autom√°tico al cerrar el sistema
        </label>
    </div>
    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px;">
        <small style="color: #856404;">
            <strong>üìå Informaci√≥n:</strong> Los backups se descargan autom√°ticamente a tu carpeta de Descargas. 
            Guarda estos archivos en un lugar seguro para poder restaurar tu informaci√≥n si es necesario.
        </small>
    </div>
</div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <p><strong>Versi√≥n:</strong> Sistema ADAMS v4.0</p>
                        <p><strong>√öltima actualizaci√≥n:</strong> <span id="ultima-actualizacion">-</span></p>
                        <p><strong>Total de estudiantes:</strong> <span id="info-total-estudiantes">0</span></p>
                        <p><strong>Total de entrenadores:</strong> <span id="info-total-entrenadores">0</span></p>
                        <p><strong>Total de pagos:</strong> <span id="info-total-pagos">0</span></p>
                        <p><strong>Tama√±o de datos:</strong> <span id="info-tamano-datos">0 KB</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
        </main>
    </div>
<!-- Modal para gestionar conceptos -->
<div id="modal-conceptos" class="modal-recibo" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div style="background: white; padding: 30px; border-radius: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #9c27b0;">Gestionar Conceptos de Pago</h3>
                <button class="btn btn-primary" onclick="mostrarFormularioNuevoConcepto()">
                    + Nuevo Concepto
                </button>
            </div>

            <!-- Formulario para nuevo concepto -->
            <div id="formulario-nuevo-concepto" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h4>Agregar Nuevo Concepto</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre del Concepto *</label>
                        <input type="text" id="nuevo-concepto-nombre" placeholder="Ej: Pago de Torneo Nacional">
                    </div>
                    <div class="form-group">
                        <label>Tipo Interno *</label>
                        <input type="text" id="nuevo-concepto-tipo" placeholder="Ej: torneo-nacional">
                        <small>Solo letras min√∫sculas, n√∫meros y guiones</small>
                    </div>
                </div>
                <div style="text-align: right; margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="cancelarNuevoConcepto()">Cancelar</button>
                    <button class="btn btn-primary" onclick="guardarNuevoConcepto()" style="margin-left: 10px;">
                        Guardar Concepto
                    </button>
                </div>
            </div>

            <!-- Lista de conceptos existentes -->
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Nombre del Concepto</th>
                            <th>Tipo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-conceptos">
                        <!-- Se llena din√°micamente -->
                    </tbody>
                </table>
            </div>

            <div style="text-align: right; border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="cerrarGestionConceptos()">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal para Carga Masiva -->
<div id="modal-carga-masiva" class="modal-recibo" style="display: none;">
    <div class="modal-content" style="max-width: 1000px;">
        <div style="background: white; padding: 30px; border-radius: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="color: #9c27b0;">üìÅ Carga Masiva de Estudiantes</h3>
                <button class="btn btn-secondary" onclick="cerrarCargaMasiva()">‚úñ Cerrar</button>
            </div>

            <!-- Paso 1: Instrucciones -->
            <div id="paso-instrucciones" style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h4>üìã Instrucciones</h4>
                <p><strong>Formato requerido del archivo Excel:</strong></p>
                <ul style="margin-left: 20px;">
                    <li><strong>Columna A:</strong> Nombre del Estudiante</li>
                    <li><strong>Columna B:</strong> Fecha de Nacimiento (formato: YYYY-MM-DD o DD/MM/YYYY)</li>
                    <li><strong>Columna C:</strong> Nombre del Tutor</li>
                    <li><strong>Columna D:</strong> Tel√©fono del Tutor</li>
                    <li><strong>Columna E:</strong> Correo Electr√≥nico (opcional)</li>
                </ul>
                <p style="color: #666; font-size: 14px; margin-top: 10px;">
                    <strong>Nota:</strong> Los estudiantes se cargar√°n con estatus "PENDIENTE" para completar informaci√≥n posteriormente.
                </p>
            </div>

            <!-- Paso 2: Seleccionar archivo -->
            <div class="form-section show">
                <h4>üìÇ Seleccionar Archivo Excel</h4>
                <input type="file" id="archivo-excel-masivo" accept=".xlsx,.xls" 
                       onchange="procesarArchivoExcel()" 
                       style="padding: 10px; border: 2px solid #9c27b0; border-radius: 8px; width: 100%;">
            </div>

            <!-- Paso 3: Vista previa (inicialmente oculta) -->
            <div id="vista-previa-datos" style="display: none; margin-top: 20px;">
                <h4>üëÄ Vista Previa de Datos</h4>
                <div id="resumen-carga" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <div style="max-height: 400px; overflow-y: auto; border: 2px solid #e9ecef; border-radius: 8px;">
                    <table class="table" style="margin: 0;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Fecha Nac.</th>
                                <th>Tutor</th>
                                <th>Tel√©fono</th>
                                <th>Email</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-vista-previa">
                            <!-- Se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Paso 4: Botones de acci√≥n -->
            <div id="botones-carga" style="display: none; text-align: right; margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee;">
                <button class="btn btn-secondary" onclick="cancelarCargaMasiva()" style="margin-right: 10px;">
                    ‚ùå Cancelar
                </button>
                <button class="btn btn-success" onclick="confirmarCargaMasiva()" id="btn-confirmar-carga">
                    ‚úÖ Confirmar Carga Masiva
                </button>
            </div>
        </div>
    </div>
</div>
    <!-- Notification -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
    </div>

    <script>
        // Base de datos del sistema
        // FUNCIONES DE FORMATEO DE FECHA - AGREGAR AQU√ç
function formatearFecha(fecha, incluirHora = false) {
    if (!fecha) return 'Sin fecha';
    
    const fechaObj = typeof fecha === 'string' ? new Date(fecha) : fecha;
    
    // Verificar que la fecha sea v√°lida
    if (isNaN(fechaObj.getTime())) return 'Fecha inv√°lida';
    
    const dia = fechaObj.getDate().toString().padStart(2, '0');
    const mes = (fechaObj.getMonth() + 1).toString().padStart(2, '0');
    const a√±o = fechaObj.getFullYear();
    
    if (incluirHora) {
        const horas = fechaObj.getHours().toString().padStart(2, '0');
        const minutos = fechaObj.getMinutes().toString().padStart(2, '0');
        return `${dia}/${mes}/${a√±o} ${horas}:${minutos}`;
    }
    
    return `${dia}/${mes}/${a√±o}`;
}

function formatearFechaCorta(fecha) {
    if (!fecha) return 'Sin fecha';
    
    const fechaObj = typeof fecha === 'string' ? new Date(fecha) : fecha;
    
    if (isNaN(fechaObj.getTime())) return 'Fecha inv√°lida';
    
    const dia = fechaObj.getDate().toString().padStart(2, '0');
    const mes = (fechaObj.getMonth() + 1).toString().padStart(2, '0');
    
    return `${dia}/${mes}`;
}

function obtenerFechaHoy() {
    const hoy = new Date();
    const a√±o = hoy.getFullYear();
    const mes = (hoy.getMonth() + 1).toString().padStart(2, '0');
    const dia = hoy.getDate().toString().padStart(2, '0');
    return `${a√±o}-${mes}-${dia}`;
}
        let sistemaADAMS = {
            estudiantes: [],
            gruposDisponibles: ['A', 'B', 'C', 'D'],
    asistenciasEstudiantes: [],
            entrenadores: [
                { 
                    id: 1, 
                    nombre: 'Prof. Oscar Adams Ortiz', 
                    telefono: '777-123-4567',
                    email: 'oscar@academiaadams.com',
                    fechaContratacion: '2022-01-15',
                    disciplinas: ['gimnasia'], 
                    tarifaHora: 150,
                    certificaciones: 'Instructor Nacional de Gimnasia Ol√≠mpica, Certificado FIG',
                    experiencia: 'experto',
                    estado: 'activo',
                    horarios: [
                        { dia: 'lunes', horaInicio: '15:00', horaFin: '16:00', disciplina: 'gimnasia', grupo: 'Principiantes', capacidad: 10 },
                        { dia: 'miercoles', horaInicio: '16:00', horaFin: '17:00', disciplina: 'gimnasia', grupo: 'Avanzados', capacidad: 8 }
                    ]
                },
                { 
                    id: 2, 
                    nombre: 'Prof. Miguel Medero', 
                    telefono: '777-234-5678',
                    email: 'miguel@academiaadams.com',
                    fechaContratacion: '2023-03-20',
                    disciplinas: ['parkour'], 
                    tarifaHora: 160,
                    certificaciones: 'Instructor Certificado de Parkour, ADAPT Methodology',
                    experiencia: 'avanzado',
                    estado: 'activo',
                    horarios: [
                        { dia: 'martes', horaInicio: '17:00', horaFin: '18:00', disciplina: 'parkour', grupo: 'Juveniles', capacidad: 12 }
                    ]
                },
                { 
                    id: 3, 
                    nombre: 'Prof. Daniela M√©rito', 
                    telefono: '777-345-6789',
                    email: 'daniela@academiaadams.com',
                    fechaContratacion: '2023-08-10',
                    disciplinas: ['gimnasia'], 
                    tarifaHora: 140,
                    certificaciones: 'Entrenador de Gimnasia Art√≠stica, Curso de Psicolog√≠a Deportiva',
                    experiencia: 'intermedio',
                    estado: 'activo',
                    horarios: []
                },
                { 
                    id: 4, 
                    nombre: 'Prof. Jose Millan', 
                    telefono: '777-456-7890',
                    email: 'jose@academiaadams.com',
                    fechaContratacion: '2023-05-15',
                    disciplinas: ['box'], 
                    tarifaHora: 145,
                    certificaciones: 'Entrenador de Box Amateur, Primeros Auxilios',
                    experiencia: 'avanzado',
                    estado: 'activo',
                    horarios: [
                        { dia: 'viernes', horaInicio: '18:00', horaFin: '19:00', disciplina: 'box', grupo: 'Adultos', capacidad: 15 }
                    ]
                }
            ],
            asistenciasEntrenadores: [],
            configuracion: {
                colegiaturaBase: 900,
                inscripcion: 500,
                recargo1: 10,
                recargo2: 15,
                descuentoHermanos: 10,
                capacidadPorEntrenador: 10,
                disciplinas: ['gimnasia', 'parkour', 'box']
            }, // <- ESTA COMA ES IMPORTANTE
conceptosPago: [
    { id: 1, nombre: 'Colegiatura Mensual', tipo: 'colegiatura', activo: true },
    { id: 2, nombre: 'Ajuste de Colegiatura', tipo: 'ajuste-colegiatura', activo: true },
    { id: 3, nombre: 'Inscripci√≥n', tipo: 'inscripcion', activo: true },
    { id: 4, nombre: 'Reinscripci√≥n', tipo: 'reinscripcion', activo: true },
    { id: 5, nombre: 'Producto/Uniforme', tipo: 'producto', activo: true },
    { id: 6, nombre: 'Afiliaci√≥n', tipo: 'afiliacion', activo: true },
    { id: 7, nombre: 'Pago de Competencia', tipo: 'competencia', activo: true }
],
categorias: [
    { id: 1, nombre: 'Bebidas', descripcion: 'Aguas, refrescos, bebidas deportivas', activa: true },
    { id: 2, nombre: 'Dulces y Snacks', descripcion: 'Dulces, chocolates, botanas', activa: true },
    { id: 3, nombre: 'Uniformes', descripcion: 'Uniformes de entrenamiento y competencia', activa: true },
    { id: 4, nombre: 'Playeras', descripcion: 'Playeras deportivas y casuales', activa: true },
    { id: 5, nombre: 'Accesorios', descripcion: 'Accesorios deportivos y personales', activa: true }
]
            
        };

        // Navegaci√≥n entre secciones
        function cambiarSeccion(seccion, elemento) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            // Remover active de nav-cards
            document.querySelectorAll('.nav-card').forEach(c => c.classList.remove('active'));
            
            // Mostrar secci√≥n seleccionada
            document.getElementById(seccion).classList.add('active');
            elemento.classList.add('active');
            
            // Actualizar datos espec√≠ficos de cada secci√≥n
if (seccion === 'dashboard') {
    actualizarDashboard();
} else if (seccion === 'entrenadores') {
    console.log('Cambiando a secci√≥n entrenadores...');
    verificarSistema();
    actualizarTablaEntrenadores();
    cargarSelectoresEntrenadores();
} else if (seccion === 'pagos') {
    actualizarTablaPagos();
    actualizarTablaProductos();
    actualizarControlMorosidad();
    generarReporteFinanciero();
} else if (seccion === 'asistencias') {
    establecerFechaAsistenciaHoy();
    actualizarTablaClasesMuestra();
} else if (seccion === 'configuracion') {
    inicializarConfiguracion();
} else if (seccion === 'reportes') {
    inicializarModuloReportes();
}
}

        // Navegaci√≥n entre tabs
        function cambiarTab(tabId, elemento) {
            // Ocultar todos los tab-panes
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            
            // Remover active de tabs
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Mostrar tab seleccionado
            document.getElementById(tabId).classList.add('active');
            elemento.classList.add('active');

            // Cargar datos espec√≠ficos del tab
if (tabId === 'nomina-semanal') {
    establecerSemanaActual();
} else if (tabId === 'asistencias-entrenadores') {
    establecerFechaHoy();
} else if (tabId === 'asignacion-horarios') {
    setTimeout(() => limitarSeleccionGrupos(), 100);
} else if (tabId === 'asistencias-diarias') {
    establecerFechaAsistenciaHoy();
} else if (tabId === 'clases-muestra') {
    actualizarTablaClasesMuestra();
} else if (tabId === 'reportes-asistencia') {
    generarReporteAsistencia();
}
        }

        // FUNCIONES DE ESTUDIANTES
        function mostrarFormularioEstudiante() {
    document.getElementById('formulario-estudiante').classList.add('show');
    
    // Asegurar que se cargan los campos completos
    setTimeout(() => {
        cargarEntrenadoresEnSelect();
        cargarDisciplinasEnHorarios();
        reiniciarHorariosEstudiante();
    }, 100);
}
// Nueva funci√≥n para mostrar formulario sin reiniciar horarios (para edici√≥n)
function mostrarFormularioEstudianteSinReiniciar() {
    document.getElementById('formulario-estudiante').classList.add('show');
    
    // Solo cargar selectores sin reiniciar horarios
    setTimeout(() => {
        cargarEntrenadoresEnSelect();
        cargarDisciplinasEnHorarios();
        // NO llamamos a reiniciarHorariosEstudiante() aqu√≠
        // porque ya tenemos los horarios cargados del estudiante
    }, 100);
}

        function ocultarFormularioEstudiante() {
            document.getElementById('formulario-estudiante').classList.remove('show');
            document.getElementById('form-estudiante').reset();
            
            // Limpiar estado de edici√≥n
            delete document.getElementById('form-estudiante').dataset.editando;
            
            // Restaurar t√≠tulo y bot√≥n originales
            document.querySelector('#formulario-estudiante h3').textContent = 'üìù Registro de Nuevo Estudiante';
            document.querySelector('#form-estudiante button[type="submit"]').innerHTML = 'üíæ Guardar Estudiante';
            document.getElementById('estatus-estudiante').value = 'activo';
            reiniciarHorariosEstudiante();
        }

        function reiniciarHorariosEstudiante() {
    const container = document.getElementById('horarios-container-estudiante');
    container.innerHTML = `
        <div class="horario-card">
            <div class="form-row">
                <div class="form-group">
                    <label>D√≠a</label>
                    <select class="dia-select">
                        <option value="">Seleccionar d√≠a...</option>
                        <option value="lunes">Lunes</option>
                        <option value="martes">Martes</option>
                        <option value="miercoles">Mi√©rcoles</option>
                        <option value="jueves">Jueves</option>
                        <option value="viernes">Viernes</option>
                        <option value="sabado">S√°bado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Disciplina en este horario *</label>
                    <select class="disciplina-horario-select">
                        <option value="">Seleccionar disciplina...</option>
                        <option value="gimnasia">Gimnasia</option>
                        <option value="parkour">Parkour</option>
                        <option value="box">Box</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Hora de Inicio</label>
                    <input type="time" class="hora-inicio" value="15:00">
                </div>
                <div class="form-group">
                    <label>Hora de Fin</label>
                    <input type="time" class="hora-fin" value="16:00">
                </div>
            </div>
            <div class="form-row" style="margin-top: 10px;">
                <div class="form-group">
                    <label>Grupo Asignado</label>
                    <select class="grupo-select">
                        <option value="">Seleccionar grupo...</option>
                        <option value="A">Grupo A</option>
                        <option value="B">Grupo B</option>
                        <option value="C">Grupo C</option>
                        <option value="D">Grupo D</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Entrenador Principal</label>
                    <select class="entrenador-select">
                        <option value="">Asignar autom√°ticamente</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-danger btn-small" onclick="eliminarHorarioEstudiante(this)" disabled>
                üóëÔ∏è Eliminar
            </button>
        </div>
    `;
    
    // Cargar entrenadores y disciplinas
    setTimeout(() => {
        cargarEntrenadoresEnSelect();
        cargarDisciplinasEnHorarios();
    }, 100);
}      

        function agregarHorarioEstudiante() {
    const container = document.getElementById('horarios-container-estudiante');
    
    // Si es el primer horario, limpiar el mensaje informativo
    if (container.innerHTML.includes('Haz clic en "Agregar Horario"')) {
        container.innerHTML = '';
    }
    
    const nuevoHorario = document.createElement('div');
    nuevoHorario.className = 'horario-card';
    nuevoHorario.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label>D√≠a</label>
                <select class="dia-select">
                    <option value="">Seleccionar d√≠a...</option>
                    <option value="lunes">Lunes</option>
                    <option value="martes">Martes</option>
                    <option value="miercoles">Mi√©rcoles</option>
                    <option value="jueves">Jueves</option>
                    <option value="viernes">Viernes</option>
                    <option value="sabado">S√°bado</option>
                </select>
            </div>
            <div class="form-group">
                <label>Disciplina en este horario *</label>
                <select class="disciplina-horario-select">
                    <option value="">Seleccionar disciplina...</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Hora de Inicio</label>
                <input type="time" class="hora-inicio" value="15:00">
            </div>
            <div class="form-group">
                <label>Hora de Fin</label>
                <input type="time" class="hora-fin" value="16:00">
            </div>
        </div>
        <div class="form-row" style="margin-top: 10px;">
            <div class="form-group">
                <label>Grupo Asignado</label>
                <select class="grupo-select">
                    <option value="">Seleccionar grupo...</option>
                    <option value="A">Grupo A</option>
                    <option value="B">Grupo B</option>
                    <option value="C">Grupo C</option>
                    <option value="D">Grupo D</option>
                </select>
            </div>
            <div class="form-group">
                <label>Entrenador Principal</label>
                <select class="entrenador-select">
                    <option value="">Asignar autom√°ticamente</option>
                </select>
            </div>
        </div>
        <button type="button" class="btn btn-danger btn-small" onclick="eliminarHorarioEstudiante(this)">
            üóëÔ∏è Eliminar
        </button>
    `;
    container.appendChild(nuevoHorario);
    setTimeout(() => {
        cargarEntrenadoresEnSelect();
        cargarDisciplinasEnHorarios();
    }, 100);
    actualizarBotonesEliminarEstudiante();
}

        function eliminarHorarioEstudiante(boton) {
            boton.closest('.horario-card').remove();
            actualizarBotonesEliminarEstudiante();
        }

        function actualizarBotonesEliminarEstudiante() {
            const horarios = document.querySelectorAll('#horarios-container-estudiante .horario-card');
            horarios.forEach(item => {
                const boton = item.querySelector('.btn-danger');
                boton.disabled = horarios.length === 1;
            });
        }

        // FUNCI√ìN DE EDITAR ESTUDIANTE - CORREGIDA
        // FUNCI√ìN CORREGIDA - editarEstudiante
function editarEstudiante(id) {
    console.log("üîç Buscando estudiante con ID:", id, "Tipo:", typeof id);
    
    // Buscar de forma m√°s robusta
    let estudiante = sistemaADAMS.estudiantes.find(e => e.id === id);
    
    // Si no encuentra, intentar convertir tipos
    if (!estudiante) {
        estudiante = sistemaADAMS.estudiantes.find(e => e.id.toString() === id.toString());
    }
    
    // Si a√∫n no encuentra, buscar por √≠ndice
    if (!estudiante && typeof id === 'number') {
        estudiante = sistemaADAMS.estudiantes[id];
    }
    
    if (!estudiante) {
        console.log("‚ùå No encontrado. IDs disponibles:", sistemaADAMS.estudiantes.map(e => `ID: ${e.id} (${typeof e.id})`));
        mostrarNotificacion('Estudiante no encontrado. Revisa la consola para detalles.', 'error');
        return;
    }
    
    console.log("‚úÖ Estudiante encontrado:", estudiante.nombre);

    // Marcar que estamos editando
    document.getElementById('form-estudiante').dataset.editando = id;
    
    // Cargar datos en el formulario
    document.getElementById('nombre').value = estudiante.nombre;
    document.getElementById('fecha-nacimiento').value = estudiante.fechaNacimiento;
    document.getElementById('curp').value = estudiante.curp || '';
    document.getElementById('tutor').value = estudiante.tutor;
    document.getElementById('telefono').value = estudiante.telefono;
    document.getElementById('email').value = estudiante.email || '';
    document.getElementById('colegiatura').value = estudiante.colegiatura;
    document.getElementById('es-hermano').value = estudiante.esHermano ? 'si' : 'no';
    document.getElementById('beca').value = estudiante.porcentajeBeca;
    document.getElementById('estatus-estudiante').value = estudiante.estatus || 'activo';

    // Cargar disciplinas
    document.querySelectorAll('#formulario-estudiante input[type="checkbox"]').forEach(cb => {
        cb.checked = estudiante.disciplinas.includes(cb.value);
    });

    // Cargar horarios ANTES de mostrar el formulario
    cargarHorariosParaEdicion(estudiante.horarios);

    // Cambiar t√≠tulo y bot√≥n
    document.querySelector('#formulario-estudiante h3').textContent = '‚úèÔ∏è Editar Estudiante';
    document.querySelector('#form-estudiante button[type="submit"]').innerHTML = 'üíæ Actualizar Alumno';

    // CAMBIO IMPORTANTE: Usar la nueva funci√≥n que NO reinicia horarios
    mostrarFormularioEstudianteSinReiniciar(); // ‚Üê ESTA ES LA L√çNEA CAMBIADA
    // Debug temporal - QUITAR DESPU√âS DE VERIFICAR
    setTimeout(() => {
        debugFormularioEstudiante();
    }, 2000);

}

        function cargarHorariosParaEdicion(horarios) {
    console.log('Cargando horarios para edici√≥n:', horarios); // Debug
    const container = document.getElementById('horarios-container-estudiante');
    container.innerHTML = '';

    if (horarios.length === 0) {
        // Si no hay horarios, crear uno vac√≠o como base
        container.innerHTML = `
            <div class="horario-card">
                <div class="form-row">
                    <div class="form-group">
                        <label>D√≠a</label>
                        <select class="dia-select">
                            <option value="">Seleccionar d√≠a...</option>
                            <option value="lunes">Lunes</option>
                            <option value="martes">Martes</option>
                            <option value="miercoles">Mi√©rcoles</option>
                            <option value="jueves">Jueves</option>
                            <option value="viernes">Viernes</option>
                            <option value="sabado">S√°bado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Disciplina en este horario *</label>
                        <select class="disciplina-horario-select">
                            <option value="">Seleccionar disciplina...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora de Inicio</label>
                        <input type="time" class="hora-inicio" value="15:00">
                    </div>
                    <div class="form-group">
                        <label>Hora de Fin</label>
                        <input type="time" class="hora-fin" value="16:00">
                    </div>
                </div>
                <div class="form-row" style="margin-top: 10px;">
                    <div class="form-group">
                        <label>Grupo Asignado</label>
                        <select class="grupo-select">
                            <option value="">Seleccionar grupo...</option>
                            <option value="A">Grupo A</option>
                            <option value="B">Grupo B</option>
                            <option value="C">Grupo C</option>
                            <option value="D">Grupo D</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Entrenador Principal</label>
                        <select class="entrenador-select">
                            <option value="">Asignar autom√°ticamente</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="eliminarHorarioEstudiante(this)" disabled>
                    üóëÔ∏è Eliminar
                </button>
            </div>
        `;
    } else {
        // Cargar horarios existentes
        horarios.forEach((horario, index) => {
            console.log(`Cargando horario ${index + 1}:`, horario); // Debug
            
            const horarioDiv = document.createElement('div');
            horarioDiv.className = 'horario-card';
            horarioDiv.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>D√≠a</label>
                        <select class="dia-select">
                            <option value="">Seleccionar d√≠a...</option>
                            <option value="lunes" ${horario.dia === 'lunes' ? 'selected' : ''}>Lunes</option>
                            <option value="martes" ${horario.dia === 'martes' ? 'selected' : ''}>Martes</option>
                            <option value="miercoles" ${horario.dia === 'miercoles' ? 'selected' : ''}>Mi√©rcoles</option>
                            <option value="jueves" ${horario.dia === 'jueves' ? 'selected' : ''}>Jueves</option>
                            <option value="viernes" ${horario.dia === 'viernes' ? 'selected' : ''}>Viernes</option>
                            <option value="sabado" ${horario.dia === 'sabado' ? 'selected' : ''}>S√°bado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Disciplina en este horario *</label>
                        <select class="disciplina-horario-select">
                            <option value="">Seleccionar disciplina...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Hora de Inicio</label>
                        <input type="time" class="hora-inicio" value="${horario.horaInicio}">
                    </div>
                    <div class="form-group">
                        <label>Hora de Fin</label>
                        <input type="time" class="hora-fin" value="${horario.horaFin}">
                    </div>
                </div>
                <div class="form-row" style="margin-top: 10px;">
                    <div class="form-group">
                        <label>Grupo Asignado</label>
                        <select class="grupo-select">
                            <option value="">Seleccionar grupo...</option>
                            <option value="A" ${horario.grupo === 'A' ? 'selected' : ''}>Grupo A</option>
                            <option value="B" ${horario.grupo === 'B' ? 'selected' : ''}>Grupo B</option>
                            <option value="C" ${horario.grupo === 'C' ? 'selected' : ''}>Grupo C</option>
                            <option value="D" ${horario.grupo === 'D' ? 'selected' : ''}>Grupo D</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Entrenador Principal</label>
                        <select class="entrenador-select">
                            <option value="">Asignar autom√°ticamente</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="eliminarHorarioEstudiante(this)">
                    üóëÔ∏è Eliminar
                </button>
            `;
            container.appendChild(horarioDiv);
        });
    }

    // IMPORTANTE: Cargar opciones DESPU√âS de crear los elementos
    setTimeout(() => {
        console.log('Cargando entrenadores y disciplinas en selects...'); // Debug
        cargarEntrenadoresEnSelect();
        cargarDisciplinasEnHorarios();

        // Seleccionar las disciplinas y entrenadores correctos para cada horario
        const horariosCards = container.querySelectorAll('.horario-card');
        horariosCards.forEach((card, index) => {
            if (horarios[index]) {
                // Seleccionar disciplina
                if (horarios[index].disciplina) {
                    const selectDisciplina = card.querySelector('.disciplina-horario-select');
                    if (selectDisciplina) {
                        selectDisciplina.value = horarios[index].disciplina;
                    }
                }
                
                // Seleccionar entrenador
                if (horarios[index].entrenadorId) {
                    const selectEntrenador = card.querySelector('.entrenador-select');
                    if (selectEntrenador) {
                        selectEntrenador.value = horarios[index].entrenadorId;
                    }
                }
            }
        });

        actualizarBotonesEliminarEstudiante();
        console.log('Horarios cargados completamente'); // Debug
    }, 150); // Aumentamos el tiempo para asegurar que todo se cargue
}

// Funci√≥n temporal para debugging - QUITAR DESPU√âS DE VERIFICAR
function debugFormularioEstudiante() {
    const container = document.getElementById('horarios-container-estudiante');
    const horarios = container.querySelectorAll('.horario-card');
    
    console.log('=== DEBUGGING FORMULARIO ===');
    console.log('N√∫mero de horarios en el DOM:', horarios.length);
    
    horarios.forEach((horario, index) => {
        const dia = horario.querySelector('.dia-select')?.value;
        const disciplina = horario.querySelector('.disciplina-horario-select')?.value;
        const horaInicio = horario.querySelector('.hora-inicio')?.value;
        const horaFin = horario.querySelector('.hora-fin')?.value;
        const grupo = horario.querySelector('.grupo-select')?.value;
        
        console.log(`Horario ${index + 1}:`, {
            dia, disciplina, horaInicio, horaFin, grupo
        });
    });
    console.log('=== FIN DEBUG ===');
}
       function guardarEstudiante(event) {
    event.preventDefault();
    
    // Verificar si estamos editando o creando
    const esEdicion = document.getElementById('form-estudiante').dataset.editando;
    const estudianteId = esEdicion ? parseFloat(esEdicion) : null;
    console.log("ID del estudiante a actualizar:", estudianteId, "Tipo:", typeof estudianteId);
    
    // RECOPILAR DATOS DEL FORMULARIO AL INICIO
    const nombre = document.getElementById('nombre').value?.trim() || '';
    const fechaNacimiento = document.getElementById('fecha-nacimiento').value || '';
    const curp = document.getElementById('curp').value?.trim() || '';
    const tutor = document.getElementById('tutor').value?.trim() || '';
    const telefono = document.getElementById('telefono').value?.trim() || '';
    const email = document.getElementById('email').value?.trim() || '';
    
    console.log("Datos recopilados - Nombre:", nombre, "Tutor:", tutor);
    
    // Validar disciplinas
    const disciplinasSeleccionadas = [];
    document.querySelectorAll('#formulario-estudiante input[type="checkbox"]:checked').forEach(cb => {
        disciplinasSeleccionadas.push(cb.value);
    });
    
    const estatusActual = document.getElementById('estatus-estudiante').value;
    
    if (disciplinasSeleccionadas.length === 0 && estatusActual !== 'pendiente') {
        mostrarNotificacion('Selecciona al menos una disciplina (o marca como PENDIENTE)', 'error');
        return;
    }

    // Validar horarios
    const horarios = [];
    const horariosItems = document.querySelectorAll('#horarios-container-estudiante .horario-card');
    
    for (let item of horariosItems) {
        const dia = item.querySelector('.dia-select').value;
        const disciplinaHorario = item.querySelector('.disciplina-horario-select').value;
        const horaInicio = item.querySelector('.hora-inicio').value;
        const horaFin = item.querySelector('.hora-fin').value;
        const grupo = item.querySelector('.grupo-select').value;
        const entrenadorId = item.querySelector('.entrenador-select').value;
        
        if (!dia || !disciplinaHorario || !horaInicio || !horaFin || !grupo) {
            mostrarNotificacion('Completa todos los campos del horario: d√≠a, disciplina, horarios y grupo', 'error');
            return;
        }
        
        if (horaInicio >= horaFin) {
            mostrarNotificacion('La hora de inicio debe ser menor que la de fin', 'error');
            return;
        }
        
        // Verificar duplicados
        const existe = horarios.find(h => h.dia === dia && h.horaInicio === horaInicio);
        if (existe) {
            mostrarNotificacion(`Ya existe un horario para ${dia} a las ${horaInicio}`, 'error');
            return;
        }
        
        horarios.push({ 
            dia, 
            disciplina: disciplinaHorario,
            horaInicio, 
            horaFin, 
            grupo,
            entrenadorId: entrenadorId || null
        });
    }

    // Calcular edad
    const fechaNac = new Date(fechaNacimiento);
    const hoy = new Date();
    let edad = hoy.getFullYear() - fechaNac.getFullYear();
    if (hoy.getMonth() < fechaNac.getMonth() || 
        (hoy.getMonth() === fechaNac.getMonth() && hoy.getDate() < fechaNac.getDate())) {
        edad--;
    }
    
    // Calcular estatus final
    const estatusFinal = (disciplinasSeleccionadas.length > 0 && horarios.length > 0) ? 'activo' : 'pendiente';

    if (esEdicion) {
        // EDITAR ESTUDIANTE EXISTENTE
        console.log("Buscando √≠ndice para ID:", estudianteId);
        console.log("Todos los IDs disponibles:", sistemaADAMS.estudiantes.slice(0,5).map(e => ({id: e.id, nombre: e.nombre})));

        let indiceEstudiante = -1;

        // M√©todo 1: Comparaci√≥n exacta
        indiceEstudiante = sistemaADAMS.estudiantes.findIndex(e => e.id === estudianteId);
        console.log("M√©todo 1 (exacto):", indiceEstudiante);

        // M√©todo 2: Como strings
        if (indiceEstudiante === -1) {
            indiceEstudiante = sistemaADAMS.estudiantes.findIndex(e => e.id.toString() === estudianteId.toString());
            console.log("M√©todo 2 (string):", indiceEstudiante);
        }

        // M√©todo 3: Tolerancia a decimales
        if (indiceEstudiante === -1) {
            indiceEstudiante = sistemaADAMS.estudiantes.findIndex(e => Math.floor(e.id) === Math.floor(estudianteId));
            console.log("M√©todo 3 (sin decimales):", indiceEstudiante);
        }

        // M√©todo 4: B√∫squeda aproximada
        if (indiceEstudiante === -1) {
            const idBase = estudianteId.toString().split('.')[0];
            indiceEstudiante = sistemaADAMS.estudiantes.findIndex(e => e.id.toString().startsWith(idBase));
            console.log("M√©todo 4 (aproximado):", indiceEstudiante);
        }

        console.log("√çndice encontrado:", indiceEstudiante);
        
        if (indiceEstudiante === -1) {
            mostrarNotificacion('Error: Estudiante no encontrado', 'error');
            return;
        }

        // Actualizar datos del estudiante existente
        const estudianteExistente = sistemaADAMS.estudiantes[indiceEstudiante];
        sistemaADAMS.estudiantes[indiceEstudiante] = {
            ...estudianteExistente,
            nombre: formatearNombrePropio(nombre),
            edad: edad,
            fechaNacimiento: fechaNacimiento,
            curp: curp,
            tutor: tutor,
            telefono: telefono,
            email: email,
            disciplinas: disciplinasSeleccionadas,
            colegiatura: parseFloat(document.getElementById('colegiatura').value),
            horarios: horarios,
            esHermano: document.getElementById('es-hermano').value === 'si',
            porcentajeBeca: parseInt(document.getElementById('beca').value) || 0,
            estatus: estatusFinal
        };

        mostrarNotificacion('Alumno actualizado exitosamente', 'success');
    } else {
        // CREAR NUEVO ESTUDIANTE
        const nuevoEstudiante = {
            id: Date.now(),
            nombre: formatearNombrePropio(nombre),
            edad: edad,
            fechaNacimiento: fechaNacimiento,
            curp: curp,
            tutor: tutor,
            telefono: telefono,
            email: email,
            disciplinas: disciplinasSeleccionadas,
            colegiatura: parseFloat(document.getElementById('colegiatura').value),
            horarios: horarios,
            esHermano: document.getElementById('es-hermano').value === 'si',
            porcentajeBeca: parseInt(document.getElementById('beca').value) || 0,
            estatus: estatusFinal,
            fechaRegistro: new Date().toISOString()
        };

        sistemaADAMS.estudiantes.push(nuevoEstudiante);
        mostrarNotificacion('Alumno registrado exitosamente', 'success');
    }

    // Guardar en el sistema
    guardarDatos();
    
    // Limpiar y cerrar formulario
    ocultarFormularioEstudiante();
    actualizarTablaEstudiantes();
    actualizarDashboard();
}
        function actualizarTablaEstudiantes() {
    const tbody = document.getElementById('tabla-estudiantes');
    
    // AGREGAR ESTA VALIDACI√ìN CR√çTICA:
    if (!sistemaADAMS || !sistemaADAMS.estudiantes) {
        console.error('Sistema ADAMS no inicializado correctamente');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                    Error: Sistema no inicializado. Refresca la p√°gina.
                </td>
            </tr>
        `;
        return;
    }
    
    if (sistemaADAMS.estudiantes.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                    No hay estudiantes registrados. ¬°Registra el primero!
                </td>
            </tr>
        `;
        actualizarContadorEstudiantes(0, 0);
        return;
    }

    // Aplicar filtros
    const estudiantesFiltrados = aplicarFiltrosEstudiantes();
    
    if (estudiantesFiltrados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                    No se encontraron estudiantes con los filtros aplicados
                </td>
            </tr>
        `;
        actualizarContadorEstudiantes(0, sistemaADAMS.estudiantes.length);
        return;
    }

    // Ordenar alfab√©ticamente por nombre
    const estudiantesOrdenados = estudiantesFiltrados.sort((a, b) => 
        a.nombre.localeCompare(b.nombre)
    );

    tbody.innerHTML = estudiantesOrdenados.map(estudiante => {
        const disciplinasText = estudiante.disciplinas.map(d => 
            d.charAt(0).toUpperCase() + d.slice(1)
        ).join(', ');

        const horariosText = estudiante.horarios.map(h => 
    `${h.dia}: ${h.horaInicio}-${h.horaFin}<br><small style="color: #9c27b0;">${(h.disciplina || 'Sin disciplina').charAt(0).toUpperCase() + (h.disciplina || 'Sin disciplina').slice(1)} - Grupo ${h.grupo || 'Sin asignar'}</small>`
).join('<br><br>');

        const estadoBadge = getEstatusBadge(estudiante.estatus || 'activo');

        return `
            <tr>
                <td>
                    <strong>${estudiante.nombre}</strong><br>
                    <small style="color: #666;">Tutor: ${estudiante.tutor}</small>
                </td>
                <td>${estudiante.edad} a√±os</td>
                <td>${disciplinasText}</td>
                <td style="font-size: 12px;">${horariosText}</td>
                <td>${estadoBadge}</td>
                <td>
                    <strong>${estudiante.colegiatura.toLocaleString()}</strong>
                    ${estudiante.porcentajeBeca > 0 ? `<br><small style="color: #28a745;">Beca: ${estudiante.porcentajeBeca}%</small>` : ''}
                </td>
                <td>
                    <button class="btn btn-secondary btn-small" onclick="editarEstudiante('${estudiante.id}')" style="margin-right: 5px; margin-bottom: 5px;">
                        Editar
                    </button>
                    <button class="btn btn-primary btn-small" onclick="cambiarEstatusRapido(${estudiante.id})" style="margin-right: 5px; margin-bottom: 5px;">
                        Cambiar Estatus
                    </button><br>
                    <button class="btn btn-danger btn-small" onclick="eliminarEstudiante(${estudiante.id})">
                        Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    actualizarContadorEstudiantes(estudiantesFiltrados.length, sistemaADAMS.estudiantes.length);
}

// Funci√≥n para aplicar filtros a estudiantes
function aplicarFiltrosEstudiantes() {
    const filtroNombre = document.getElementById('filtro-nombre-estudiante')?.value.toLowerCase().trim() || '';
    const filtroDisciplina = document.getElementById('filtro-disciplina-estudiante')?.value || '';
    const filtroEstatus = document.getElementById('filtro-estatus-estudiante')?.value || '';
    
    return sistemaADAMS.estudiantes.filter(estudiante => {
        // Filtro por nombre (estudiante o tutor)
        if (filtroNombre) {
            const nombreCompleto = (estudiante.nombre + ' ' + estudiante.tutor).toLowerCase();
            if (!nombreCompleto.includes(filtroNombre)) {
                return false;
            }
        }
        
        // Filtro por disciplina
        if (filtroDisciplina) {
            if (!estudiante.disciplinas.includes(filtroDisciplina)) {
                return false;
            }
        }
        
        // Filtro por estatus
        if (filtroEstatus) {
            const estatus = estudiante.estatus || 'activo';
            if (estatus !== filtroEstatus) {
                return false;
            }
        }
        
        return true;
    });
}

// Funci√≥n para filtrar estudiantes (llamada por los campos)
function filtrarEstudiantes() {
    actualizarTablaEstudiantes();
}

// Funci√≥n para limpiar filtros
function limpiarFiltrosEstudiantes() {
    document.getElementById('filtro-nombre-estudiante').value = '';
    document.getElementById('filtro-disciplina-estudiante').value = '';
    document.getElementById('filtro-estatus-estudiante').value = '';
    actualizarTablaEstudiantes();
}

// Funci√≥n para actualizar contador
function actualizarContadorEstudiantes(filtrados, total) {
    const contadorFiltrados = document.getElementById('contador-estudiantes-filtrados');
    const contadorTotal = document.getElementById('contador-estudiantes-total');
    if (contadorFiltrados) contadorFiltrados.textContent = filtrados;
    if (contadorTotal) contadorTotal.textContent = total;
}

        function eliminarEstudiante(id) {
            if (confirm('¬øEst√°s seguro de eliminar este estudiante?')) {
                sistemaADAMS.estudiantes = sistemaADAMS.estudiantes.filter(e => e.id !== id);
                guardarDatos();
                actualizarTablaEstudiantes();
                actualizarDashboard();
                mostrarNotificacion('Estudiante eliminado', 'success');
            }
        }
        function cambiarEstatusRapido(estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) {
        mostrarNotificacion('Estudiante no encontrado', 'error');
        return;
    }

    const nuevoEstatus = prompt(
        `Cambiar estatus de ${estudiante.nombre}\n\nOpciones:\n- activo\n- inactivo\n- baja\n\nEstatus actual: ${estudiante.estatus || 'activo'}`,
        estudiante.estatus || 'activo'
    );

    if (nuevoEstatus && ['activo', 'inactivo', 'baja'].includes(nuevoEstatus.toLowerCase())) {
        estudiante.estatus = nuevoEstatus.toLowerCase();
        guardarDatos();
        actualizarTablaEstudiantes();
        actualizarDashboard();
        
        const emoji = nuevoEstatus === 'activo' ? 'üü¢' : nuevoEstatus === 'inactivo' ? 'üü°' : 'üî¥';
        mostrarNotificacion(`${emoji} Estatus cambiado a: ${nuevoEstatus.toUpperCase()}`, 'success');
    } else if (nuevoEstatus !== null) {
        mostrarNotificacion('Estatus no v√°lido. Use: activo, inactivo o baja', 'error');
    }
}
// FUNCIONES DEL M√ìDULO DE PAGOS
function mostrarFormularioPago() {
    document.getElementById('formulario-pago').classList.add('show');
    cargarEstudiantesEnPago();
    cargarProductosEnPago();
    cargarConceptosEnSelect();
    
    // Establecer fecha actual por defecto
    // Establecer fecha actual por defecto
document.getElementById('fecha-pago-manual').value = obtenerFechaHoy();
}

        function ocultarFormularioPago() {
            document.getElementById('formulario-pago').classList.remove('show');
            document.getElementById('form-pago').reset();
            
            // Limpiar estado de edici√≥n
            delete document.getElementById('form-pago').dataset.editando;
            
            // Restaurar t√≠tulos originales
            document.querySelector('#formulario-pago h3').textContent = 'üí≥ Registrar Nuevo Pago';
            document.querySelector('#form-pago button[type="submit"]').innerHTML = 'üí∞ Procesar Pago';
            
            // Limpiar carrito y campos temporales
            carritoConceptos = [];
            conceptoTemporal = {};
            
            // Ocultar secciones
            document.getElementById('info-estudiante-pago').style.display = 'none';
            document.getElementById('campos-concepto-temporal').style.display = 'none';
            document.getElementById('carrito-conceptos').style.display = 'none';
            document.getElementById('seccion-metodo-pago').style.display = 'none';
            
            // Limpiar campos
            document.getElementById('concepto-temporal').value = '';
            document.getElementById('monto-recibido').value = '';
            document.getElementById('cambio-entregar').value = '';

            // Restaurar selector de estudiante si estaba bloqueado
const selectEstudiante = document.getElementById('pago-estudiante');
selectEstudiante.disabled = false;
selectEstudiante.style.backgroundColor = '';
selectEstudiante.style.color = '';

selectEstudiante.style.border = '';

// Restaurar label original
const label = selectEstudiante.parentElement.querySelector('label');
if (label) {
    label.innerHTML = 'Seleccionar Estudiante *';
    label.style.color = '';
}

// Remover mensaje de bloqueo
const mensajeBloqueo = document.querySelector('.estudiante-bloqueado-msg');
if (mensajeBloqueo) {
    mensajeBloqueo.remove();
}

        }

        function cargarEstudiantesEnPago() {
            const select = document.getElementById('pago-estudiante');
            select.innerHTML = '<option value="">Seleccionar estudiante...</option>';
            
            sistemaADAMS.estudiantes.forEach(estudiante => {
                select.innerHTML += `
                    <option value="${estudiante.id}">${estudiante.nombre} - ${estudiante.tutor}</option>
                `;
            });
        }

        function cargarDatosEstudiante() {
            const estudianteId = parseInt(document.getElementById('pago-estudiante').value);
            const infoDiv = document.getElementById('info-estudiante-pago');
            const detallesDiv = document.getElementById('estudiante-detalles');
            
            if (!estudianteId) {
                infoDiv.style.display = 'none';
                return;
            }

            const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
            if (!estudiante) return;

            // Calcular √∫ltimo pago
            const ultimoPago = obtenerUltimoPago(estudianteId);
            const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
            
            detallesDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <strong>üìù Informaci√≥n B√°sica</strong><br>
                        Nombre: ${estudiante.nombre}<br>
                        Tutor: ${estudiante.tutor}<br>
                        Tel√©fono: ${estudiante.telefono}<br>
                        Estado: ${getEstatusBadge(estudiante.estado)}
                    </div>
                    <div>
                        <strong>üí∞ Informaci√≥n Financiera</strong><br>
                        Colegiatura: $${estudiante.colegiatura}<br>
                        Beca: ${estudiante.porcentajeBeca}%<br>
                        √öltimo pago: ${ultimoPago ? formatearFecha(ultimoPago.fecha) : 'Sin registros'}<br>
                        D√≠as sin pagar: ${diasSinPagar} d√≠as
                    </div>
                </div>
            `;
            
            infoDiv.style.display = 'block';
            // Remover la llamada a calcularMontoPago ya que no la necesitamos aqu√≠
// calcularMontoPago();
        }

        function calcularMontoPago() {
            const estudianteId = parseInt(document.getElementById('pago-estudiante').value);
            const tipoPago = document.getElementById('pago-tipo').value;
            
            if (!estudianteId || !tipoPago) {
                document.getElementById('resumen-pago').style.display = 'none';
                return;
            }

            const estudiante = sistemaADAMS.estudiantes.find(e => e.id === estudianteId);
            if (!estudiante) return;

            let montoBase = 0;
            let concepto = '';
            
            switch(tipoPago) {
                case 'colegiatura':
                    montoBase = estudiante.colegiatura;
                    concepto = 'Colegiatura Mensual';
                    break;
                case 'ajuste-colegiatura':
                    // Para ajustes, mostrar campo editable
                    mostrarCampoAjusteColegiatura(estudiante);
                    return;
                case 'inscripcion':
                    montoBase = 500;
                    concepto = 'Inscripci√≥n';
                    break;
                case 'reinscripcion':
                    montoBase = 500;
                    concepto = 'Reinscripci√≥n';
                    break;
                case 'producto':
                    document.getElementById('seleccion-productos').style.display = 'block';
                    mostrarProductosDisponibles();
                    return;
            }

            // Calcular recargos para colegiaturas
            let recargo = 0;
            let detalleRecargo = '';
            
            if (tipoPago === 'colegiatura') {
                const ultimoPago = obtenerUltimoPago(estudianteId);
                const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
                
                if (diasSinPagar > 15) {
                    recargo = montoBase * 0.15;
                    detalleRecargo = `Recargo del 15% por ${diasSinPagar} d√≠as de atraso`;
                    mostrarAlertaRecargo(detalleRecargo, recargo);
                } else if (diasSinPagar > 10) {
                    recargo = montoBase * 0.15;
                    detalleRecargo = `Recargo del 15% por ${diasSinPagar} d√≠as de atraso`;
                    mostrarAlertaRecargo(detalleRecargo, recargo);
                } else if (diasSinPagar > 5) {
                    recargo = montoBase * 0.10;
                    detalleRecargo = `Recargo del 10% por ${diasSinPagar} d√≠as de atraso`;
                    mostrarAlertaRecargo(detalleRecargo, recargo);
                } else {
                    document.getElementById('alerta-recargos').style.display = 'none';
                }
            }

            // Aplicar beca
            const descuentoBeca = (montoBase * estudiante.porcentajeBeca) / 100;
            const montoFinal = montoBase - descuentoBeca + recargo;

            mostrarResumenPago({
                concepto: concepto,
                montoBase: montoBase,
                descuentoBeca: descuentoBeca,
                recargo: recargo,
                detalleRecargo: detalleRecargo,
                montoFinal: montoFinal,
                estudiante: estudiante
            });
        }

        function mostrarAlertaRecargo(detalle, monto) {
            const alertDiv = document.getElementById('alerta-recargos');
            const detalleDiv = document.getElementById('recargo-detalles');
            
            detalleDiv.innerHTML = `
                ${detalle}<br>
                <strong>Monto del recargo: $${monto.toFixed(2)}</strong>
            `;
            
            alertDiv.style.display = 'block';
        }
        function mostrarCampoAjusteColegiatura(estudiante) {
            const resumenDiv = document.getElementById('resumen-pago');
            const detallesDiv = document.getElementById('detalles-resumen');
            
            detallesDiv.innerHTML = `
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 15px 0;">
                    <h4 style="color: #856404; margin-bottom: 15px;">üí° Ajuste de Colegiatura</h4>
                    <p style="margin-bottom: 15px;">
                        <strong>Colegiatura normal:</strong> $${estudiante.colegiatura}<br>
                        <small>Este ajuste es para estudiantes que se inscriben a mitad de mes o casos especiales</small>
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Monto del Ajuste *</label>
                            <input type="number" id="monto-ajuste" step="0.01" min="0" max="${estudiante.colegiatura}" 
                                   placeholder="Ej. 450" onchange="actualizarAjusteColegiatura()" 
                                   style="font-size: 16px; font-weight: bold; border: 2px solid #ffc107;">
                        </div>
                        <div class="form-group">
                            <label>Motivo del Ajuste</label>
                            <input type="text" id="motivo-ajuste" placeholder="Ej. Inscripci√≥n d√≠a 15 del mes" 
                                   style="width: 100%;">
                        </div>
                    </div>
                    
                    <div style="font-size: 20px; font-weight: bold; color: #9c27b0; margin-top: 15px; text-align: center;">
                        TOTAL: $<span id="total-ajuste">0.00</span>
                    </div>
                </div>
            `;
            
            resumenDiv.style.display = 'block';
            
            // Focus en el campo de monto
            setTimeout(() => {
                document.getElementById('monto-ajuste').focus();
            }, 100);
        }

        function actualizarAjusteColegiatura() {
            const montoAjuste = parseFloat(document.getElementById('monto-ajuste').value) || 0;
            document.getElementById('total-ajuste').textContent = montoAjuste.toFixed(2);
            document.getElementById('monto-recibido').value = montoAjuste.toFixed(2);
            
            // Simular el input total-editable para compatibilidad
            let totalEditable = document.getElementById('total-editable');
            if (!totalEditable) {
                totalEditable = document.createElement('input');
                totalEditable.id = 'total-editable';
                totalEditable.style.display = 'none';
                document.body.appendChild(totalEditable);
            }
            totalEditable.value = montoAjuste.toFixed(2);
            
            calcularCambio();
        }

        function mostrarResumenPago(datos) {
            const resumenDiv = document.getElementById('resumen-pago');
            const detallesDiv = document.getElementById('detalles-resumen');
            
           detallesDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <strong>Concepto:</strong> ${datos.concepto}<br>
                        <strong>Monto base:</strong> $${datos.montoBase.toFixed(2)}<br>
                        ${datos.descuentoBeca > 0 ? `<strong>Descuento beca (${datos.estudiante.porcentajeBeca}%):</strong> -$${datos.descuentoBeca.toFixed(2)}<br>` : ''}
                        <strong>Recargo calculado:</strong> 
                        <input type="number" id="recargo-editable" value="${datos.recargo.toFixed(2)}" 
                               step="0.01" min="0" style="width: 80px; padding: 2px;" 
                               onchange="actualizarMontoFinal()" class="monto-editable">
                        <button class="toggle-edicion" onclick="toggleEdicionRecargo()">‚úèÔ∏è Editar</button><br>
                        ${datos.recargo > 0 ? `<small style="color: #f57c00; font-size: 11px;">${datos.detalleRecargo}</small><br>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 20px; font-weight: bold; color: #9c27b0; margin-bottom: 10px;">
                            TOTAL: $<input type="number" id="total-editable" value="${datos.montoFinal.toFixed(2)}" 
                                          step="0.01" min="0" style="font-size: 20px; font-weight: bold; width: 120px; 
                                          text-align: right; border: 2px solid #9c27b0; border-radius: 5px; padding: 5px;"
                                          onchange="verificarCambioManual()" class="monto-editable">
                        </div>
                        <button class="btn btn-success btn-small" onclick="aplicarCondonacion()" style="margin-bottom: 10px;">
                            üíö Condonar Recargo
                        </button><br>
                        <button class="btn btn-secondary btn-small" onclick="restaurarMontoAutomatico()">
                            üîÑ Restaurar Autom√°tico
                        </button>
                    </div>
                </div>
                
                <!-- Secci√≥n de Condonaci√≥n -->
                <div id="seccion-condonacion" class="condonacion-section" style="display: none;">
                    <h5 style="color: #28a745; margin-bottom: 10px;">üìù Motivo de Condonaci√≥n</h5>
                    <textarea id="motivo-condonacion" placeholder="Escribe el motivo de la condonaci√≥n del recargo..." 
                              style="width: 100%; height: 60px; padding: 8px; border: 1px solid #28a745; border-radius: 5px;"></textarea>
                    <small style="color: #666;">Este motivo se guardar√° en el historial del pago</small>
                </div>
            `;
            
            resumenDiv.style.display = 'block';
            
            // Guardar datos originales para poder restaurar
            montoOriginalCalculado = datos.montoFinal;
            recargoOriginalCalculado = datos.recargo;
            datosOriginalesPago = datos;
            
            document.getElementById('monto-recibido').value = datos.montoFinal.toFixed(2);
            calcularCambio();
        }

        function seleccionarMetodo(metodo) {
            // Remover selecci√≥n previa
            document.querySelectorAll('.metodo-pago').forEach(el => el.classList.remove('selected'));
            
            // Seleccionar nuevo m√©todo
            document.querySelector(`input[value="${metodo}"]`).checked = true;
            event.currentTarget.classList.add('selected');
        }
// FUNCIONES PARA EDICI√ìN MANUAL DE MONTOS
        let montoOriginalCalculado = 0;
        let recargoOriginalCalculado = 0;
        let datosOriginalesPago = {};

        function toggleEdicionRecargo() {
            const campo = document.getElementById('recargo-editable');
            const boton = event.currentTarget;
            
            if (campo.readOnly) {
                campo.readOnly = false;
                campo.focus();
                campo.style.background = '#fff3cd';
                boton.innerHTML = 'üíæ Guardar';
                mostrarNotificacion('Puedes editar el recargo manualmente', 'success');
            } else {
                campo.readOnly = true;
                campo.style.background = '#f8f9fa';
                boton.innerHTML = '‚úèÔ∏è Editar';
                actualizarMontoFinal();
            }
        }

        function actualizarMontoFinal() {
            const recargoEditado = parseFloat(document.getElementById('recargo-editable').value) || 0;
            const montoBase = datosOriginalesPago.montoBase || 0;
            const descuentoBeca = datosOriginalesPago.descuentoBeca || 0;
            
            const nuevoTotal = montoBase - descuentoBeca + recargoEditado;
            document.getElementById('total-editable').value = nuevoTotal.toFixed(2);
            
            // Actualizar el monto recibido autom√°ticamente
            document.getElementById('monto-recibido').value = nuevoTotal.toFixed(2);
            calcularCambio();
            
            // Mostrar secci√≥n de condonaci√≥n si se redujo el recargo
            if (recargoEditado < recargoOriginalCalculado) {
                document.getElementById('seccion-condonacion').style.display = 'block';
            } else {
                document.getElementById('seccion-condonacion').style.display = 'none';
            }
        }

        function verificarCambioManual() {
            const totalEditado = parseFloat(document.getElementById('total-editable').value) || 0;
            const montoBase = datosOriginalesPago.montoBase || 0;
            const descuentoBeca = datosOriginalesPago.descuentoBeca || 0;
            
            // Calcular qu√© recargo corresponde al total editado
            const recargoImplicito = totalEditado - (montoBase - descuentoBeca);
            document.getElementById('recargo-editable').value = Math.max(0, recargoImplicito).toFixed(2);
            
            // Actualizar el monto recibido
            document.getElementById('monto-recibido').value = totalEditado.toFixed(2);
            calcularCambio();
            
            // Mostrar secci√≥n de condonaci√≥n si se cambi√≥ manualmente
            if (totalEditado < montoOriginalCalculado) {
                document.getElementById('seccion-condonacion').style.display = 'block';
            }
        }

        function aplicarCondonacion() {
            // Poner recargo en 0
            document.getElementById('recargo-editable').value = '0.00';
            actualizarMontoFinal();
            
            // Mostrar secci√≥n de motivo
            document.getElementById('seccion-condonacion').style.display = 'block';
            document.getElementById('motivo-condonacion').focus();
            
            mostrarNotificacion('Recargo condonado. Escribe el motivo.', 'success');
        }

        function restaurarMontoAutomatico() {
            // Restaurar valores originales
            document.getElementById('recargo-editable').value = recargoOriginalCalculado.toFixed(2);
            document.getElementById('total-editable').value = montoOriginalCalculado.toFixed(2);
            document.getElementById('monto-recibido').value = montoOriginalCalculado.toFixed(2);
            
            // Ocultar secci√≥n de condonaci√≥n
            document.getElementById('seccion-condonacion').style.display = 'none';
            document.getElementById('motivo-condonacion').value = '';
            
            calcularCambio();
            mostrarNotificacion('Monto restaurado al c√°lculo autom√°tico', 'success');
        }

        function calcularCambio() {
            const montoRecibido = parseFloat(document.getElementById('monto-recibido').value) || 0;
            let montoTotal = 0;

            // Obtener total del carrito si existe
            const totalCarrito = document.getElementById('total-carrito');
            if (totalCarrito && totalCarrito.textContent) {
                montoTotal = parseFloat(totalCarrito.textContent) || 0;
            } else {
                // Fallback para pagos individuales (compatibilidad)
                const totalEditable = document.getElementById('total-editable');
                const totalAjuste = document.getElementById('total-ajuste');

                if (totalAjuste && totalAjuste.textContent) {
                    montoTotal = parseFloat(totalAjuste.textContent) || 0;
                } else if (totalEditable && totalEditable.value) {
                    montoTotal = parseFloat(totalEditable.value) || 0;
                } else {
                    try {
                        const textoResumen = document.getElementById('detalles-resumen').textContent;
                        const match = textoResumen.match(/TOTAL: \$([0-9,]+\.?[0-9]*)/);
                        if (match) {
                            montoTotal = parseFloat(match[1].replace(/,/g, ''));
                        }
                    } catch (e) {
                        console.error('Error al calcular cambio:', e);
                    }
                }
            }
            
            const cambio = montoRecibido - montoTotal;
            document.getElementById('cambio-entregar').value = cambio >= 0 ? `$${cambio.toFixed(2)}` : 'Monto insuficiente';
        }

        function procesarPago(event) {
            event.preventDefault();
            
            const estudianteId = document.getElementById('pago-estudiante').value;
            const metodoPago = document.querySelector('input[name="metodo-pago"]:checked');
            const montoRecibido = parseFloat(document.getElementById('monto-recibido').value) || montoTotal;
            const esEdicion = document.getElementById('form-pago').dataset.editando;
            
            if (!estudianteId || !metodoPago) {
                mostrarNotificacion('Completa todos los campos requeridos', 'error');
                return;
            }

            if (carritoConceptos.length === 0) {
                mostrarNotificacion('Agrega al menos un concepto al carrito', 'error');
                return;
            }

            const montoTotal = carritoConceptos.reduce((sum, concepto) => sum + concepto.total, 0);
            
            if (montoRecibido < montoTotal) {
                mostrarNotificacion('El monto recibido es insuficiente', 'error');
                return;
            }

            if (esEdicion) {
                // EDITAR PAGO EXISTENTE
                const pagoId = parseInt(esEdicion);
                const pagoIndex = sistemaADAMS.pagos.findIndex(p => p.id === pagoId);
                
                if (pagoIndex === -1) {
                    mostrarNotificacion('Error: Pago no encontrado', 'error');
                    return;
                }

                // Restaurar inventario del pago original si era producto
                const pagoOriginal = sistemaADAMS.pagos[pagoIndex];
                if (pagoOriginal.concepto === 'producto' && pagoOriginal.producto) {
                    const producto = sistemaADAMS.productos.find(p => p.id === pagoOriginal.producto.id);
                    if (producto && pagoOriginal.talla && pagoOriginal.cantidad) {
                        producto.inventario[pagoOriginal.talla] += pagoOriginal.cantidad;
                    }
                }

                // Actualizar el pago
                const pagoActualizado = crearObjetoPago(estudianteId, metodoPago.value, montoRecibido, montoTotal, pagoId);
                sistemaADAMS.pagos[pagoIndex] = pagoActualizado;
                
                mostrarNotificacion('Pago actualizado exitosamente', 'success');
            } else {
                // CREAR NUEVO PAGO
                const fechaPagoManual = document.getElementById('fecha-pago-manual').value;
const nuevoPago = crearObjetoPago(estudianteId, metodoPago.value, montoRecibido, montoTotal, null, fechaPagoManual);
                sistemaADAMS.pagos.push(nuevoPago);
                
                mostrarNotificacion('Pago procesado exitosamente', 'success');
            }

            // Actualizar inventario para productos
            carritoConceptos.forEach(concepto => {
                if (concepto.tipo === 'producto' && concepto.producto) {
                    const producto = sistemaADAMS.productos.find(p => p.id === concepto.producto.id);
                    if (producto && concepto.talla && concepto.cantidad) {
                        producto.inventario[concepto.talla] -= concepto.cantidad;
                    }
                }
            });

            // Actualizar estado del estudiante
            const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
            if (estudiante && carritoConceptos.some(c => c.tipo === 'colegiatura' || c.tipo === 'ajuste-colegiatura')) {
                estudiante.estado = 'activo';
                estudiante.ultimoPago = new Date().toISOString();
            }

            // Guardar y actualizar
guardarDatos();

// El recibo se puede generar desde el bot√≥n "Reimprimir" en el historial de pagos
// const pagoParaRecibo = esEdicion ? 
//     sistemaADAMS.pagos.find(p => p.id === parseInt(esEdicion)) :
//     sistemaADAMS.pagos[sistemaADAMS.pagos.length - 1];
// mostrarRecibo(pagoParaRecibo);
mostrarNotificacion(esEdicion ? 
    'Pago actualizado exitosamente' : 
    'Pago registrado exitosamente - Puedes reimprimir el recibo desde el historial', 
    'success');

// Actualizar tablas
actualizarTablaPagos();
actualizarTablaEstudiantes();
actualizarDashboard();

// Actualizar reportes financieros autom√°ticamente
generarReporteFinanciero();

ocultarFormularioPago();
        }

function crearObjetoPago(estudianteId, metodoPago, montoRecibido, montoTotal, pagoId = null, fechaManual = null) {
    // AGREGAR: Buscar datos del estudiante
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    const nombreEstudiante = estudiante ? estudiante.nombre : 'Estudiante no encontrado';
    const tutorEstudiante = estudiante ? estudiante.tutor : '';
    // Validar que los montos sean coherentes
if (!montoRecibido || montoRecibido < 0) {
    console.warn('Monto recibido inv√°lido, usando total como monto recibido');
    montoRecibido = montoTotal;
}

if (montoRecibido < montoTotal) {
    console.warn('Monto recibido menor al total:', montoRecibido, 'vs', montoTotal);
}
    
    const pago = {
        id: pagoId || Date.now(),
        estudianteId: estudianteId,
        estudianteNombre: nombreEstudiante,  // NUEVO
        estudianteTutor: tutorEstudiante,    // NUEVO
        fecha: fechaManual ? new Date(fechaManual + 'T12:00:00').toISOString() : new Date().toISOString(),
        fechaRegistro: new Date().toISOString(),
        conceptos: carritoConceptos.map(c => ({...c})), // Copia profunda
        montoTotal: montoTotal,
        montoRecibido: montoRecibido,
        cambio: Math.max(0, montoRecibido - montoTotal),
        metodoPago: metodoPago,
        estado: 'completado'
    };

    // Para compatibilidad con recibos, mantener el concepto principal
    if (carritoConceptos.length === 1) {
        pago.concepto = carritoConceptos[0].tipo;
        
        // NUEVO: Agregar informaci√≥n del mes para reportes
        if (carritoConceptos[0].mesAplicacion && carritoConceptos[0].a√±oAplicacion) {
            pago.mesAplicacion = carritoConceptos[0].mesAplicacion;
            pago.a√±oAplicacion = carritoConceptos[0].a√±oAplicacion;
            pago.descripcionMes = carritoConceptos[0].descripcionMes;
        }
        
        // Agregar datos espec√≠ficos del concepto principal
        if (carritoConceptos[0].tipo === 'producto') {
            pago.producto = carritoConceptos[0].producto;
            pago.talla = carritoConceptos[0].talla;
            pago.cantidad = carritoConceptos[0].cantidad;
        } else if (carritoConceptos[0].tipo === 'colegiatura') {
            pago.recargoOriginal = carritoConceptos[0].recargo || 0;
            pago.recargoFinal = carritoConceptos[0].recargo || 0;
            pago.montoBase = carritoConceptos[0].montoBase;
            pago.descuentoBeca = carritoConceptos[0].descuentoBeca;
        } else if (carritoConceptos[0].tipo === 'ajuste-colegiatura') {
            pago.motivo = carritoConceptos[0].motivo;
            pago.montoNormal = carritoConceptos[0].montoNormal;
        }
    } else {
        pago.concepto = 'm√∫ltiple';
        
        // NUEVO: Para pagos m√∫ltiples, agregar informaci√≥n de meses si todos son del mismo mes
        const mesesUnicos = [...new Set(carritoConceptos
            .filter(c => c.mesAplicacion && c.a√±oAplicacion)
            .map(c => `${c.mesAplicacion}-${c.a√±oAplicacion}`))];
        
        if (mesesUnicos.length === 1) {
            const primerConcepto = carritoConceptos.find(c => c.mesAplicacion && c.a√±oAplicacion);
            if (primerConcepto) {
                pago.mesAplicacion = primerConcepto.mesAplicacion;
                pago.a√±oAplicacion = primerConcepto.a√±oAplicacion;
                pago.descripcionMes = primerConcepto.descripcionMes;
            }
        }
    }

    return pago;
}

        function obtenerUltimoPago(estudianteId) {
    if (!sistemaADAMS.pagos || sistemaADAMS.pagos.length === 0) return null;
    
    const pagosEstudiante = sistemaADAMS.pagos
        .filter(p => p.estudianteId === estudianteId && 
                    (p.concepto === 'colegiatura' || p.concepto === 'ajuste-colegiatura'))
        .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    return pagosEstudiante.length > 0 ? pagosEstudiante[0] : null;
}

        function calcularDiasSinPagar(ultimoPago, estudiante) {
            const hoy = new Date();
            const diaActual = hoy.getDate();
            
            // Si no hay √∫ltimo pago, usar fecha de registro del estudiante
            if (!ultimoPago) {
                if (!estudiante || !estudiante.fechaRegistro) {
                    // Si es estudiante nuevo sin fecha de registro, asumir que se inscribi√≥ hoy
                    // Los primeros 5 d√≠as del mes est√°n en tiempo
                    return diaActual > 5 ? diaActual - 5 : 0;
                }
                
                const fechaRegistro = new Date(estudiante.fechaRegistro);
                const mesRegistro = fechaRegistro.getMonth();
                const a√±oRegistro = fechaRegistro.getFullYear();
                
                // Si se registr√≥ en el mes actual, calcular desde el d√≠a 5 del mes
                if (mesRegistro === hoy.getMonth() && a√±oRegistro === hoy.getFullYear()) {
                    return diaActual > 5 ? diaActual - 5 : 0;
                } else {
                    // Si se registr√≥ en un mes anterior, calcular normalmente
                    const diferencia = hoy - fechaRegistro;
                    return Math.floor(diferencia / (1000 * 60 * 60 * 24));
                }
            }
            
            // Si hay √∫ltimo pago, calcular desde la fecha del √∫ltimo pago
            const fechaUltimoPago = new Date(ultimoPago.fecha);
            const diferencia = hoy - fechaUltimoPago;
            const diasTranscurridos = Math.floor(diferencia / (1000 * 60 * 60 * 24));
            
            // Si el √∫ltimo pago fue este mes, considerar los primeros 5 d√≠as como v√°lidos
            if (fechaUltimoPago.getMonth() === hoy.getMonth() && 
                fechaUltimoPago.getFullYear() === hoy.getFullYear()) {
                return diaActual > 5 ? diaActual - 5 : 0;
            }
            
            return diasTranscurridos;
        }

        // PASO 3: REEMPLAZAR LA FUNCI√ìN mostrarRecibo EXISTENTE CON ESTA

function mostrarRecibo(pago) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == pago.estudianteId);
    
    // Generar detalle de conceptos mejorado
    let detalleConceptos = '';
    let subtotal = 0;
    
    if (pago.conceptos && pago.conceptos.length > 0) {
        detalleConceptos = pago.conceptos.map(concepto => {
            subtotal += concepto.total;
            let descripcion = obtenerNombreConcepto(concepto.tipo);
            
            // NUEVO: Agregar informaci√≥n del mes
            if (concepto.mesAplicacion && concepto.a√±oAplicacion) {
                const nombreMes = new Date(concepto.a√±oAplicacion, concepto.mesAplicacion - 1, 1)
                    .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                descripcion += ` (${nombreMes})`;
            }
            
            if (concepto.tipo === 'producto') {
                descripcion += ` - ${concepto.nombre} (${concepto.talla}) x${concepto.cantidad}`;
            }
            
            if (concepto.tipo === 'ajuste-colegiatura' && concepto.motivo) {
                descripcion += ` - ${concepto.motivo}`;
            }
            
            return `
                <div class="concepto-item">
                    <span>${descripcion}</span>
                    <span>$${concepto.total.toFixed(2)}</span>
                </div>
            `;
        }).join('');
    } else {
        // Compatibilidad con pagos antiguos
        let descripcionLegacy = obtenerNombreConcepto(pago.concepto);
        
        // NUEVO: Agregar mes para pagos antiguos si existe
        if (pago.mesAplicacion && pago.a√±oAplicacion) {
            const nombreMes = new Date(pago.a√±oAplicacion, pago.mesAplicacion - 1, 1)
                .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            descripcionLegacy += ` (${nombreMes})`;
        }
        
        detalleConceptos = `
            <div class="concepto-item">
                <span>${descripcionLegacy}</span>
                <span>$${pago.montoTotal.toFixed(2)}</span>
            </div>
        `;
        subtotal = pago.montoTotal;
    }
    
    // HTML del recibo mejorado para tama√±o carta
    const reciboHTML = `
        <div class="recibo-carta" id="recibo-para-pdf">
            <!-- Header con logo y t√≠tulo -->
            <div class="recibo-header">
                <div class="logo-section">
    <div class="logo-placeholder" style="display: none;">
        ${obtenerInicialAcademia()}
    </div>
    <div>
        <h1 class="academia-title">${obtenerNombreAcademia()}</h1>
        <p class="academia-subtitle">Formando Campeones ‚Ä¢ ${obtenerDireccionAcademia()}</p>
    </div>
</div>
            
            <!-- Informaci√≥n del recibo y estudiante -->
            <div class="recibo-info">
                <div class="info-section">
                    <div class="info-title">üìÑ Informaci√≥n del Recibo</div>
                    <div class="info-row">
                        <span class="info-label">N√∫mero de Recibo:</span>
                        <span class="info-value">#${pago.id}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha del Pago:</span>
                        <span class="info-value">${formatearFecha(pago.fecha)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha de Registro:</span>
                        <span class="info-value">${pago.fechaRegistro ? formatearFecha(pago.fechaRegistro) : formatearFecha(new Date())}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">M√©todo de Pago:</span>
                        <span class="info-value">${pago.metodoPago.toUpperCase()}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Estado:</span>
                        <span class="info-value" style="color: #28a745; font-weight: bold;">‚úì PAGADO</span>
                    </div>
                </div>
                
                <div class="info-section">
                    <div class="info-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Datos del Estudiante</div>
                    <div class="info-row">
                        <span class="info-label">Estudiante:</span>
                        <span class="info-value">${estudiante.nombre}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tutor/Responsable:</span>
                        <span class="info-value">${estudiante.tutor}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tel√©fono:</span>
                        <span class="info-value">${estudiante.telefono}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value">${estudiante.email || 'No registrado'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Detalle del pago -->
            <div class="detalle-pago">
                <div class="detalle-title">üí∞ Detalle del Pago</div>
                ${detalleConceptos}
                <div class="concepto-item">
                    <span><strong>TOTAL A PAGAR</strong></span>
                    <span><strong>$${pago.montoTotal.toFixed(2)}</strong></span>
                </div>
            </div>
            
            <!-- Informaci√≥n de pago -->
            <div class="total-section">
                <div style="font-size: 16px;">üíµ Informaci√≥n del Pago</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 15px 0;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">Monto Recibido</div>
                        <div style="font-size: 20px; font-weight: bold;">$${pago.montoRecibido.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">Total</div>
                        <div class="total-amount">$${pago.montoTotal.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">Cambio</div>
                        <div style="font-size: 20px; font-weight: bold;">$${pago.cambio.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <!-- Footer con informaci√≥n de contacto -->
            <div class="footer-recibo">
                <div class="contacto-info">
    <div class="contacto-item">
        <strong>üìç Direcci√≥n</strong><br>
        ${obtenerDireccionAcademia()}<br>
        M√©xico
    </div>
    <div class="contacto-item">
        <strong>üìû Contacto</strong><br>
        Tel: ${obtenerTelefonoAcademia()}<br>
        WhatsApp: ${obtenerWhatsAppAcademia()}
    </div>
    <div class="contacto-item">
        <strong>üìß Digital</strong><br>
        IG: ${obtenerInstagramAcademia()}<br>
        Email: ${obtenerEmailAcademia()}
    </div>
</div>
                <div class="agradecimiento">
                    ¬°Gracias por confiar en nosotros!<br>
                    <strong>Academia ADAMS - Formando Campeones</strong>
                </div>
            </div>
        </div>
    `;
    
    // Crear modal para mostrar recibo
    const modal = document.createElement('div');
    modal.id = 'modal-recibo-mejorado';
    modal.className = 'modal-recibo';
    
    modal.innerHTML = `
        <div class="modal-content">
            ${reciboHTML}
            <div class="botones-recibo">
    <button class="btn btn-success" onclick="descargarReciboPDF()">
        üì• Descargar PDF
    </button>
    <button class="btn btn-secondary" onclick="cerrarReciboMejorado()">
        ‚ùå Cerrar
    </button>
</div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

        function imprimirRecibo() {
            const recibo = document.querySelector('.recibo-preview').innerHTML;
            const ventana = window.open('', '_blank');
            ventana.document.write(`
                <html>
                <head><title>Recibo de Pago</title></head>
                <body style="font-family: 'Courier New', monospace; margin: 20px;">
                    <pre>${recibo}</pre>
                </body>
                </html>
            `);
            ventana.document.close();
            ventana.print();
        }

        function cerrarRecibo() {
            const modal = document.getElementById('modal-recibo');
            if (modal) {
                modal.remove();
            }
        }
        // PASO 4: AGREGAR ESTAS FUNCIONES DESPU√âS DE cerrarRecibo()

        function limpiarReciboParaPDF(elemento) {
    // Crear una copia temporal del elemento
    const copia = elemento.cloneNode(true);
    
    // Eliminar todos los botones y elementos interactivos de la copia
    const elementosAEliminar = [
        ...copia.querySelectorAll('button'),
        ...copia.querySelectorAll('.btn'),
        ...copia.querySelectorAll('input'),
        ...copia.querySelectorAll('select'),
        ...copia.querySelectorAll('.logo-placeholder'),
        ...copia.querySelectorAll('.botones-recibo')
    ];
    
    elementosAEliminar.forEach(el => el.remove());
    
    return copia;
}
// Funci√≥n para descargar recibo como PDF
function descargarReciboPDF() {
    const { jsPDF } = window.jspdf;
    const recibo = document.getElementById('recibo-para-pdf');
    
    if (!recibo) {
        alert('Error: No se encontr√≥ el recibo para descargar');
        return;
    }
    
    // Mostrar mensaje de carga
    const btnDescargar = event.target;
    const textoOriginal = btnDescargar.textContent;
    btnDescargar.textContent = '‚è≥ Generando PDF...';
    btnDescargar.disabled = true;
    
    // PASO CR√çTICO: Ocultar elementos antes de capturar
    const elementosAOcultar = [
        // Todos los botones dentro del recibo
        ...recibo.querySelectorAll('button'),
        ...recibo.querySelectorAll('.btn'),
        ...recibo.querySelectorAll('input[type="button"]'),
        
        // El logo placeholder espec√≠ficamente  
        ...recibo.querySelectorAll('.logo-placeholder'),
        
        // Los botones del modal
        ...document.querySelectorAll('.botones-recibo'),
        
        // Cualquier input o select dentro del recibo
        ...recibo.querySelectorAll('input'),
        ...recibo.querySelectorAll('select'),
        ...recibo.querySelectorAll('textarea')
    ];
    
    // Guardar estilos originales y ocultar
    const estilosOriginales = [];
    elementosAOcultar.forEach((elemento, index) => {
        estilosOriginales[index] = elemento.style.display;
        elemento.style.display = 'none';
    });
    
    // Tambi√©n ocultar espec√≠ficamente cualquier elemento con texto "A" del logo
    const logosA = recibo.querySelectorAll('div');
    const logosOcultos = [];
    logosA.forEach(div => {
        if (div.textContent.trim() === 'A' && div.style.background && div.style.borderRadius) {
            logosOcultos.push({elemento: div, display: div.style.display});
            div.style.display = 'none';
        }
    });
    
    // Usar html2canvas para convertir el HTML a imagen
    html2canvas(recibo, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: recibo.scrollWidth,
        height: recibo.scrollHeight,
        ignoreElements: function(element) {
            // Ignorar elementos espec√≠ficos durante la captura
            return element.tagName === 'BUTTON' || 
                   element.classList.contains('btn') ||
                   element.classList.contains('logo-placeholder') ||
                   element.classList.contains('botones-recibo');
        }
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        
        // Crear PDF en tama√±o carta
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgWidth = 190; // Ancho en mm para A4
        const pageHeight = 297; // Alto de p√°gina A4 en mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        
        let position = 10; // Margen superior
        
        // Agregar imagen al PDF
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Si el contenido es m√°s alto que una p√°gina, agregar p√°ginas adicionales
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight + 10;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        // Generar nombre del archivo con fecha y hora
        const ahora = new Date();
        const fecha = ahora.toISOString().split('T')[0]; // YYYY-MM-DD
        const hora = ahora.toTimeString().split(':').slice(0, 2).join(''); // HHMM
        const nombreArchivo = `Recibo_Academia_Adams_${fecha}_${hora}.pdf`;
        
        // Descargar el PDF
        pdf.save(nombreArchivo);
        
        // RESTAURAR elementos ocultos
        elementosAOcultar.forEach((elemento, index) => {
            elemento.style.display = estilosOriginales[index];
        });
        
        // Restaurar logos ocultos
        logosOcultos.forEach(item => {
            item.elemento.style.display = item.display;
        });
        
        // Restaurar bot√≥n
        btnDescargar.textContent = textoOriginal;
        btnDescargar.disabled = false;
        
        // Mostrar mensaje de √©xito
        mostrarNotificacion('PDF descargado exitosamente', 'success');
        
    }).catch(error => {
    console.error('Error al generar PDF:', error);
    
    // RESTAURAR elementos ocultos SIEMPRE
    elementosAOcultar.forEach((elemento, index) => {
        elemento.style.display = estilosOriginales[index];
    });
    
    // Restaurar logos ocultos
    logosOcultos.forEach(item => {
        item.elemento.style.display = item.display;
    });
    
    mostrarNotificacion('Error al generar el PDF. Intenta de nuevo.', 'error');
    
    // Restaurar bot√≥n
    btnDescargar.textContent = textoOriginal;
    btnDescargar.disabled = false;
});
}

// Funci√≥n mejorada para imprimir
function imprimirReciboMejorado() {
    // Ocultar botones antes de imprimir
    const botones = document.querySelector('.botones-recibo');
    if (botones) {
        botones.style.display = 'none';
    }
    
    window.print();
    
    // Mostrar botones despu√©s de imprimir
    setTimeout(() => {
        if (botones) {
            botones.style.display = 'flex';
        }
    }, 1000);
}

// Funci√≥n para cerrar el recibo mejorado
function cerrarReciboMejorado() {
    const modal = document.getElementById('modal-recibo-mejorado');
    if (modal) {
        modal.remove();
    }
}

// Mantener la funci√≥n original para compatibilidad
function imprimirRecibo() {
    // Verificar si es el recibo nuevo o el viejo
    const reciboNuevo = document.getElementById('recibo-para-pdf');
    if (reciboNuevo) {
        imprimirReciboMejorado();
    } else {
        // C√≥digo original para recibos viejos
        const recibo = document.querySelector('.recibo-preview');
        if (recibo) {
            const ventana = window.open('', '_blank');
            ventana.document.write(`
                <html>
                <head><title>Recibo de Pago</title></head>
                <body style="font-family: 'Courier New', monospace; margin: 20px;">
                    <pre>${recibo.innerHTML}</pre>
                </body>
                </html>
            `);
            ventana.document.close();
            ventana.print();
        }
    }
}

        function actualizarTablaPagos() {
    const tbody = document.getElementById('tabla-pagos');
    
    if (!sistemaADAMS.pagos || sistemaADAMS.pagos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                    No hay pagos registrados
                </td>
            </tr>
        `;
        actualizarContadorPagos(0, 0);
        return;
    }

    // Aplicar filtros
    const pagosFiltrados = aplicarFiltrosPagos();
    
    if (pagosFiltrados.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                    No se encontraron pagos con los filtros aplicados
                </td>
            </tr>
        `;
        actualizarContadorPagos(0, sistemaADAMS.pagos.length);
        return;
    }

    // Ordenar por fecha m√°s reciente
    const pagosOrdenados = pagosFiltrados.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

    tbody.innerHTML = pagosOrdenados.map(pago => {
        const estudiante = sistemaADAMS.estudiantes.find(e => e.id == pago.estudianteId);
        let conceptoText = {
    'colegiatura': 'Colegiatura',
    'ajuste-colegiatura': 'Ajuste Colegiatura',
    'inscripcion': 'Inscripci√≥n',
    'reinscripcion': 'Reinscripci√≥n',
    'producto': 'Producto',
    'm√∫ltiple': 'Pago M√∫ltiple'
}[pago.concepto] || pago.concepto;

// Agregar informaci√≥n del mes para colegiaturas
if ((pago.concepto === 'colegiatura' || pago.concepto === 'ajuste-colegiatura') && 
    pago.mesAplicacion && pago.a√±oAplicacion) {
    const nombreMes = new Date(pago.a√±oAplicacion, pago.mesAplicacion - 1, 1)
        .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    conceptoText += ` (${nombreMes})`;
} else if (pago.concepto === 'm√∫ltiple' && pago.mesAplicacion && pago.a√±oAplicacion) {
    const nombreMes = new Date(pago.a√±oAplicacion, pago.mesAplicacion - 1, 1)
        .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    conceptoText += ` (${nombreMes})`;
}

        return `
            <tr>
                <td>${formatearFecha(pago.fecha)}</td>
                <td>
    <strong>${pago.estudianteNombre || (estudiante ? estudiante.nombre : 'Estudiante no encontrado')}</strong><br>
    <small style="color: #666;">${pago.estudianteTutor || (estudiante ? estudiante.tutor : '')}</small>
</td>
                <td>${conceptoText}</td>
                <td><strong>$${(pago.montoTotal || 0).toFixed(2)}</strong></td>
                <td>${pago.metodoPago}</td>
                <td><span class="status status-active">Pagado</span></td>
                <td>
                    <button class="btn btn-success btn-small" onclick="reimprimeRecibo(${pago.id})" style="margin-bottom: 5px;">
    üìÑ Recibo PDF
</button><br>
                    <button class="btn btn-primary btn-small" onclick="editarPago(${pago.id})" style="margin-right: 5px;">
                        ‚úèÔ∏è Editar
                    </button>
                    <button class="btn btn-danger btn-small" onclick="eliminarPago(${pago.id})">
                        üóëÔ∏è Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    actualizarContadorPagos(pagosFiltrados.length, sistemaADAMS.pagos.length);
}

// Funci√≥n para aplicar filtros a pagos
function aplicarFiltrosPagos() {
    const filtroEstudiante = document.getElementById('filtro-estudiante-pago')?.value.toLowerCase().trim() || '';
    const filtroConcepto = document.getElementById('filtro-concepto-pago')?.value || '';
    const filtroMetodo = document.getElementById('filtro-metodo-pago')?.value || '';
    
    return sistemaADAMS.pagos.filter(pago => {
        // Filtro por estudiante
        if (filtroEstudiante) {
            const estudiante = sistemaADAMS.estudiantes.find(e => e.id === pago.estudianteId);
            if (!estudiante || !estudiante.nombre.toLowerCase().includes(filtroEstudiante)) {
                return false;
            }
        }
        
        // Filtro por concepto
        if (filtroConcepto && pago.concepto !== filtroConcepto) {
            return false;
        }
        
        // Filtro por m√©todo
        if (filtroMetodo && pago.metodoPago !== filtroMetodo) {
            return false;
        }
        
        return true;
    });
}

// Funci√≥n para filtrar pagos
function filtrarPagos() {
    actualizarTablaPagos();
}

// Funci√≥n para limpiar filtros de pagos
function limpiarFiltrosPagos() {
    document.getElementById('filtro-estudiante-pago').value = '';
    document.getElementById('filtro-concepto-pago').value = '';
    document.getElementById('filtro-metodo-pago').value = '';
    actualizarTablaPagos();
}

// Funci√≥n para actualizar contador de pagos
function actualizarContadorPagos(filtrados, total) {
    const contadorFiltrados = document.getElementById('contador-pagos-filtrados');
    const contadorTotal = document.getElementById('contador-pagos-total');
    if (contadorFiltrados) contadorFiltrados.textContent = filtrados;
    if (contadorTotal) contadorTotal.textContent = total;
}

    function reimprimeRecibo(pagoId) {
    const pago = sistemaADAMS.pagos.find(p => p.id == pagoId);
    if (!pago) {
        mostrarNotificacion('Pago no encontrado', 'error');
        return;
    }
    
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == pago.estudianteId);
    if (!estudiante) {
        mostrarNotificacion('Estudiante no encontrado', 'error');
        return;
    }

    // Crear el HTML del recibo temporalmente
    const reciboHTML = generarHTMLRecibo(pago, estudiante);
    
    // Crear elemento temporal
    const tempDiv = document.createElement('div');
    tempDiv.id = 'recibo-temp-pdf';
    tempDiv.innerHTML = reciboHTML;
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px'; // Ocultar fuera de pantalla
    document.body.appendChild(tempDiv);
    
    // Descargar PDF directamente
    descargarReciboPDFDirecto('recibo-temp-pdf', pago.id);
}
function generarHTMLRecibo(pago, estudiante) {
    // Generar detalle de conceptos
    let detalleConceptos = '';
    
    if (pago.conceptos && pago.conceptos.length > 0) {
        detalleConceptos = pago.conceptos.map(concepto => {
            let descripcion = obtenerNombreConcepto(concepto.tipo);
            
            if (concepto.mesAplicacion && concepto.a√±oAplicacion) {
                const nombreMes = new Date(concepto.a√±oAplicacion, concepto.mesAplicacion - 1, 1)
                    .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                descripcion += ` (${nombreMes})`;
            }
            
            if (concepto.tipo === 'producto') {
                descripcion += ` - ${concepto.nombre} (${concepto.talla}) x${concepto.cantidad}`;
            }
            
            if (concepto.tipo === 'ajuste-colegiatura' && concepto.motivo) {
                descripcion += ` - ${concepto.motivo}`;
            }
            
            return `
                <div class="concepto-item">
                    <span>${descripcion}</span>
                    <span>$${(concepto.total || 0).toFixed(2)}</span>
                </div>
            `;
        }).join('');
    } else {
        let descripcionLegacy = obtenerNombreConcepto(pago.concepto);
        
        if (pago.mesAplicacion && pago.a√±oAplicacion) {
            const nombreMes = new Date(pago.a√±oAplicacion, pago.mesAplicacion - 1, 1)
                .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            descripcionLegacy += ` (${nombreMes})`;
        }
        
        detalleConceptos = `
            <div class="concepto-item">
                <span>${descripcionLegacy}</span>
                <span>$${(pago.montoTotal || 0).toFixed(2)}</span>
            </div>
        `;
    }

    return `
        <div class="recibo-carta">
            <div class="recibo-header">
                <div class="logo-section">
                    <div>
                        <h1 class="academia-title">${obtenerNombreAcademia()}</h1>
                        <p class="academia-subtitle">Formando Campeones ‚Ä¢ ${obtenerDireccionAcademia()}</p>
                    </div>
                </div>
            </div>
            
            <div class="recibo-info">
                <div class="info-section">
                    <div class="info-title">üìÑ Informaci√≥n del Recibo</div>
                    <div class="info-row">
                        <span class="info-label">N√∫mero de Recibo:</span>
                        <span class="info-value">#${pago.id}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Fecha del Pago:</span>
                        <span class="info-value">${formatearFecha(pago.fecha)}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">M√©todo de Pago:</span>
                        <span class="info-value">${pago.metodoPago.toUpperCase()}</span>
                    </div>
                    <div class="info-row">
    <span class="info-label">Estado:</span>
    <span class="info-value" style="color: #28a745; font-weight: bold;">‚úì PAGADO</span>
</div>
                </div>
                
                <div class="info-section">
                    <div class="info-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Datos del Estudiante</div>
                    <div class="info-row">
                        <span class="info-label">Estudiante:</span>
                        <span class="info-value">${estudiante.nombre}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tutor/Responsable:</span>
                        <span class="info-value">${estudiante.tutor}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tel√©fono:</span>
                        <span class="info-value">${estudiante.telefono}</span>
                    </div>
                </div>
            </div>
            
            <div class="detalle-pago">
                <div class="detalle-title">üí∞ Detalle del Pago</div>
                ${detalleConceptos}
                <div class="concepto-item">
                    <span><strong>TOTAL A PAGAR</strong></span>
                    <span><strong>$${(pago.montoTotal || 0).toFixed(2)}</strong></span>
                </div>
            </div>
            
            <div class="total-section">
                <div style="font-size: 16px;">üíµ Informaci√≥n del Pago</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 15px 0;">
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">Monto Recibido</div>
                        <div style="font-size: 20px; font-weight: bold;">$${(pago.montoRecibido || 0).toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">Total</div>
                        <div class="total-amount">$${(pago.montoTotal || 0).toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; opacity: 0.9;">Cambio</div>
                        <div style="font-size: 20px; font-weight: bold;">$${(pago.cambio || 0).toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <div class="footer-recibo">
                <div class="contacto-info">
                    <div class="contacto-item">
                        <strong>üìç Direcci√≥n</strong><br>
                        ${obtenerDireccionAcademia()}<br>
                        M√©xico
                    </div>
                    <div class="contacto-item">
                        <strong>üìû Contacto</strong><br>
                        Tel: ${obtenerTelefonoAcademia()}<br>
                        WhatsApp: ${obtenerWhatsAppAcademia()}
                    </div>
                    <div class="contacto-item">
    <strong>üìß Digital</strong><br>
    IG: ${obtenerInstagramAcademia()}${obtenerEmailAcademia() ? '<br>Email: ' + obtenerEmailAcademia() : ''}
</div>
                </div>
                <div class="agradecimiento">
                    ¬°Gracias por confiar en nosotros!<br>
                    <strong>Academia ADAMS - Formando Campeones</strong>
                </div>
            </div>
        </div>
    `;
}
function descargarReciboPDFDirecto(elementoId, pagoId) {
    const { jsPDF } = window.jspdf;
    const recibo = document.getElementById(elementoId);
    
    if (!recibo) {
        mostrarNotificacion('Error: No se pudo generar el recibo', 'error');
        return;
    }
    
    // Mostrar notificaci√≥n de carga
    mostrarNotificacion('Generando PDF...', 'success');
    
    // Usar html2canvas para convertir el HTML a imagen
    html2canvas(recibo, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: recibo.scrollWidth,
        height: recibo.scrollHeight
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        
        // Crear PDF en tama√±o carta
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });
        
        const imgWidth = 190; // Ancho en mm para A4
        const pageHeight = 297; // Alto de p√°gina A4 en mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        
        let position = 10; // Margen superior
        
        // Agregar imagen al PDF
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Si el contenido es m√°s alto que una p√°gina, agregar p√°ginas adicionales
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight + 10;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        // Generar nombre del archivo
        const ahora = new Date();
        const fecha = ahora.toISOString().split('T')[0];
        const nombreArchivo = `Recibo_Adams_${pagoId}_${fecha}.pdf`;
        
        // Descargar el PDF
        pdf.save(nombreArchivo);
        
        // Limpiar elemento temporal
        document.body.removeChild(recibo);
        
        // Mostrar mensaje de √©xito
        mostrarNotificacion('PDF descargado exitosamente', 'success');
        
    }).catch(error => {
        console.error('Error al generar PDF:', error);
        
        // Limpiar elemento temporal en caso de error
        const tempElement = document.getElementById(elementoId);
        if (tempElement) {
            document.body.removeChild(tempElement);
        }
        
        mostrarNotificacion('Error al generar el PDF. Intenta de nuevo.', 'error');
    });
}
        // FUNCIONES DE PRODUCTOS Y UNIFORMES
       function mostrarFormularioProducto() {
    document.getElementById('formulario-producto').classList.add('show');
    cargarCategoriasEnSelect();
    // Limpiar formulario
    document.getElementById('producto-requiere-tallas').checked = false;
    document.getElementById('seccion-tallas').style.display = 'none';
    document.getElementById('inventario-simple').style.display = 'block';
}

        function ocultarFormularioProducto() {
    document.getElementById('formulario-producto').classList.remove('show');
    document.getElementById('form-producto').reset();
    
    // Limpiar estado de edici√≥n
    delete document.getElementById('form-producto').dataset.editando;
    
    // Restaurar t√≠tulos originales
    document.querySelector('#formulario-producto h4').textContent = 'üì¶ Nuevo Producto';
    document.querySelector('#form-producto button[type="submit"]').innerHTML = 'üíæ Guardar Producto';
    
    // Reinicializar sistema de tallas
    setTimeout(() => cambiarSistemaTallas(), 100);
}

// NUEVAS FUNCIONES PARA GESTI√ìN DE CATEGOR√çAS Y TALLAS

function cargarCategoriasEnSelect() {
    const select = document.getElementById('producto-categoria');
    if (!select) return;
    
    // Inicializar categor√≠as si no existen
    if (!sistemaADAMS.categorias || sistemaADAMS.categorias.length === 0) {
        sistemaADAMS.categorias = [
            { id: 1, nombre: 'Bebidas', descripcion: 'Aguas, refrescos, bebidas deportivas', activa: true },
            { id: 2, nombre: 'Dulces y Snacks', descripcion: 'Dulces, chocolates, botanas', activa: true },
            { id: 3, nombre: 'Uniformes', descripcion: 'Uniformes de entrenamiento y competencia', activa: true },
            { id: 4, nombre: 'Playeras', descripcion: 'Playeras deportivas y casuales', activa: true },
            { id: 5, nombre: 'Accesorios', descripcion: 'Accesorios deportivos y personales', activa: true }
        ];
        guardarDatos();
    }
    
    const valorActual = select.value;
    select.innerHTML = '<option value="">Seleccionar categor√≠a...</option>';
    
    sistemaADAMS.categorias
        .filter(categoria => categoria.activa)
        .forEach(categoria => {
            select.innerHTML += `<option value="${categoria.id}">${categoria.nombre}</option>`;
        });
    
    if (valorActual) {
        select.value = valorActual;
    }
}

function toggleSistemaTallas() {
    const checkbox = document.getElementById('producto-requiere-tallas');
    const seccionTallas = document.getElementById('seccion-tallas');
    const inventarioSimple = document.getElementById('inventario-simple');
    
    if (checkbox.checked) {
        seccionTallas.style.display = 'block';
        inventarioSimple.style.display = 'none';
    } else {
        seccionTallas.style.display = 'none';
        inventarioSimple.style.display = 'block';
        // Limpiar campos de tallas
        document.getElementById('tallas-personalizadas').value = '';
        document.getElementById('inventario-tallas').innerHTML = `
            <p style="color: #666; text-align: center; padding: 20px;">
                Define las tallas arriba para configurar el inventario
            </p>
        `;
    }
}

function generarCamposTallasPersonalizadas() {
    const tallasTexto = document.getElementById('tallas-personalizadas').value;
    const inventarioContainer = document.getElementById('inventario-tallas');
    
    if (!tallasTexto.trim()) {
        inventarioContainer.innerHTML = `
            <p style="color: #666; text-align: center; padding: 20px;">
                Define las tallas arriba para configurar el inventario
            </p>
        `;
        return;
    }
    
    const tallas = tallasTexto.split(',').map(t => t.trim()).filter(t => t);
    
    if (tallas.length === 0) {
        mostrarNotificacion('Ingresa al menos una talla v√°lida', 'error');
        return;
    }
    
    inventarioContainer.innerHTML = `
        <h5>üì¶ Inventario por Tallas</h5>
        <div class="form-row">
            ${tallas.map(talla => `
                <div class="form-group">
                    <label>Talla ${talla}</label>
                    <input type="number" id="talla-${talla.replace(/\s+/g, '').toLowerCase()}" 
                           min="0" value="0" data-talla="${talla}">
                </div>
            `).join('')}
        </div>
    `;
}

function abrirGestionCategorias() {
    const modal = document.createElement('div');
    modal.id = 'modal-categorias-productos';
    modal.className = 'modal-recibo';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #9c27b0;">Gestionar Categor√≠as de Productos</h3>
                    <button class="btn btn-primary" onclick="mostrarFormularioNuevaCategoria()">
                        + Nueva Categor√≠a
                    </button>
                </div>

                <!-- Formulario para nueva categor√≠a -->
                <div id="formulario-nueva-categoria" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>Agregar Nueva Categor√≠a</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nombre de la Categor√≠a *</label>
                            <input type="text" id="nueva-categoria-nombre" placeholder="Ej: Bebidas Energ√©ticas">
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n</label>
                            <input type="text" id="nueva-categoria-descripcion" placeholder="Descripci√≥n opcional">
                        </div>
                    </div>
                    <div style="text-align: right; margin-top: 15px;">
                        <button class="btn btn-secondary" onclick="cancelarNuevaCategoria()">Cancelar</button>
                        <button class="btn btn-primary" onclick="guardarNuevaCategoria()" style="margin-left: 10px;">
                            Guardar Categor√≠a
                        </button>
                    </div>
                </div>

                <!-- Lista de categor√≠as existentes -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Descripci√≥n</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-categorias-productos">
                            <!-- Se llena din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <div style="text-align: right; border-top: 2px solid #eee; padding-top: 20px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="cerrarGestionCategorias()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    actualizarTablaCategorias();
}
function mostrarFormularioNuevaCategoria() {
    document.getElementById('formulario-nueva-categoria').style.display = 'block';
    document.getElementById('nueva-categoria-nombre').focus();
}

function cancelarNuevaCategoria() {
    document.getElementById('formulario-nueva-categoria').style.display = 'none';
    document.getElementById('nueva-categoria-nombre').value = '';
    document.getElementById('nueva-categoria-descripcion').value = '';
}

function guardarNuevaCategoria() {
    const nombre = document.getElementById('nueva-categoria-nombre').value.trim();
    
    if (!nombre) {
        mostrarNotificacion('Ingresa el nombre de la categor√≠a', 'error');
        return;
    }
    
    // Verificar que no exista ya una categor√≠a con ese nombre
    const existeCategoria = sistemaADAMS.categorias.find(c => 
        c.nombre.toLowerCase() === nombre.toLowerCase()
    );
    
    if (existeCategoria) {
        mostrarNotificacion('Ya existe una categor√≠a con ese nombre', 'error');
        return;
    }
    
    // Crear nueva categor√≠a
    const nuevoId = Math.max(...sistemaADAMS.categorias.map(c => c.id)) + 1;
    const nuevaCategoria = {
        id: nuevoId,
        nombre: nombre,
        descripcion: document.getElementById('nueva-categoria-descripcion').value.trim(),
        activa: true
    };
    
    sistemaADAMS.categorias.push(nuevaCategoria);
    guardarDatos();
    
    mostrarNotificacion('Categor√≠a agregada exitosamente', 'success');
    cancelarNuevaCategoria();
    actualizarTablaCategorias();
    cargarCategoriasEnSelect();
}

function actualizarTablaCategorias() {
    const tbody = document.getElementById('tabla-categorias-productos');
    
    if (!sistemaADAMS.categorias || sistemaADAMS.categorias.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: #666; padding: 40px;">
                    No hay categor√≠as configuradas
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = sistemaADAMS.categorias.map(categoria => `
        <tr>
            <td><strong>${categoria.nombre}</strong></td>
            <td>${categoria.descripcion || 'Sin descripci√≥n'}</td>
            <td>
                <span class="status ${categoria.activa ? 'status-active' : 'status-inactive'}">
                    ${categoria.activa ? 'Activa' : 'Inactiva'}
                </span>
            </td>
            <td>
                <button class="btn btn-secondary btn-small" onclick="editarCategoria(${categoria.id})" style="margin-right: 5px;">
                    Editar
                </button>
                <button class="btn ${categoria.activa ? 'btn-danger' : 'btn-success'} btn-small" 
                        onclick="toggleCategoria(${categoria.id})" style="margin-right: 5px;">
                    ${categoria.activa ? 'Desactivar' : 'Activar'}
                </button>
                ${categoria.id > 5 ? `<button class="btn btn-danger btn-small" onclick="eliminarCategoria(${categoria.id})">Eliminar</button>` : ''}
            </td>
        </tr>
    `).join('');
}

function editarCategoria(id) {
    const categoria = sistemaADAMS.categorias.find(c => c.id === id);
    if (!categoria) return;
    
    const nuevoNombre = prompt('Editar nombre de la categor√≠a:', categoria.nombre);
    if (nuevoNombre && nuevoNombre.trim() !== categoria.nombre) {
        categoria.nombre = nuevoNombre.trim();
        guardarDatos();
        mostrarNotificacion('Categor√≠a actualizada', 'success');
        actualizarTablaCategorias();
        cargarCategoriasEnSelect();
    }
}

function toggleCategoria(id) {
    const categoria = sistemaADAMS.categorias.find(c => c.id === id);
    if (!categoria) return;
    
    categoria.activa = !categoria.activa;
    guardarDatos();
    
    mostrarNotificacion(categoria.activa ? 'Categor√≠a activada' : 'Categor√≠a desactivada', 'success');
    actualizarTablaCategorias();
    cargarCategoriasEnSelect();
}

function eliminarCategoria(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta categor√≠a? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    sistemaADAMS.categorias = sistemaADAMS.categorias.filter(c => c.id !== id);
    guardarDatos();
    
    mostrarNotificacion('Categor√≠a eliminada', 'success');
    actualizarTablaCategorias();
    cargarCategoriasEnSelect();
}

function cerrarGestionCategorias() {
    const modal = document.getElementById('modal-categorias-productos');
    if (modal) {
        modal.remove();
    }
}

        function guardarProducto(event) {
    event.preventDefault();
    
    // Verificar si estamos editando
    const esEdicion = document.getElementById('form-producto').dataset.editando;
    const productoId = esEdicion ? parseInt(esEdicion) : null;

    // Obtener datos b√°sicos
    const nombre = document.getElementById('producto-nombre').value.trim();
    const precio = parseFloat(document.getElementById('producto-precio').value);
    const categoriaId = parseInt(document.getElementById('producto-categoria').value);
    const descripcion = document.getElementById('producto-descripcion').value.trim();
    const requiereTallas = document.getElementById('producto-requiere-tallas').checked;

    // Validaciones b√°sicas
    if (!nombre || !precio || !categoriaId) {
        mostrarNotificacion('Completa todos los campos obligatorios', 'error');
        return;
    }

    // Obtener nombre de la categor√≠a
    const categoria = sistemaADAMS.categorias.find(c => c.id === categoriaId);
    const nombreCategoria = categoria ? categoria.nombre : 'Sin categor√≠a';

    let inventario = {};
    
    if (requiereTallas) {
        // Producto con tallas
        const camposTallas = document.querySelectorAll('#inventario-tallas input[data-talla]');
        
        if (camposTallas.length === 0) {
            mostrarNotificacion('Define las tallas para este producto', 'error');
            return;
        }
        
        camposTallas.forEach(campo => {
            const talla = campo.getAttribute('data-talla');
            const cantidad = parseInt(campo.value) || 0;
            inventario[talla] = cantidad;
        });
        
        // Guardar las tallas personalizadas
        const tallasPersonalizadas = document.getElementById('tallas-personalizadas').value;
        
    } else {
        // Producto sin tallas
        const cantidad = parseInt(document.getElementById('inventario-cantidad').value) || 0;
        inventario = { 'unica': cantidad };
    }

    if (esEdicion) {
        // EDITAR PRODUCTO EXISTENTE
        const indiceProducto = sistemaADAMS.productos.findIndex(p => p.id === productoId);
        if (indiceProducto === -1) {
            mostrarNotificacion('Error: Producto no encontrado', 'error');
            return;
        }

        // Actualizar producto existente
        const productoExistente = sistemaADAMS.productos[indiceProducto];
        sistemaADAMS.productos[indiceProducto] = {
            ...productoExistente, // Mantener ID y fecha de creaci√≥n
            nombre: nombre,
            precio: precio,
            categoriaId: categoriaId,
            categoriaNombre: nombreCategoria,
            descripcion: descripcion,
            requiereTallas: requiereTallas,
            inventario: inventario,
            tallasPersonalizadas: requiereTallas ? document.getElementById('tallas-personalizadas').value : null,
            fechaModificacion: new Date().toISOString()
        };

        mostrarNotificacion('Producto actualizado exitosamente', 'success');
    } else {
        // CREAR NUEVO PRODUCTO
        const nuevoProducto = {
            id: Date.now(),
            nombre: nombre,
            precio: precio,
            categoriaId: categoriaId,
            categoriaNombre: nombreCategoria,
            descripcion: descripcion,
            requiereTallas: requiereTallas,
            inventario: inventario,
            tallasPersonalizadas: requiereTallas ? document.getElementById('tallas-personalizadas').value : null,
            fechaCreacion: new Date().toISOString()
        };

        sistemaADAMS.productos.push(nuevoProducto);
        mostrarNotificacion('Producto agregado exitosamente', 'success');
    }
    
    guardarDatos();
    ocultarFormularioProducto();
    actualizarTablaProductos();
}




function generarCamposTallasPersonalizadas() {
    const tallasTexto = document.getElementById('tallas-personalizadas').value;
    const inventarioContainer = document.getElementById('inventario-tallas');
    
    if (!tallasTexto.trim()) {
        inventarioContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Define tus tallas personalizadas arriba</p>';
        return;
    }
    
    const tallas = tallasTexto.split(',').map(t => t.trim()).filter(t => t);
    
    if (tallas.length === 0) {
        mostrarNotificacion('Ingresa al menos una talla v√°lida', 'error');
        return;
    }
    
    inventarioContainer.innerHTML = `
        <h5>üì¶ Inventario por Tallas Personalizadas</h5>
        <div class="form-row">
            ${tallas.map(talla => `
                <div class="form-group">
                    <label>Talla ${talla}</label>
                    <input type="number" id="talla-${talla.replace(/\s+/g, '').toLowerCase()}" min="0" value="0" data-talla="${talla}">
                </div>
            `).join('')}
        </div>
    `;
}

        function actualizarTablaProductos() {
    const tbody = document.getElementById('tabla-productos');
    
    if (!sistemaADAMS.productos || sistemaADAMS.productos.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                    No hay productos registrados
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = sistemaADAMS.productos.map(producto => {
        let stockTotal = 0;
        let tallasDisponibles = '';
        
        if (producto.requiereTallas) {
            // Producto con tallas
            stockTotal = Object.values(producto.inventario).reduce((sum, cantidad) => sum + cantidad, 0);
            tallasDisponibles = Object.entries(producto.inventario)
                .filter(([talla, cantidad]) => cantidad > 0)
                .map(([talla, cantidad]) => `${talla}: ${cantidad}`)
                .join(', ');
        } else {
            // Producto sin tallas
            stockTotal = producto.inventario.unica || 0;
            tallasDisponibles = 'No requiere tallas';
        }

        return `
            <tr>
                <td>
                    <strong>${producto.nombre}</strong><br>
                    <small style="color: #666;">${producto.descripcion || 'Sin descripci√≥n'}</small>
                </td>
                <td>
                    <span style="background: #e3f2fd; padding: 4px 8px; border-radius: 12px; font-size: 12px; color: #1976d2;">
                        ${producto.categoriaNombre || 'Sin categor√≠a'}
                    </span>
                </td>
                <td><strong>$${producto.precio.toFixed(2)}</strong></td>
                <td>
                    <span class="status ${stockTotal > 10 ? 'status-active' : stockTotal > 0 ? 'status-warning' : 'status-inactive'}">
                        ${stockTotal} unidades
                    </span>
                </td>
                <td style="font-size: 12px;">${tallasDisponibles || 'Sin stock'}</td>
                <td>
                    <button class="btn btn-secondary btn-small" onclick="editarProducto(${producto.id})" style="margin-right: 5px;">
                        Editar
                    </button>
                    <button class="btn btn-danger btn-small" onclick="eliminarProducto(${producto.id})">
                        Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    setTimeout(() => mostrarAlertasStockBajo(), 100);
}
        function verificarStockBajo() {
    const productosStockBajo = [];
    
    if (!sistemaADAMS.productos) return [];
    
    sistemaADAMS.productos.forEach(producto => {
        const tallasConStockBajo = [];
        
        Object.entries(producto.inventario).forEach(([talla, cantidad]) => {
            if (cantidad <= 2 && cantidad >= 0) {
                tallasConStockBajo.push({
                    talla: talla,
                    cantidad: cantidad
                });
            }
        });
        
        if (tallasConStockBajo.length > 0) {
            productosStockBajo.push({
                producto: producto,
                tallasAfectadas: tallasConStockBajo
            });
        }
    });
    
    return productosStockBajo;
}

function mostrarAlertasStockBajo() {
    const productosStockBajo = verificarStockBajo();
    const alertasContainer = document.getElementById('alertas-container');
    
    if (productosStockBajo.length === 0) {
        alertasContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay alertas pendientes</p>';
        return;
    }
    
    const alertasHTML = productosStockBajo.map(item => {
        const tallasTexto = item.tallasAfectadas.map(t => 
            `${t.talla.toUpperCase()}: ${t.cantidad} ${t.cantidad === 0 ? '(AGOTADO)' : 'unidades'}`
        ).join(', ');
        
        return `
            <div style="background: ${item.tallasAfectadas.some(t => t.cantidad === 0) ? '#ffebee' : '#fff3e0'}; 
                        border-left: 4px solid ${item.tallasAfectadas.some(t => t.cantidad === 0) ? '#f44336' : '#ff9800'}; 
                        padding: 15px; margin: 10px 0; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: ${item.tallasAfectadas.some(t => t.cantidad === 0) ? '#d32f2f' : '#f57c00'};">
                            üì¶ ${item.producto.nombre}
                        </strong><br>
                        <small>Tallas con stock bajo: ${tallasTexto}</small>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="abrirActualizacionStock(${item.producto.id})">
                        üìà Actualizar Stock
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    alertasContainer.innerHTML = `
        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: #1976d2; margin-bottom: 15px;">‚ö†Ô∏è Productos con Stock Bajo</h4>
            ${alertasHTML}
        </div>
    `;
}

       
        function eliminarProducto(id) {
    if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
        sistemaADAMS.productos = sistemaADAMS.productos.filter(p => p.id !== id);
        guardarDatos();
        actualizarTablaProductos();
        mostrarNotificacion('Producto eliminado', 'success');
    }
}
function verificarStockBajo() {
    const productosStockBajo = [];
    
    if (!sistemaADAMS.productos) return [];
    
    sistemaADAMS.productos.forEach(producto => {
        if (producto.requiereTallas) {
            // Productos con tallas
            const tallasConStockBajo = [];
            Object.entries(producto.inventario).forEach(([talla, cantidad]) => {
                if (cantidad <= 2 && cantidad >= 0) {
                    tallasConStockBajo.push({
                        talla: talla,
                        cantidad: cantidad
                    });
                }
            });
            
            if (tallasConStockBajo.length > 0) {
                productosStockBajo.push({
                    producto: producto,
                    tallasAfectadas: tallasConStockBajo
                });
            }
        } else {
            // Productos sin tallas
            const cantidad = producto.inventario.unica || 0;
            if (cantidad <= 2) {
                productosStockBajo.push({
                    producto: producto,
                    tallasAfectadas: [{ talla: 'Producto general', cantidad: cantidad }]
                });
            }
        }
    });
    
    return productosStockBajo;
}
function mostrarAlertasStockBajo() {
    const productosStockBajo = verificarStockBajo();
    const alertasContainer = document.getElementById('alertas-container');
    
    if (productosStockBajo.length === 0) {
        alertasContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No hay alertas pendientes</p>';
        return;
    }
    
    const alertasHTML = productosStockBajo.map(item => {
        const tallasTexto = item.tallasAfectadas.map(t => 
            `${t.talla.toUpperCase()}: ${t.cantidad} ${t.cantidad === 0 ? '(AGOTADO)' : 'unidades'}`
        ).join(', ');
        
        return `
            <div style="background: ${item.tallasAfectadas.some(t => t.cantidad === 0) ? '#ffebee' : '#fff3e0'}; 
                        border-left: 4px solid ${item.tallasAfectadas.some(t => t.cantidad === 0) ? '#f44336' : '#ff9800'}; 
                        padding: 15px; margin: 10px 0; border-radius: 5px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: ${item.tallasAfectadas.some(t => t.cantidad === 0) ? '#d32f2f' : '#f57c00'};">
                            üì¶ ${item.producto.nombre}
                        </strong><br>
                        <small>Tallas con stock bajo: ${tallasTexto}</small>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="abrirActualizacionStock(${item.producto.id})">
                        üìà Actualizar Stock
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    alertasContainer.innerHTML = `
        <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h4 style="color: #1976d2; margin-bottom: 15px;">‚ö†Ô∏è Productos con Stock Bajo</h4>
            ${alertasHTML}
        </div>
    `;
}

function abrirActualizacionStock(productoId) {
    const producto = sistemaADAMS.productos.find(p => p.id === productoId);
    if (!producto) {
        mostrarNotificacion('Producto no encontrado', 'error');
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'modal-actualizacion-stock';
    modal.className = 'modal-recibo';
    
    let tallasHTML = '';
    
    if (producto.requiereTallas) {
        // Producto con tallas
        tallasHTML = Object.entries(producto.inventario).map(([talla, cantidad]) => `
            <div class="form-row" style="align-items: center; margin-bottom: 15px;">
                <div class="form-group" style="margin: 0; flex: 1;">
                    <label>Talla ${talla.toUpperCase()}</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="background: #f0f0f0; padding: 8px 12px; border-radius: 5px; min-width: 60px; text-align: center;">
                            Stock actual: <strong>${cantidad}</strong>
                        </span>
                        <select id="accion-${talla}" style="padding: 8px;">
                            <option value="agregar">+ Agregar</option>
                            <option value="quitar">- Quitar</option>
                            <option value="establecer">üéØ Establecer</option>
                        </select>
                        <input type="number" id="cantidad-${talla}" min="0" value="1" 
                               style="width: 80px; padding: 8px; text-align: center;">
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        // Producto sin tallas
        const cantidad = producto.inventario.unica || 0;
        tallasHTML = `
            <div class="form-row" style="align-items: center; margin-bottom: 15px;">
                <div class="form-group" style="margin: 0; flex: 1;">
                    <label>Inventario General</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="background: #f0f0f0; padding: 8px 12px; border-radius: 5px; min-width: 60px; text-align: center;">
                            Stock actual: <strong>${cantidad}</strong>
                        </span>
                        <select id="accion-unica" style="padding: 8px;">
                            <option value="agregar">+ Agregar</option>
                            <option value="quitar">- Quitar</option>
                            <option value="establecer">üéØ Establecer</option>
                        </select>
                        <input type="number" id="cantidad-unica" min="0" value="1" 
                               style="width: 80px; padding: 8px; text-align: center;">
                    </div>
                </div>
            </div>
        `;
    }
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <h3 style="color: #9c27b0; margin-bottom: 20px;">üìà Actualizar Stock - ${producto.nombre}</h3>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4>Stock Actual:</h4>
                    ${tallasHTML}
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label>Motivo del Ajuste</label>
                    <input type="text" id="motivo-ajuste-stock" placeholder="Ej: Recepci√≥n de mercanc√≠a, Producto da√±ado, Inventario f√≠sico..." 
                           style="width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 5px;">
                </div>
                
                <div style="text-align: right; border-top: 2px solid #eee; padding-top: 20px;">
                    <button class="btn btn-secondary" onclick="cerrarModalStock()" style="margin-right: 10px;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" onclick="aplicarActualizacionStock(${producto.id})">
                        üíæ Aplicar Cambios
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function aplicarActualizacionStock(productoId) {
    const producto = sistemaADAMS.productos.find(p => p.id === productoId);
    if (!producto) return;
    
    const motivo = document.getElementById('motivo-ajuste-stock').value || 'Ajuste manual';
    let cambiosRealizados = 0;
    let resumenCambios = [];
    
    Object.keys(producto.inventario).forEach(talla => {
        const accion = document.getElementById(`accion-${talla}`).value;
        const cantidad = parseInt(document.getElementById(`cantidad-${talla}`).value) || 0;
        const stockAnterior = producto.inventario[talla];
        let nuevoStock = stockAnterior;
        
        switch(accion) {
            case 'agregar':
                nuevoStock = stockAnterior + cantidad;
                break;
            case 'quitar':
                nuevoStock = Math.max(0, stockAnterior - cantidad);
                break;
            case 'establecer':
                nuevoStock = cantidad;
                break;
        }
        
        if (nuevoStock !== stockAnterior) {
            producto.inventario[talla] = nuevoStock;
            cambiosRealizados++;
            resumenCambios.push({
                talla: talla,
                anterior: stockAnterior,
                nuevo: nuevoStock,
                diferencia: nuevoStock - stockAnterior
            });
        }
    });
    
    if (cambiosRealizados === 0) {
        mostrarNotificacion('No se realizaron cambios en el stock', 'error');
        return;
    }
    
    if (!sistemaADAMS.historialStock) {
        sistemaADAMS.historialStock = [];
    }
    
    sistemaADAMS.historialStock.push({
        id: Date.now(),
        productoId: productoId,
        productoNombre: producto.nombre,
        fecha: new Date().toISOString(),
        motivo: motivo,
        cambios: resumenCambios,
        usuario: 'Sistema'
    });
    
    guardarDatos();
    actualizarTablaProductos();
    mostrarAlertasStockBajo();
    
    const resumenTexto = resumenCambios.map(c => 
        `${c.talla.toUpperCase()}: ${c.anterior} ‚Üí ${c.nuevo} (${c.diferencia > 0 ? '+' : ''}${c.diferencia})`
    ).join(', ');
    
    mostrarNotificacion(`Stock actualizado: ${resumenTexto}`, 'success');
    cerrarModalStock();
}

function cerrarModalStock() {
    const modal = document.getElementById('modal-actualizacion-stock');
    if (modal) {
        modal.remove();
    }
}

function obtenerInventarioTallas() {
    const inventario = {};
    const requiereTallas = document.getElementById('producto-requiere-tallas').checked;
    
    if (requiereTallas) {
        const camposTallas = document.querySelectorAll('#inventario-tallas input[data-talla]');
        camposTallas.forEach(campo => {
            const talla = campo.getAttribute('data-talla');
            const cantidad = parseInt(campo.value) || 0;
            inventario[talla] = cantidad;
        });
    } else {
        const cantidad = parseInt(document.getElementById('inventario-cantidad').value) || 0;
        inventario['unica'] = cantidad;
    }
    
    return inventario;
}

function cargarProductosEnPago() {
    // Esta funci√≥n se usa cuando el usuario selecciona "producto" como tipo de pago
}

        function cargarProductosEnPago() {
            // Esta funci√≥n se usa cuando el usuario selecciona "producto" como tipo de pago
        }
        // FUNCIONES PARA M√öLTIPLES CONCEPTOS
        let carritoConceptos = [];
        let conceptoTemporal = {};

function mostrarCamposConcepto() {
    const concepto = document.getElementById('concepto-temporal').value;
    const campos = document.getElementById('campos-dinamicos');
    const titulo = document.getElementById('titulo-concepto');
    const seccion = document.getElementById('campos-concepto-temporal');
    
    if (!concepto) {
        seccion.style.display = 'none';
        return;
    }

    conceptoTemporal = { tipo: concepto };
    titulo.textContent = `Agregar: ${obtenerNombreConcepto(concepto)}`;

    switch(concepto) {
        case 'colegiatura':
            // Verificar que hay un estudiante seleccionado
            const estudianteSeleccionado = document.getElementById('pago-estudiante').value;
            if (!estudianteSeleccionado) {
                mostrarNotificacion('Selecciona un estudiante primero', 'error');
                document.getElementById('concepto-temporal').value = '';
                return;
            }

            const estudianteData = sistemaADAMS.estudiantes.find(e => e.id == estudianteSeleccionado);
            const montoBase = estudianteData ? estudianteData.colegiatura : 900;

            campos.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Mes de la Colegiatura *</label>
                        <select id="mes-colegiatura" required>
    <option value="">Seleccionar mes...</option>
    <option value="1" ${new Date().getMonth() + 1 === 1 ? 'selected' : ''}>Enero</option>
    <option value="2" ${new Date().getMonth() + 1 === 2 ? 'selected' : ''}>Febrero</option>
    <option value="3" ${new Date().getMonth() + 1 === 3 ? 'selected' : ''}>Marzo</option>
    <option value="4" ${new Date().getMonth() + 1 === 4 ? 'selected' : ''}>Abril</option>
    <option value="5" ${new Date().getMonth() + 1 === 5 ? 'selected' : ''}>Mayo</option>
    <option value="6" ${new Date().getMonth() + 1 === 6 ? 'selected' : ''}>Junio</option>
    <option value="7" ${new Date().getMonth() + 1 === 7 ? 'selected' : ''}>Julio</option>
    <option value="8" ${new Date().getMonth() + 1 === 8 ? 'selected' : ''}>Agosto</option>
    <option value="9" ${new Date().getMonth() + 1 === 9 ? 'selected' : ''}>Septiembre</option>
    <option value="10" ${new Date().getMonth() + 1 === 10 ? 'selected' : ''}>Octubre</option>
    <option value="11" ${new Date().getMonth() + 1 === 11 ? 'selected' : ''}>Noviembre</option>
    <option value="12" ${new Date().getMonth() + 1 === 12 ? 'selected' : ''}>Diciembre</option>
</select>
                    </div>
                    <div class="form-group">
                        <label>A√±o de la Colegiatura *</label>
                        <select id="a√±o-colegiatura" required>
    <option value="${new Date().getFullYear()}" selected>${new Date().getFullYear()}</option>
    <option value="${new Date().getFullYear() - 1}">${new Date().getFullYear() - 1}</option>
</select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Monto de Colegiatura</label>
                        <input type="number" id="monto-colegiatura" value="${montoBase}" 
                               step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Total del Concepto</label>
                        <input type="number" id="total-concepto" value="${montoBase}" 
                               step="0.01" min="0" required style="font-weight: bold;">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Aplicar descuento por beca</label>
                        <input type="checkbox" id="aplicar-beca" checked>
                        <small>El descuento se calcular√° autom√°ticamente seg√∫n el perfil del estudiante</small>
                    </div>
                </div>
            `;
            break;

        case 'ajuste-colegiatura':
            const estudianteSeleccionado2 = document.getElementById('pago-estudiante').value;
            if (!estudianteSeleccionado2) {
                mostrarNotificacion('Selecciona un estudiante primero', 'error');
                document.getElementById('concepto-temporal').value = '';
                return;
            }

            campos.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Mes del Ajuste *</label>
                        <select id="mes-ajuste" required>
    <option value="">Seleccionar mes...</option>
    <option value="1" ${new Date().getMonth() + 1 === 1 ? 'selected' : ''}>Enero</option>
    <option value="2" ${new Date().getMonth() + 1 === 2 ? 'selected' : ''}>Febrero</option>
    <option value="3" ${new Date().getMonth() + 1 === 3 ? 'selected' : ''}>Marzo</option>
    <option value="4" ${new Date().getMonth() + 1 === 4 ? 'selected' : ''}>Abril</option>
    <option value="5" ${new Date().getMonth() + 1 === 5 ? 'selected' : ''}>Mayo</option>
    <option value="6" ${new Date().getMonth() + 1 === 6 ? 'selected' : ''}>Junio</option>
    <option value="7" ${new Date().getMonth() + 1 === 7 ? 'selected' : ''}>Julio</option>
    <option value="8" ${new Date().getMonth() + 1 === 8 ? 'selected' : ''}>Agosto</option>
    <option value="9" ${new Date().getMonth() + 1 === 9 ? 'selected' : ''}>Septiembre</option>
    <option value="10" ${new Date().getMonth() + 1 === 10 ? 'selected' : ''}>Octubre</option>
    <option value="11" ${new Date().getMonth() + 1 === 11 ? 'selected' : ''}>Noviembre</option>
    <option value="12" ${new Date().getMonth() + 1 === 12 ? 'selected' : ''}>Diciembre</option>
</select>
                    </div>
                    <div class="form-group">
                        <label>A√±o del Ajuste *</label>
                        <select id="a√±o-ajuste" required>
    <option value="${new Date().getFullYear()}" selected>${new Date().getFullYear()}</option>
    <option value="${new Date().getFullYear() - 1}">${new Date().getFullYear() - 1}</option>
</select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Monto del Ajuste *</label>
                        <input type="number" id="monto-ajuste-concepto" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Motivo del Ajuste</label>
                        <input type="text" id="motivo-ajuste-concepto" placeholder="Ej: Inscripci√≥n a mitad de mes">
                    </div>
                </div>
                <div class="form-group">
                    <label>Total del Concepto</label>
                    <input type="number" id="total-concepto" step="0.01" min="0" readonly style="background: #f0f0f0;">
                </div>
            `;
            break;

        case 'inscripcion':
        case 'reinscripcion':
            campos.innerHTML = `
                <div class="form-group">
                    <label>Monto *</label>
                    <input type="number" id="monto-inscripcion" value="500" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="observaciones-concepto" rows="3"></textarea>
                </div>
            `;
            break;

        default:
            campos.innerHTML = `
                <div class="form-group">
                    <label>Monto *</label>
                    <input type="number" id="monto-personalizado" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea id="observaciones-concepto" rows="3"></textarea>
                </div>
            `;
            break;
    }
    
    seccion.style.display = 'block';
}

        function obtenerNombreConcepto(concepto) {
    // Primero buscar en conceptos configurados
    const conceptoConfig = sistemaADAMS.conceptosPago.find(c => c.tipo === concepto);
    if (conceptoConfig) {
        return conceptoConfig.nombre;
    }
    
    // Fallback para conceptos antiguos
    const nombres = {
        'colegiatura': 'Colegiatura Mensual',
        'ajuste-colegiatura': 'Ajuste de Colegiatura',
        'inscripcion': 'Inscripci√≥n',
        'reinscripcion': 'Reinscripci√≥n',
        'producto': 'Producto/Uniforme'
    };
    return nombres[concepto] || concepto;
}

        function mostrarCamposColegiatura(campos) {
    const estudianteId = parseInt(document.getElementById('pago-estudiante').value);
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    
    if (!estudiante) {
        campos.innerHTML = '<p style="color: red;">Selecciona un estudiante primero</p>';
        return;
    }

    const ultimoPago = obtenerUltimoPago(estudianteId);
    const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
    let recargo = 0;
    let detalleRecargo = '';
    
    if (diasSinPagar > 15) {
        recargo = estudiante.colegiatura * 0.15;
        detalleRecargo = `Recargo del 15% por ${diasSinPagar} d√≠as de atraso`;
    } else if (diasSinPagar > 10) {
        recargo = estudiante.colegiatura * 0.15;
        detalleRecargo = `Recargo del 15% por ${diasSinPagar} d√≠as de atraso`;
    } else if (diasSinPagar > 5) {
        recargo = estudiante.colegiatura * 0.10;
        detalleRecargo = `Recargo del 10% por ${diasSinPagar} d√≠as de atraso`;
    }

    const descuentoBeca = (estudiante.colegiatura * estudiante.porcentajeBeca) / 100;
    const montoFinal = estudiante.colegiatura - descuentoBeca + recargo;

    // NUEVO: Generar opciones de meses
    const opcionesMeses = generarOpcionesMeses();
    
    campos.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label>Mes de la Colegiatura *</label>
                <select id="mes-colegiatura" onchange="actualizarDetallesMesColegiatura()" style="border: 2px solid #9c27b0;">
                    ${opcionesMeses}
                </select>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Selecciona el mes al que corresponde esta colegiatura
                </small>
            </div>
            <div class="form-group">
                <label>A√±o</label>
                <select id="a√±o-colegiatura" onchange="actualizarDetallesMesColegiatura()">
                    <option value="${new Date().getFullYear()}">${new Date().getFullYear()}</option>
                    <option value="${new Date().getFullYear() + 1}">${new Date().getFullYear() + 1}</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Monto Base</label>
                <input type="number" value="${estudiante.colegiatura}" readonly style="background: #f8f9fa;">
            </div>
            <div class="form-group">
                <label>Descuento Beca (${estudiante.porcentajeBeca}%)</label>
                <input type="number" value="${descuentoBeca.toFixed(2)}" readonly style="background: #f8f9fa;">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Recargo</label>
                <input type="number" id="recargo-concepto" value="${recargo.toFixed(2)}" step="0.01" min="0" onchange="actualizarTotalConcepto()">
                ${detalleRecargo ? `<small style="color: #f57c00;">${detalleRecargo}</small>` : ''}
            </div>
            <div class="form-group">
                <label>Total</label>
                <input type="number" id="total-concepto" value="${montoFinal.toFixed(2)}" step="0.01" min="0" onchange="actualizarTotalColegiaturaManual()">
            </div>
        </div>
        <div class="form-group">
            <label>Observaciones</label>
            <input type="text" id="observaciones-concepto" placeholder="Observaciones del pago...">
        </div>
        <div id="info-mes-seleccionado" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #2196f3;">
            <h5 style="color: #1976d2; margin-bottom: 8px;">üìÖ Informaci√≥n del Mes Seleccionado</h5>
            <div id="detalle-mes-seleccionado">Selecciona un mes para ver los detalles</div>
        </div>
    `;

    conceptoTemporal = {
        tipo: 'colegiatura',
        montoBase: estudiante.colegiatura,
        descuentoBeca: descuentoBeca,
        recargo: recargo,
        total: montoFinal,
        detalleRecargo: detalleRecargo,
        mesAplicacion: null, // NUEVO campo
        a√±oAplicacion: null  // NUEVO campo
    };
    
    // Establecer mes actual por defecto
    setTimeout(() => {
        const mesActual = new Date().getMonth() + 1;
        document.getElementById('mes-colegiatura').value = mesActual;
        actualizarDetallesMesColegiatura();
    }, 100);
}
function generarOpcionesMeses() {
    const meses = [
        'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    
    const hoy = new Date();
    const mesActual = hoy.getMonth() + 1; // getMonth() devuelve 0-11
    
    let opciones = '<option value="">Seleccionar mes...</option>';
    
    meses.forEach((nombreMes, index) => {
        const numeroMes = index + 1;
        const esActual = numeroMes === mesActual;
        const claseEstilo = esActual ? 'style="background: #e8f5e8; font-weight: bold;"' : '';
        
        opciones += `<option value="${numeroMes}" ${claseEstilo}>
            ${nombreMes}${esActual ? ' (Actual)' : ''}
        </option>`;
    });
    
    return opciones;
}
function actualizarDetallesMesColegiatura() {
    const mesSeleccionado = parseInt(document.getElementById('mes-colegiatura').value);
    const a√±oSeleccionado = parseInt(document.getElementById('a√±o-colegiatura').value);
    const detalleDiv = document.getElementById('detalle-mes-seleccionado');
    
    if (!mesSeleccionado) {
        detalleDiv.innerHTML = 'Selecciona un mes para ver los detalles';
        return;
    }
    
    const estudianteId = parseInt(document.getElementById('pago-estudiante').value);
    
    // Actualizar el objeto temporal
    if (conceptoTemporal) {
        conceptoTemporal.mesAplicacion = mesSeleccionado;
        conceptoTemporal.a√±oAplicacion = a√±oSeleccionado;
    }
    
    // Verificar si ya hay un pago para este mes
    const yaExistePago = verificarPagoExistenteMes(estudianteId, mesSeleccionado, a√±oSeleccionado);
    
    // Calcular informaci√≥n del mes
    const hoy = new Date();
    const fechaSeleccionada = new Date(a√±oSeleccionado, mesSeleccionado - 1, 1);
    const esFuturo = fechaSeleccionada > hoy;
    const esPasado = fechaSeleccionada < new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    const nombreMes = fechaSeleccionada.toLocaleDateString('es-ES', { 
        month: 'long', 
        year: 'numeric' 
    });
    
    let estadoMes = '';
    let colorEstado = '';
    
    if (yaExistePago) {
        estadoMes = '‚úÖ Ya pagado';
        colorEstado = '#4caf50';
    } else if (esFuturo) {
        estadoMes = 'üìÖ Pago adelantado';
        colorEstado = '#2196f3';
    } else if (esPasado) {
        estadoMes = '‚ö†Ô∏è Pago atrasado';
        colorEstado = '#ff9800';
    } else {
        estadoMes = 'üóìÔ∏è Mes actual';
        colorEstado = '#9c27b0';
    }
    
    detalleDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${nombreMes}</strong>
                <div style="color: ${colorEstado}; font-weight: bold; margin-top: 5px;">
                    ${estadoMes}
                </div>
            </div>
            <div style="text-align: right; color: #666; font-size: 12px;">
                ${esFuturo ? 'Este pago se aplicar√° al mes futuro seleccionado' : 
                  esPasado ? 'Este pago cubrir√° el mes atrasado seleccionado' : 
                  'Pago del mes en curso'}
            </div>
        </div>
        ${yaExistePago ? `
            <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px; border-left: 4px solid #ffc107;">
                <small style="color: #856404;">
                    <strong>‚ö†Ô∏è Advertencia:</strong> Ya existe un pago registrado para este mes. 
                    Al continuar estar√°s registrando un pago adicional.
                </small>
            </div>
        ` : ''}
    `;
}
function verificarPagoExistenteMes(estudianteId, mes, a√±o) {
    if (!sistemaADAMS.pagos) return false;
    
    return sistemaADAMS.pagos.some(pago => {
        // Verificar que es del mismo estudiante
        if (pago.estudianteId !== estudianteId) return false;
        
        // Verificar si el pago tiene informaci√≥n de mes de aplicaci√≥n
        if (pago.mesAplicacion && pago.a√±oAplicacion) {
            return pago.mesAplicacion === mes && pago.a√±oAplicacion === a√±o;
        }
        
        // Para pagos antiguos sin mes espec√≠fico, usar la fecha del pago
        if (pago.concepto === 'colegiatura' || pago.concepto === 'ajuste-colegiatura') {
            const fechaPago = new Date(pago.fecha);
            return fechaPago.getMonth() + 1 === mes && fechaPago.getFullYear() === a√±o;
        }
        
        return false;
    });
}

        function mostrarCamposAjuste(campos) {
    const estudianteId = parseInt(document.getElementById('pago-estudiante').value);
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    
    if (!estudiante) {
        campos.innerHTML = '<p style="color: red;">Selecciona un estudiante primero</p>';
        return;
    }

    // NUEVO: Generar opciones de meses
    const opcionesMeses = generarOpcionesMeses();

    campos.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label>Mes del Ajuste *</label>
                <select id="mes-ajuste" onchange="actualizarDetallesMesAjuste()" style="border: 2px solid #ffc107;">
                    ${opcionesMeses}
                </select>
                <small style="color: #666; display: block; margin-top: 5px;">
                    Selecciona el mes al que corresponde este ajuste
                </small>
            </div>
            <div class="form-group">
                <label>A√±o</label>
                <select id="a√±o-ajuste" onchange="actualizarDetallesMesAjuste()">
                    <option value="${new Date().getFullYear()}">${new Date().getFullYear()}</option>
                    <option value="${new Date().getFullYear() + 1}">${new Date().getFullYear() + 1}</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Colegiatura Normal</label>
                <input type="number" value="${estudiante.colegiatura}" readonly style="background: #f8f9fa;">
            </div>
            <div class="form-group">
                <label>Monto del Ajuste *</label>
                <input type="number" id="monto-ajuste-concepto" step="0.01" min="0" max="${estudiante.colegiatura}" 
                       placeholder="Ej. 450" onchange="actualizarTotalConcepto()">
            </div>
        </div>
        <div class="form-group">
            <label>Motivo del Ajuste</label>
            <input type="text" id="motivo-ajuste-concepto" placeholder="Ej. Inscripci√≥n d√≠a 15 del mes">
        </div>
        <div id="info-mes-ajuste" style="background: #fff3e0; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ff9800;">
            <h5 style="color: #f57c00; margin-bottom: 8px;">üìÖ Informaci√≥n del Mes del Ajuste</h5>
            <div id="detalle-mes-ajuste">Selecciona un mes para ver los detalles</div>
        </div>
    `;

    conceptoTemporal = {
        tipo: 'ajuste-colegiatura',
        montoNormal: estudiante.colegiatura,
        total: 0,
        mesAplicacion: null, // NUEVO campo
        a√±oAplicacion: null  // NUEVO campo
    };
    
    // Establecer mes actual por defecto
    setTimeout(() => {
        const mesActual = new Date().getMonth() + 1;
        document.getElementById('mes-ajuste').value = mesActual;
        actualizarDetallesMesAjuste();
    }, 100);
}
function actualizarDetallesMesAjuste() {
    const mesSeleccionado = parseInt(document.getElementById('mes-ajuste').value);
    const a√±oSeleccionado = parseInt(document.getElementById('a√±o-ajuste').value);
    const detalleDiv = document.getElementById('detalle-mes-ajuste');
    
    if (!mesSeleccionado) {
        detalleDiv.innerHTML = 'Selecciona un mes para ver los detalles';
        return;
    }
    
    // Actualizar el objeto temporal
    if (conceptoTemporal) {
        conceptoTemporal.mesAplicacion = mesSeleccionado;
        conceptoTemporal.a√±oAplicacion = a√±oSeleccionado;
    }
    
    const estudianteId = parseInt(document.getElementById('pago-estudiante').value);
    const yaExistePago = verificarPagoExistenteMes(estudianteId, mesSeleccionado, a√±oSeleccionado);
    
    const hoy = new Date();
    const fechaSeleccionada = new Date(a√±oSeleccionado, mesSeleccionado - 1, 1);
    const esFuturo = fechaSeleccionada > hoy;
    const esPasado = fechaSeleccionada < new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    const nombreMes = fechaSeleccionada.toLocaleDateString('es-ES', { 
        month: 'long', 
        year: 'numeric' 
    });
    
    let estadoMes = '';
    let colorEstado = '';
    
    if (yaExistePago) {
        estadoMes = '‚úÖ Ya tiene pago registrado';
        colorEstado = '#4caf50';
    } else if (esFuturo) {
        estadoMes = 'üìÖ Ajuste para mes futuro';
        colorEstado = '#2196f3';
    } else if (esPasado) {
        estadoMes = '‚ö†Ô∏è Ajuste para mes pasado';
        colorEstado = '#ff9800';
    } else {
        estadoMes = 'üóìÔ∏è Ajuste mes actual';
        colorEstado = '#f57c00';
    }
    
    detalleDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>Ajuste para: ${nombreMes}</strong>
                <div style="color: ${colorEstado}; font-weight: bold; margin-top: 5px;">
                    ${estadoMes}
                </div>
            </div>
            <div style="text-align: right; color: #666; font-size: 12px;">
                ${esFuturo ? 'Ajuste que se aplicar√° al mes futuro' : 
                  esPasado ? 'Ajuste para regularizar mes pasado' : 
                  'Ajuste del mes en curso'}
            </div>
        </div>
        <div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-top: 10px;">
            <small style="color: #2e7d32;">
                üí° <strong>Tip:</strong> Los ajustes son √∫tiles para estudiantes que se inscriben a mitad de mes, 
                o para correcciones de pagos anteriores.
            </small>
        </div>
    `;
}

        function mostrarCamposInscripcion(campos, tipo) {
    campos.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label>Monto</label>
                <input type="number" id="monto-inscripcion" value="500" step="0.01" min="0" onchange="actualizarMontoInscripcion()">
            </div>
            <div class="form-group">
                <label>Observaciones</label>
                <input type="text" id="observaciones-concepto" placeholder="Observaciones...">
            </div>
        </div>
    `;

    conceptoTemporal = {
        tipo: tipo,
        total: 500
    };
}

        function mostrarCamposProducto(campos) {
            if (!sistemaADAMS.productos || sistemaADAMS.productos.length === 0) {
                campos.innerHTML = '<p style="color: red;">No hay productos disponibles</p>';
                return;
            }

            campos.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>Producto *</label>
                        <select id="producto-seleccionado" onchange="cargarDatosProducto()">
                            <option value="">Seleccionar producto...</option>
                            ${sistemaADAMS.productos.map(p => 
                                `<option value="${p.id}">${p.nombre} - $${p.precio}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Talla</label>
                        <select id="talla-producto" disabled>
                            <option value="">Seleccionar talla...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Cantidad</label>
                        <input type="number" id="cantidad-producto" value="1" min="1" disabled onchange="actualizarTotalProducto()">
                    </div>
                    <div class="form-group">
                        <label>Total</label>
                        <input type="number" id="total-producto" readonly style="background: #f8f9fa;">
                    </div>
                </div>
            `;

            conceptoTemporal = {
                tipo: 'producto',
                total: 0
            };
        }

        function cargarDatosProducto() {
            const productoId = parseInt(document.getElementById('producto-seleccionado').value);
            const producto = sistemaADAMS.productos.find(p => p.id === productoId);
            
            if (!producto) return;

            // Cargar tallas disponibles
            const selectTalla = document.getElementById('talla-producto');
            selectTalla.innerHTML = '<option value="">Seleccionar talla...</option>';
            
            Object.entries(producto.inventario).forEach(([talla, cantidad]) => {
                if (cantidad > 0) {
                    selectTalla.innerHTML += `<option value="${talla}">${talla.toUpperCase()} (${cantidad} disponibles)</option>`;
                }
            });
            
            selectTalla.disabled = false;
            document.getElementById('cantidad-producto').disabled = false;
            
            conceptoTemporal.producto = producto;
            actualizarTotalProducto();
        }

        function actualizarTotalProducto() {
            const cantidad = parseInt(document.getElementById('cantidad-producto').value) || 0;
            if (conceptoTemporal.producto) {
                const total = conceptoTemporal.producto.precio * cantidad;
                document.getElementById('total-producto').value = total.toFixed(2);
                conceptoTemporal.total = total;
            }
        }

       function actualizarTotalConcepto() {
    if (conceptoTemporal.tipo === 'ajuste-colegiatura') {
        const monto = parseFloat(document.getElementById('monto-ajuste-concepto').value) || 0;
        conceptoTemporal.total = monto;
    } else if (conceptoTemporal.tipo === 'colegiatura') {
        const recargo = parseFloat(document.getElementById('recargo-concepto').value) || 0;
        const total = conceptoTemporal.montoBase - conceptoTemporal.descuentoBeca + recargo;
        document.getElementById('total-concepto').value = total.toFixed(2);
        conceptoTemporal.total = total;
        conceptoTemporal.recargo = recargo;
    }
}

        function agregarConceptoAlCarrito() {
            // Validar campos requeridos seg√∫n el tipo
            if (!validarConceptoTemporal()) return;

            // Agregar al carrito
            carritoConceptos.push({...conceptoTemporal});
            
            // Actualizar visualizaci√≥n del carrito
            actualizarCarritoVisual();
            
            // Limpiar campos temporales
            cancelarConcepto();
            
            mostrarNotificacion('Concepto agregado al carrito', 'success');
        }

function validarConceptoTemporal() {
    // VALIDACI√ìN PARA PRODUCTOS
    if (conceptoTemporal.tipo === 'producto') {
        const productoId = document.getElementById('producto-seleccionado').value;
        const talla = document.getElementById('talla-producto').value;
        const cantidad = parseInt(document.getElementById('cantidad-producto').value) || 0;
        
        if (!productoId || !talla || cantidad <= 0) {
            mostrarNotificacion('Completa todos los campos del producto', 'error');
            return false;
        }
        
        conceptoTemporal.talla = talla;
        conceptoTemporal.cantidad = cantidad;
        conceptoTemporal.nombre = conceptoTemporal.producto.nombre;
    } 
    
    // VALIDACI√ìN PARA COLEGIATURA (CON MES Y A√ëO) - VERSI√ìN ACTUALIZADA
else if (conceptoTemporal.tipo === 'colegiatura') {
    // Verificar que se seleccion√≥ mes y a√±o
    const mesSeleccionado = document.getElementById('mes-colegiatura')?.value;
    const a√±oSeleccionado = document.getElementById('a√±o-colegiatura')?.value;
    const montoTotal = parseFloat(document.getElementById('total-concepto')?.value) || 0;
    
    if (!mesSeleccionado || !a√±oSeleccionado) {
        mostrarNotificacion('Selecciona el mes y a√±o de la colegiatura', 'error');
        return false;
    }
    
    if (montoTotal <= 0) {
        mostrarNotificacion('El monto debe ser mayor a 0', 'error');
        return false;
    }
    
    // Validar que sean n√∫meros v√°lidos
    const mes = parseInt(mesSeleccionado);
    const a√±o = parseInt(a√±oSeleccionado);
    
    if (mes < 1 || mes > 12) {
        mostrarNotificacion('Mes inv√°lido', 'error');
        return false;
    }
    
    if (a√±o < 2020 || a√±o > 2030) {
        mostrarNotificacion('A√±o inv√°lido', 'error');
        return false;
    }
    
    // Agregar informaci√≥n del mes al concepto temporal
    conceptoTemporal.mesAplicacion = mes;
    conceptoTemporal.a√±oAplicacion = a√±o;
    conceptoTemporal.descripcionMes = new Date(a√±o, mes - 1, 1).toLocaleDateString('es-ES', { 
        month: 'long', 
        year: 'numeric' 
    });
    conceptoTemporal.total = montoTotal;
}
    
    // VALIDACI√ìN PARA AJUSTE DE COLEGIATURA (CON MES Y A√ëO)
    else if (conceptoTemporal.tipo === 'ajuste-colegiatura') {
        // NUEVA VALIDACI√ìN: Verificar que se seleccion√≥ mes y a√±o
        const mesSeleccionado = document.getElementById('mes-ajuste')?.value;
        const a√±oSeleccionado = document.getElementById('a√±o-ajuste')?.value;
        
        if (!mesSeleccionado || !a√±oSeleccionado) {
            mostrarNotificacion('Selecciona el mes y a√±o del ajuste', 'error');
            return false;
        }
        
        // Validar que sean n√∫meros v√°lidos
        const mes = parseInt(mesSeleccionado);
        const a√±o = parseInt(a√±oSeleccionado);
        
        if (mes < 1 || mes > 12) {
            mostrarNotificacion('Mes inv√°lido', 'error');
            return false;
        }
        
        if (a√±o < 2020 || a√±o > 2030) {
            mostrarNotificacion('A√±o inv√°lido', 'error');
            return false;
        }
        
        // Validar monto del ajuste
        const monto = parseFloat(document.getElementById('monto-ajuste-concepto').value) || 0;
        if (monto <= 0) {
            mostrarNotificacion('Ingresa un monto v√°lido para el ajuste', 'error');
            return false;
        }
        
        // Agregar informaci√≥n del mes y monto al concepto temporal
        conceptoTemporal.mesAplicacion = mes;
        conceptoTemporal.a√±oAplicacion = a√±o;
        conceptoTemporal.descripcionMes = new Date(a√±o, mes - 1, 1).toLocaleDateString('es-ES', { 
            month: 'long', 
            year: 'numeric' 
        });
        conceptoTemporal.motivo = document.getElementById('motivo-ajuste-concepto').value;
        conceptoTemporal.total = monto;
    } 
    
    // VALIDACI√ìN PARA INSCRIPCI√ìN Y REINSCRIPCI√ìN
    else if (conceptoTemporal.tipo === 'inscripcion' || conceptoTemporal.tipo === 'reinscripcion') {
        // Tomar el monto editado manualmente
        const campoMonto = document.getElementById('monto-inscripcion');
        if (campoMonto) {
            const monto = parseFloat(campoMonto.value) || 0;
            conceptoTemporal.total = monto;
        }
    } 
    
    // VALIDACI√ìN PARA CONCEPTOS PERSONALIZADOS
    else {
        // Validaci√≥n para conceptos personalizados
        const campoMonto = document.getElementById('monto-personalizado');
        if (campoMonto) {
            const monto = parseFloat(campoMonto.value) || 0;
            if (monto < 0) {
                mostrarNotificacion('El monto no puede ser negativo', 'error');
                return false;
            }
            conceptoTemporal.total = monto;
        }
    }

    // AGREGAR OBSERVACIONES SI LAS HAY (PARA TODOS LOS CONCEPTOS)
    const observaciones = document.getElementById('observaciones-concepto');
    if (observaciones) {
        conceptoTemporal.observaciones = observaciones.value;
    }

    // VALIDACI√ìN FINAL: Verificar que el total sea mayor a 0
    if (!conceptoTemporal.total || conceptoTemporal.total <= 0) {
        mostrarNotificacion('El total del concepto debe ser mayor a 0', 'error');
        return false;
    }

    return true;
}
        function actualizarCarritoVisual() {
    const carrito = document.getElementById('carrito-conceptos');
    const lista = document.getElementById('lista-conceptos');
    
    if (carritoConceptos.length === 0) {
        carrito.style.display = 'none';
        document.getElementById('seccion-metodo-pago').style.display = 'none';
        return;
    }

    lista.innerHTML = carritoConceptos.map((concepto, index) => {
        let descripcionDetallada = obtenerNombreConcepto(concepto.tipo);
        
        // NUEVO: Agregar informaci√≥n del mes para colegiaturas y ajustes
        if (concepto.mesAplicacion && concepto.a√±oAplicacion) {
            const nombreMes = new Date(concepto.a√±oAplicacion, concepto.mesAplicacion - 1, 1)
                .toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            descripcionDetallada += ` - ${nombreMes}`;
        }
        
        // Para productos
        if (concepto.tipo === 'producto') {
            descripcionDetallada += `<br><small>Talla: ${concepto.talla.toUpperCase()}, Cantidad: ${concepto.cantidad}</small>`;
        }
        
        // Para ajustes con motivo
        if (concepto.tipo === 'ajuste-colegiatura' && concepto.motivo) {
            descripcionDetallada += `<br><small>Motivo: ${concepto.motivo}</small>`;
        }
        
        // Observaciones generales
        if (concepto.observaciones) {
            descripcionDetallada += `<br><small style="color: #666;">${concepto.observaciones}</small>`;
        }
        
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                <div>
                    <strong>${descripcionDetallada}</strong>
                </div>
                <div style="text-align: right;">
                    <strong>$${(concepto.total || 0).toFixed(2)}</strong><br>
                    <button class="btn btn-danger btn-small" onclick="eliminarDelCarrito(${index})">
                        üóëÔ∏è Quitar
                    </button>
                </div>
            </div>
        `;
    }).join('');

    // Calcular total
    const total = carritoConceptos.reduce((sum, concepto) => sum + (concepto.total || 0), 0);
    document.getElementById('total-carrito').textContent = (total || 0).toFixed(2);
    document.getElementById('monto-recibido').value = (total || 0).toFixed(2);

    carrito.style.display = 'block';
    document.getElementById('seccion-metodo-pago').style.display = 'block';
    calcularCambio();
}

        function eliminarDelCarrito(index) {
            carritoConceptos.splice(index, 1);
            actualizarCarritoVisual();
            mostrarNotificacion('Concepto eliminado del carrito', 'success');
        }

        function cancelarConcepto() {
            document.getElementById('campos-concepto-temporal').style.display = 'none';
            document.getElementById('concepto-temporal').value = '';
            conceptoTemporal = {};
        }
        // FUNCIONES PARA EDITAR Y ELIMINAR PAGOS
        function editarPago(pagoId) {
            const pago = sistemaADAMS.pagos.find(p => p.id == pagoId);
            if (!pago) {
                mostrarNotificacion('Pago no encontrado', 'error');
                return;
            }

// Cargar datos del pago en el formulario
document.getElementById('pago-estudiante').value = pago.estudianteId;
cargarDatosEstudiante();

// ESPERAR a que se cargue el estudiante, luego bloquear
setTimeout(() => {
    const selectEstudiante = document.getElementById('pago-estudiante');
    const estudianteSeleccionado = sistemaADAMS.estudiantes.find(e => e.id == pago.estudianteId);
    
    if (estudianteSeleccionado) {
        // Asegurar que el estudiante est√© seleccionado correctamente
        selectEstudiante.value = pago.estudianteId;
        
        // BLOQUEAR la selecci√≥n pero mantener el nombre visible
        selectEstudiante.disabled = true;
        selectEstudiante.style.backgroundColor = '#f8f9fa';
        selectEstudiante.style.color = '#6c757d';
        selectEstudiante.style.border = '2px solid #dc3545';
        
        // Cambiar el label para mostrar el nombre
        const label = selectEstudiante.parentElement.querySelector('label');
        if (label) {
            label.innerHTML = `Estudiante (BLOQUEADO): <strong>${estudianteSeleccionado.nombre}</strong>`;
            label.style.color = '#dc3545';
        }
        
        // Agregar mensaje de bloqueo si no existe
        const estudianteContainer = selectEstudiante.parentElement;
        if (!estudianteContainer.querySelector('.estudiante-bloqueado-msg')) {
            const mensajeBloqueo = document.createElement('small');
            mensajeBloqueo.className = 'estudiante-bloqueado-msg';
            mensajeBloqueo.style.color = '#dc3545';
            mensajeBloqueo.style.fontWeight = 'bold';
            mensajeBloqueo.style.display = 'block';
            mensajeBloqueo.style.marginTop = '5px';
            mensajeBloqueo.innerHTML = 'üîí Para cambiar estudiante, elimina este pago y crea uno nuevo.';
            estudianteContainer.appendChild(mensajeBloqueo);
        }
    }
}, 100);

cargarDatosEstudiante();

// Recrear el carrito basado en el pago existente
carritoConceptos = [];

if (pago.conceptos && pago.conceptos.length > 0) {
    // Pago moderno con array de conceptos
    carritoConceptos = pago.conceptos.map(concepto => ({...concepto}));
} else {
    // Pago legacy con concepto √∫nico
    const conceptoPago = {
        tipo: pago.concepto,
        total: pago.montoTotal,
        observaciones: pago.observaciones || ''
    };
    
    // Agregar datos espec√≠ficos seg√∫n el tipo
    if (pago.concepto === 'colegiatura') {
        conceptoPago.montoBase = pago.montoBase || pago.montoTotal;
        conceptoPago.descuentoBeca = pago.descuentoBeca || 0;
        conceptoPago.recargo = pago.recargoFinal || 0;
        conceptoPago.detalleRecargo = pago.detalleRecargo || '';
        
        // Agregar informaci√≥n del mes si existe
        if (pago.mesAplicacion && pago.a√±oAplicacion) {
            conceptoPago.mesAplicacion = pago.mesAplicacion;
            conceptoPago.a√±oAplicacion = pago.a√±oAplicacion;
            conceptoPago.descripcionMes = pago.descripcionMes;
        }
    } else if (pago.concepto === 'producto' && pago.producto) {
        conceptoPago.producto = pago.producto;
        conceptoPago.talla = pago.talla;
        conceptoPago.cantidad = pago.cantidad;
        conceptoPago.nombre = pago.producto.nombre;
    }
    
    carritoConceptos.push(conceptoPago);
}
            actualizarCarritoVisual();

            // Marcar que estamos editando
            document.getElementById('form-pago').dataset.editando = pagoId;
            
            // Cambiar t√≠tulos
            document.querySelector('#formulario-pago h3').textContent = '‚úèÔ∏è Editar Pago';
            document.querySelector('#form-pago button[type="submit"]').innerHTML = 'üíæ Actualizar Pago';

            // Mostrar formulario
            mostrarFormularioPago();
            
            mostrarNotificacion('Datos del pago cargados para edici√≥n', 'success');
        }

        function eliminarPago(pagoId) {
            if (!confirm('¬øEst√°s seguro de eliminar este pago? Esta acci√≥n no se puede deshacer.')) {
                return;
            }

            const pagoIndex = sistemaADAMS.pagos.findIndex(p => p.id === pagoId);
            if (pagoIndex === -1) {
                mostrarNotificacion('Pago no encontrado', 'error');
                return;
            }

            const pago = sistemaADAMS.pagos[pagoIndex];
            
            // Si era pago de producto, restaurar inventario
            if (pago.concepto === 'producto' && pago.producto && pago.talla && pago.cantidad) {
                const producto = sistemaADAMS.productos.find(p => p.id === pago.producto.id);
                if (producto && producto.inventario[pago.talla] !== undefined) {
                    producto.inventario[pago.talla] += pago.cantidad;
                }
            }

            // Eliminar el pago
            sistemaADAMS.pagos.splice(pagoIndex, 1);

            // Actualizar estado del estudiante si es necesario
            const estudiante = sistemaADAMS.estudiantes.find(e => e.id === pago.estudianteId);
            if (estudiante && pago.concepto === 'colegiatura') {
                // Buscar el pago de colegiatura m√°s reciente restante
                const pagosColRestantes = sistemaADAMS.pagos
                    .filter(p => p.estudianteId === pago.estudianteId && p.concepto === 'colegiatura')
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
                if (pagosColRestantes.length > 0) {
                    estudiante.ultimoPago = pagosColRestantes[0].fecha;
                } else {
                    delete estudiante.ultimoPago;
                    // Recalcular estado basado en d√≠as sin pagar
                    const diasSinPagar = calcularDiasSinPagar(null, estudiante);
                    if (diasSinPagar > 15) {
                        estudiante.estado = 'inactivo';
                    } else if (diasSinPagar > 5) {
                        estudiante.estado = 'moroso';
                    }
                }
            }

            guardarDatos();
actualizarTablaPagos();
actualizarTablaEstudiantes();
actualizarDashboard();

// Actualizar reportes financieros autom√°ticamente
generarReporteFinanciero();

mostrarNotificacion('Pago eliminado correctamente', 'success');
        }

        function mostrarProductosDisponibles() {
            const container = document.getElementById('productos-disponibles');
            
            if (!sistemaADAMS.productos || sistemaADAMS.productos.length === 0) {
                container.innerHTML = '<p>No hay productos disponibles</p>';
                return;
            }

            container.innerHTML = sistemaADAMS.productos.map(producto => {
                const stockTotal = Object.values(producto.inventario).reduce((sum, cantidad) => sum + cantidad, 0);
                
                if (stockTotal === 0) return '';

                return `
                    <div class="producto-card">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h5>${producto.nombre}</h5>
                                <p>Precio: $${producto.precio.toFixed(2)}</p>
                                <p>Stock disponible: ${stockTotal} unidades</p>
                            </div>
                            <div>
                                <label>Talla:</label>
                                <select id="talla-${producto.id}">
                                    ${Object.entries(producto.inventario)
                                        .filter(([talla, cantidad]) => cantidad > 0)
                                        .map(([talla, cantidad]) => 
                                            `<option value="${talla}">${talla.toUpperCase()} (${cantidad} disponibles)</option>`
                                        ).join('')}
                                </select>
                                <br><br>
                                <label>Cantidad:</label>
                                <input type="number" id="cantidad-${producto.id}" min="1" max="${stockTotal}" value="1">
                                <br><br>
                                <button class="btn btn-primary btn-small" onclick="agregarProductoAPago(${producto.id})">
                                    Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).filter(html => html).join('');
        }

        function agregarProductoAPago(productoId) {
            const producto = sistemaADAMS.productos.find(p => p.id === productoId);
            const talla = document.getElementById(`talla-${productoId}`).value;
            const cantidad = parseInt(document.getElementById(`cantidad-${productoId}`).value);
            
            if (!producto || !talla || !cantidad) {
                mostrarNotificacion('Selecciona talla y cantidad', 'error');
                return;
            }

            if (cantidad > producto.inventario[talla]) {
                mostrarNotificacion('Cantidad no disponible en stock', 'error');
                return;
            }

            // Crear resumen para productos
            const montoTotal = producto.precio * cantidad;
            
            mostrarResumenPago({
                concepto: `${producto.nombre} (Talla: ${talla.toUpperCase()}, Cant: ${cantidad})`,
                montoBase: montoTotal,
                descuentoBeca: 0,
                recargo: 0,
                detalleRecargo: '',
                montoFinal: montoTotal,
                estudiante: { porcentajeBeca: 0 },
                producto: producto,
                talla: talla,
                cantidad: cantidad
            });

            document.getElementById('seleccion-productos').style.display = 'none';
        }

        // FUNCIONES DE CONTROL DE MOROSIDAD
        function actualizarControlMorosidad() {
            if (!sistemaADAMS.pagos) sistemaADAMS.pagos = [];
            
            const hoy = new Date();
            let totalMorosos = 0;
            let totalAdeudo = 0;
            let inactivosPorPago = 0;
            
            const tbody = document.getElementById('tabla-morosidad');
            const estudiantesMorosos = [];

            sistemaADAMS.estudiantes.forEach(estudiante => {
                const ultimoPago = obtenerUltimoPago(estudiante.id);
                const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
                
                if (diasSinPagar > 5) { // Consideramos moroso despu√©s de 5 d√≠as
                    const montoAdeudado = calcularMontoAdeudado(estudiante, diasSinPagar);
                    const recargos = calcularRecargos(estudiante.colegiatura, diasSinPagar);
                    
                    estudiantesMorosos.push({
                        estudiante: estudiante,
                        ultimoPago: ultimoPago,
                        diasSinPagar: diasSinPagar,
                        montoAdeudado: montoAdeudado,
                        recargos: recargos,
                        estado: diasSinPagar > 15 ? 'inactivo' : 'moroso'
                    });
                    
                    totalMorosos++;
                    totalAdeudo += montoAdeudado + recargos;
                    
                    if (diasSinPagar > 15) {
                        inactivosPorPago++;
                        // Actualizar estado del estudiante
                        estudiante.estado = 'inactivo';
                    }
                }
            });

            // Actualizar estad√≠sticas
            document.getElementById('total-morosos').textContent = totalMorosos;
            document.getElementById('total-adeudo').textContent = `$${totalAdeudo.toFixed(2)}`;
            document.getElementById('inactivos-por-pago').textContent = inactivosPorPago;

            // Actualizar tabla
            if (estudiantesMorosos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                            ¬°Excelente! No hay estudiantes morosos
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = estudiantesMorosos.map(item => `
                    <tr>
                        <td>
                            <strong>${item.estudiante.nombre}</strong><br>
                            <small style="color: #666;">Tutor: ${item.estudiante.tutor}</small><br>
                            <small style="color: #666;">Tel: ${item.estudiante.telefono}</small>
                        </td>
                        <td>${item.ultimoPago ? formatearFecha(item.ultimoPago.fecha) : 'Sin registros'}</td>
                        <td>
                            <span class="status ${item.diasSinPagar > 15 ? 'status-inactive' : item.diasSinPagar > 10 ? 'status-warning' : 'status-warning'}">
                                ${item.diasSinPagar} d√≠as
                            </span>
                        </td>
                        <td><strong>$${item.montoAdeudado.toFixed(2)}</strong></td>
                        <td><strong>$${item.recargos.toFixed(2)}</strong></td>
                        <td>${getEstatusBadge(item.estado)}</td>
                        <td>
                            <button class="btn btn-primary btn-small" onclick="abrirFormularioPagoRapido(${item.estudiante.id})" style="margin-bottom: 5px;">
                                üí≥ Pagar Ahora
                            <button class="btn btn-success btn-small" onclick="enviarRecordatorio(${item.estudiante.id})" style="margin-bottom: 5px;">
    üì± WhatsApp
</button><br>
<button class="btn btn-secondary btn-small" onclick="llamadaTelefonica(${item.estudiante.id})">
    üìû Llamar
</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function calcularMontoAdeudado(estudiante, diasSinPagar) {
            // Simplificado: asumimos que debe 1 colegiatura
            return estudiante.colegiatura * (1 - estudiante.porcentajeBeca / 100);
        }

        function calcularRecargos(colegiatura, diasSinPagar) {
            if (diasSinPagar > 15) {
                return colegiatura * 0.15;
            } else if (diasSinPagar > 10) {
                return colegiatura * 0.15;
            } else if (diasSinPagar > 5) {
                return colegiatura * 0.10;
            }
            return 0;
        }

        function abrirFormularioPagoRapido(estudianteId) {
            // Cambiar a la pesta√±a de registro de pagos
            cambiarTab('registro-pagos', document.querySelector('.tab'));
            
            // Mostrar formulario y preseleccionar estudiante
            mostrarFormularioPago();
            document.getElementById('pago-estudiante').value = estudianteId;
            document.getElementById('pago-tipo').value = 'colegiatura';
            
            // Cargar datos autom√°ticamente
            cargarDatosEstudiante();
            calcularMontoPago();
        }

        function enviarRecordatorio(estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) {
        mostrarNotificacion('Estudiante no encontrado', 'error');
        return;
    }

    // Mostrar opciones de contacto
    mostrarOpcionesContacto(estudiante);
}

function mostrarOpcionesContacto(estudiante) {
    // Calcular datos de morosidad
    const ultimoPago = obtenerUltimoPago(estudiante.id);
    const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
    const montoAdeudado = calcularMontoAdeudado(estudiante, diasSinPagar);
    const recargos = calcularRecargos(estudiante.colegiatura, diasSinPagar);
    const totalAdeudo = montoAdeudado + recargos;

    // Crear modal de opciones
    const modal = document.createElement('div');
    modal.id = 'modal-contacto-deudor';
    modal.className = 'modal-recibo';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #9c27b0;">üì± Contactar Deudor</h3>
                    <button onclick="cerrarModalContacto()" style="background: none; border: none; font-size: 24px; cursor: pointer;">‚úï</button>
                </div>
                
                <!-- Informaci√≥n del estudiante -->
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n del Adeudo</h4>
                    <p><strong>Estudiante:</strong> ${estudiante.nombre}</p>
                    <p><strong>Tutor:</strong> ${estudiante.tutor}</p>
                    <p><strong>Tel√©fono:</strong> ${estudiante.telefono}</p>
                    <p><strong>D√≠as sin pagar:</strong> ${diasSinPagar} d√≠as</p>
                    <p><strong>Monto adeudado:</strong> $${totalAdeudo.toFixed(2)}</p>
                </div>
                
                <!-- Opciones de contacto -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="enviarWhatsAppAmigable(${estudiante.id})" style="padding: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">üíö</span>
                        <div style="text-align: left;">
                            <div style="font-weight: bold;">WhatsApp Amigable</div>
                            <small>Recordatorio cordial</small>
                        </div>
                    </button>
                    
                    <button class="btn btn-primary" onclick="enviarWhatsAppFormal(${estudiante.id})" style="padding: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">üìã</span>
                        <div style="text-align: left;">
                            <div style="font-weight: bold;">WhatsApp Formal</div>
                            <small>Notificaci√≥n oficial</small>
                        </div>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="llamadaTelefonica(${estudiante.id})" style="padding: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">üìû</span>
                        <div style="text-align: left;">
                            <div style="font-weight: bold;">Llamada</div>
                            <small>Marcar n√∫mero</small>
                        </div>
                    </button>
                    
                    <button class="btn btn-primary" onclick="abrirFormularioPagoRapido(${estudiante.id})" style="padding: 15px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 20px;">üí≥</span>
                        <div style="text-align: left;">
                            <div style="font-weight: bold;">Pagar Ahora</div>
                            <small>Registrar pago</small>
                        </div>
                    </button>
                </div>
                
                <div style="text-align: right; border-top: 2px solid #eee; padding-top: 20px;">
                    <button class="btn btn-secondary" onclick="cerrarModalContacto()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function cerrarModalContacto() {
    const modal = document.getElementById('modal-contacto-deudor');
    if (modal) {
        modal.remove();
    }
}

function enviarWhatsAppAmigable(estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) return;
    
    const ultimoPago = obtenerUltimoPago(estudiante.id);
    const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
    const montoAdeudado = calcularMontoAdeudado(estudiante, diasSinPagar);
    const recargos = calcularRecargos(estudiante.colegiatura, diasSinPagar);
    const totalAdeudo = montoAdeudado + recargos;
    
    // Obtener informaci√≥n de la academia
    const nombreAcademia = obtenerNombreAcademia();
    
    // Mensaje amigable y cordial
    const mensaje = `¬°Hola! üòä

Espero que ${estudiante.nombre} est√© muy bien en sus entrenamientos.

Te escribo de ${nombreAcademia} para recordarte cordialmente que tenemos pendiente el pago de la colegiatura.

üìã *Resumen:*
- Estudiante: ${estudiante.nombre}
- D√≠as de atraso: ${diasSinPagar} d√≠as
- Monto total: $${totalAdeudo.toFixed(2)}

Sabemos que a veces se nos pueden pasar las fechas üòÖ. Puedes realizar tu pago cuando te sea conveniente.

Si ya realizaste el pago, por favor comp√°rtenos el comprobante para actualizar nuestros registros.

¬°Cualquier duda, aqu√≠ estamos para apoyarte! üí™

Saludos cordiales ü§ù`;

    abrirWhatsApp(estudiante.telefono, mensaje);
    cerrarModalContacto();
}

function enviarWhatsAppFormal(estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) return;
    
    const ultimoPago = obtenerUltimoPago(estudiante.id);
    const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
    const montoAdeudado = calcularMontoAdeudado(estudiante, diasSinPagar);
    const recargos = calcularRecargos(estudiante.colegiatura, diasSinPagar);
    const totalAdeudo = montoAdeudado + recargos;
    
    const nombreAcademia = obtenerNombreAcademia();
    const hoy = formatearFecha(algo);
    
    // Mensaje formal y profesional
    const mensaje = `*${nombreAcademia}*
üìã NOTIFICACI√ìN DE PAGO PENDIENTE

*Fecha:* ${hoy}
*Estudiante:* ${estudiante.nombre}
*Responsable:* ${estudiante.tutor}

*DETALLE DEL ADEUDO:*
- Colegiatura base: $${estudiante.colegiatura}
- D√≠as de atraso: ${diasSinPagar} d√≠as
- Recargos aplicados: $${recargos.toFixed(2)}
- *TOTAL A PAGAR: $${totalAdeudo.toFixed(2)}*

*INSTRUCCIONES DE PAGO:*
Para regularizar la situaci√≥n, favor de:
1. Realizar el pago del monto total
2. Enviar comprobante de pago
3. Confirmar recepci√≥n con administraci√≥n

*IMPORTANTE:* Despu√©s de 15 d√≠as sin pago, el estudiante ser√° dado de baja temporal hasta regularizar su situaci√≥n.

Para dudas o aclaraciones, contactar a administraci√≥n.

Atentamente,
Administraci√≥n ${nombreAcademia}`;

    abrirWhatsApp(estudiante.telefono, mensaje);
    cerrarModalContacto();
}

function llamadaTelefonica(estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) return;
    
    // Abrir marcador del tel√©fono
    window.open(`tel:${estudiante.telefono}`, '_self');
    cerrarModalContacto();
    
    mostrarNotificacion(`Marcando a ${estudiante.tutor}: ${estudiante.telefono}`, 'success');
}

function abrirWhatsApp(telefono, mensaje) {
    // Limpiar el n√∫mero de tel√©fono (solo n√∫meros)
    let numeroLimpio = telefono.replace(/\D/g, '');
    
    // Si el n√∫mero no tiene c√≥digo de pa√≠s, agregar +52 para M√©xico
    if (numeroLimpio.length === 10) {
        numeroLimpio = '52' + numeroLimpio;
    }
    
    // Codificar el mensaje para URL
    const mensajeCodificado = encodeURIComponent(mensaje);
    
    // Crear URL de WhatsApp
    const urlWhatsApp = `https://wa.me/${numeroLimpio}?text=${mensajeCodificado}`;
    
    // Abrir WhatsApp en nueva pesta√±a
    window.open(urlWhatsApp, '_blank');
    
    mostrarNotificacion('WhatsApp abierto. Mensaje listo para enviar.', 'success');
}


function enviarRecordatoriosMasivos() {
    // Obtener todos los estudiantes morosos
    const estudiantesMorosos = [];
    
    sistemaADAMS.estudiantes.forEach(estudiante => {
        const ultimoPago = obtenerUltimoPago(estudiante.id);
        const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
        
        if (diasSinPagar > 5 && (estudiante.estatus || 'activo') === 'activo') {
            estudiantesMorosos.push(estudiante);
        }
    });
    
    if (estudiantesMorosos.length === 0) {
        mostrarNotificacion('No hay estudiantes morosos', 'success');
        return;
    }
    
    // Mostrar modal con lista de deudores para env√≠o masivo
    mostrarModalEnvioMasivo(estudiantesMorosos);
}

function mostrarModalEnvioMasivo(estudiantesMorosos) {
    const modal = document.createElement('div');
    modal.id = 'modal-envio-masivo';
    modal.className = 'modal-recibo';
    
    const listaHTML = estudiantesMorosos.map((estudiante, index) => {
        const ultimoPago = obtenerUltimoPago(estudiante.id);
        const diasSinPagar = calcularDiasSinPagar(ultimoPago, estudiante);
        
        return `
            <div id="deudor-${index}" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 8px;">
                <div>
                    <strong>${estudiante.nombre}</strong> - ${estudiante.tutor}<br>
                    <small>Tel: ${estudiante.telefono} | ${diasSinPagar} d√≠as de atraso</small>
                </div>
                <div>
                    <button class="btn btn-success btn-small" onclick="enviarWhatsAppIndividual(${index}, ${estudiante.id})">
                        üì± Enviar
                    </button>
                    <span id="status-${index}" style="margin-left: 10px; font-size: 12px;"></span>
                </div>
            </div>
        `;
    }).join('');
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
            <div style="background: white; padding: 30px; border-radius: 15px;">
                <h3 style="color: #9c27b0; margin-bottom: 20px;">üì± Env√≠o Masivo de Recordatorios</h3>
                
                <div style="background: #e3f2fd; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h4 style="color: #1976d2;">üìã Instrucciones:</h4>
                    <p style="margin: 10px 0;">Haz clic en cada bot√≥n "Enviar" uno por uno. Cada clic abrir√° WhatsApp Web con el mensaje preparado.</p>
                    <p style="margin: 0; font-weight: bold; color: #f57c00;">‚ö†Ô∏è IMPORTANTE: Espera a que se abra WhatsApp antes de hacer clic en el siguiente.</p>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 10px;">
                    ${listaHTML}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px;">
                    <div>
                        <button class="btn btn-primary" onclick="enviarTodosSecuencial()">
                            üöÄ Enviar Todos (Autom√°tico)
                        </button>
                        <small style="display: block; color: #666; margin-top: 5px;">Se abrir√° uno cada 3 segundos</small>
                    </div>
                    <button class="btn btn-secondary" onclick="cerrarModalEnvioMasivo()">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Guardar lista global para uso posterior
    window.listaDeudoresMasivo = estudiantesMorosos;
}

function enviarWhatsAppIndividual(index, estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) return;
    
    const nombreAcademia = obtenerNombreAcademia();
    
    const mensaje = `Recordatorio de Pago Autom√°tico de ${nombreAcademia}

Le invitamos a realizar su pago de colegiatura, recuerde que los pagos se realizan dentro de los primeros 5 d√≠as del mes. A partir del d√≠a 6 se generan recargos autom√°ticos en sistema.

Estudiante: ${estudiante.nombre}

Gracias por su atenci√≥n.`;

    abrirWhatsApp(estudiante.telefono, mensaje);
    
    // Marcar como enviado
    const statusElement = document.getElementById(`status-${index}`);
    const deudorElement = document.getElementById(`deudor-${index}`);
    
    if (statusElement) {
        statusElement.innerHTML = '<span style="color: #4caf50;">‚úÖ Enviado</span>';
    }
    
    if (deudorElement) {
        deudorElement.style.background = '#e8f5e8';
        deudorElement.style.border = '2px solid #4caf50';
    }
}

function enviarTodosSecuencial() {
    if (!window.listaDeudoresMasivo) return;
    
    const totalDeudores = window.listaDeudoresMasivo.length;
    
    if (!confirm(`Se abrir√°n ${totalDeudores} ventanas de WhatsApp, una cada 3 segundos. ¬øContinuar?`)) {
        return;
    }
    
    let enviados = 0;
    
    window.listaDeudoresMasivo.forEach((estudiante, index) => {
        setTimeout(() => {
            enviarWhatsAppIndividual(index, estudiante.id);
            enviados++;
            
            if (enviados === totalDeudores) {
                setTimeout(() => {
                    mostrarNotificacion(`‚úÖ Proceso completado. ${enviados} mensajes enviados.`, 'success');
                }, 1000);
            }
        }, index * 3000); // 3 segundos entre cada env√≠o
    });
    
    mostrarNotificacion(`üöÄ Iniciando env√≠o secuencial de ${totalDeudores} mensajes...`, 'success');
}

function cerrarModalEnvioMasivo() {
    const modal = document.getElementById('modal-envio-masivo');
    if (modal) {
        modal.remove();
    }
    window.listaDeudoresMasivo = null;
}

        // FUNCIONES DE REPORTES FINANCIEROS
        function generarReporteFinanciero() {
    const periodo = document.getElementById('periodo-reporte').value;
    const tipo = document.getElementById('tipo-reporte').value;
    
    // Mostrar/ocultar campos personalizados
    const camposPersonalizados = document.getElementById('campos-periodo-personalizado');
    if (periodo === 'personalizado') {
        camposPersonalizados.style.display = 'block';
        // No generar reporte hasta que se aplique el per√≠odo personalizado
        const container = document.getElementById('resumen-financiero');
        container.innerHTML = `
            <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 20px; text-align: center;">
                <h4 style="color: #1976d2; margin-bottom: 15px;">üìÖ Per√≠odo Personalizado</h4>
                <p>Selecciona las fechas de inicio y fin para generar el reporte personalizado.</p>
            </div>
        `;
        return;
    } else {
        camposPersonalizados.style.display = 'none';
    }
    
    if (!sistemaADAMS.pagos) sistemaADAMS.pagos = [];
    
    const fechas = calcularFechasPeriodo(periodo);
    const pagosDelPeriodo = sistemaADAMS.pagos.filter(pago => {
        const fechaPago = new Date(pago.fecha);
        return fechaPago >= fechas.inicio && fechaPago <= fechas.fin;
    });

    const resumen = calcularResumenFinanciero(pagosDelPeriodo, tipo);
    mostrarResumenFinanciero(resumen, periodo);
}

        function calcularFechasPeriodo(periodo, fechaInicioPersonalizada = null, fechaFinPersonalizada = null) {
    const hoy = new Date();
    let inicio, fin;

    switch(periodo) {
        case 'mes-actual':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            break;
        case 'mes-anterior':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
            break;
        case 'trimestre':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 3, 1);
            fin = hoy;
            break;
        case 'semestre':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 6, 1);
            fin = hoy;
            break;
        case 'a√±o':
            inicio = new Date(hoy.getFullYear(), 0, 1);
            fin = hoy;
            break;
        case 'personalizado':
            case 'personalizado':
    if (fechaInicioPersonalizada && fechaFinPersonalizada) {
        // Corregir problema de zona horaria
        const [a√±oInicio, mesInicio, diaInicio] = fechaInicioPersonalizada.split('-');
        const [a√±oFin, mesFin, diaFin] = fechaFinPersonalizada.split('-');
        inicio = new Date(parseInt(a√±oInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
        fin = new Date(parseInt(a√±oFin), parseInt(mesFin) - 1, parseInt(diaFin));
        // Ajustar la fecha de fin al final del d√≠a
        fin.setHours(23, 59, 59, 999);
    } else {
                // Valores por defecto si no se proporcionan fechas
                inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                fin = hoy;
            }
            break;
        default:
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = hoy;
    }

    return { inicio, fin };
}

        function calcularResumenFinanciero(pagos, tipo) {
    const resumen = {
        totalIngresos: 0,
        totalColegiaturas: 0,
        totalInscripciones: 0,
        totalProductos: 0,
        totalRecargos: 0,
        cantidadPagos: pagos.length,
        promedioMensual: 0
    };

    pagos.forEach(pago => {
        resumen.totalIngresos += pago.montoTotal;
        
        // Si el pago tiene m√∫ltiples conceptos
        if (pago.conceptos && pago.conceptos.length > 0) {
            pago.conceptos.forEach(concepto => {
                switch(concepto.tipo) {
                    case 'colegiatura':
                    case 'ajuste-colegiatura':
                        resumen.totalColegiaturas += concepto.total;
                        break;
                    case 'inscripcion':
                    case 'reinscripcion':
                        resumen.totalInscripciones += concepto.total;
                        break;
                    case 'producto':
                        resumen.totalProductos += concepto.total;
                        break;
                }
            });
        } else {
            // Para pagos antiguos sin el array de conceptos
            switch(pago.concepto) {
                case 'colegiatura':
                case 'ajuste-colegiatura':
                    resumen.totalColegiaturas += pago.montoTotal;
                    break;
                case 'inscripcion':
                case 'reinscripcion':
                    resumen.totalInscripciones += pago.montoTotal;
                    break;
                case 'producto':
                    resumen.totalProductos += pago.montoTotal;
                    break;
            }
        }
    });

    return resumen;
}

        function mostrarResumenFinanciero(resumen, periodo) {
    const container = document.getElementById('resumen-financiero');
    
    // Calcular ingresos por cada concepto personalizado
    const ingresosPorConcepto = {};
    let totalIngresos = 0;
    
    // Inicializar todos los conceptos configurados
    sistemaADAMS.conceptosPago.forEach(concepto => {
        if (concepto.activo) {
            ingresosPorConcepto[concepto.tipo] = {
                nombre: concepto.nombre,
                total: 0,
                cantidad: 0
            };
        }
    });
    
    // Calcular totales por concepto desde los pagos
    if (sistemaADAMS.pagos) {
        const fechas = calcularFechasPeriodo(periodo);
        
        // NUEVO: Filtrado mejorado que considera el mes de aplicaci√≥n
        const pagosDelPeriodo = sistemaADAMS.pagos.filter(pago => {
            const fechaPago = new Date(pago.fecha);
            const cumpleFiltroFecha = fechaPago >= fechas.inicio && fechaPago <= fechas.fin;
            
            // Si el pago tiene mes de aplicaci√≥n espec√≠fico, usarlo para el filtro
            if (pago.mesAplicacion && pago.a√±oAplicacion) {
                const fechaAplicacion = new Date(pago.a√±oAplicacion, pago.mesAplicacion - 1, 1);
                return fechaAplicacion >= fechas.inicio && fechaAplicacion <= fechas.fin;
            }
            
            // Para pagos antiguos sin mes espec√≠fico, usar fecha de pago
            return cumpleFiltroFecha;
        });
        
        pagosDelPeriodo.forEach(pago => {
            totalIngresos += pago.montoTotal;
            
            if (pago.conceptos && pago.conceptos.length > 0) {
                // Pagos con m√∫ltiples conceptos
                pago.conceptos.forEach(concepto => {
                    if (ingresosPorConcepto[concepto.tipo]) {
                        ingresosPorConcepto[concepto.tipo].total += concepto.total;
                        ingresosPorConcepto[concepto.tipo].cantidad += 1;
                    }
                });
            } else {
                // Pagos antiguos con un solo concepto
                if (ingresosPorConcepto[pago.concepto]) {
                    ingresosPorConcepto[pago.concepto].total += pago.montoTotal;
                    ingresosPorConcepto[pago.concepto].cantidad += 1;
                }
            }
        });
    }
    
    // Generar las tarjetas de conceptos din√°micamente
    const conceptosConIngresos = Object.entries(ingresosPorConcepto)
        .filter(([tipo, datos]) => datos.total > 0 || datos.cantidad > 0)
        .sort((a, b) => b[1].total - a[1].total); // Ordenar por monto descendente
    
    // Si no hay conceptos con ingresos, mostrar todos los configurados
    const conceptosAMostrar = conceptosConIngresos.length > 0 ? 
        conceptosConIngresos : 
        Object.entries(ingresosPorConcepto).slice(0, 6); // M√°ximo 6 para que se vea bien
    
    const tarjetasHTML = conceptosAMostrar.map(([tipo, datos], index) => {
        const colores = [
            { bg: '#e8f5e8', color: '#2e7d32' }, // Verde
            { bg: '#e3f2fd', color: '#1976d2' }, // Azul
            { bg: '#fff3e0', color: '#f57c00' }, // Naranja
            { bg: '#fce4ec', color: '#c2185b' }, // Rosa
            { bg: '#f3e5f5', color: '#7b1fa2' }, // Morado
            { bg: '#e0f2f1', color: '#00695c' }  // Verde agua
        ];
        
        const colorIndex = index % colores.length;
        const { bg, color } = colores[colorIndex];
        
        return `
            <div style="text-align: center; padding: 15px; background: ${bg}; border-radius: 10px;">
                <h4 style="color: ${color}; font-size: 14px; margin-bottom: 8px;">${datos.nombre}</h4>
                <div style="font-size: 20px; font-weight: bold; color: ${color};">$${datos.total.toFixed(2)}</div>
                <small style="color: ${color}; opacity: 0.8;">${datos.cantidad} pago${datos.cantidad !== 1 ? 's' : ''}</small>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <!-- Tarjeta de total general -->
        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; background: linear-gradient(135deg, #9c27b0, #e91e63); border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 10px;">üí∞ INGRESOS TOTALES</h3>
            <div style="font-size: 36px; font-weight: bold; color: white;">$${totalIngresos.toFixed(2)}</div>
        </div>
        
        <!-- Grid de conceptos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
            ${tarjetasHTML}
        </div>
        
        <!-- Estad√≠sticas del per√≠odo -->
        <div style="padding: 20px; background: #f5f5f5; border-radius: 10px;">
            <h4>üìä Estad√≠sticas del Per√≠odo</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div>
                    <strong>Cantidad total de pagos:</strong> ${conceptosAMostrar.reduce((sum, [_, datos]) => sum + datos.cantidad, 0)}
                </div>
                <div>
                    <strong>Promedio por pago:</strong> $${totalIngresos > 0 ? (totalIngresos / conceptosAMostrar.reduce((sum, [_, datos]) => sum + datos.cantidad, 0)).toFixed(2) : '0.00'}
                </div>
                <div>
                    <strong>Concepto m√°s rentable:</strong> ${conceptosAMostrar.length > 0 ? conceptosAMostrar[0][1].nombre : 'N/A'}
                </div>
                <div>
                    <strong>Per√≠odo:</strong> ${periodo.replace('-', ' ').toUpperCase()}
                </div>
            </div>
        </div>
    `;
}

        function exportarReporte() {
            mostrarNotificacion('Funci√≥n de exportaci√≥n en desarrollo', 'success');
            // Aqu√≠ se implementar√≠a la exportaci√≥n a PDF
        }
        function editarProducto(id) {
    const producto = sistemaADAMS.productos.find(p => p.id === id);
    if (!producto) {
        mostrarNotificacion('Producto no encontrado', 'error');
        return;
    }

    // Cargar datos b√°sicos en el formulario
    document.getElementById('producto-nombre').value = producto.nombre;
    document.getElementById('producto-precio').value = producto.precio;
    document.getElementById('producto-categoria').value = producto.categoriaId || '';
    document.getElementById('producto-descripcion').value = producto.descripcion || '';
    
    // Configurar sistema de tallas
    const requiereTallas = producto.requiereTallas || false;
    document.getElementById('producto-requiere-tallas').checked = requiereTallas;
    
    if (requiereTallas) {
        // Mostrar secci√≥n de tallas
        document.getElementById('seccion-tallas').style.display = 'block';
        document.getElementById('inventario-simple').style.display = 'none';
        
        // Cargar tallas personalizadas
        if (producto.tallasPersonalizadas) {
            document.getElementById('tallas-personalizadas').value = producto.tallasPersonalizadas;
            generarCamposTallasPersonalizadas();
            
            // Cargar valores del inventario despu√©s de generar los campos
            setTimeout(() => {
                Object.entries(producto.inventario).forEach(([talla, cantidad]) => {
                    const campo = document.querySelector(`input[data-talla="${talla}"]`);
                    if (campo) {
                        campo.value = cantidad;
                    }
                });
            }, 100);
        }
    } else {
        // Mostrar inventario simple
        document.getElementById('seccion-tallas').style.display = 'none';
        document.getElementById('inventario-simple').style.display = 'block';
        
        // Cargar cantidad para productos sin tallas
        const cantidad = producto.inventario.unica || 0;
        document.getElementById('inventario-cantidad').value = cantidad;
    }
    
    // Marcar que estamos editando
    document.getElementById('form-producto').dataset.editando = id;
    
    // Cambiar t√≠tulo del formulario
    document.querySelector('#formulario-producto h4').textContent = '‚úèÔ∏è Editar Producto';
    document.querySelector('#form-producto button[type="submit"]').innerHTML = 'üíæ Actualizar Producto';
    
    mostrarFormularioProducto();
}

        // INICIALIZACI√ìN DEL M√ìDULO DE PAGOS
        function inicializarModuloPagos() {
    // Inicializar arrays si no existen
    if (!sistemaADAMS.pagos) {
        sistemaADAMS.pagos = [];
    }
    if (!sistemaADAMS.productos) {
        sistemaADAMS.productos = [];
    }
    
    // Actualizar tablas al cargar
    actualizarTablaPagos();
    actualizarTablaProductos();
    actualizarControlMorosidad();
    generarReporteFinanciero();
}
        
        // FUNCIONES DE ENTRENADORES
        function mostrarFormularioEntrenador() {
            document.getElementById('formulario-entrenador').classList.add('show');
        }

        function ocultarFormularioEntrenador() {
            document.getElementById('formulario-entrenador').classList.remove('show');
            document.getElementById('form-entrenador').reset();
            
            // Limpiar estado de edici√≥n
            delete document.getElementById('form-entrenador').dataset.editando;
            
            // Restaurar t√≠tulo y bot√≥n originales
            document.querySelector('#formulario-entrenador h3').textContent = 'üìù Registro de Nuevo Entrenador';
            document.querySelector('#form-entrenador button[type="submit"]').innerHTML = 'üíæ Guardar Entrenador';
        }

        // FUNCI√ìN DE EDITAR ENTRENADOR - CORREGIDA
        function editarEntrenador(id) {
            const entrenador = sistemaADAMS.entrenadores.find(e => e.id === id);
            if (!entrenador) {
                mostrarNotificacion('Entrenador no encontrado', 'error');
                return;
            }

            // Marcar que estamos editando
            document.getElementById('form-entrenador').dataset.editando = id;
            
            // Cargar datos en el formulario
            document.getElementById('entrenador-nombre').value = entrenador.nombre;
            document.getElementById('entrenador-telefono').value = entrenador.telefono;
            document.getElementById('entrenador-email').value = entrenador.email;
            document.getElementById('entrenador-fecha-contratacion').value = entrenador.fechaContratacion;
            document.getElementById('entrenador-tarifa').value = entrenador.tarifaHora;
            document.getElementById('entrenador-certificaciones').value = entrenador.certificaciones || '';
            document.getElementById('entrenador-experiencia').value = entrenador.experiencia;

            // Cargar disciplinas
            document.querySelectorAll('#formulario-entrenador input[type="checkbox"]').forEach(cb => {
                cb.checked = entrenador.disciplinas.includes(cb.value);
            });

            // Cambiar t√≠tulo y bot√≥n
            document.querySelector('#formulario-entrenador h3').textContent = '‚úèÔ∏è Editar Entrenador';
            document.querySelector('#form-entrenador button[type="submit"]').innerHTML = 'üíæ Actualizar Entrenador';

            // Mostrar formulario
            mostrarFormularioEntrenador();
        }

        function guardarEntrenador(event) {
            event.preventDefault();
            
            // Verificar si estamos editando o creando
            const esEdicion = document.getElementById('form-entrenador').dataset.editando;
            const entrenadorId = esEdicion ? parseInt(esEdicion) : null;
            
            // Validar disciplinas
            const disciplinasSeleccionadas = [];
            document.querySelectorAll('#formulario-entrenador input[type="checkbox"]:checked').forEach(cb => {
                disciplinasSeleccionadas.push(cb.value);
            });

            if (disciplinasSeleccionadas.length === 0) {
                mostrarNotificacion('Selecciona al menos una disciplina', 'error');
                return;
            }

            if (esEdicion) {
                // EDITAR ENTRENADOR EXISTENTE
                const indiceEntrenador = sistemaADAMS.entrenadores.findIndex(e => e.id === entrenadorId);
                if (indiceEntrenador === -1) {
                    mostrarNotificacion('Error: Entrenador no encontrado', 'error');
                    return;
                }

                // Actualizar datos del entrenador existente
                const entrenadorExistente = sistemaADAMS.entrenadores[indiceEntrenador];
                sistemaADAMS.entrenadores[indiceEntrenador] = {
                    ...entrenadorExistente, // Mantener ID, horarios asignados y fecha de contrataci√≥n original
                    nombre: formatearNombrePropio(document.getElementById('entrenador-nombre').value),
                    telefono: document.getElementById('entrenador-telefono').value,
                    email: document.getElementById('entrenador-email').value,
                    fechaContratacion: document.getElementById('entrenador-fecha-contratacion').value,
                    disciplinas: disciplinasSeleccionadas,
                    tarifaHora: parseFloat(document.getElementById('entrenador-tarifa').value),
                    certificaciones: document.getElementById('entrenador-certificaciones').value,
                    experiencia: document.getElementById('entrenador-experiencia').value,
                    fechaModificacion: new Date().toISOString()
                };

                mostrarNotificacion('Entrenador actualizado exitosamente', 'success');
            } else {
                // CREAR NUEVO ENTRENADOR
                const nuevoEntrenador = {
                    id: Date.now(),
                    nombre: document.getElementById('entrenador-nombre').value,
                    telefono: document.getElementById('entrenador-telefono').value,
                    email: document.getElementById('entrenador-email').value,
                    fechaContratacion: document.getElementById('entrenador-fecha-contratacion').value,
                    disciplinas: disciplinasSeleccionadas,
                    tarifaHora: parseFloat(document.getElementById('entrenador-tarifa').value),
                    certificaciones: document.getElementById('entrenador-certificaciones').value,
                    experiencia: document.getElementById('entrenador-experiencia').value,
                    estado: 'activo',
                    horarios: []
                };

                sistemaADAMS.entrenadores.push(nuevoEntrenador);
                mostrarNotificacion('Entrenador registrado exitosamente', 'success');
            }

            // Guardar en el sistema
            guardarDatos();
            
            // Limpiar y cerrar formulario
            ocultarFormularioEntrenador();
            actualizarTablaEntrenadores();
            cargarSelectoresEntrenadores();
            actualizarDashboard();
        }

        function actualizarTablaEntrenadores() {
    const tbody = document.getElementById('tabla-entrenadores');
    
    // Verificar que existe el elemento
    if (!tbody) {
        console.error('No se encontr√≥ la tabla de entrenadores');
        return;
    }
    
    console.log('Actualizando tabla de entrenadores. Total:', sistemaADAMS.entrenadores.length);
    
    if (!sistemaADAMS.entrenadores || sistemaADAMS.entrenadores.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #666; padding: 40px;">
                    No hay entrenadores registrados. ¬°Registra el primero!
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = sistemaADAMS.entrenadores.map(entrenador => {
        const disciplinasText = entrenador.disciplinas.map(d => 
            d.charAt(0).toUpperCase() + d.slice(1)
        ).join(', ');

        const experienciaText = {
            'principiante': 'Principiante (0-2 a√±os)',
            'intermedio': 'Intermedio (2-5 a√±os)', 
            'avanzado': 'Avanzado (5-10 a√±os)',
            'experto': 'Experto (10+ a√±os)'
        }[entrenador.experiencia] || entrenador.experiencia;

        const estadoBadge = getEstatusBadge(entrenador.estado);

        return `
            <tr>
                <td>
                    <strong>${entrenador.nombre}</strong><br>
                    <small style="color: #666;">Desde: ${formatearFecha(entrenador.fechaContratacion)}</small>
                </td>
                <td>${disciplinasText}</td>
                <td>${experienciaText}</td>
                <td><strong>$${entrenador.tarifaHora}</strong>/hora</td>
                <td>
                    <div style="font-size: 12px;">
                        üìß ${entrenador.email}<br>
                        üìû ${entrenador.telefono}
                    </div>
                </td>
                <td>${estadoBadge}</td>
                <td>
                    <button class="btn btn-secondary btn-small" onclick="editarEntrenador(${entrenador.id})" style="margin-right: 5px; margin-bottom: 5px;">
                        Editar
                    </button><br>
                    <button class="btn btn-danger btn-small" onclick="eliminarEntrenador(${entrenador.id})">
                        Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    console.log('Tabla de entrenadores actualizada correctamente');
}
function getEstatusBadge(estado) {
    switch(estado) {
        case 'activo':
            return '<span class="status status-active">üü¢ Activo</span>';
        case 'inactivo':
            return '<span class="status status-inactive">üî¥ Inactivo</span>';
        case 'suspendido':
            return '<span class="status status-warning">üü° Suspendido</span>';
        default:
            return '<span class="status status-active">üü¢ Activo</span>';
    }
}

        function eliminarEntrenador(id) {
            if (confirm('¬øEst√°s seguro de eliminar este entrenador?')) {
                sistemaADAMS.entrenadores = sistemaADAMS.entrenadores.filter(e => e.id !== id);
                guardarDatos();
                actualizarTablaEntrenadores();
                cargarSelectoresEntrenadores();
                actualizarDashboard();
                mostrarNotificacion('Entrenador eliminado', 'success');
            }
        }

        function cargarSelectoresEntrenadores() {
    console.log('Cargando selectores de entrenadores...');
    
    // Cargar selector de entrenadores para asignaci√≥n de horarios
    const selectEntrenador = document.getElementById('select-entrenador-horario');
    if (selectEntrenador) {
        selectEntrenador.innerHTML = '<option value="">Seleccionar entrenador...</option>';
        
        sistemaADAMS.entrenadores.forEach(entrenador => {
            if (entrenador.estado === 'activo') {
                selectEntrenador.innerHTML += `
                    <option value="${entrenador.id}">${entrenador.nombre}</option>
                `;
            }
        });
        console.log('Selector de entrenadores cargado con', sistemaADAMS.entrenadores.length, 'entrenadores');
    } else {
        console.error('No se encontr√≥ el elemento select-entrenador-horario');
    }
}
        function cargarEntrenadoresEnSelect() {
    // Cargar entrenadores en todos los selects de entrenador-select de horarios de estudiantes
    const selectsEntrenador = document.querySelectorAll('.entrenador-select');
    
    selectsEntrenador.forEach(select => {
        const valorActual = select.value;
        select.innerHTML = '<option value="">Asignar autom√°ticamente</option>';
        
        sistemaADAMS.entrenadores.forEach(entrenador => {
            if (entrenador.estado === 'activo') {
                select.innerHTML += `
                    <option value="${entrenador.id}">${entrenador.nombre}</option>
                `;
            }
        });
        
        if (valorActual) {
            select.value = valorActual;
        }
    });
}

function cargarDisciplinasEnHorarios() {
    // Cargar disciplinas en todos los selects de disciplina-horario-select
    const selectsDisciplina = document.querySelectorAll('.disciplina-horario-select');
    
    selectsDisciplina.forEach(select => {
        const valorActual = select.value;
        select.innerHTML = '<option value="">Seleccionar disciplina...</option>';
        
        sistemaADAMS.configuracion.disciplinas.forEach(disciplina => {
            select.innerHTML += `
                <option value="${disciplina}">${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</option>
            `;
        });
        
        if (valorActual) {
            select.value = valorActual;
        }
    });
}

// FUNCIONES DEL M√ìDULO DE ASISTENCIAS

// Inicializar datos de asistencias si no existen
function inicializarAsistencias() {
    if (!sistemaADAMS.asistenciasEstudiantes) {
        sistemaADAMS.asistenciasEstudiantes = [];
    }
    if (!sistemaADAMS.clasesMuestra) {
        sistemaADAMS.clasesMuestra = [];
    }
}

// Establecer fecha actual al cargar asistencias
function establecerFechaAsistenciaHoy() {
    document.getElementById('fecha-asistencia').value = obtenerFechaHoy();
}

// Cargar asistencias del d√≠a seleccionado
function cargarAsistenciasDia() {
    const fecha = document.getElementById('fecha-asistencia').value;
    const filtroDisciplina = document.getElementById('filtro-disciplina').value;
    const filtroHorario = document.getElementById('filtro-horario').value;
    
    if (!fecha) {
        document.getElementById('asistencias-container').innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px;">
                <h4>üìÖ Selecciona una fecha</h4>
                <p>Elige una fecha para ver los horarios y grupos programados</p>
            </div>
        `;
        return;
    }

    // CORRECCI√ìN: Crear la fecha correctamente para evitar problemas de zona horaria
    const [a√±o, mes, dia] = fecha.split('-');
    const fechaObj = new Date(parseInt(a√±o), parseInt(mes) - 1, parseInt(dia));
    
    // Array de d√≠as en espa√±ol
    const diasSemana = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
    const diaSemana = diasSemana[fechaObj.getDay()];
    
    // Debug para verificar
    console.log(`Fecha seleccionada: ${fecha}`);
    console.log(`Fecha objeto: ${fechaObj.toDateString()}`);
    console.log(`D√≠a calculado: ${diaSemana} (√≠ndice: ${fechaObj.getDay()})`);

    // Organizar estudiantes por horario y grupo
    const horariosDelDia = organizarEstudiantesPorHorarioYGrupo(diaSemana, filtroDisciplina, filtroHorario);
    
    console.log('Horarios del d√≠a:', horariosDelDia);
    // NUEVO: Agregar clases de muestra programadas para este d√≠a
    const clasesMuestraDelDia = obtenerClasesMuestraDelDia(fecha, filtroDisciplina, filtroHorario);

    if (Object.keys(horariosDelDia).length === 0 && clasesMuestraDelDia.length === 0) {
        document.getElementById('asistencias-container').innerHTML = `
            <div style="text-align: center; color: #666; padding: 40px;">
                <h4>üö´ Sin clases programadas</h4>
                <p>No hay estudiantes programados para <strong>${diaSemana}</strong> con los filtros seleccionados</p>
                <small>Fecha: ${fechaObj.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}</small><br>
                <small>Filtros activos: Disciplina: ${filtroDisciplina || 'Todas'}, Horario: ${filtroHorario || 'Todos'}</small>
            </div>
        `;
        return;
    }

    // Generar HTML para mostrar las asistencias organizadas
    let htmlAsistencias = '';
    
    Object.keys(horariosDelDia).sort().forEach(horario => {
        const grupos = horariosDelDia[horario];
        
        htmlAsistencias += `
            <div style="background: white; border-radius: 15px; margin: 20px 0; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <h3 style="color: #9c27b0; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üïê ${horario} - ${diaSemana.toUpperCase()}
                    <small style="font-weight: normal; color: #666; margin-left: auto;">
                        ${fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' })}
                    </small>
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        `;
        
        Object.keys(grupos).sort().forEach(claveGrupo => {
    const estudiantesGrupo = grupos[claveGrupo];
    
    // Extraer disciplina y grupo de la clave
    const [disciplina, grupo] = claveGrupo.split('-');
    const disciplinaFormateada = disciplina.charAt(0).toUpperCase() + disciplina.slice(1);
    
    const entrenador = obtenerEntrenadorPorHorarioYGrupo(diaSemana, horario, grupo);
    
    htmlAsistencias += `
        <div class="grupo-asistencia" style="border: 2px solid #e3f2fd; border-radius: 10px; padding: 15px;">
            <h4 style="color: #1976d2; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                <span>${disciplinaFormateada} - Grupo ${grupo}</span>
                <small style="font-weight: normal; color: #666;">${estudiantesGrupo.length} estudiante${estudiantesGrupo.length !== 1 ? 's' : ''}</small>
            </h4>
            ${entrenador ? `<p style="margin-bottom: 15px; color: #666;"><strong>Entrenador:</strong> ${entrenador.nombre}</p>` : ''}
            
            <div class="estudiantes-grupo">
                ${estudiantesGrupo.map(estudiante => {
                    const asistenciaGuardada = obtenerAsistenciaEstudiante(estudiante.id, fecha, horario);
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                            <div>
                                <strong>${estudiante.nombre}</strong>
                                <br><small style="color: #666;">Disciplina espec√≠fica: ${disciplinaFormateada}</small>
                                <br><small style="color: #999;">Estatus: ${estudiante.estatus || 'activo'}</small>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <select class="asistencia-select" data-estudiante="${estudiante.id}" data-horario="${horario}" style="padding: 4px; border-radius: 5px;">
                                    <option value="presente" ${asistenciaGuardada.estado === 'presente' ? 'selected' : ''}>‚úÖ Presente</option>
                                    <option value="ausente" ${asistenciaGuardada.estado === 'ausente' ? 'selected' : ''}>‚ùå Ausente</option>
                                    <option value="tardanza" ${asistenciaGuardada.estado === 'tardanza' ? 'selected' : ''}>‚è∞ Tardanza</option>
                                    <option value="justificado" ${asistenciaGuardada.estado === 'justificado' ? 'selected' : ''}>üìã Justificado</option>
                                </select>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
        </div>
    `;
});
        
        // Verificar si este horario ya tiene asistencias guardadas
        const yaGuardado = verificarAsistenciasGuardadas(fecha, horario);
        const estadoGuardado = yaGuardado ? 'guardado' : 'pendiente';
        const colorEstado = yaGuardado ? '#28a745' : '#ffc107';
        const textoEstado = yaGuardado ? '‚úÖ GUARDADO' : '‚è≥ PENDIENTE';
        const iconoBoton = yaGuardado ? 'üîÑ' : 'üíæ';
        const textoBoton = yaGuardado ? 'Actualizar' : 'Guardar';

        htmlAsistencias += `
                </div>
                <div class="horario-footer" data-horario="${horario}" style="text-align: center; margin: 20px 0; padding: 15px; border-top: 2px solid #e3f2fd; background: linear-gradient(90deg, rgba(${yaGuardado ? '40,167,69' : '255,193,7'}, 0.1) 0%, rgba(255,255,255,0.1) 100%);">
                    
                    <div class="estado-guardado" style="margin-bottom: 15px;">
                        <span style="background: ${colorEstado}; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                            ${textoEstado}
                        </span>
                        ${yaGuardado ? `<small style="display: block; color: #666; margin-top: 5px;">√öltima actualizaci√≥n: ${obtenerHoraGuardado(fecha, horario)}</small>` : ''}
                    </div>
                    
                    <button class="btn btn-guardar-horario ${yaGuardado ? 'btn-warning' : 'btn-success'}" 
                            onclick="guardarAsistenciasHorario('${horario}', '${diaSemana}', '${fecha}')" 
                            data-horario="${horario}"
                            style="margin-right: 10px;">
                        ${iconoBoton} ${textoBoton} Asistencias de ${horario}
                    </button>
                    
                    <button class="btn btn-secondary" onclick="marcarTodosPresentes('${horario}')" style="font-size: 12px;">
                        ‚úÖ Marcar Todos Presentes
                    </button>
                </div>
            </div>
        `;
    });

    // NUEVO: Agregar clases de muestra al final
    if (clasesMuestraDelDia.length > 0) {
        htmlAsistencias += `
            <div style="background: #fff8e1; border: 2px solid #ffc107; border-radius: 15px; margin: 20px 0; padding: 20px; box-shadow: 0 5px 15px rgba(255,193,7,0.2);">
                <h3 style="color: #f57c00; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                    üéØ CLASES DE MUESTRA - ${diaSemana.toUpperCase()}
                    <small style="font-weight: normal; color: #666; margin-left: auto;">
                        ${fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' })}
                    </small>
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
        `;
        
        clasesMuestraDelDia.forEach(clase => {
            const estadoColor = clase.estado === 'realizada' ? '#4caf50' : '#ff9800';
            const estadoTexto = clase.estado === 'realizada' ? '‚úÖ Realizada' : '‚è≥ Programada';
            
            htmlAsistencias += `
                <div class="grupo-asistencia" style="border: 2px solid #ffc107; border-radius: 10px; padding: 15px; background: white;">
                    <h4 style="color: #f57c00; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span>${clase.disciplina.charAt(0).toUpperCase() + clase.disciplina.slice(1)} - CLASE MUESTRA</span>
                        <small style="font-weight: normal; color: #666;">üë§ Prospecto</small>
                    </h4>
                    <p style="margin-bottom: 10px;"><strong>Horario:</strong> ${clase.horario}</p>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <div>
                                <strong>${clase.nombre}</strong>
                                ${clase.edad ? `<br><small style="color: #666;">Edad: ${clase.edad} a√±os</small>` : ''}
                                ${clase.telefono ? `<br><small style="color: #666;">Tel: ${clase.telefono}</small>` : ''}
                                ${clase.observaciones ? `<br><small style="color: #999;">${clase.observaciones}</small>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                                <select class="muestra-estado-select" data-muestra="${clase.id}" style="padding: 8px; border-radius: 5px; border: 2px solid #ffc107; background: white;">
                                    <option value="programada" ${clase.estado === 'programada' ? 'selected' : ''}>‚è≥ Programada</option>
                                    <option value="realizada" ${clase.estado === 'realizada' ? 'selected' : ''}>‚úÖ Realizada</option>
                                    <option value="cancelada" ${clase.estado === 'cancelada' ? 'selected' : ''}>‚ùå Cancelada</option>
                                    <option value="convertida" ${clase.estado === 'convertida' ? 'selected' : ''}>üéâ Convertida</option>
                                </select>
                                <button class="btn btn-primary btn-small" onclick="convertirAEstudiante(${clase.id})" style="font-size: 11px;">
                                    üéì Convertir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        htmlAsistencias += `
                </div>
            </div>
        `;
    }

    document.getElementById('asistencias-container').innerHTML = htmlAsistencias;
}

function verificarAsistenciasGuardadas(fecha, horario) {
    try {
        const asistenciasGuardadas = JSON.parse(localStorage.getItem('asistenciasPorHorario') || '[]');
        return asistenciasGuardadas.some(a => a.fecha === fecha && a.horario === horario);
    } catch (error) {
        return false;
    }
}

function obtenerHoraGuardado(fecha, horario) {
    try {
        const asistenciasGuardadas = JSON.parse(localStorage.getItem('asistenciasPorHorario') || '[]');
        const asistencia = asistenciasGuardadas.find(a => a.fecha === fecha && a.horario === horario);
        
        if (asistencia && asistencia.timestamp) {
            const fechaGuardado = new Date(asistencia.timestamp);
            return fechaGuardado.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        return 'No disponible';
    } catch (error) {
        return 'Error';
    }
}


function guardarAsistenciasHorario(horario, diaSemana, fecha) {
    try {
        console.log(`Guardando asistencias para horario: ${horario} del ${fecha}`);
        
        // Encontrar el bot√≥n y el contenedor
        const botonGuardar = document.querySelector(`button[data-horario="${horario}"]`);
        const contenedorFooter = document.querySelector(`div[data-horario="${horario}"]`);
        
        // Mostrar estado de carga
        if (botonGuardar) {
            botonGuardar.disabled = true;
            botonGuardar.innerHTML = '‚è≥ Guardando...';
            botonGuardar.style.opacity = '0.7';
        }
        
        // Recopilar asistencias
        const selectsAsistencia = document.querySelectorAll(`select[data-horario="${horario}"]`);
        const asistenciasHorario = [];
        
        selectsAsistencia.forEach(select => {
            const estudianteId = select.dataset.estudiante;
            const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
            
            if (estudiante) {
                asistenciasHorario.push({
                    estudianteId: estudianteId,
                    nombreEstudiante: estudiante.nombre,
                    fecha: fecha,
                    horario: horario,
                    diaSemana: diaSemana,
                    estado: select.value,
                    timestamp: new Date().toISOString()
                });
            }
        });
        
        if (asistenciasHorario.length === 0) {
            mostrarNotificacion('No hay asistencias para guardar en este horario', 'error');
            return;
        }
        
        // Guardar datos (tu l√≥gica existente)
        let asistenciasGuardadas = JSON.parse(localStorage.getItem('asistenciasPorHorario') || '[]');
        asistenciasGuardadas = asistenciasGuardadas.filter(a => 
            !(a.fecha === fecha && a.horario === horario)
        );
        asistenciasGuardadas.push(...asistenciasHorario);
        localStorage.setItem('asistenciasPorHorario', JSON.stringify(asistenciasGuardadas));
        
        // Actualizar sistema principal
        if (!sistemaADAMS.asistenciasEstudiantes) {
            sistemaADAMS.asistenciasEstudiantes = [];
        }
        sistemaADAMS.asistenciasEstudiantes = sistemaADAMS.asistenciasEstudiantes.filter(a => 
            !(a.fecha === fecha && a.horario === horario)
        );
        sistemaADAMS.asistenciasEstudiantes.push(...asistenciasHorario);
        localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
        
        // ACTUALIZAR INTERFAZ VISUAL
        setTimeout(() => {
            const horaActual = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            if (contenedorFooter) {
                // Actualizar el indicador de estado
                const estadoGuardado = contenedorFooter.querySelector('.estado-guardado');
                if (estadoGuardado) {
                    estadoGuardado.innerHTML = `
                        <span style="background: #28a745; color: white; padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: bold;">
                            ‚úÖ GUARDADO
                        </span>
                        <small style="display: block; color: #666; margin-top: 5px;">√öltima actualizaci√≥n: ${horaActual}</small>
                    `;
                }
                
                // Cambiar el fondo del footer
                contenedorFooter.style.background = 'linear-gradient(90deg, rgba(40,167,69, 0.1) 0%, rgba(255,255,255,0.1) 100%)';
            }
            
            if (botonGuardar) {
                botonGuardar.disabled = false;
                botonGuardar.innerHTML = 'üîÑ Actualizar Asistencias de ' + horario;
                botonGuardar.className = 'btn btn-guardar-horario btn-warning';
                botonGuardar.style.opacity = '1';
            }
            
            mostrarNotificacion(`Asistencias del horario ${horario} guardadas exitosamente (${asistenciasHorario.length} alumnos)`, 'success');
        }, 500);
        
    } catch (error) {
        console.error('Error al guardar asistencias del horario:', error);
        mostrarNotificacion('Error al guardar asistencias del horario', 'error');
        
        // Restaurar bot√≥n en caso de error
        const botonGuardar = document.querySelector(`button[data-horario="${horario}"]`);
        if (botonGuardar) {
            botonGuardar.disabled = false;
            botonGuardar.style.opacity = '1';
        }
    }
}

function marcarTodosPresentes(horario) {
    const selectsAsistencia = document.querySelectorAll(`select[data-horario="${horario}"]`);
    let contador = 0;
    
    selectsAsistencia.forEach(select => {
        if (select.value !== 'presente') {
            select.value = 'presente';
            contador++;
        }
    });
    
    if (contador > 0) {
        mostrarNotificacion(`${contador} alumnos marcados como presentes en ${horario}`, 'success');
    } else {
        mostrarNotificacion('Todos los alumnos ya estaban marcados como presentes', 'info');
    }
}
// FUNCIONES DEL M√ìDULO DE ASISTENCIAS

// Inicializar datos de asistencias si no existen
function inicializarAsistencias() {
    if (!sistemaADAMS.asistenciasEstudiantes) {
        sistemaADAMS.asistenciasEstudiantes = [];
    }
    if (!sistemaADAMS.clasesMuestra) {
        sistemaADAMS.clasesMuestra = [];
    }
}


// Organizar estudiantes por horario y grupo
function organizarEstudiantesPorHorarioYGrupo(diaSemana, filtroDisciplina, filtroHorario) {
    const horariosDelDia = {};
    
    console.log(`Organizando estudiantes para: ${diaSemana}`);
    
    sistemaADAMS.estudiantes.forEach(estudiante => {
        // Solo estudiantes activos
        const estatus = estudiante.estatus || 'activo';
        if (estatus !== 'activo') {
            console.log(`Estudiante ${estudiante.nombre} omitido por estatus: ${estatus}`);
            return;
        }
        
        console.log(`Procesando estudiante: ${estudiante.nombre}, horarios: ${estudiante.horarios.length}`);
        
        estudiante.horarios.forEach(horario => {
            console.log(`  Horario: ${horario.dia} vs ${diaSemana}, disciplina: ${horario.disciplina}`);
            
            if (horario.dia !== diaSemana) return;
            
            // Aplicar filtros - ahora filtramos por la disciplina espec√≠fica del horario
            if (filtroDisciplina && horario.disciplina !== filtroDisciplina) return;
            
            const horarioTexto = `${horario.horaInicio}-${horario.horaFin}`;
            if (filtroHorario && horarioTexto !== filtroHorario) return;
            
            // CAMBIO PRINCIPAL: Crear clave √∫nica por disciplina + grupo
            const disciplina = horario.disciplina || 'sin-disciplina';
            const grupo = horario.grupo || 'Sin grupo';
            const claveGrupo = `${disciplina}-${grupo}`; // Ej: "gimnasia-A", "parkour-A"
            
            if (!horariosDelDia[horarioTexto]) {
                horariosDelDia[horarioTexto] = {};
            }
            
            if (!horariosDelDia[horarioTexto][claveGrupo]) {
                horariosDelDia[horarioTexto][claveGrupo] = [];
            }
            
            horariosDelDia[horarioTexto][claveGrupo].push(estudiante);
            console.log(`    ‚úì Estudiante agregado a ${horarioTexto} - ${disciplina.toUpperCase()} Grupo ${grupo}`);
        });
    });
    
    console.log('Resultado final:', horariosDelDia);
    return horariosDelDia;
}

// Obtener entrenador asignado a un horario y grupo espec√≠fico
function obtenerEntrenadorPorHorarioYGrupo(diaSemana, horario, grupo) {
    for (let entrenador of sistemaADAMS.entrenadores) {
        if (entrenador.estado !== 'activo') continue;
        
        for (let horarioEntrenador of entrenador.horarios) {
            if (horarioEntrenador.dia === diaSemana) {
                const horarioTexto = `${horarioEntrenador.horaInicio}-${horarioEntrenador.horaFin}`;
                if (horarioTexto === horario) {
                    // Verificar si maneja este grupo
                    if (horarioEntrenador.gruposAsignados && horarioEntrenador.gruposAsignados.includes(grupo)) {
                        return entrenador;
                    }
                }
            }
        }
    }
    return null;
}

// Obtener asistencia guardada de un estudiante
function obtenerAsistenciaEstudiante(estudianteId, fecha, horario) {
    const clave = `${estudianteId}-${fecha}-${horario}`;
    const asistencia = sistemaADAMS.asistenciasEstudiantes.find(a => a.clave === clave);
    return asistencia || { estado: 'presente', observacion: '' };
}

// Funci√≥n para obtener clases de muestra programadas para un d√≠a espec√≠fico
function obtenerClasesMuestraDelDia(fecha, filtroDisciplina, filtroHorario) {
    if (!sistemaADAMS.clasesMuestra) return [];
    
    return sistemaADAMS.clasesMuestra.filter(clase => {
        // Filtrar por fecha
        if (clase.fecha !== fecha) return false;
        
        // Filtrar por estado (solo programadas y realizadas)
        if (!['programada', 'realizada'].includes(clase.estado)) return false;
        
        // Aplicar filtro de disciplina
        if (filtroDisciplina && clase.disciplina !== filtroDisciplina) return false;
        
        // Aplicar filtro de horario
        if (filtroHorario && clase.horario !== filtroHorario) return false;
        
        return true;
    });
}

// Guardar todas las asistencias del d√≠a
function guardarAsistenciasDelDia() {
    const fecha = document.getElementById('fecha-asistencia').value;
    if (!fecha) {
        mostrarNotificacion('Selecciona una fecha', 'error');
        return;
    }

    let asistenciasGuardadas = 0;
    const selectsAsistencia = document.querySelectorAll('.asistencia-select');
    
    selectsAsistencia.forEach(select => {
        const estudianteId = parseInt(select.dataset.estudiante);
        const horario = select.dataset.horario;
        const estado = select.value;
        
        const clave = `${estudianteId}-${fecha}-${horario}`;
        
        // Buscar si ya existe la asistencia
        const indiceExistente = sistemaADAMS.asistenciasEstudiantes.findIndex(a => a.clave === clave);
        
        const asistencia = {
            clave: clave,
            estudianteId: estudianteId,
            fecha: fecha,
            horario: horario,
            estado: estado,
            fechaRegistro: new Date().toISOString()
        };
        
        if (indiceExistente >= 0) {
            sistemaADAMS.asistenciasEstudiantes[indiceExistente] = asistencia;
        } else {
            sistemaADAMS.asistenciasEstudiantes.push(asistencia);
        }
        
        asistenciasGuardadas++;
    });

    guardarDatos();
    // Tambi√©n guardar estados de clases de muestra
    guardarEstadosClasesMuestra();
    mostrarNotificacion(`${asistenciasGuardadas} asistencias guardadas`, 'success');
}
function guardarAsistenciasPorHorario(contenedorHorario) {
    try {
        const fecha = document.getElementById('fecha-asistencia').value;
        if (!fecha) {
            mostrarNotificacion('Selecciona una fecha primero', 'error');
            return;
        }
        
        console.log('Guardando asistencias para horario espec√≠fico...');
        
        // Obtener informaci√≥n del horario desde el contenedor
        const tituloHorario = contenedorHorario.querySelector('h4').textContent;
        const disciplina = tituloHorario.split(' - ')[0];
        const horario = tituloHorario.split(' - ')[1];
        
        // Recopilar asistencias de este horario espec√≠fico
        const filasAsistencia = contenedorHorario.querySelectorAll('tr:not(:first-child)');
        const asistenciasHorario = [];
        
        filasAsistencia.forEach(fila => {
            const estudianteId = fila.dataset.estudianteId;
            const nombreEstudiante = fila.querySelector('td:first-child').textContent.split('\n')[0];
            const selectAsistencia = fila.querySelector('select[data-tipo="asistencia"]');
            const inputObservaciones = fila.querySelector('input[data-tipo="observaciones"]');
            
            if (estudianteId && selectAsistencia) {
                asistenciasHorario.push({
                    estudianteId: estudianteId,
                    nombreEstudiante: nombreEstudiante.trim(),
                    asistencia: selectAsistencia.value,
                    observaciones: inputObservaciones ? inputObservaciones.value : '',
                    disciplina: disciplina,
                    horario: horario,
                    fecha: fecha,
                    timestamp: new Date().toISOString()
                });
            }
        });
        
        if (asistenciasHorario.length === 0) {
            mostrarNotificacion('No hay asistencias para guardar en este horario', 'error');
            return;
        }
        
        // Obtener asistencias existentes
        let asistenciasGuardadas = JSON.parse(localStorage.getItem('asistenciasDetalladas') || '[]');
        
        // Eliminar asistencias previas de este mismo horario y fecha
        asistenciasGuardadas = asistenciasGuardadas.filter(a => 
            !(a.fecha === fecha && a.disciplina === disciplina && a.horario === horario)
        );
        
        // Agregar nuevas asistencias
        asistenciasGuardadas.push(...asistenciasHorario);
        
        // Guardar en localStorage
        localStorage.setItem('asistenciasDetalladas', JSON.stringify(asistenciasGuardadas));
        
        // Tambi√©n actualizar el sistema principal si existe
        if (sistemaADAMS.asistenciasEstudiantes) {
            sistemaADAMS.asistenciasEstudiantes.push(...asistenciasHorario);
            localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
        }
        
        console.log(`Guardadas ${asistenciasHorario.length} asistencias para ${disciplina} - ${horario}`);
        mostrarNotificacion(`Asistencias del horario ${disciplina} - ${horario} guardadas exitosamente`, 'success');
        
        // Marcar visualmente que se guard√≥
        const botonGuardar = contenedorHorario.querySelector('.btn-guardar-horario');
        if (botonGuardar) {
            botonGuardar.textContent = '‚úÖ Guardado';
            botonGuardar.style.background = '#28a745';
            botonGuardar.disabled = true;
            
            // Reactivar despu√©s de 3 segundos
            setTimeout(() => {
                botonGuardar.textContent = 'üíæ Guardar Horario';
                botonGuardar.style.background = '';
                botonGuardar.disabled = false;
            }, 3000);
        }
        
    } catch (error) {
        console.error('Error al guardar asistencias del horario:', error);
        mostrarNotificacion('Error al guardar asistencias del horario', 'error');
    }
}

// Marcar todos los estudiantes como presentes
function marcarTodosPresentes() {
    const selectsAsistencia = document.querySelectorAll('.asistencia-select');
    selectsAsistencia.forEach(select => {
        select.value = 'presente';
    });
    mostrarNotificacion('Todos los estudiantes marcados como presentes', 'success');
}

// Funci√≥n para guardar estados de clases de muestra
function guardarEstadosClasesMuestra() {
    let cambiosGuardados = 0;
    
    document.querySelectorAll('.muestra-estado-select').forEach(select => {
        const muestraId = parseInt(select.dataset.muestra);
        const nuevoEstado = select.value;
        
        const clase = sistemaADAMS.clasesMuestra.find(c => c.id === muestraId);
        if (clase && clase.estado !== nuevoEstado) {
            clase.estado = nuevoEstado;
            clase.fechaModificacion = new Date().toISOString();
            cambiosGuardados++;
        }
    });
    
    if (cambiosGuardados > 0) {
        guardarDatos();
        mostrarNotificacion(`${cambiosGuardados} clases de muestra actualizadas`, 'success');
        // Actualizar tabla de clases muestra
        actualizarTablaClasesMuestra();
    }
}

// Funci√≥n para convertir prospecto a estudiante
function convertirAEstudiante(muestraId) {
    const clase = sistemaADAMS.clasesMuestra.find(c => c.id === muestraId);
    if (!clase) {
        mostrarNotificacion('Clase de muestra no encontrada', 'error');
        return;
    }
    
    if (confirm(`¬øConvertir a ${clase.nombre} en estudiante regular?`)) {
        // Cambiar a secci√≥n de estudiantes y precargar datos
        cambiarSeccion('estudiantes', document.querySelector('.nav-card[onclick*="estudiantes"]'));
        
        // Mostrar formulario con datos precargados
        mostrarFormularioEstudiante();
        
        // Precargar datos del prospecto
        document.getElementById('nombre').value = clase.nombre;
        if (clase.edad) document.getElementById('fecha-nacimiento').value = calcularFechaNacimiento(clase.edad);
        if (clase.telefono) document.getElementById('telefono').value = clase.telefono;
        
        // Preseleccionar disciplina
        document.getElementById(`disc-${clase.disciplina}`).checked = true;
        
        // Marcar clase como convertida
        clase.estado = 'convertida';
        clase.fechaConversion = new Date().toISOString();
        guardarDatos();
        
        mostrarNotificacion(`Datos de ${clase.nombre} cargados en el formulario de estudiante`, 'success');
    }
}

// Funci√≥n auxiliar para calcular fecha de nacimiento aproximada
function calcularFechaNacimiento(edad) {
    const hoy = new Date();
    const a√±oNacimiento = hoy.getFullYear() - edad;
    return `${a√±oNacimiento}-01-01`;
}
// FUNCIONES PARA CLASES DE MUESTRA

// Mostrar formulario de clase de muestra
function mostrarFormularioClaseMuestra() {
    document.getElementById('formulario-clase-muestra').classList.add('show');
    // Establecer fecha m√≠nima como hoy
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('muestra-fecha').min = hoy;
}

// Ocultar formulario de clase de muestra
function ocultarFormularioClaseMuestra() {
    document.getElementById('formulario-clase-muestra').classList.remove('show');
    document.getElementById('form-clase-muestra').reset();
    document.getElementById('muestra-horario').innerHTML = '<option value="">Seleccionar horario...</option>';
}

// Cargar horarios disponibles para clase de muestra
// Cargar horarios disponibles para clase de muestra
function cargarHorariosMuestra() {
    const disciplina = document.getElementById('muestra-disciplina').value;
    const fecha = document.getElementById('muestra-fecha').value;
    const selectHorario = document.getElementById('muestra-horario');
    
    selectHorario.innerHTML = '<option value="">Seleccionar horario...</option>';
    
    if (!disciplina || !fecha) return;
    
    // ‚úÖ CORRECCI√ìN: Crear la fecha correctamente para evitar problemas de zona horaria
    const [a√±o, mes, dia] = fecha.split('-');
    const fechaObj = new Date(parseInt(a√±o), parseInt(mes) - 1, parseInt(dia));
    const diaSemana = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'][fechaObj.getDay()];
    
    // Debug para verificar que funciona correctamente
    console.log(`Fecha seleccionada: ${fecha}`);
    console.log(`D√≠a calculado: ${diaSemana} (√≠ndice: ${fechaObj.getDay()})`);
    
    // Buscar horarios disponibles para esa disciplina y d√≠a
    const horariosDisponibles = new Set();
    
    sistemaADAMS.entrenadores.forEach(entrenador => {
        if (entrenador.estado !== 'activo') return;
        if (!entrenador.disciplinas.includes(disciplina)) return;
        
        entrenador.horarios.forEach(horario => {
            if (horario.dia === diaSemana && horario.disciplina === disciplina) {
                const horarioTexto = `${horario.horaInicio}-${horario.horaFin}`;
                horariosDisponibles.add(horarioTexto);
            }
        });
    });
    
    // Agregar horarios al select
    Array.from(horariosDisponibles).sort().forEach(horario => {
        selectHorario.innerHTML += `<option value="${horario}">${horario}</option>`;
    });
    
    if (horariosDisponibles.size === 0) {
        selectHorario.innerHTML += '<option value="">No hay horarios disponibles para este d√≠a</option>';
    }
}

// Guardar clase de muestra
function guardarClaseMuestra(event) {
    event.preventDefault();
    
    const nuevaClaseMuestra = {
        id: Date.now(),
        nombre: formatearNombrePropio(document.getElementById('muestra-nombre').value),
        edad: document.getElementById('muestra-edad').value || null,
        telefono: document.getElementById('muestra-telefono').value,
        disciplina: document.getElementById('muestra-disciplina').value,
        fecha: document.getElementById('muestra-fecha').value,
        horario: document.getElementById('muestra-horario').value,
        observaciones: document.getElementById('muestra-observaciones').value,
        estado: 'programada',
        fechaCreacion: new Date().toISOString()
    };
    
    sistemaADAMS.clasesMuestra.push(nuevaClaseMuestra);
    guardarDatos();
    
    mostrarNotificacion('Clase de muestra agendada exitosamente', 'success');
    ocultarFormularioClaseMuestra();
    actualizarTablaClasesMuestra();
}
// Actualizar tabla de clases de muestra
function actualizarTablaClasesMuestra() {
    const tbody = document.getElementById('tabla-clases-muestra');
    const filtro = document.getElementById('filtro-periodo-muestra')?.value || 'todas';
    
    if (!sistemaADAMS.clasesMuestra || sistemaADAMS.clasesMuestra.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                    No hay clases de muestra programadas
                </td>
            </tr>
        `;
        return;
    }
    
    // Filtrar clases seg√∫n el filtro seleccionado
    let clasesFiltradas = sistemaADAMS.clasesMuestra;
    
    if (filtro !== 'todas') {
        clasesFiltradas = sistemaADAMS.clasesMuestra.filter(clase => clase.estado === filtro);
    }
    
    if (clasesFiltradas.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                    No hay clases de muestra con el filtro seleccionado
                </td>
            </tr>
        `;
        return;
    }
    
    // Ordenar por fecha m√°s reciente
    clasesFiltradas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    tbody.innerHTML = clasesFiltradas.map(clase => {
        const estadoBadge = {
            'programada': '<span class="status status-warning">üü° Programada</span>',
            'realizada': '<span class="status status-active">üü¢ Realizada</span>',
            'convertida': '<span class="status status-active">üü¢ Convertida</span>',
            'cancelada': '<span class="status status-inactive">üî¥ Cancelada</span>'
        }[clase.estado] || '<span class="status status-warning">üü° Programada</span>';
        
        return `
            <tr>
                <td>
                    <strong>${clase.nombre}</strong>
                    ${clase.edad ? `<br><small style="color: #666;">Edad: ${clase.edad} a√±os</small>` : ''}
                </td>
                <td>${clase.disciplina.charAt(0).toUpperCase() + clase.disciplina.slice(1)}</td>
                <td>
                    <strong>${formatearFecha(clase.fecha)}</strong><br>
                    <small>${clase.horario}</small>
                </td>
                <td>
                    ${clase.telefono ? `üìû ${clase.telefono}` : 'Sin tel√©fono'}
                </td>
                <td>${estadoBadge}</td>
                <td>
                    <button class="btn btn-secondary btn-small" onclick="cambiarEstadoClaseMuestra(${clase.id})" style="margin-bottom: 5px;">
                        Cambiar Estado
                    </button><br>
                    <button class="btn btn-danger btn-small" onclick="eliminarClaseMuestra(${clase.id})">
                        Eliminar
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}
// Cambiar estado de clase de muestra
function cambiarEstadoClaseMuestra(id) {
    const clase = sistemaADAMS.clasesMuestra.find(c => c.id === id);
    if (!clase) return;
    
    const nuevoEstado = prompt(
        `Cambiar estado de la clase de muestra de ${clase.nombre}\n\nOpciones:\n- programada\n- realizada\n- convertida\n- cancelada\n\nEstado actual: ${clase.estado}`,
        clase.estado
    );
    
    if (nuevoEstado && ['programada', 'realizada', 'convertida', 'cancelada'].includes(nuevoEstado.toLowerCase())) {
        clase.estado = nuevoEstado.toLowerCase();
        guardarDatos();
        actualizarTablaClasesMuestra();
        mostrarNotificacion(`Estado cambiado a: ${nuevoEstado.toUpperCase()}`, 'success');
    } else if (nuevoEstado !== null) {
        mostrarNotificacion('Estado no v√°lido. Use: programada, realizada, convertida o cancelada', 'error');
    }
}

// Eliminar clase de muestra
function eliminarClaseMuestra(id) {
    if (confirm('¬øEst√°s seguro de eliminar esta clase de muestra?')) {
        sistemaADAMS.clasesMuestra = sistemaADAMS.clasesMuestra.filter(c => c.id !== id);
        guardarDatos();
        actualizarTablaClasesMuestra();
        mostrarNotificacion('Clase de muestra eliminada', 'success');
    }
}
// FUNCIONES PARA REPORTES DE ASISTENCIA

// Generar reporte de asistencia
function generarReporteAsistencia() {
    const tipoReporte = document.getElementById('tipo-reporte-asistencia').value;
    const periodo = document.getElementById('periodo-reporte-asistencia').value;
    
    // Mostrar campos de fechas personalizadas si es necesario
    if (periodo === 'personalizado') {
        document.getElementById('fechas-personalizadas').style.display = 'block';
    } else {
        document.getElementById('fechas-personalizadas').style.display = 'none';
    }
    
    const fechas = calcularFechasPeriodoAsistencia(periodo);
    if (!fechas) return;
    
    const reporteContainer = document.getElementById('reporte-asistencia-container');
    let reporteHTML = '';
    
    switch (tipoReporte) {
        case 'general':
            reporteHTML = generarReporteGeneral(fechas);
            break;
        case 'por-estudiante':
            reporteHTML = generarReportePorEstudiante(fechas);
            break;
        case 'por-grupo':
            reporteHTML = generarReportePorGrupo(fechas);
            break;
        case 'por-entrenador':
            reporteHTML = generarReportePorEntrenador(fechas);
            break;
        case 'por-disciplina':
            reporteHTML = generarReportePorDisciplina(fechas);
            break;
        default:
            reporteHTML = generarReporteGeneral(fechas);
    }
    
    reporteContainer.innerHTML = reporteHTML;
}

// Calcular fechas del per√≠odo para asistencia
function calcularFechasPeriodoAsistencia(periodo) {
    const hoy = new Date();
    let inicio, fin;

    switch(periodo) {
        case 'semana-actual':
            const inicioSemana = new Date(hoy);
            inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes
            inicio = inicioSemana;
            fin = hoy;
            break;
        case 'mes-actual':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = hoy;
            break;
        case 'mes-anterior':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
            break;
        case 'personalizado':
            const fechaDesde = document.getElementById('fecha-desde').value;
            const fechaHasta = document.getElementById('fecha-hasta').value;
            if (!fechaDesde || !fechaHasta) {
                mostrarNotificacion('Selecciona las fechas del per√≠odo personalizado', 'error');
                return null;
            }
            inicio = new Date(fechaDesde);
            fin = new Date(fechaHasta);
            break;
        default:
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = hoy;
    }

    return { inicio, fin };
}

// Generar reporte general
function generarReporteGeneral(fechas) {
    const asistenciasPeriodo = sistemaADAMS.asistenciasEstudiantes.filter(a => {
        const fechaAsistencia = new Date(a.fecha);
        return fechaAsistencia >= fechas.inicio && fechaAsistencia <= fechas.fin;
    });
    
    const totalClases = asistenciasPeriodo.length;
    const presentes = asistenciasPeriodo.filter(a => a.estado === 'presente').length;
    const ausentes = asistenciasPeriodo.filter(a => a.estado === 'ausente').length;
    const tardanzas = asistenciasPeriodo.filter(a => a.estado === 'tardanza').length;
    const justificados = asistenciasPeriodo.filter(a => a.estado === 'justificado').length;
    
    const porcentajeAsistencia = totalClases > 0 ? ((presentes + tardanzas) / totalClases * 100).toFixed(1) : 0;
    
    return `
        <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h3 style="color: #9c27b0; margin-bottom: 20px; text-align: center;">üìä Reporte General de Asistencias</h3>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Per√≠odo: ${formatearFecha(fechas.inicio)} - ${fechas.fin.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="text-align: center; padding: 20px; background: #e8f5e8; border-radius: 10px;">
                    <h4 style="color: #2e7d32; font-size: 24px; margin-bottom: 5px;">${presentes}</h4>
                    <p style="color: #2e7d32;">Presentes</p>
                </div>
                <div style="text-align: center; padding: 20px; background: #fff3e0; border-radius: 10px;">
                    <h4 style="color: #f57c00; font-size: 24px; margin-bottom: 5px;">${tardanzas}</h4>
                    <p style="color: #f57c00;">Tardanzas</p>
                </div>
                <div style="text-align: center; padding: 20px; background: #ffebee; border-radius: 10px;">
                    <h4 style="color: #d32f2f; font-size: 24px; margin-bottom: 5px;">${ausentes}</h4>
                    <p style="color: #d32f2f;">Ausentes</p>
                </div>
                <div style="text-align: center; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                    <h4 style="color: #1976d2; font-size: 24px; margin-bottom: 5px;">${justificados}</h4>
                    <p style="color: #1976d2;">Justificados</p>
                </div>
            </div>
            
            <div style="text-align: center; background: linear-gradient(135deg, #9c27b0, #e91e63); color: white; padding: 20px; border-radius: 15px;">
                <h2 style="font-size: 36px; margin-bottom: 10px;">${porcentajeAsistencia}%</h2>
                <p style="font-size: 18px;">Porcentaje General de Asistencia</p>
                <small>Total de registros: ${totalClases}</small>
            </div>
        </div>
    `;
}
// Generar reporte por estudiante
function generarReportePorEstudiante(fechas) {
    // Cargar datos completos del sistema
    const datosCompletos = JSON.parse(localStorage.getItem('sistemaADAMS')) || { estudiantes: [], asistenciasEstudiantes: [] };
    const estudiantesConAsistencia = {};
    
    datosCompletos.asistenciasEstudiantes.forEach(asistencia => {
        const fechaAsistencia = new Date(asistencia.fecha);
        if (fechaAsistencia >= fechas.inicio && fechaAsistencia <= fechas.fin) {
            if (!estudiantesConAsistencia[asistencia.estudianteId]) {
                // Cargar datos completos del sistema
const datosCompletos = JSON.parse(localStorage.getItem('sistemaADAMS')) || { estudiantes: [], asistenciasEstudiantes: [] };
const estudiante = datosCompletos.estudiantes.find(e => e.id == asistencia.estudianteId);
                estudiantesConAsistencia[asistencia.estudianteId] = {
                    estudiante: estudiante,
                    total: 0,
                    presente: 0,
                    ausente: 0,
                    tardanza: 0,
                    justificado: 0
                };
            }
            
            estudiantesConAsistencia[asistencia.estudianteId].total++;
            estudiantesConAsistencia[asistencia.estudianteId][asistencia.estado]++;
        }
    });

    let tablaHTML = `
        <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h3 style="color: #9c27b0; margin-bottom: 20px; text-align: center;">üë• Reporte por Estudiante</h3>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Per√≠odo: ${fechas.inicio.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })} - ${fechas.fin.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}
            </p>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Estudiante</th>
                            <th>Total Clases</th>
                            <th>Presente</th>
                            <th>Tardanza</th>
                            <th>Ausente</th>
                            <th>Justificado</th>
                            <th>% Asistencia</th>
                        </tr>
                    </thead>
                    <tbody>
    `;

    Object.values(estudiantesConAsistencia).forEach(datos => {
        const porcentaje = datos.total > 0 ? ((datos.presente + datos.tardanza) / datos.total * 100).toFixed(1) : 0;
        const colorPorcentaje = porcentaje >= 85 ? '#2e7d32' : porcentaje >= 70 ? '#f57c00' : '#d32f2f';
        
        tablaHTML += `
            <tr>
                <td><strong>${datos.estudiante ? datos.estudiante.nombre : 'Estudiante eliminado'}</strong></td>
                <td>${datos.total}</td>
                <td style="color: #2e7d32;">${datos.presente}</td>
                <td style="color: #f57c00;">${datos.tardanza}</td>
                <td style="color: #d32f2f;">${datos.ausente}</td>
                <td style="color: #1976d2;">${datos.justificado}</td>
                <td style="color: ${colorPorcentaje}; font-weight: bold;">${porcentaje}%</td>
            </tr>
        `;
    });

    tablaHTML += `
                    </tbody>
                </table>
            </div>
        </div>
    `;

    return tablaHTML;
}

// Generar reporte por grupo
function generarReportePorGrupo(fechas) {
    const gruposData = {};
    
    sistemaADAMS.asistenciasEstudiantes.forEach(asistencia => {
        const fechaAsistencia = new Date(asistencia.fecha);
        if (fechaAsistencia >= fechas.inicio && fechaAsistencia <= fechas.fin) {
            // Cargar datos completos del sistema
const datosCompletos = JSON.parse(localStorage.getItem('sistemaADAMS')) || { estudiantes: [], asistenciasEstudiantes: [] };
const estudiante = datosCompletos.estudiantes.find(e => e.id === asistencia.estudianteId);
            if (!estudiante) return;
            
            // Buscar el grupo del estudiante para este horario
            const horarioEstudiante = estudiante.horarios.find(h => 
                `${h.horaInicio}-${h.horaFin}` === asistencia.horario
            );
            
            const grupo = horarioEstudiante ? horarioEstudiante.grupo : 'Sin grupo';
            
            if (!gruposData[grupo]) {
                gruposData[grupo] = {
                    total: 0,
                    presente: 0,
                    ausente: 0,
                    tardanza: 0,
                    justificado: 0
                };
            }
            
            gruposData[grupo].total++;
            gruposData[grupo][asistencia.estado]++;
        }
    });

    let reporteHTML = `
        <div style="background: white; border-radius: 15px; padding: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
            <h3 style="color: #9c27b0; margin-bottom: 20px; text-align: center;">üéØ Reporte por Grupo</h3>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Per√≠odo: ${formatearFecha(fechas.inicio)} - ${formatearFecha(fechas.fin)}
            </p>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
    `;

    Object.entries(gruposData).forEach(([grupo, datos]) => {
        const porcentaje = datos.total > 0 ? ((datos.presente + datos.tardanza) / datos.total * 100).toFixed(1) : 0;
        const colorFondo = porcentaje >= 85 ? '#e8f5e8' : porcentaje >= 70 ? '#fff3e0' : '#ffebee';
        const colorTexto = porcentaje >= 85 ? '#2e7d32' : porcentaje >= 70 ? '#f57c00' : '#d32f2f';
        
        reporteHTML += `
            <div style="background: ${colorFondo}; border-radius: 10px; padding: 20px; text-align: center;">
                <h4 style="color: ${colorTexto}; margin-bottom: 15px;">Grupo ${grupo}</h4>
                <div style="font-size: 32px; font-weight: bold; color: ${colorTexto}; margin-bottom: 10px;">
                    ${porcentaje}%
                </div>
                <div style="font-size: 14px; color: #666;">
                    ${datos.presente} presentes<br>
                    ${datos.tardanza} tardanzas<br>
                    ${datos.ausente} ausentes<br>
                    ${datos.justificado} justificados<br>
                    <strong>Total: ${datos.total} registros</strong>
                </div>
            </div>
        `;
    });

    reporteHTML += `
            </div>
        </div>
    `;

    return reporteHTML;
}

// Funci√≥n para exportar reporte
function exportarReporteAsistencia() {
    const tipoReporte = document.getElementById('tipo-reporte-asistencia').value;
    const periodo = document.getElementById('periodo-reporte-asistencia').value;
    const fechas = calcularFechasPeriodoAsistencia(periodo);
    
    if (!fechas) {
        mostrarNotificacion('Error al calcular el per√≠odo', 'error');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    
    // Configuraci√≥n del PDF
    pdf.setFontSize(18);
    pdf.text('Academia de Gimnasia ADAMS', 105, 20, { align: 'center' });
    pdf.setFontSize(14);
    pdf.text('Reporte de Asistencias', 105, 32, { align: 'center' });
    pdf.setFontSize(10);
    pdf.text(`Per√≠odo: ${fechas.inicio.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })} - ${fechas.fin.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' })}`, 105, 42, { align: 'center' });
    
    let yPosition = 50;
    
    if (tipoReporte === 'por-estudiante') {
        const estudianteEspecifico = document.getElementById('estudiante-especifico').value;
        
        if (estudianteEspecifico) {
            // Reporte de estudiante espec√≠fico
            yPosition = generarPDFEstudianteEspecifico(pdf, estudianteEspecifico, fechas, yPosition);
        } else {
            // Reporte de todos los estudiantes
            yPosition = generarPDFTodosEstudiantes(pdf, fechas, yPosition);
        }
    } else {
        // Otros tipos de reporte
        pdf.text('Tipo de reporte: ' + tipoReporte, 20, yPosition);
        yPosition += 20;
        pdf.text('Funcionalidad en desarrollo para este tipo de reporte', 20, yPosition);
    }
    
    const nombreArchivo = `reporte_asistencias_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(nombreArchivo);
    mostrarNotificacion('Reporte exportado exitosamente', 'success');
}

// Nueva funci√≥n para manejar el cambio de tipo de reporte
function manejarCambioTipoReporte() {
    const tipoReporte = document.getElementById('tipo-reporte-asistencia').value;
    const selectorEstudiante = document.getElementById('selector-estudiante');
    
    if (tipoReporte === 'por-estudiante') {
        selectorEstudiante.style.display = 'block';
        cargarEstudiantesEnSelector();
    } else {
        selectorEstudiante.style.display = 'none';
    }
    
    generarReporteAsistencia();
}

// Funci√≥n para cargar estudiantes en el selector
function cargarEstudiantesEnSelector() {
    const datosCompletos = JSON.parse(localStorage.getItem('sistemaADAMS')) || { estudiantes: [] };
    const selector = document.getElementById('estudiante-especifico');
    
    selector.innerHTML = '<option value="">Todos los estudiantes</option>';
    
    datosCompletos.estudiantes
        .filter(estudiante => estudiante.estatus === 'activo')
        .sort((a, b) => a.nombre.localeCompare(b.nombre))
        .forEach(estudiante => {
            const option = document.createElement('option');
            option.value = estudiante.id;
            option.textContent = estudiante.nombre;
            selector.appendChild(option);
        });
}

// Funci√≥n para generar PDF de estudiante espec√≠fico
function generarPDFEstudianteEspecifico(pdf, estudianteId, fechas, yPosition) {
    const datosCompletos = JSON.parse(localStorage.getItem('sistemaADAMS')) || { estudiantes: [], asistenciasEstudiantes: [] };
    const estudiante = datosCompletos.estudiantes.find(e => e.id == estudianteId);
    
    if (!estudiante) {
        pdf.setTextColor(255, 0, 0);
        pdf.text('Estudiante no encontrado', 20, yPosition);
        return yPosition + 2;
    }
    
    // Header estudiante
    pdf.setFillColor(156, 39, 176);
    pdf.rect(15, yPosition, 180, 10, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(9);
    pdf.text('INFORMACI√ìN DEL ESTUDIANTE', 105, yPosition + 6, { align: 'center' });
    
    yPosition += 16;
    
    // Nombre del estudiante m√°s grande y en negritas
    pdf.setTextColor(0, 0, 0);
    pdf.setFontSize(13);
    pdf.setFont('helvetica', 'bold');
    pdf.text(`Estudiante: ${estudiante.nombre}`, 20, yPosition);
    
    yPosition += 7;
    
    // Resto de informaci√≥n normal
    pdf.setFont('helvetica', 'normal');
    pdf.setFontSize(8);
    pdf.text(`Tutor: ${estudiante.tutor || 'No especificado'}`, 20, yPosition);
    
    yPosition += 6;
    
    pdf.text(`Disciplinas: ${(estudiante.disciplinas || []).join(', ')}`, 20, yPosition);
    
    yPosition += 4;
    
    // C√°lculos de datos
    const horariosEstudiante = estudiante.horarios || [];
    if (horariosEstudiante.length === 0) {
        pdf.setTextColor(255, 87, 34);
        pdf.text('Este estudiante no tiene horarios asignados', 20, yPosition);
        return yPosition + 10;
    }
    
    const diasProgramados = generarDiasProgramados(fechas, horariosEstudiante);
    const asistenciasRegistradas = datosCompletos.asistenciasEstudiantes.filter(asistencia => {
        const fechaAsistencia = new Date(asistencia.fecha);
        return asistencia.estudianteId == estudianteId && 
               fechaAsistencia >= fechas.inicio && 
               fechaAsistencia <= fechas.fin;
    });
    
    let presente = 0, ausente = 0, tardanza = 0, justificado = 0;
    diasProgramados.forEach(diaProgramado => {
        const asistencia = asistenciasRegistradas.find(a => 
            a.fecha === diaProgramado.fecha && a.horario === diaProgramado.horario
        );
        
        if (asistencia) {
            if (asistencia.estado === 'presente') presente++;
            else if (asistencia.estado === 'tardanza') tardanza++;
            else if (asistencia.estado === 'justificado') justificado++;
            else ausente++;
        } else {
            ausente++;
        }
    });
    
    const total = diasProgramados.length;
    const porcentaje = total > 0 ? ((presente + tardanza) / total * 100).toFixed(1) : 0;
    
    // Header resumen
    pdf.setFillColor(46, 125, 50);
    pdf.rect(15, yPosition, 180, 10, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(9);
    pdf.text('RESUMEN DE ASISTENCIAS', 105, yPosition + 6, { align: 'center' });
    
    yPosition += 14;
    
    // Estad√≠sticas con espaciado corregido
    pdf.setFontSize(8);
    pdf.setTextColor(0, 0, 0);
    
    // Primera fila con espacio suficiente
    pdf.text(`Total: ${total} clases`, 20, yPosition);
    pdf.setTextColor(46, 125, 50);
    pdf.text(`Presente: ${presente}`, 80, yPosition);
    pdf.setTextColor(255, 152, 0);
    pdf.text(`Tardanza: ${tardanza}`, 140, yPosition);
    
    yPosition += 6;
    
    // Segunda fila
    pdf.setTextColor(244, 67, 54);
    pdf.text(`Ausente: ${ausente}`, 20, yPosition);
    pdf.setTextColor(33, 150, 243);
    pdf.text(`Justificado: ${justificado}`, 80, yPosition);
    
    // Porcentaje destacado
    const colorPorcentaje = porcentaje >= 85 ? [46, 125, 50] : porcentaje >= 70 ? [255, 152, 0] : [244, 67, 54];
    pdf.setTextColor(...colorPorcentaje);
    pdf.setFontSize(10);
    pdf.text(`Asistencia: ${porcentaje}%`, 140, yPosition);
    
    yPosition += 9;
    
    // Header detalle
    pdf.setFillColor(63, 81, 181);
    pdf.rect(15, yPosition, 180, 10, 'F');
    pdf.setTextColor(255, 255, 255);
    pdf.setFontSize(9);
    pdf.text('DETALLE POR FECHA', 105, yPosition + 6, { align: 'center' });
    
    yPosition += 14;
    
    // Tabla de detalles
    if (diasProgramados.length > 0) {
        pdf.setFontSize(8);
        
        // Headers de tabla con espacio suficiente
        pdf.setTextColor(80, 80, 80);
        pdf.text('FECHA', 20, yPosition);
        pdf.text('D√çA', 55, yPosition);
        pdf.text('HORARIO', 85, yPosition);
        pdf.text('ESTADO', 140, yPosition);
        
        // L√≠nea separadora
        pdf.setDrawColor(200, 200, 200);
        pdf.line(20, yPosition + 2, 190, yPosition + 2);
        
        yPosition += 10;
        
        diasProgramados.forEach((diaProgramado, index) => {
            if (yPosition > 270) {
                pdf.addPage();
                yPosition = 20;
                // Repetir headers
                pdf.setFontSize(8);
                pdf.setTextColor(80, 80, 80);
                pdf.text('FECHA', 20, yPosition);
                pdf.text('D√çA', 55, yPosition);
                pdf.text('HORARIO', 85, yPosition);
                pdf.text('ESTADO', 140, yPosition);
                pdf.line(20, yPosition + 2, 190, yPosition + 2);
                yPosition += 10;
            }
            
            const asistencia = asistenciasRegistradas.find(a => 
                a.fecha === diaProgramado.fecha && a.horario === diaProgramado.horario
            );
            
            // Fecha en formato 01-Sep
            const fechaObj = new Date(diaProgramado.fecha + 'T12:00:00');
            const dia = fechaObj.getDate().toString().padStart(2, '0');
            const mes = fechaObj.toLocaleDateString('es-ES', { month: 'short' });
            const fechaFormato = `${dia}-${mes}`;
            
            const diaCorto = fechaObj.toLocaleDateString('es-ES', { weekday: 'short' }).toUpperCase();
            const estado = asistencia ? asistencia.estado : 'ausente';
            
            // Fondo alternado
            if (index % 2 === 0) {
                pdf.setFillColor(250, 250, 250);
                pdf.rect(15, yPosition - 3, 180, 8, 'F');
            }
            
            // Datos de la fila con espaciado correcto
            pdf.setTextColor(0, 0, 0);
            pdf.setFontSize(8);
            pdf.text(fechaFormato, 20, yPosition);
            pdf.text(diaCorto, 55, yPosition);
            pdf.text(diaProgramado.horario, 85, yPosition);
            
            // Estado con color
            switch (estado) {
                case 'presente':
                    pdf.setTextColor(46, 125, 50);
                    pdf.text('PRESENTE', 140, yPosition);
                    break;
                case 'tardanza':
                    pdf.setTextColor(255, 152, 0);
                    pdf.text('TARDANZA', 140, yPosition);
                    break;
                case 'ausente':
                    pdf.setTextColor(244, 67, 54);
                    pdf.text('AUSENTE', 140, yPosition);
                    break;
                case 'justificado':
                    pdf.setTextColor(33, 150, 243);
                    pdf.text('JUSTIFICADO', 140, yPosition);
                    break;
            }
            
            yPosition += 8;
        });
    }
    
    return yPosition;
}

// Funci√≥n auxiliar para generar todos los d√≠as programados
function generarDiasProgramados(fechas, horariosEstudiante) {
    const diasProgramados = [];
    const diasSemana = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
    
    // Crear una nueva fecha para evitar modificar la original
    const fechaActual = new Date(fechas.inicio);
    const fechaFin = new Date(fechas.fin);
    
    // Iterar cada d√≠a en el rango de fechas
    while (fechaActual <= fechaFin) {
        const diaSemana = diasSemana[fechaActual.getDay()];
        
        // Verificar si el estudiante tiene clases este d√≠a
        horariosEstudiante.forEach(horario => {
            if (horario.dia === diaSemana) {
                diasProgramados.push({
                    fecha: fechaActual.toISOString().split('T')[0],
                    horario: `${horario.horaInicio}-${horario.horaFin}`,
                    dia: diaSemana,
                    fechaCompleta: new Date(fechaActual) // Guardar una copia de la fecha
                });
            }
        });
        
        // Avanzar al siguiente d√≠a
        fechaActual.setDate(fechaActual.getDate() + 1);
    }
    
    return diasProgramados.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
}

// Funci√≥n auxiliar para s√≠mbolos de estado
function getSimboloEstado(estado) {
    switch (estado) {
        case 'PRESENTE': return 'P';
        case 'TARDANZA': return 'T';
        case 'AUSENTE': return 'A';
        case 'JUSTIFICADO': return 'J';
        default: return '?';
    }
}

// Funci√≥n para generar PDF de todos los estudiantes
function generarPDFTodosEstudiantes(pdf, fechas, yPosition) {
    const datosCompletos = JSON.parse(localStorage.getItem('sistemaADAMS')) || { estudiantes: [], asistenciasEstudiantes: [] };
    const estudiantesConAsistencia = {};
    
    datosCompletos.asistenciasEstudiantes.forEach(asistencia => {
        const fechaAsistencia = new Date(asistencia.fecha);
        if (fechaAsistencia >= fechas.inicio && fechaAsistencia <= fechas.fin) {
            if (!estudiantesConAsistencia[asistencia.estudianteId]) {
                const estudiante = datosCompletos.estudiantes.find(e => e.id == asistencia.estudianteId);
                estudiantesConAsistencia[asistencia.estudianteId] = {
                    estudiante: estudiante,
                    total: 0,
                    presente: 0,
                    ausente: 0,
                    tardanza: 0,
                    justificado: 0
                };
            }
            
            estudiantesConAsistencia[asistencia.estudianteId].total++;
            estudiantesConAsistencia[asistencia.estudianteId][asistencia.estado]++;
        }
    });
    
    pdf.setFontSize(10);
    pdf.text('Resumen por estudiante:', 20, yPosition);
    yPosition += 15;
    
    Object.values(estudiantesConAsistencia).forEach(datos => {
        if (yPosition > 250) {
            pdf.addPage();
            yPosition = 20;
        }
        
        const porcentaje = datos.total > 0 ? ((datos.presente + datos.tardanza) / datos.total * 100).toFixed(1) : 0;
        const nombre = datos.estudiante ? datos.estudiante.nombre : 'Estudiante eliminado';
        
        pdf.text(`${nombre} - Total: ${datos.total} - Presente: ${datos.presente} - Asistencia: ${porcentaje}%`, 20, yPosition);
        yPosition += 10;
    });
    
    return yPosition;
}
// Manejar cambio de per√≠odo en reportes
document.addEventListener('DOMContentLoaded', function() {
    const periodoSelect = document.getElementById('periodo-reporte-asistencia');
    if (periodoSelect) {
        periodoSelect.addEventListener('change', function() {
            if (this.value === 'personalizado') {
                document.getElementById('fechas-personalizadas').style.display = 'block';
            } else {
                document.getElementById('fechas-personalizadas').style.display = 'none';
                generarReporteAsistencia();
            }
        });
    }
});
// Filtrar clases de muestra
function filtrarClasesMuestra() {
    actualizarTablaClasesMuestra();
}
// Funci√≥n para controlar que solo se seleccionen m√°ximo 2 grupos
function limitarSeleccionGrupos() {
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="grupo-"]');
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checkedBoxes = document.querySelectorAll('input[type="checkbox"][id^="grupo-"]:checked');
            
            if (checkedBoxes.length > 2) {
                this.checked = false;
                mostrarNotificacion('Solo puedes seleccionar m√°ximo 2 grupos', 'error');
            }
        });
    });
}

        function cargarHorariosEntrenador() {
            const entrenadorId = parseInt(document.getElementById('select-entrenador-horario').value);
            const container = document.getElementById('horarios-entrenador-container');
            const nuevoHorarioSection = document.getElementById('nuevo-horario-section');
            
            if (!entrenadorId) {
                container.innerHTML = `
                    <p style="text-align: center; color: #666; padding: 40px;">
                        Selecciona un entrenador para ver sus horarios asignados
                    </p>
                `;
                nuevoHorarioSection.style.display = 'none';
                return;
            }

            const entrenador = sistemaADAMS.entrenadores.find(e => e.id === entrenadorId);
            if (!entrenador) return;

            // Cargar disciplinas del entrenador
            const selectDisciplina = document.getElementById('select-disciplina-horario');
            selectDisciplina.innerHTML = '<option value="">Seleccionar disciplina...</option>';
            entrenador.disciplinas.forEach(disciplina => {
                selectDisciplina.innerHTML += `
                    <option value="${disciplina}">${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</option>
                `;
            });

            // Mostrar horarios existentes
            if (entrenador.horarios.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <h4>Sin horarios asignados</h4>
                        <p>Este entrenador a√∫n no tiene horarios asignados.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
    <h4>Horarios Asignados a ${entrenador.nombre}</h4>
    <div class="horario-grid">
        ${entrenador.horarios.map((horario, index) => `
            <div class="horario-card">
                <h5>${horario.dia.charAt(0).toUpperCase() + horario.dia.slice(1)}</h5>
                <p><strong>${horario.horaInicio} - ${horario.horaFin}</strong></p>
                <p>Disciplina: ${horario.disciplina.charAt(0).toUpperCase() + horario.disciplina.slice(1)}</p>
                <p>Nivel: ${horario.grupo}</p>
                <p>Grupos asignados: ${horario.gruposAsignados ? horario.gruposAsignados.join(', ') : 'Sin grupos'}</p>
                <p>Capacidad: ${horario.capacidad} estudiantes</p>
                <button class="btn btn-danger btn-small" onclick="eliminarHorarioEntrenador(${entrenadorId}, ${index})">
                    üóëÔ∏è Eliminar
                </button>
            </div>
        `).join('')}
    </div>
`;
            }

            nuevoHorarioSection.style.display = 'block';
        }

        function asignarNuevoHorario() {
           const entrenadorId = parseInt(document.getElementById('select-entrenador-horario').value);
const disciplina = document.getElementById('nuevo-horario-disciplina').value;
const dia = document.getElementById('nuevo-horario-dia').value;
const horaInicio = document.getElementById('nuevo-horario-inicio').value;
const horaFin = document.getElementById('nuevo-horario-fin').value;
const capacidad = parseInt(document.getElementById('nuevo-horario-capacidad').value);
const grupo = document.getElementById('nuevo-horario-grupo').value;

// Obtener grupos seleccionados
const gruposSeleccionados = [];
document.querySelectorAll('input[type="checkbox"][id^="grupo-"]:checked').forEach(checkbox => {
    gruposSeleccionados.push(checkbox.value);
});

            // Validaciones
if (!entrenadorId || !disciplina || !dia || !horaInicio || !horaFin || !capacidad || !grupo) {
    mostrarNotificacion('Completa todos los campos', 'error');
    return;
}

if (gruposSeleccionados.length === 0 || gruposSeleccionados.length > 2) {
    mostrarNotificacion('Selecciona entre 1 y 2 grupos para el entrenador', 'error');
    return;
}

            if (horaInicio >= horaFin) {
                mostrarNotificacion('La hora de inicio debe ser menor que la de fin', 'error');
                return;
            }

            const entrenador = sistemaADAMS.entrenadores.find(e => e.id === entrenadorId);
            if (!entrenador) return;

            // Verificar conflictos de horario
            const conflicto = entrenador.horarios.find(h => 
                h.dia === dia && 
                ((horaInicio >= h.horaInicio && horaInicio < h.horaFin) ||
                 (horaFin > h.horaInicio && horaFin <= h.horaFin) ||
                 (horaInicio <= h.horaInicio && horaFin >= h.horaFin))
            );

            if (conflicto) {
                mostrarNotificacion('El entrenador ya tiene un horario asignado en ese per√≠odo', 'error');
                return;
            }

            // Verificar que la disciplina sea v√°lida para el entrenador
            if (!entrenador.disciplinas.includes(disciplina)) {
                mostrarNotificacion('El entrenador no est√° capacitado para esa disciplina', 'error');
                return;
            }

            // Agregar nuevo horario
// Agregar nuevo horario
const nuevoHorario = {
    dia,
    horaInicio,
    horaFin,
    disciplina,
    grupo,
    capacidad,
    gruposAsignados: gruposSeleccionados // Grupos que maneja este entrenador
};

            entrenador.horarios.push(nuevoHorario);
            guardarDatos();

            mostrarNotificacion('Horario asignado exitosamente', 'success');
            
            // Limpiar formulario
document.getElementById('nuevo-horario-dia').value = '';
document.getElementById('nuevo-horario-inicio').value = '15:00';
document.getElementById('nuevo-horario-fin').value = '16:00';
document.getElementById('nuevo-horario-capacidad').value = '10';
document.getElementById('nuevo-horario-grupo').value = '';

// Limpiar checkboxes de grupos
document.querySelectorAll('input[type="checkbox"][id^="grupo-"]').forEach(checkbox => {
    checkbox.checked = false;
});
            
            // Recargar horarios
            cargarHorariosEntrenador();
        }

        function eliminarHorarioEntrenador(entrenadorId, horarioIndex) {
            if (confirm('¬øEst√°s seguro de eliminar este horario?')) {
                const entrenador = sistemaADAMS.entrenadores.find(e => e.id === entrenadorId);
                if (entrenador) {
                    entrenador.horarios.splice(horarioIndex, 1);
                    guardarDatos();
                    mostrarNotificacion('Horario eliminado', 'success');
                    cargarHorariosEntrenador();
                }
            }
        }

        // FUNCIONES DE N√ìMINA
        function establecerSemanaActual() {
    const hoy = new Date();
    const a√±o = hoy.getFullYear();
    
    // Obtener el n√∫mero de semana del a√±o
    const primerEnero = new Date(a√±o, 0, 1);
    const dias = Math.floor((hoy - primerEnero) / (24 * 60 * 60 * 1000));
    const numeroSemana = Math.ceil((dias + primerEnero.getDay() + 1) / 7);
    
    document.getElementById('semana-nomina').value = `${a√±o}-W${numeroSemana.toString().padStart(2, '0')}`;
}

        function getNumeroSemana(fecha) {
            const d = new Date(fecha);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return 1 + Math.round(((d.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        function calcularNomina() {
            const semanaInput = document.getElementById('semana-nomina').value;
            if (!semanaInput) {
                document.getElementById('tabla-nomina').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: #666; padding: 40px;">
                            Selecciona una semana para calcular la n√≥mina
                        </td>
                    </tr>
                `;
                return;
            }

            const [a√±o, semana] = semanaInput.split('-W');
            const fechaInicio = getFirstDayOfWeek(parseInt(a√±o), parseInt(semana));
            const fechaFin = new Date(fechaInicio);
            fechaFin.setDate(fechaFin.getDate() + 6);

            let totalHoras = 0;
            let totalPagar = 0;

            const tbody = document.getElementById('tabla-nomina');
            tbody.innerHTML = sistemaADAMS.entrenadores.map(entrenador => {
                // Calcular horas trabajadas por este entrenador en la semana
                const horasSemanales = calcularHorasEntrenador(entrenador, fechaInicio, fechaFin);
                const subtotal = horasSemanales * entrenador.tarifaHora;
                
                totalHoras += horasSemanales;
                totalPagar += subtotal;

                const estadoPago = obtenerEstadoPago(entrenador.id, semanaInput);

                return `
                    <tr>
                        <td>
                            <strong>${entrenador.nombre}</strong><br>
                            <small style="color: #666;">${entrenador.disciplinas.join(', ')}</small>
                        </td>
                        <td>${horasSemanales} horas</td>
                        <td>$${entrenador.tarifaHora}/hora</td>
                        <td><strong>$${subtotal.toLocaleString()}</strong></td>
                        <td>
                            <span class="status ${estadoPago === 'pagada' ? 'status-active' : 'status-warning'}">
                                ${estadoPago === 'pagada' ? 'Pagada' : 'Pendiente'}
                            </span>
                        </td>
                        <td>
                            ${estadoPago === 'pendiente' ? 
                                `<button class="btn btn-success btn-small" onclick="marcarComoPagada(${entrenador.id}, '${semanaInput}')">
                                    ‚úÖ Marcar Pagada
                                </button>` : 
                                `<button class="btn btn-secondary btn-small" onclick="marcarComoPendiente(${entrenador.id}, '${semanaInput}')">
                                    ‚Ü©Ô∏è Marcar Pendiente
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            }).join('');

            // Actualizar resumen
            document.getElementById('total-horas').textContent = `${totalHoras} horas`;
            document.getElementById('total-pagar').textContent = `$${totalPagar.toLocaleString()}`;
        }

        function getFirstDayOfWeek(a√±o, semana) {
            const enero4 = new Date(a√±o, 0, 4);
            const dias = (semana - 1) * 7 - enero4.getDay() + 1;
            return new Date(a√±o, 0, 4 + dias);
        }

        function calcularHorasEntrenador(entrenador, fechaInicio, fechaFin) {
            // Por ahora, calculamos basado en horarios asignados
            // En una implementaci√≥n completa, esto se basar√≠a en asistencias reales
            let horasSemanales = 0;
            
            entrenador.horarios.forEach(horario => {
                const horaInicio = new Date(`2000-01-01 ${horario.horaInicio}`);
                const horaFin = new Date(`2000-01-01 ${horario.horaFin}`);
                const duracion = (horaFin - horaInicio) / (1000 * 60 * 60); // horas
                horasSemanales += duracion;
            });

            return horasSemanales;
        }

        function obtenerEstadoPago(entrenadorId, semana) {
            // Verificar en localStorage si este pago ya fue marcado como realizado
            const pagos = JSON.parse(localStorage.getItem('pagosRealizados') || '{}');
            const clave = `${entrenadorId}-${semana}`;
            return pagos[clave] || 'pendiente';
        }

        function marcarComoPagada(entrenadorId, semana) {
            const pagos = JSON.parse(localStorage.getItem('pagosRealizados') || '{}');
            const clave = `${entrenadorId}-${semana}`;
            pagos[clave] = 'pagada';
            localStorage.setItem('pagosRealizados', JSON.stringify(pagos));
            
            mostrarNotificacion('Pago marcado como realizado', 'success');
            calcularNomina();
        }

        function marcarComoPendiente(entrenadorId, semana) {
            const pagos = JSON.parse(localStorage.getItem('pagosRealizados') || '{}');
            const clave = `${entrenadorId}-${semana}`;
            pagos[clave] = 'pendiente';
            localStorage.setItem('pagosRealizados', JSON.stringify(pagos));
            
            mostrarNotificacion('Pago marcado como pendiente', 'success');
            calcularNomina();
        }

        // FUNCIONES DE ASISTENCIAS DE ENTRENADORES
        function establecerFechaHoy() {
    document.getElementById('fecha-asistencia-entrenador').value = obtenerFechaHoy();
}

        function cargarAsistenciasEntrenadores() {
    const fecha = document.getElementById('fecha-asistencia-entrenador').value;
    const horarioFiltro = document.getElementById('horario-asistencia-entrenador').value;
    
    if (!fecha) {
        document.getElementById('tabla-asistencias-entrenadores').innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #666; padding: 40px;">
                    Selecciona una fecha para registrar asistencias
                </td>
            </tr>
        `;
        return;
    }

    // CORRECCI√ìN: Crear la fecha correctamente
    const [a√±o, mes, dia] = fecha.split('-');
    const fechaObj = new Date(parseInt(a√±o), parseInt(mes) - 1, parseInt(dia));
    const diasSemana = ['domingo', 'lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado'];
    const diaSemana = diasSemana[fechaObj.getDay()];
    
    console.log(`Entrenadores - Fecha: ${fecha}, D√≠a: ${diaSemana}`);

    const tbody = document.getElementById('tabla-asistencias-entrenadores');
    let horariosDelDia = [];

    // Recopilar todos los horarios de ese d√≠a correctamente
    sistemaADAMS.entrenadores.forEach(entrenador => {
        if (entrenador.estado !== 'activo') return;
        
        entrenador.horarios.forEach(horario => {
            if (horario.dia === diaSemana) {
                const horarioTexto = `${horario.horaInicio}-${horario.horaFin}`;
                if (!horarioFiltro || horarioTexto === horarioFiltro) {
                    horariosDelDia.push({
                        entrenador: entrenador,
                        horario: horario,
                        horarioTexto: horarioTexto
                    });
                }
            }
        });
    });

    if (horariosDelDia.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; color: #666; padding: 40px;">
                    No hay entrenadores programados para ${diaSemana} ${horarioFiltro ? `en el horario ${horarioFiltro}` : ''}
                    <br><small>${fechaObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}</small>
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = horariosDelDia.map((item, index) => {
        const asistenciaGuardada = obtenerAsistenciaEntrenador(item.entrenador.id, fecha, item.horario);
        const idUnico = `${item.entrenador.id}-${item.horarioTexto.replace(':', '').replace('-', '')}`;
        
        return `
            <tr>
                <td><strong>${item.entrenador.nombre}</strong></td>
                <td>${item.horario.disciplina.charAt(0).toUpperCase() + item.horario.disciplina.slice(1)}</td>
                <td>${item.horarioTexto}</td>
                <td>
                    <select id="asistencia-${idUnico}" class="asistencia-select" 
                            data-entrenador="${item.entrenador.id}" data-horario="${item.horarioTexto}">
                        <option value="presente" ${asistenciaGuardada.estado === 'presente' ? 'selected' : ''}>‚úÖ Presente</option>
                        <option value="ausente" ${asistenciaGuardada.estado === 'ausente' ? 'selected' : ''}>‚ùå Ausente</option>
                        <option value="tardanza" ${asistenciaGuardada.estado === 'tardanza' ? 'selected' : ''}>‚è∞ Tardanza</option>
                    </select>
                </td>
                <td>
                    <input type="text" id="observacion-${idUnico}" 
                           value="${asistenciaGuardada.observacion || ''}"
                           placeholder="Observaciones..." 
                           style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 5px;">
                </td>
            </tr>
        `;
    }).join('');
}

        function obtenerAsistenciaEntrenador(entrenadorId, fecha, horario) {
    const horarioTexto = typeof horario === 'string' ? horario : `${horario.horaInicio}-${horario.horaFin}`;
    const clave = `${entrenadorId}-${fecha}-${horarioTexto}`;
    const asistencias = JSON.parse(localStorage.getItem('asistenciasEntrenadores') || '{}');
    return asistencias[clave] || { estado: 'presente', observacion: '' };
}

        function guardarAsistenciasEntrenadores() {
    const fecha = document.getElementById('fecha-asistencia-entrenador').value;
    if (!fecha) {
        mostrarNotificacion('Selecciona una fecha', 'error');
        return;
    }

    const asistencias = JSON.parse(localStorage.getItem('asistenciasEntrenadores') || '{}');
    let asistenciasGuardadas = 0;

    // CORRECCI√ìN: Obtener asistencias usando los data attributes
    document.querySelectorAll('.asistencia-select').forEach((select) => {
        const entrenadorId = parseInt(select.dataset.entrenador);
        const horarioTexto = select.dataset.horario;
        
        const idSelect = select.id.replace('asistencia-', '');
        const observacion = document.getElementById(`observacion-${idSelect}`);
        
        if (observacion) {
            const clave = `${entrenadorId}-${fecha}-${horarioTexto}`;
            
            asistencias[clave] = {
                estado: select.value,
                observacion: observacion.value,
                fecha: fecha,
                entrenadorId: entrenadorId,
                horario: horarioTexto,
                fechaRegistro: new Date().toISOString()
            };
            asistenciasGuardadas++;
        }
    });

    localStorage.setItem('asistenciasEntrenadores', JSON.stringify(asistencias));
    mostrarNotificacion(`${asistenciasGuardadas} asistencias de entrenadores guardadas`, 'success');
}

        function actualizarDisciplinasEnFormularios() {
    // Actualizar checkboxes de disciplinas en formulario de estudiantes
    const containerEstudiantes = document.querySelector('#formulario-estudiante .checkbox-group');
    if (containerEstudiantes) {
        const disciplinasSeleccionadas = [];
        // Guardar las selecciones actuales
        containerEstudiantes.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            disciplinasSeleccionadas.push(cb.value);
        });
        
        containerEstudiantes.innerHTML = sistemaADAMS.configuracion.disciplinas.map(disciplina => `
            <div class="checkbox-item">
                <input type="checkbox" id="disc-${disciplina}" value="${disciplina}" ${disciplinasSeleccionadas.includes(disciplina) ? 'checked' : ''}>
                <label for="disc-${disciplina}">${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</label>
            </div>
        `).join('');
    }
    
    // Actualizar checkboxes de disciplinas en formulario de entrenadores
    const containerEntrenadores = document.querySelector('#formulario-entrenador .checkbox-group');
    if (containerEntrenadores) {
        const disciplinasSeleccionadas = [];
        // Guardar las selecciones actuales
        containerEntrenadores.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
            disciplinasSeleccionadas.push(cb.value);
        });
        
        containerEntrenadores.innerHTML = sistemaADAMS.configuracion.disciplinas.map(disciplina => `
            <div class="checkbox-item">
                <input type="checkbox" id="ent-disc-${disciplina}" value="${disciplina}" ${disciplinasSeleccionadas.includes(disciplina) ? 'checked' : ''}>
                <label for="ent-disc-${disciplina}">${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</label>
            </div>
        `).join('');
    }
    
    // Tambi√©n actualizar los selects de disciplina en horarios de estudiantes
    cargarDisciplinasEnHorarios();
}
        // FUNCIONES GENERALES
        function cargarDatos() {
    const datosGuardados = localStorage.getItem('sistemaADAMS');
    if (datosGuardados) {
        try {
            const datos = JSON.parse(datosGuardados);
            sistemaADAMS = { ...sistemaADAMS, ...datos };
        } catch (e) {
            console.error('Error al cargar datos:', e);
        }
    }
}

// Funci√≥n para formatear nombres a formato propio
function formatearNombrePropio(texto) {
    if (!texto || typeof texto !== 'string') {
        console.warn('formatearNombrePropio recibi√≥ valor inv√°lido:', texto);
        return String(texto || '');
    }
    
    const textoLimpio = texto.toString().trim();
    if (!textoLimpio) return '';
    
    try {
        return textoLimpio.split(' ')
            .filter(palabra => palabra.length > 0)
            .map(palabra => 
                palabra.charAt(0).toUpperCase() + 
                palabra.slice(1).toLowerCase()
            )
            .join(' ');
    } catch (error) {
        console.error('Error en formatearNombrePropio:', error);
        return String(texto);
    }
}

function getEstatusBadge(estatus) {
    switch(estatus) {
        case 'activo':
            return '<span class="status status-activo">üü¢ ACTIVO</span>';
        case 'inactivo':
            return '<span class="status status-inactivo">üü° INACTIVO</span>';
        case 'pendiente':
            return '<span class="status" style="background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;">üü† PENDIENTE</span>';
        case 'baja':
            return '<span class="status status-baja">üî¥ BAJA</span>';
        default:
            return '<span class="status status-activo">üü¢ ACTIVO</span>';
    }
}

       function actualizarDashboard() {
    console.log("Actualizando Dashboard...");
    
    // Verificar que sistemaADAMS est√© disponible
    if (!sistemaADAMS || !sistemaADAMS.estudiantes) {
        console.log("Sistema ADAMS no disponible");
        return;
    }
    
    // Contar estudiantes por estatus
    const totalActivos = sistemaADAMS.estudiantes.filter(e => e.estatus === 'activo').length;
    const totalPendientes = sistemaADAMS.estudiantes.filter(e => e.estatus === 'pendiente').length;
    const totalInactivos = sistemaADAMS.estudiantes.filter(e => e.estatus === 'inactivo').length;
    const totalBaja = sistemaADAMS.estudiantes.filter(e => e.estatus === 'baja').length;
    
    // Estudiantes con horarios (activos funcionales)
    const estudiantesConHorarios = sistemaADAMS.estudiantes.filter(e => 
        (e.estatus === 'activo' || e.estatus === 'pendiente') && 
        e.horarios && e.horarios.length > 0
    ).length;
    
    console.log("Estudiantes activos:", totalActivos);
    console.log("Estudiantes pendientes:", totalPendientes);
    console.log("Estudiantes inactivos:", totalInactivos);
    console.log("Estudiantes con horarios:", estudiantesConHorarios);
    
    // Contar entrenadores activos
    const entrenadoresActivos = sistemaADAMS.entrenadores.filter(e => e.estado === 'activo').length;
    
    // Calcular ingresos del mes actual
    let ingresosMes = 0;
    if (sistemaADAMS.pagos && sistemaADAMS.pagos.length > 0) {
        const hoy = new Date();
        const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        const pagosMes = sistemaADAMS.pagos.filter(pago => {
            const fechaPago = new Date(pago.fecha);
            return fechaPago >= inicioMes && fechaPago <= hoy;
        });
        ingresosMes = pagosMes.reduce((total, pago) => total + (pago.montoTotal || 0), 0);
    }
    
    // Obtener elementos del DOM
    const elementoTotalEstudiantes = document.getElementById('total-estudiantes');
    const elementoTotalEntrenadores = document.getElementById('total-entrenadores');
    const elementoIngresosMes = document.getElementById('ingresos-mes');
    const elementoEstudiantesPendientes = document.getElementById('estudiantes-pendientes');
    
    // Actualizar primera tarjeta (solo activos)
    if (elementoTotalEstudiantes) {
        elementoTotalEstudiantes.textContent = totalActivos;
    }
    
    // Actualizar segunda tarjeta (entrenadores)
    if (elementoTotalEntrenadores) {
        elementoTotalEntrenadores.textContent = entrenadoresActivos;
    }
    
    // Actualizar tercera tarjeta (ingresos)
    if (elementoIngresosMes) {
        elementoIngresosMes.textContent = `$${ingresosMes.toLocaleString()}`;
    }
    
    // Actualizar cuarta tarjeta (pendientes)
    if (elementoEstudiantesPendientes) {
        elementoEstudiantesPendientes.textContent = totalPendientes;
    }
    
    // Actualizar etiquetas
    const labelEstudiantes = elementoTotalEstudiantes?.parentNode.querySelector('.stat-label');
    const labelPendientes = elementoEstudiantesPendientes?.parentNode.querySelector('.stat-label');
    
    if (labelEstudiantes) {
        labelEstudiantes.textContent = 'Alumnos Activos';
    }
    
    if (labelPendientes) {
        labelPendientes.textContent = 'Alumnos Pendientes';
    }
    
    // Ejecutar funci√≥n de alertas si existe
    if (typeof mostrarAlertasStockBajo === 'function') {
        mostrarAlertasStockBajo();
    }
    
    console.log("Dashboard actualizado - Activos:", totalActivos, "Pendientes:", totalPendientes, "Ingresos:", ingresosMes);
}

function exportarListaEstudiantes() {
    try {
        const fecha = new Date().toISOString().split('T')[0];
        
        // Preparar datos de estudiantes
        const datosEstudiantes = sistemaADAMS.estudiantes.map(estudiante => ({
            Nombre: estudiante.nombre,
            Tutor: estudiante.tutor,
            Telefono: estudiante.telefono,
            Email: estudiante.email || 'No registrado',
            Edad: estudiante.edad,
            Disciplinas: estudiante.disciplinas.join(', '),
            Estatus: estudiante.estatus,
            Colegiatura: estudiante.colegiatura,
            'Porcentaje Beca': estudiante.porcentajeBeca || 0,
            'Es Hermano': estudiante.esHermano ? 'S√≠' : 'No',
            'Fecha Registro': new Date(estudiante.fechaRegistro).toLocaleDateString()
        }));
        
        const reporte = {
            titulo: 'Lista de Estudiantes - Academia ADAMS',
            fecha: fecha,
            totalEstudiantes: sistemaADAMS.estudiantes.length,
            estudiantesActivos: sistemaADAMS.estudiantes.filter(e => e.estatus === 'activo').length,
            estudiantesPendientes: sistemaADAMS.estudiantes.filter(e => e.estatus === 'pendiente').length,
            datos: datosEstudiantes
        };
        
        descargarJSON(reporte, `Lista_Estudiantes_${fecha}.json`);
        mostrarNotificacion('Lista de estudiantes exportada exitosamente', 'success');
        
    } catch (error) {
        console.error('Error al exportar lista de estudiantes:', error);
        mostrarNotificacion('Error al exportar lista de estudiantes', 'error');
    }
}
function exportarReporteFinanciero() {
    try {
        const fecha = new Date().toISOString().split('T')[0];
        const mesActual = new Date().getMonth();
        const a√±oActual = new Date().getFullYear();
        
        // Calcular ingresos por mes
        const ingresosPorMes = {};
        const pagosPorConcepto = {};
        
        sistemaADAMS.pagos.forEach(pago => {
            const fechaPago = new Date(pago.fecha);
            const mes = fechaPago.toISOString().substring(0, 7); // YYYY-MM
            
            if (!ingresosPorMes[mes]) ingresosPorMes[mes] = 0;
            ingresosPorMes[mes] += pago.montoTotal;
            
            if (!pagosPorConcepto[pago.concepto]) pagosPorConcepto[pago.concepto] = 0;
            pagosPorConcepto[pago.concepto] += pago.montoTotal;
        });
        
        const reporte = {
            titulo: 'Reporte Financiero - Academia ADAMS',
            fecha: fecha,
            resumen: {
                totalPagos: sistemaADAMS.pagos.length,
                ingresoTotal: sistemaADAMS.pagos.reduce((total, pago) => total + pago.montoTotal, 0),
                ingresoMesActual: ingresosPorMes[`${a√±oActual}-${String(mesActual + 1).padStart(2, '0')}`] || 0
            },
            ingresosPorMes: ingresosPorMes,
            pagosPorConcepto: pagosPorConcepto,
            detallesPagos: sistemaADAMS.pagos.map(pago => ({
                fecha: pago.fecha,
                estudiante: pago.estudiante,
                concepto: pago.concepto,
                monto: pago.montoTotal,
                metodo: pago.metodoPago
            }))
        };
        
        descargarJSON(reporte, `Reporte_Financiero_${fecha}.json`);
        mostrarNotificacion('Reporte financiero exportado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error al exportar reporte financiero:', error);
        mostrarNotificacion('Error al exportar reporte financiero', 'error');
    }
}
function descargarJSON(datos, nombreArchivo) {
    const dataStr = JSON.stringify(datos, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = nombreArchivo;
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => URL.revokeObjectURL(link.href), 1000);
}

function exportarReportesCompletos() {
    try {
        console.log("Generando reporte completo del sistema...");
        
        const fecha = new Date().toISOString().split('T')[0];
        const timestamp = new Date().toISOString();
        
        // Verificar que hay datos
        if (!sistemaADAMS) {
            mostrarNotificacion('Sistema no disponible', 'error');
            return;
        }
        
        // Calcular estad√≠sticas generales
        const estudiantes = sistemaADAMS.estudiantes || [];
        const entrenadores = sistemaADAMS.entrenadores || [];
        const pagos = sistemaADAMS.pagos || [];
        
        const estadisticas = {
            estudiantes: {
                total: estudiantes.length,
                activos: estudiantes.filter(e => e.estatus === 'activo').length,
                pendientes: estudiantes.filter(e => e.estatus === 'pendiente').length,
                inactivos: estudiantes.filter(e => e.estatus === 'inactivo').length,
                baja: estudiantes.filter(e => e.estatus === 'baja').length
            },
            entrenadores: {
                total: entrenadores.length,
                activos: entrenadores.filter(e => e.estado === 'activo').length
            },
            financiero: {
                totalPagos: pagos.length,
                ingresoTotal: pagos.reduce((total, pago) => total + (pago.montoTotal || 0), 0),
                ingresoMesActual: calcularIngresosMesActual(pagos)
            },
            disciplinas: calcularEstadisticasDisciplinas(estudiantes)
        };
        
        // Preparar datos de estudiantes con m√°s detalle
        const estudiantesDetalle = estudiantes.map(estudiante => ({
            id: estudiante.id,
            nombre: estudiante.nombre,
            tutor: estudiante.tutor,
            telefono: estudiante.telefono,
            email: estudiante.email || '',
            edad: estudiante.edad,
            fechaNacimiento: estudiante.fechaNacimiento,
            curp: estudiante.curp || '',
            disciplinas: estudiante.disciplinas || [],
            estatus: estudiante.estatus,
            colegiatura: estudiante.colegiatura,
            porcentajeBeca: estudiante.porcentajeBeca || 0,
            esHermano: estudiante.esHermano || false,
            fechaRegistro: estudiante.fechaRegistro,
            horarios: estudiante.horarios || []
        }));
        
        // Preparar datos de entrenadores
        const entrenadoresDetalle = entrenadores.map(entrenador => ({
            id: entrenador.id,
            nombre: entrenador.nombre,
            telefono: entrenador.telefono,
            email: entrenador.email,
            disciplinas: entrenador.disciplinas || [],
            tarifaHora: entrenador.tarifaHora,
            experiencia: entrenador.experiencia,
            estado: entrenador.estado,
            fechaContratacion: entrenador.fechaContratacion,
            horarios: entrenador.horarios || []
        }));
        
        // Preparar datos de pagos
        const pagosDetalle = pagos.map(pago => ({
            fecha: pago.fecha,
            estudiante: pago.estudiante,
            concepto: pago.concepto,
            montoTotal: pago.montoTotal,
            metodoPago: pago.metodoPago,
            detalles: pago.detalles || []
        }));
        
        // Crear reporte completo
        const reporteCompleto = {
            metadata: {
                titulo: 'REPORTE COMPLETO - Academia ADAMS',
                fechaGeneracion: timestamp,
                version: '1.0',
                generadoPor: 'Sistema ADAMS'
            },
            resumen: {
                fechaReporte: fecha,
                estadisticas: estadisticas
            },
            datos: {
                estudiantes: estudiantesDetalle,
                entrenadores: entrenadoresDetalle,
                pagos: pagosDetalle,
                configuracion: sistemaADAMS.configuracion || {},
                productos: sistemaADAMS.productos || []
            },
            analisis: {
                tendencias: analizarTendencias(estudiantes, pagos),
                alertas: generarAlertas(estadisticas)
            }
        };
        
        // Descargar reporte
        descargarJSON(reporteCompleto, `Reporte_Completo_Academia_Adams_${fecha}.json`);
        
        mostrarNotificacion('Reporte completo generado y descargado exitosamente', 'success');
        console.log("Reporte completo generado con √©xito");
        
    } catch (error) {
        console.error('Error al generar reporte completo:', error);
        mostrarNotificacion('Error al generar reporte completo', 'error');
    }
}

// Funciones auxiliares para el reporte completo
function calcularIngresosMesActual(pagos) {
    const hoy = new Date();
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    return pagos
        .filter(pago => {
            const fechaPago = new Date(pago.fecha);
            return fechaPago >= inicioMes && fechaPago <= hoy;
        })
        .reduce((total, pago) => total + (pago.montoTotal || 0), 0);
}

function calcularEstadisticasDisciplinas(estudiantes) {
    const disciplinas = { gimnasia: 0, parkour: 0, box: 0 };
    
    estudiantes.forEach(estudiante => {
        if (estudiante.disciplinas) {
            estudiante.disciplinas.forEach(disciplina => {
                if (disciplinas.hasOwnProperty(disciplina)) {
                    disciplinas[disciplina]++;
                }
            });
        }
    });
    
    return disciplinas;
}

function analizarTendencias(estudiantes, pagos) {
    return {
        crecimientoEstudiantes: estudiantes.length > 0 ? 'En crecimiento' : 'Sin datos',
        ingresoPromedio: pagos.length > 0 ? pagos.reduce((t, p) => t + (p.montoTotal || 0), 0) / pagos.length : 0,
        disciplinaMasPopular: Object.keys(calcularEstadisticasDisciplinas(estudiantes)).reduce((a, b) => 
            calcularEstadisticasDisciplinas(estudiantes)[a] > calcularEstadisticasDisciplinas(estudiantes)[b] ? a : b
        )
    };
}

function generarAlertas(estadisticas) {
    const alertas = [];
    
    if (estadisticas.estudiantes.pendientes > 10) {
        alertas.push('Alto n√∫mero de estudiantes pendientes');
    }
    
    if (estadisticas.estudiantes.activos < 5) {
        alertas.push('Pocos estudiantes activos');
    }
    
    if (estadisticas.financiero.ingresoMesActual === 0) {
        alertas.push('Sin ingresos registrados este mes');
    }
    
    return alertas.length > 0 ? alertas : ['Sin alertas'];
}


        function mostrarNotificacion(mensaje, tipo = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            notificationText.textContent = mensaje;
            notification.className = `notification ${tipo}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function guardarDatos() {
            localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
        }
        // Funci√≥n para crear backup manual desde la interfaz
function crearBackupManualAhora() {
    console.log('üì¶ Creando backup manual...');
    
    try {
        // PASO 1: CARGAR DATOS REALES DEL LOCALSTORAGE
        let datosReales;
        const datosGuardados = localStorage.getItem('sistemaADAMS');
        
        if (datosGuardados) {
            try {
                datosReales = JSON.parse(datosGuardados);
                console.log('‚úÖ Datos cargados del localStorage');
            } catch (e) {
                console.error('‚ùå Error al parsear datos del localStorage:', e);
                datosReales = window.sistemaADAMS || {};
            }
        } else {
            console.log('‚ö†Ô∏è No hay datos en localStorage, usando sistemaADAMS global');
            datosReales = window.sistemaADAMS || {};
        }
        
        // PASO 2: VERIFICAR Y ASEGURAR ESTRUCTURA
        if (!datosReales.estudiantes) datosReales.estudiantes = [];
        if (!datosReales.entrenadores) datosReales.entrenadores = [];
        if (!datosReales.pagos) datosReales.pagos = [];
        if (!datosReales.productos) datosReales.productos = [];
        if (!datosReales.configuracion) {
            datosReales.configuracion = { disciplinas: ['gimnasia', 'parkour', 'box'] };
        }
        
        // PASO 3: LOGGING PARA VERIFICAR DATOS
        console.log('üìä Datos que se van a respaldar:');
        console.log('- Estudiantes:', datosReales.estudiantes.length);
        console.log('- Entrenadores:', datosReales.entrenadores.length);
        console.log('- Pagos:', datosReales.pagos.length);
        console.log('- Productos:', datosReales.productos.length);
        
        // Si no hay datos, mostrar advertencia
        if (datosReales.estudiantes.length === 0 && datosReales.entrenadores.length === 0) {
            console.log('‚ö†Ô∏è ADVERTENCIA: No se encontraron datos para respaldar');
            const continuar = confirm('‚ö†Ô∏è No se encontraron estudiantes ni entrenadores.\n\n¬øCrear backup vac√≠o de todas formas?');
            if (!continuar) {
                mostrarNotificacion('Backup cancelado', 'error');
                return;
            }
        }
        
        // PASO 4: GENERAR TIMESTAMP
        const fecha = new Date();
        const timestamp = fecha.toISOString().replace(/[:.]/g, '-').split('T')[0] + '_' + 
                         fecha.toTimeString().split(':').slice(0, 2).join('-');
        
        // PASO 5: CREAR ESTRUCTURA DEL BACKUP
        const datosCompletos = {
            metadata: {
                version: "4.0",
                tipoBackup: "manual",
                fechaCreacion: fecha.toISOString(),
                timestamp: timestamp,
                origen: "backup_manual_corregido",
                totalEstudiantes: datosReales.estudiantes.length,
                totalEntrenadores: datosReales.entrenadores.length,
                totalPagos: datosReales.pagos.length,
                totalProductos: datosReales.productos.length
            },
            
            sistemaADAMS: datosReales,
            
            datosAdicionales: {
                asistenciasEntrenadores: JSON.parse(localStorage.getItem('asistenciasEntrenadores') || '{}'),
                pagosRealizados: JSON.parse(localStorage.getItem('pagosRealizados') || '{}'),
                configBackups: {
                    fechaCreacion: fecha.toISOString(),
                    navegador: navigator.userAgent.substring(0, 100),
                    datosOriginales: {
                        fuenteDatos: datosGuardados ? 'localStorage' : 'sistemaADAMS',
                        tama√±oLocalStorage: datosGuardados ? datosGuardados.length : 0
                    }
                }
            }
        };
        
        // PASO 6: VERIFICACI√ìN FINAL
        console.log('üîç Verificaci√≥n final del backup:');
        console.log('- Metadata estudiantes:', datosCompletos.metadata.totalEstudiantes);
        console.log('- Estudiantes reales:', datosCompletos.sistemaADAMS.estudiantes.length);
        console.log('- Metadata entrenadores:', datosCompletos.metadata.totalEntrenadores);
        console.log('- Entrenadores reales:', datosCompletos.sistemaADAMS.entrenadores.length);
        
        // PASO 7: GENERAR Y DESCARGAR ARCHIVO
        const nombreArchivo = `BACKUP_MANUAL_Academia_Adams_${timestamp}.json`;
        const dataStr = JSON.stringify(datosCompletos, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = nombreArchivo;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(link.href), 2000);
        
        // PASO 8: ACTUALIZAR REGISTRO
        localStorage.setItem('ultimoBackupManual', fecha.getTime().toString());
        
        console.log(`‚úÖ Backup creado exitosamente: ${nombreArchivo}`);
        mostrarNotificacion(`‚úÖ Backup creado con ${datosCompletos.metadata.totalEstudiantes} estudiantes y ${datosCompletos.metadata.totalEntrenadores} entrenadores`, 'success');
        
    } catch (error) {
        console.error('‚ùå Error al crear backup manual:', error);
        mostrarNotificacion('‚ùå Error al crear backup manual: ' + error.message, 'error');
    }
}
function crearBackupDirecto() {
    try {
        console.log('Creando backup directo...');
        
        const fecha = new Date();
        const timestamp = fecha.toISOString().replace(/[:.]/g, '-');
        
        const datosCompletos = {
            metadata: {
                version: "4.0",
                tipoBackup: "manual-directo",
                fechaCreacion: fecha.toISOString(),
                timestamp: timestamp,
                totalEstudiantes: (window.sistemaADAMS?.estudiantes?.length || 0),
                totalEntrenadores: (window.sistemaADAMS?.entrenadores?.length || 0),
                totalPagos: (window.sistemaADAMS?.pagos?.length || 0)
            },
            
            sistemaADAMS: window.sistemaADAMS || {},
            
            datosAdicionales: {
                asistenciasEntrenadores: JSON.parse(localStorage.getItem('asistenciasEntrenadores') || '{}'),
                pagosRealizados: JSON.parse(localStorage.getItem('pagosRealizados') || '{}')
            }
        };
        
        const nombreArchivo = `BACKUP_MANUAL_Academia_Adams_${timestamp}.json`;
        const dataStr = JSON.stringify(datosCompletos, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = nombreArchivo;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        
        console.log(`Backup directo creado: ${nombreArchivo}`);
        mostrarNotificacion('Backup manual creado exitosamente', 'success');
        
        // Actualizar timestamp del √∫ltimo backup
        localStorage.setItem('ultimoBackupAutomatico', new Date().getTime().toString());
        
    } catch (error) {
        console.error('Error en backup directo:', error);
        mostrarNotificacion('Error al crear backup manual', 'error');
    }
}
// Funci√≥n para obtener estad√≠sticas de backups
function obtenerEstadisticasBackups() {
    const ultimoBackup = localStorage.getItem('ultimoBackupAutomatico');
    
    return {
        ultimoBackup: ultimoBackup ? new Date(parseInt(ultimoBackup)).toLocaleString() : 'Nunca',
        proximoBackup: ultimoBackup ? 
            new Date(parseInt(ultimoBackup) + (24 * 60 * 60 * 1000)).toLocaleString() : 
            'Al pr√≥ximo cambio importante'
    };
}        
// FUNCIONES PARA GESTI√ìN DE CONCEPTOS DE PAGO
function abrirGestionConceptos() {
    document.getElementById('modal-conceptos').style.display = 'flex';
    actualizarTablaConceptos();
    cargarConceptosEnSelect();
}

function cerrarGestionConceptos() {
    document.getElementById('modal-conceptos').style.display = 'none';
    cancelarNuevoConcepto();
    cargarConceptosEnSelect(); // Actualizar el select despu√©s de cerrar
}

function mostrarFormularioNuevoConcepto() {
    document.getElementById('formulario-nuevo-concepto').style.display = 'block';
    document.getElementById('nuevo-concepto-nombre').focus();
}

function cancelarNuevoConcepto() {
    document.getElementById('formulario-nuevo-concepto').style.display = 'none';
    document.getElementById('nuevo-concepto-nombre').value = '';
    document.getElementById('nuevo-concepto-tipo').value = '';
}

function guardarNuevoConcepto() {
    const nombre = document.getElementById('nuevo-concepto-nombre').value.trim();
    const tipo = document.getElementById('nuevo-concepto-tipo').value.trim().toLowerCase();
    
    if (!nombre || !tipo) {
        mostrarNotificacion('Completa todos los campos', 'error');
        return;
    }
    
    // Validar que el tipo solo tenga caracteres v√°lidos
    if (!/^[a-z0-9-]+$/.test(tipo)) {
        mostrarNotificacion('El tipo solo puede contener letras min√∫sculas, n√∫meros y guiones', 'error');
        return;
    }
    
    // Verificar que no exista ya un concepto con ese tipo
    const existeTipo = sistemaADAMS.conceptosPago.find(c => c.tipo === tipo);
    if (existeTipo) {
        mostrarNotificacion('Ya existe un concepto con ese tipo interno', 'error');
        return;
    }
    
    // Crear nuevo concepto
    const nuevoId = Math.max(...sistemaADAMS.conceptosPago.map(c => c.id)) + 1;
    const nuevoConcepto = {
        id: nuevoId,
        nombre: nombre,
        tipo: tipo,
        activo: true
    };
    
    sistemaADAMS.conceptosPago.push(nuevoConcepto);
    guardarDatos();
    
    mostrarNotificacion('Concepto agregado exitosamente', 'success');
    cancelarNuevoConcepto();
    actualizarTablaConceptos();
    cargarConceptosEnSelect();
}

function actualizarTablaConceptos() {
    const tbody = document.getElementById('tabla-conceptos');
    
    if (!sistemaADAMS.conceptosPago || sistemaADAMS.conceptosPago.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: #666; padding: 40px;">
                    No hay conceptos configurados
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = sistemaADAMS.conceptosPago.map(concepto => `
        <tr>
            <td>
                <strong>${concepto.nombre}</strong>
            </td>
            <td>
                <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${concepto.tipo}</code>
            </td>
            <td>
                <span class="status ${concepto.activo ? 'status-active' : 'status-inactive'}">
                    ${concepto.activo ? 'Activo' : 'Inactivo'}
                </span>
            </td>
            <td>
                <button class="btn btn-secondary btn-small" onclick="editarConcepto(${concepto.id})" style="margin-right: 5px;">
                    Editar
                </button>
                <button class="btn ${concepto.activo ? 'btn-danger' : 'btn-success'} btn-small" 
                        onclick="toggleConcepto(${concepto.id})" style="margin-right: 5px;">
                    ${concepto.activo ? 'Desactivar' : 'Activar'}
                </button>
                ${concepto.id > 5 ? `<button class="btn btn-danger btn-small" onclick="eliminarConcepto(${concepto.id})">Eliminar</button>` : ''}
            </td>
        </tr>
    `).join('');
}

function editarConcepto(id) {
    const concepto = sistemaADAMS.conceptosPago.find(c => c.id === id);
    if (!concepto) return;
    
    const nuevoNombre = prompt('Editar nombre del concepto:', concepto.nombre);
    if (nuevoNombre && nuevoNombre.trim() !== concepto.nombre) {
        concepto.nombre = nuevoNombre.trim();
        guardarDatos();
        mostrarNotificacion('Concepto actualizado', 'success');
        actualizarTablaConceptos();
        cargarConceptosEnSelect();
    }
}

function toggleConcepto(id) {
    const concepto = sistemaADAMS.conceptosPago.find(c => c.id === id);
    if (!concepto) return;
    
    concepto.activo = !concepto.activo;
    guardarDatos();
    
    mostrarNotificacion(concepto.activo ? 'Concepto activado' : 'Concepto desactivado', 'success');
    actualizarTablaConceptos();
    cargarConceptosEnSelect();
}

function eliminarConcepto(id) {
    if (!confirm('¬øEst√°s seguro de eliminar este concepto? Esta acci√≥n no se puede deshacer.')) {
        return;
    }
    
    sistemaADAMS.conceptosPago = sistemaADAMS.conceptosPago.filter(c => c.id !== id);
    guardarDatos();
    
    mostrarNotificacion('Concepto eliminado', 'success');
    actualizarTablaConceptos();
    cargarConceptosEnSelect();
}

function cargarConceptosEnSelect() {
    if (!sistemaADAMS.conceptosPago || sistemaADAMS.conceptosPago.length === 0) {
        sistemaADAMS.conceptosPago = [
            { id: 1, nombre: 'Colegiatura Mensual', tipo: 'colegiatura', activo: true },
            { id: 2, nombre: 'Ajuste de Colegiatura', tipo: 'ajuste-colegiatura', activo: true },
            { id: 3, nombre: 'Inscripci√≥n', tipo: 'inscripcion', activo: true },
            { id: 4, nombre: 'Reinscripci√≥n', tipo: 'reinscripcion', activo: true },
            { id: 5, nombre: 'Producto/Uniforme', tipo: 'producto', activo: true }
        ];
        guardarDatos();
    }
    
    const select = document.getElementById('concepto-temporal');
    if (!select) return;
    
    const valorActual = select.value;
    select.innerHTML = '<option value="">Seleccionar concepto...</option>';
    
    sistemaADAMS.conceptosPago
        .filter(concepto => concepto.activo)
        .forEach(concepto => {
            select.innerHTML += `<option value="${concepto.tipo}">${concepto.nombre}</option>`;
        });
    
    if (valorActual) {
        select.value = valorActual;
    }
}
function mostrarCamposConceptoPersonalizado(campos, tipoConcepto) {
    const nombreConcepto = obtenerNombreConcepto(tipoConcepto);
    
    campos.innerHTML = `
        <div class="form-row">
            <div class="form-group">
                <label>Monto *</label>
                <input type="number" id="monto-personalizado" step="0.01" min="0" value="500"
       placeholder="Ingresa el monto..." onchange="actualizarTotalPersonalizado()">
            </div>
            <div class="form-group">
                <label>Total</label>
                <input type="number" id="total-personalizado" value="500.00" readonly style="background: #f8f9fa;">
            </div>
        </div>
        <div class="form-group">
            <label>Observaciones</label>
            <input type="text" id="observaciones-concepto" placeholder="Observaciones del pago...">
        </div>
    `;

    conceptoTemporal = {
        tipo: tipoConcepto,
        nombre: nombreConcepto,
        total: 500
    };
    
    setTimeout(() => actualizarTotalPersonalizado(), 100);
}

function actualizarTotalPersonalizado() {
    const monto = parseFloat(document.getElementById('monto-personalizado').value) || 0;
    document.getElementById('total-personalizado').value = monto.toFixed(2);
    
    if (conceptoTemporal) {
        conceptoTemporal.total = monto;
    }
}
// ===== M√ìDULO DE CONFIGURACI√ìN =====

// Inicializar configuraci√≥n al cargar el m√≥dulo
function inicializarConfiguracion() {
    cargarConfiguracionGeneral();
    cargarConfiguracionFinanciera();
    cargarListaDisciplinas();
    cargarConfiguracionHorarios();
    actualizarInfoSistema();
    actualizarHeaderSistema();
    // Al final de inicializarConfiguracion(), agregar:
actualizarInfoBackups();
}

// Configuraci√≥n General
function cargarConfiguracionGeneral() {
    if (!sistemaADAMS.configuracionGeneral) {
        sistemaADAMS.configuracionGeneral = {
            nombreAcademia: "Academia de Gimnasia ADAMS",
            direccion: "Six Flags Hurricane Harbor Oaxtepec, Morelos",
            telefono: "5610488668",
            email: "contacto@academiaadams.com",
            instagram: "academiadegimnasiaolmpicaadams",
            whatsapp: "5610488668"
        };
    }

    const config = sistemaADAMS.configuracionGeneral;
    document.getElementById('config-nombre-academia').value = config.nombreAcademia;
    document.getElementById('config-direccion').value = config.direccion;
    document.getElementById('config-telefono').value = config.telefono;
    document.getElementById('config-email').value = config.email;
    document.getElementById('config-instagram').value = config.instagram;
    document.getElementById('config-whatsapp').value = config.whatsapp;
}

function guardarConfiguracionGeneral() {
    sistemaADAMS.configuracionGeneral = {
        nombreAcademia: document.getElementById('config-nombre-academia').value,
        direccion: document.getElementById('config-direccion').value,
        telefono: document.getElementById('config-telefono').value,
        email: document.getElementById('config-email').value,
        instagram: document.getElementById('config-instagram').value,
        whatsapp: document.getElementById('config-whatsapp').value,
        fechaModificacion: new Date().toISOString()
    };
    
    guardarDatos();
    actualizarHeaderSistema();
    mostrarNotificacion('Informaci√≥n general guardada exitosamente', 'success');
}

// Configuraci√≥n Financiera
function cargarConfiguracionFinanciera() {
    if (!sistemaADAMS.configuracionFinanciera) {
        sistemaADAMS.configuracionFinanciera = {
            colegiaturaBase: 900,
            inscripcion: 500,
            recargo1: 10,
            recargo2: 15,
            diaCorte: 16,
            descuentoHermanos: 10
        };
    }

    const config = sistemaADAMS.configuracionFinanciera;
    document.getElementById('config-colegiatura').value = config.colegiaturaBase;
    document.getElementById('config-inscripcion').value = config.inscripcion;
    document.getElementById('config-recargo1').value = config.recargo1;
    document.getElementById('config-recargo2').value = config.recargo2;
    document.getElementById('config-dia-corte').value = config.diaCorte;
    document.getElementById('config-descuento-hermanos').value = config.descuentoHermanos;
}

function guardarConfiguracionFinanciera() {
    sistemaADAMS.configuracionFinanciera = {
        colegiaturaBase: parseFloat(document.getElementById('config-colegiatura').value),
        inscripcion: parseFloat(document.getElementById('config-inscripcion').value),
        recargo1: parseFloat(document.getElementById('config-recargo1').value),
        recargo2: parseFloat(document.getElementById('config-recargo2').value),
        diaCorte: parseInt(document.getElementById('config-dia-corte').value),
        descuentoHermanos: parseFloat(document.getElementById('config-descuento-hermanos').value),
        fechaModificacion: new Date().toISOString()
    };
    
    // Actualizar tambi√©n en la configuraci√≥n antigua para compatibilidad
    sistemaADAMS.configuracion.colegiaturaBase = sistemaADAMS.configuracionFinanciera.colegiaturaBase;
    sistemaADAMS.configuracion.inscripcion = sistemaADAMS.configuracionFinanciera.inscripcion;
    sistemaADAMS.configuracion.recargo1 = sistemaADAMS.configuracionFinanciera.recargo1;
    sistemaADAMS.configuracion.recargo2 = sistemaADAMS.configuracionFinanciera.recargo2;
    sistemaADAMS.configuracion.descuentoHermanos = sistemaADAMS.configuracionFinanciera.descuentoHermanos;
    
    guardarDatos();
    mostrarNotificacion('Configuraci√≥n financiera guardada exitosamente', 'success');
}

// Gesti√≥n de Disciplinas
function cargarListaDisciplinas() {
    const container = document.getElementById('lista-disciplinas');
    
    if (!sistemaADAMS.configuracion.disciplinas) {
        sistemaADAMS.configuracion.disciplinas = ['gimnasia', 'parkour', 'box'];
    }

    container.innerHTML = sistemaADAMS.configuracion.disciplinas.map((disciplina, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 10px; margin: 10px 0; border: 2px solid #e3f2fd;">
            <div>
                <h4 style="color: #1976d2; margin: 0;">${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</h4>
                <small style="color: #666;">Disciplina deportiva</small>
            </div>
            <div>
                <button class="btn btn-secondary btn-small" onclick="editarDisciplina(${index})" style="margin-right: 10px;">
                    ‚úèÔ∏è Editar
                </button>
                ${sistemaADAMS.configuracion.disciplinas.length > 1 ? 
                    `<button class="btn btn-danger btn-small" onclick="eliminarDisciplina(${index})">
                        üóëÔ∏è Eliminar
                    </button>` : 
                    '<span style="color: #999; font-size: 12px;">Disciplina principal</span>'
                }
            </div>
        </div>
    `).join('');
}

function agregarNuevaDisciplina() {
    document.getElementById('form-nueva-disciplina').style.display = 'block';
    document.getElementById('nueva-disciplina-nombre').focus();
}

function cancelarNuevaDisciplina() {
    document.getElementById('form-nueva-disciplina').style.display = 'none';
    document.getElementById('nueva-disciplina-nombre').value = '';
    document.getElementById('nueva-disciplina-descripcion').value = '';
}

function guardarNuevaDisciplina() {
    const nombre = document.getElementById('nueva-disciplina-nombre').value.trim().toLowerCase();
    
    if (!nombre) {
        mostrarNotificacion('Ingresa el nombre de la disciplina', 'error');
        return;
    }
    
    if (sistemaADAMS.configuracion.disciplinas.includes(nombre)) {
        mostrarNotificacion('Esta disciplina ya existe', 'error');
        return;
    }
    
    sistemaADAMS.configuracion.disciplinas.push(nombre);
    guardarDatos();
    
    mostrarNotificacion('Disciplina agregada exitosamente', 'success');
    cancelarNuevaDisciplina();
    cargarListaDisciplinas();
    actualizarDisciplinasEnFormularios();
}

function editarDisciplina(index) {
    const disciplinaActual = sistemaADAMS.configuracion.disciplinas[index];
    const nuevoNombre = prompt('Editar nombre de la disciplina:', disciplinaActual);
    
    if (nuevoNombre && nuevoNombre.trim().toLowerCase() !== disciplinaActual) {
        const nombreLimpio = nuevoNombre.trim().toLowerCase();
        
        if (sistemaADAMS.configuracion.disciplinas.includes(nombreLimpio)) {
            mostrarNotificacion('Ya existe una disciplina con ese nombre', 'error');
            return;
        }
        
        // Actualizar la disciplina en el array
        sistemaADAMS.configuracion.disciplinas[index] = nombreLimpio;
        
        // Actualizar en estudiantes y entrenadores
        sistemaADAMS.estudiantes.forEach(estudiante => {
            if (estudiante.disciplinas.includes(disciplinaActual)) {
                const indice = estudiante.disciplinas.indexOf(disciplinaActual);
                estudiante.disciplinas[indice] = nombreLimpio;
            }
            estudiante.horarios.forEach(horario => {
                if (horario.disciplina === disciplinaActual) {
                    horario.disciplina = nombreLimpio;
                }
            });
        });
        
        sistemaADAMS.entrenadores.forEach(entrenador => {
            if (entrenador.disciplinas.includes(disciplinaActual)) {
                const indice = entrenador.disciplinas.indexOf(disciplinaActual);
                entrenador.disciplinas[indice] = nombreLimpio;
            }
            entrenador.horarios.forEach(horario => {
                if (horario.disciplina === disciplinaActual) {
                    horario.disciplina = nombreLimpio;
                }
            });
        });
        
        guardarDatos();
        mostrarNotificacion('Disciplina actualizada exitosamente', 'success');
        cargarListaDisciplinas();
        actualizarDisciplinasEnFormularios();
    }
}

function eliminarDisciplina(index) {
    if (sistemaADAMS.configuracion.disciplinas.length <= 1) {
        mostrarNotificacion('Debe haber al menos una disciplina', 'error');
        return;
    }
    
    const disciplina = sistemaADAMS.configuracion.disciplinas[index];
    
    // Verificar si hay estudiantes o entrenadores usando esta disciplina
    const estudiantesConDisciplina = sistemaADAMS.estudiantes.filter(e => 
        e.disciplinas.includes(disciplina) || 
        e.horarios.some(h => h.disciplina === disciplina)
    ).length;
    
    const entrenadoresConDisciplina = sistemaADAMS.entrenadores.filter(e => 
        e.disciplinas.includes(disciplina) || 
        e.horarios.some(h => h.disciplina === disciplina)
    ).length;
    
    if (estudiantesConDisciplina > 0 || entrenadoresConDisciplina > 0) {
        mostrarNotificacion(
            `No se puede eliminar esta disciplina porque ${estudiantesConDisciplina} estudiantes y ${entrenadoresConDisciplina} entrenadores la est√°n usando`, 
            'error'
        );
        return;
    }
    
    if (confirm(`¬øEst√°s seguro de eliminar la disciplina "${disciplina}"?`)) {
        sistemaADAMS.configuracion.disciplinas.splice(index, 1);
        guardarDatos();
        mostrarNotificacion('Disciplina eliminada exitosamente', 'success');
        cargarListaDisciplinas();
        actualizarDisciplinasEnFormularios();
    }
}

// Configuraci√≥n de Horarios
function cargarConfiguracionHorarios() {
    if (!sistemaADAMS.configuracionHorarios) {
        sistemaADAMS.configuracionHorarios = {
            horaApertura: "15:00",
            horaCierre: "19:00",
            duracionClase: 60,
            capacidadEntrenador: 10,
            diasOperacion: ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado']
        };
    }

    const config = sistemaADAMS.configuracionHorarios;
    document.getElementById('config-hora-apertura').value = config.horaApertura;
    document.getElementById('config-hora-cierre').value = config.horaCierre;
    document.getElementById('config-duracion-clase').value = config.duracionClase;
    document.getElementById('config-capacidad-entrenador').value = config.capacidadEntrenador;

    // Marcar d√≠as de operaci√≥n
    const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
    dias.forEach(dia => {
        const checkbox = document.getElementById(`dia-${dia}`);
        if (checkbox) {
            checkbox.checked = config.diasOperacion.includes(dia);
        }
    });
}

function guardarConfiguracionHorarios() {
    const diasOperacion = [];
    const dias = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
    
    dias.forEach(dia => {
        const checkbox = document.getElementById(`dia-${dia}`);
        if (checkbox && checkbox.checked) {
            diasOperacion.push(dia);
        }
    });

    if (diasOperacion.length === 0) {
        mostrarNotificacion('Debe seleccionar al menos un d√≠a de operaci√≥n', 'error');
        return;
    }

    sistemaADAMS.configuracionHorarios = {
        horaApertura: document.getElementById('config-hora-apertura').value,
        horaCierre: document.getElementById('config-hora-cierre').value,
        duracionClase: parseInt(document.getElementById('config-duracion-clase').value),
        capacidadEntrenador: parseInt(document.getElementById('config-capacidad-entrenador').value),
        diasOperacion: diasOperacion,
        fechaModificacion: new Date().toISOString()
    };

    // Actualizar tambi√©n en configuraci√≥n antigua
    sistemaADAMS.configuracion.capacidadPorEntrenador = sistemaADAMS.configuracionHorarios.capacidadEntrenador;

    guardarDatos();
    mostrarNotificacion('Configuraci√≥n de horarios guardada exitosamente', 'success');
}

// Funciones del Sistema
function exportarDatos() {
    const datos = {
        version: "4.0",
        fechaExportacion: new Date().toISOString(),
        sistemaADAMS: sistemaADAMS
    };

    const dataStr = JSON.stringify(datos, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `respaldo_academia_adams_${new Date().toISOString().split('T')[0]}.json`;
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    mostrarNotificacion('Respaldo descargado exitosamente', 'success');
}
function importarDatos(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            console.log('=== INICIANDO IMPORTACI√ìN ===');
            
            const datos = JSON.parse(e.target.result);
            console.log('JSON parseado correctamente');
            console.log('Estructura del archivo:', Object.keys(datos));
            
            let datosSistema;
            let tipoDetectado = 'desconocido';
            
            // DETECCI√ìN MEJORADA DEL FORMATO
            if (datos.metadata && datos.sistemaADAMS) {
                // Formato nuevo con metadata
                console.log('‚úÖ Formato: Backup NUEVO con metadata');
                datosSistema = datos.sistemaADAMS;
                tipoDetectado = 'nuevo-metadata';
                
            } else if (datos.sistemaADAMS && typeof datos.sistemaADAMS === 'object') {
                // Formato con sistemaADAMS como propiedad
                console.log('‚úÖ Formato: Backup con sistemaADAMS encapsulado');
                datosSistema = datos.sistemaADAMS;
                tipoDetectado = 'encapsulado';
                
            } else if (datos.estudiantes !== undefined || datos.entrenadores !== undefined) {
                // El objeto ES directamente sistemaADAMS
                console.log('‚úÖ Formato: sistemaADAMS directo');
                datosSistema = datos;
                tipoDetectado = 'directo';
                
            } else {
                console.error('‚ùå Formato no reconocido');
                console.log('Claves encontradas:', Object.keys(datos));
                throw new Error(`Formato de backup no reconocido. Claves: ${Object.keys(datos).join(', ')}`);
            }
            
            // VALIDACI√ìN DE DATOS
            if (!datosSistema || typeof datosSistema !== 'object') {
                throw new Error('Los datos del sistema no son v√°lidos');
            }
            
            // Asegurar arrays b√°sicos
            if (!Array.isArray(datosSistema.estudiantes)) datosSistema.estudiantes = [];
            if (!Array.isArray(datosSistema.entrenadores)) datosSistema.entrenadores = [];
            if (!Array.isArray(datosSistema.pagos)) datosSistema.pagos = [];
            if (!Array.isArray(datosSistema.productos)) datosSistema.productos = [];
            
            // MOSTRAR INFORMACI√ìN DETALLADA
            const infoBackup = `üì¶ INFORMACI√ìN DEL BACKUP

üîß Tipo: ${tipoDetectado.toUpperCase()}
üë• Estudiantes a importar: ${datosSistema.estudiantes.length}
üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores a importar: ${datosSistema.entrenadores.length}
üí∞ Pagos a importar: ${datosSistema.pagos.length}
üì¶ Productos a importar: ${datosSistema.productos ? datosSistema.productos.length : 0}

üìã DATOS ACTUALES (se perder√°n):
üë• Estudiantes actuales: ${sistemaADAMS.estudiantes?.length || 0}
üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores actuales: ${sistemaADAMS.entrenadores?.length || 0}
üí∞ Pagos actuales: ${sistemaADAMS.pagos?.length || 0}

‚ö†Ô∏è ADVERTENCIA: Esto reemplazar√° TODOS los datos actuales.

¬øContinuar con la restauraci√≥n?`;
            
            if (!confirm(infoBackup)) {
                mostrarNotificacion('Importaci√≥n cancelada', 'error');
                input.value = '';
                return;
            }
            
            // REALIZAR IMPORTACI√ìN
            realizarImportacionSegura(datos, datosSistema, tipoDetectado);
            
        } catch (error) {
            console.error('‚ùå ERROR EN IMPORTACI√ìN:', error);
            mostrarNotificacion(`Error al importar: ${error.message}`, 'error');
        }
    };
    
    reader.onerror = function() {
        mostrarNotificacion('Error al leer el archivo', 'error');
    };
    
    reader.readAsText(file);
    input.value = '';
}
function realizarImportacionSegura(datosCompletos, datosSistema, tipoDetectado) {
    try {
        console.log('üîÑ Iniciando importaci√≥n segura...');
        
        // 1. BACKUP DE EMERGENCIA
        const respaldoEmergencia = {
            sistemaADAMS: JSON.parse(JSON.stringify(sistemaADAMS)),
            fecha: new Date().toISOString(),
            razon: 'backup_antes_importar'
        };
        localStorage.setItem('respaldoEmergencia', JSON.stringify(respaldoEmergencia));
        console.log('‚úÖ Backup de emergencia creado');
        
        // 2. LIMPIAR SISTEMA ACTUAL
        console.log('üßπ Limpiando datos actuales...');
        
        // 3. IMPORTAR DATOS PRINCIPALES
        sistemaADAMS.estudiantes = datosSistema.estudiantes || [];
        sistemaADAMS.entrenadores = datosSistema.entrenadores || [];
        sistemaADAMS.pagos = datosSistema.pagos || [];
        sistemaADAMS.productos = datosSistema.productos || [];
        sistemaADAMS.configuracion = datosSistema.configuracion || { disciplinas: ['gimnasia', 'parkour', 'box'] };
        sistemaADAMS.configuracionGeneral = datosSistema.configuracionGeneral || null;
        sistemaADAMS.configuracionFinanciera = datosSistema.configuracionFinanciera || null;
        sistemaADAMS.configuracionHorarios = datosSistema.configuracionHorarios || null;
        sistemaADAMS.conceptosPago = datosSistema.conceptosPago || [
            { id: 1, nombre: 'Colegiatura Mensual', tipo: 'colegiatura', activo: true },
            { id: 2, nombre: 'Ajuste de Colegiatura', tipo: 'ajuste-colegiatura', activo: true },
            { id: 3, nombre: 'Inscripci√≥n', tipo: 'inscripcion', activo: true },
            { id: 4, nombre: 'Reinscripci√≥n', tipo: 'reinscripcion', activo: true },
            { id: 5, nombre: 'Producto/Uniforme', tipo: 'producto', activo: true }
        ];
        sistemaADAMS.clasesMuestra = datosSistema.clasesMuestra || [];
        sistemaADAMS.asistenciasEstudiantes = datosSistema.asistenciasEstudiantes || [];
        
        console.log('‚úÖ Datos principales importados:');
        console.log('üìä Estudiantes:', sistemaADAMS.estudiantes.length);
        console.log('üìä Entrenadores:', sistemaADAMS.entrenadores.length);
        console.log('üìä Pagos:', sistemaADAMS.pagos.length);
        
        // 4. GUARDAR EN LOCALSTORAGE
        localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
        console.log('‚úÖ Datos guardados en localStorage');
        
        // 5. IMPORTAR DATOS ADICIONALES (si existen)
        if (datosCompletos.datosAdicionales) {
            console.log('üì• Importando datos adicionales...');
            
            if (datosCompletos.datosAdicionales.asistenciasEntrenadores) {
                localStorage.setItem('asistenciasEntrenadores', 
                    JSON.stringify(datosCompletos.datosAdicionales.asistenciasEntrenadores));
            }
            
            if (datosCompletos.datosAdicionales.pagosRealizados) {
                localStorage.setItem('pagosRealizados', 
                    JSON.stringify(datosCompletos.datosAdicionales.pagosRealizados));
            }
        }
        
        // 6. ACTUALIZAR TODA LA INTERFAZ
        console.log('üîÑ Actualizando interfaz...');
        setTimeout(() => {
            actualizarTodasLasVistasSeguro();
            mostrarNotificacion('üéâ ¬°Backup importado exitosamente!', 'success');
        }, 1000);
        
        // 7. MARCAR IMPORTACI√ìN
        localStorage.setItem('ultimaImportacion', new Date().toISOString());
        localStorage.setItem('tipoUltimaImportacion', tipoDetectado);
        
        console.log('‚úÖ Importaci√≥n completada exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error durante importaci√≥n:', error);
        
        // RESTAURAR BACKUP DE EMERGENCIA
        try {
            const respaldo = localStorage.getItem('respaldoEmergencia');
            if (respaldo) {
                console.log('üîÑ Restaurando backup de emergencia...');
                const datosRespaldo = JSON.parse(respaldo);
                sistemaADAMS = datosRespaldo.sistemaADAMS;
                localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
                mostrarNotificacion('‚ùå Error en importaci√≥n. Datos originales restaurados.', 'error');
                actualizarTodasLasVistasSeguro();
            }
        } catch (errorRespaldo) {
            console.error('‚ùå Error cr√≠tico:', errorRespaldo);
            mostrarNotificacion('‚ùå Error cr√≠tico. Recarga la p√°gina.', 'error');
        }
        
        throw error;
    }
}
function actualizarTodasLasVistasSeguro() {
    console.log('üîÑ Actualizando vistas despu√©s de importaci√≥n...');
    
    try {
        // Verificar que sistemaADAMS est√© disponible
        if (!sistemaADAMS) {
            console.error('‚ùå sistemaADAMS no disponible');
            return;
        }
        
        // Asegurar arrays b√°sicos
        if (!sistemaADAMS.estudiantes) sistemaADAMS.estudiantes = [];
        if (!sistemaADAMS.entrenadores) sistemaADAMS.entrenadores = [];
        if (!sistemaADAMS.pagos) sistemaADAMS.pagos = [];
        if (!sistemaADAMS.productos) sistemaADAMS.productos = [];
        
        console.log('üìä Actualizando tablas...');
        
        // Actualizar tablas principales
        setTimeout(() => { 
            try { actualizarTablaEstudiantes(); } catch(e) { console.error('Error tabla estudiantes:', e); } 
        }, 100);
        
        setTimeout(() => { 
            try { actualizarTablaEntrenadores(); } catch(e) { console.error('Error tabla entrenadores:', e); } 
        }, 200);
        
        setTimeout(() => { 
            try { actualizarTablaPagos(); } catch(e) { console.error('Error tabla pagos:', e); } 
        }, 300);
        
        setTimeout(() => { 
            try { actualizarTablaProductos(); } catch(e) { console.error('Error tabla productos:', e); } 
        }, 400);
        
        // Actualizar dashboard y selectores
        setTimeout(() => {
            try { actualizarDashboard(); } catch(e) { console.error('Error dashboard:', e); }
            try { cargarSelectoresEntrenadores(); } catch(e) { console.error('Error selectores:', e); }
            try { cargarEntrenadoresEnSelect(); } catch(e) { console.error('Error entrenadores select:', e); }
            try { cargarDisciplinasEnHorarios(); } catch(e) { console.error('Error disciplinas:', e); }
            try { cargarConceptosEnSelect(); } catch(e) { console.error('Error conceptos:', e); }
        }, 500);
        
        // Actualizar configuraci√≥n si existe
        setTimeout(() => {
            try {
                if (typeof inicializarConfiguracion === 'function') {
                    inicializarConfiguracion();
                }
                if (typeof actualizarInfoSistema === 'function') {
                    actualizarInfoSistema();
                }
            } catch(e) { console.error('Error configuraci√≥n:', e); }
        }, 1000);
        
        console.log('üéâ Vistas actualizadas correctamente');
        
    } catch (error) {
        console.error('‚ùå Error al actualizar vistas:', error);
    }
}
function generarInfoBackupMejorada(datosCompletos, datosSistema, esBackupNuevo, tipoBackup) {
    let info = 'üì¶ INFORMACI√ìN DEL BACKUP\n\n';
    
    // Informaci√≥n del tipo de backup
    info += `üîß Tipo detectado: ${tipoBackup.toUpperCase()}\n`;
    
    if (esBackupNuevo && datosCompletos.metadata) {
        info += `üìÖ Fecha: ${new Date(datosCompletos.metadata.fechaCreacion).toLocaleString()}\n`;
        info += `üìä Versi√≥n: ${datosCompletos.metadata.version}\n`;
        info += `üë• Estudiantes: ${datosCompletos.metadata.totalEstudiantes || 0}\n`;
        info += `üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores: ${datosCompletos.metadata.totalEntrenadores || 0}\n`;
        info += `üí∞ Pagos: ${datosCompletos.metadata.totalPagos || 0}\n`;
    } else {
        // Para backups sin metadata, contar directamente
        info += `üë• Estudiantes: ${datosSistema.estudiantes?.length || 0}\n`;
        info += `üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores: ${datosSistema.entrenadores?.length || 0}\n`;
        info += `üí∞ Pagos: ${datosSistema.pagos?.length || 0}\n`;
        info += `üì¶ Productos: ${datosSistema.productos?.length || 0}\n`;
    }
    
    // Mostrar datos actuales para comparaci√≥n
    info += `\nüìã DATOS ACTUALES (se perder√°n):\n`;
    info += `üë• Estudiantes actuales: ${sistemaADAMS.estudiantes?.length || 0}\n`;
    info += `üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores actuales: ${sistemaADAMS.entrenadores?.length || 0}\n`;
    info += `üí∞ Pagos actuales: ${sistemaADAMS.pagos?.length || 0}\n`;
    
    return info;
}
function realizarImportacionMejorada(datosCompletos, datosSistema, esBackupNuevo) {
    try {
        console.log('üîÑ Iniciando proceso de restauraci√≥n...');
        
        // Respaldar datos actuales antes de importar
        const respaldoEmergencia = {
            sistemaADAMS: {...sistemaADAMS},
            fecha: new Date().toISOString(),
            razon: 'respaldo_antes_de_importar'
        };
        localStorage.setItem('respaldoEmergencia', JSON.stringify(respaldoEmergencia));
        console.log('‚úÖ Respaldo de emergencia creado');
        
        // Limpiar y preparar datos
        console.log('üßπ Limpiando datos actuales...');
        
        // Importar datos principales del sistema
        console.log('üì• Importando datos del sistema...');
        sistemaADAMS = {
            estudiantes: datosSistema.estudiantes || [],
            entrenadores: datosSistema.entrenadores || [],
            pagos: datosSistema.pagos || [],
            productos: datosSistema.productos || [],
            configuracion: datosSistema.configuracion || { disciplinas: ['gimnasia', 'parkour', 'box'] },
            configuracionGeneral: datosSistema.configuracionGeneral || null,
            configuracionFinanciera: datosSistema.configuracionFinanciera || null,
            configuracionHorarios: datosSistema.configuracionHorarios || null,
            conceptosPago: datosSistema.conceptosPago || [
                { id: 1, nombre: 'Colegiatura Mensual', tipo: 'colegiatura', activo: true },
                { id: 2, nombre: 'Ajuste de Colegiatura', tipo: 'ajuste-colegiatura', activo: true },
                { id: 3, nombre: 'Inscripci√≥n', tipo: 'inscripcion', activo: true },
                { id: 4, nombre: 'Reinscripci√≥n', tipo: 'reinscripcion', activo: true },
                { id: 5, nombre: 'Producto/Uniforme', tipo: 'producto', activo: true }
            ],
            clasesMuestra: datosSistema.clasesMuestra || [],
            asistenciasEstudiantes: datosSistema.asistenciasEstudiantes || []
        };
        
        console.log('‚úÖ Datos principales importados');
        console.log('üìä Estudiantes:', sistemaADAMS.estudiantes.length);
        console.log('üìä Entrenadores:', sistemaADAMS.entrenadores.length);
        console.log('üìä Pagos:', sistemaADAMS.pagos.length);
        
        // Guardar en localStorage
        localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
        console.log('‚úÖ Datos guardados en localStorage');
        
        // Importar datos adicionales si existen (para backups nuevos)
        if (esBackupNuevo && datosCompletos.datosAdicionales) {
            console.log('üì• Importando datos adicionales...');
            
            if (datosCompletos.datosAdicionales.asistenciasEntrenadores) {
                localStorage.setItem('asistenciasEntrenadores', 
                    JSON.stringify(datosCompletos.datosAdicionales.asistenciasEntrenadores));
                console.log('‚úÖ Asistencias de entrenadores importadas');
            }
            
            if (datosCompletos.datosAdicionales.pagosRealizados) {
                localStorage.setItem('pagosRealizados', 
                    JSON.stringify(datosCompletos.datosAdicionales.pagosRealizados));
                console.log('‚úÖ Pagos realizados importados');
            }
        }
        
        // Actualizar todas las vistas
        console.log('üîÑ Actualizando interfaz...');
        setTimeout(() => {
            actualizarTodasLasVistasMejorada();
        }, 500);
        
        // Marcar como √∫ltimo backup importado
        localStorage.setItem('ultimoBackupImportado', new Date().toISOString());
        localStorage.setItem('tipoUltimoBackupImportado', esBackupNuevo ? 'nuevo' : 'clasico');
        
        mostrarNotificacion('üéâ ¬°Backup importado exitosamente! Todos los datos han sido restaurados.', 'success');
        console.log('‚úÖ Importaci√≥n completada exitosamente');
        
    } catch (error) {
        console.error('‚ùå Error durante la importaci√≥n:', error);
        
        // Intentar restaurar desde el respaldo de emergencia
        const respaldo = localStorage.getItem('respaldoEmergencia');
        if (respaldo) {
            try {
                console.log('üîÑ Intentando restaurar desde respaldo de emergencia...');
                sistemaADAMS = JSON.parse(respaldo).sistemaADAMS;
                localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
                mostrarNotificacion('‚ùå Error en importaci√≥n. Datos originales restaurados.', 'error');
                actualizarTodasLasVistasMejorada();
            } catch (errorRespaldo) {
                console.error('‚ùå Error cr√≠tico en respaldo:', errorRespaldo);
                mostrarNotificacion('‚ùå Error cr√≠tico en importaci√≥n. Recarga la p√°gina.', 'error');
            }
        }
        
        throw error; // Re-lanzar el error para que se muestre al usuario
    }
}
function generarInfoBackup(datos, esBackupNuevo) {
    let info = 'üì¶ INFORMACI√ìN DEL BACKUP\n\n';
    
    if (esBackupNuevo && datos.metadata) {
        info += `üìÖ Fecha: ${new Date(datos.metadata.fechaCreacion).toLocaleString()}\n`;
        info += `üîß Tipo: ${datos.metadata.tipoBackup.toUpperCase()}\n`;
        info += `üìä Versi√≥n: ${datos.metadata.version}\n`;
        info += `üë• Estudiantes: ${datos.metadata.totalEstudiantes || 0}\n`;
        info += `üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores: ${datos.metadata.totalEntrenadores || 0}\n`;
        info += `üí∞ Pagos: ${datos.metadata.totalPagos || 0}\n`;
    } else {
        const sistema = datos.sistemaADAMS || datos;
        info += `üìä Tipo: Backup cl√°sico\n`;
        info += `üë• Estudiantes: ${sistema.estudiantes?.length || 0}\n`;
        info += `üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores: ${sistema.entrenadores?.length || 0}\n`;
        info += `üí∞ Pagos: ${sistema.pagos?.length || 0}\n`;
    }
    
    // Mostrar datos actuales para comparaci√≥n
    info += `\nüìã DATOS ACTUALES (se perder√°n):\n`;
    info += `üë• Estudiantes actuales: ${sistemaADAMS.estudiantes?.length || 0}\n`;
    info += `üèãÔ∏è‚Äç‚ôÇÔ∏è Entrenadores actuales: ${sistemaADAMS.entrenadores?.length || 0}\n`;
    info += `üí∞ Pagos actuales: ${sistemaADAMS.pagos?.length || 0}\n`;
    
    return info;
}
function realizarImportacion(datosCompletos, datosSistema, esBackupNuevo) {
    try {
        console.log('Iniciando proceso de restauraci√≥n...');
        
        // Respaldar datos actuales antes de importar
        const respaldoEmergencia = {
            sistemaADAMS: {...sistemaADAMS},
            fecha: new Date().toISOString(),
            razon: 'respaldo_antes_de_importar'
        };
        localStorage.setItem('respaldoEmergencia', JSON.stringify(respaldoEmergencia));
        
        // Importar datos principales del sistema
        sistemaADAMS = {...datosSistema};
        
        // Asegurar que los arrays existan
        if (!sistemaADAMS.estudiantes) sistemaADAMS.estudiantes = [];
        if (!sistemaADAMS.entrenadores) sistemaADAMS.entrenadores = [];
        if (!sistemaADAMS.pagos) sistemaADAMS.pagos = [];
        if (!sistemaADAMS.productos) sistemaADAMS.productos = [];
        
        // Guardar en localStorage
        localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
        
        // Importar datos adicionales si existen
        if (esBackupNuevo && datosCompletos.datosAdicionales) {
            if (datosCompletos.datosAdicionales.asistenciasEntrenadores) {
                localStorage.setItem('asistenciasEntrenadores', 
                    JSON.stringify(datosCompletos.datosAdicionales.asistenciasEntrenadores));
            }
            if (datosCompletos.datosAdicionales.pagosRealizados) {
                localStorage.setItem('pagosRealizados', 
                    JSON.stringify(datosCompletos.datosAdicionales.pagosRealizados));
            }
        }
        
        // Actualizar todas las tablas y vistas
        actualizarTodasLasVistas();
        
        // Marcar como √∫ltimo backup importado
        localStorage.setItem('ultimoBackupImportado', new Date().toISOString());
        
        mostrarNotificacion('¬°Backup importado exitosamente! Todos los datos han sido restaurados.', 'success');
        console.log('Importaci√≥n completada exitosamente');
        
    } catch (error) {
        console.error('Error durante la importaci√≥n:', error);
        
        // Intentar restaurar desde el respaldo de emergencia
        const respaldo = localStorage.getItem('respaldoEmergencia');
        if (respaldo) {
            try {
                sistemaADAMS = JSON.parse(respaldo).sistemaADAMS;
                localStorage.setItem('sistemaADAMS', JSON.stringify(sistemaADAMS));
                mostrarNotificacion('Error en importaci√≥n. Datos originales restaurados.', 'error');
            } catch (errorRespaldo) {
                mostrarNotificacion('Error cr√≠tico en importaci√≥n. Recarga la p√°gina.', 'error');
            }
        }
    }
}
function actualizarTodasLasVistasMejorada() {
    console.log('üîÑ Actualizando todas las vistas despu√©s de importaci√≥n...');
    
    try {
        // Verificar que los datos est√°n disponibles
        if (!sistemaADAMS) {
            console.error('‚ùå sistemaADAMS no est√° disponible');
            return;
        }
        
        // Inicializar arrays si no existen
        if (!sistemaADAMS.estudiantes) sistemaADAMS.estudiantes = [];
        if (!sistemaADAMS.entrenadores) sistemaADAMS.entrenadores = [];
        if (!sistemaADAMS.pagos) sistemaADAMS.pagos = [];
        if (!sistemaADAMS.productos) sistemaADAMS.productos = [];
        
        console.log('üìä Actualizando tablas principales...');
        
        // Actualizar tablas con manejo de errores individual
        try {
            actualizarTablaEstudiantes();
            console.log('‚úÖ Tabla estudiantes actualizada');
        } catch (e) { console.error('Error en tabla estudiantes:', e); }
        
        try {
            actualizarTablaEntrenadores();
            console.log('‚úÖ Tabla entrenadores actualizada');
        } catch (e) { console.error('Error en tabla entrenadores:', e); }
        
        try {
            actualizarTablaPagos();
            console.log('‚úÖ Tabla pagos actualizada');
        } catch (e) { console.error('Error en tabla pagos:', e); }
        
        try {
            actualizarTablaProductos();
            console.log('‚úÖ Tabla productos actualizada');
        } catch (e) { console.error('Error en tabla productos:', e); }
        
        // Actualizar dashboard
        try {
            actualizarDashboard();
            console.log('‚úÖ Dashboard actualizado');
        } catch (e) { console.error('Error en dashboard:', e); }
        
        // Cargar selectores
        try {
            cargarSelectoresEntrenadores();
            cargarEntrenadoresEnSelect();
            cargarDisciplinasEnHorarios();
            cargarConceptosEnSelect();
            console.log('‚úÖ Selectores actualizados');
        } catch (e) { console.error('Error en selectores:', e); }
        
        // Actualizar configuraci√≥n si existe
        try {
            if (typeof inicializarConfiguracion === 'function') {
                inicializarConfiguracion();
                console.log('‚úÖ Configuraci√≥n actualizada');
            }
        } catch (e) { console.error('Error en configuraci√≥n:', e); }
        
        // Actualizar informaci√≥n del sistema
        try {
            if (typeof actualizarInfoSistema === 'function') {
                actualizarInfoSistema();
            }
            if (typeof actualizarInfoBackups === 'function') {
                actualizarInfoBackups();
            }
            console.log('‚úÖ Info del sistema actualizada');
        } catch (e) { console.error('Error en info sistema:', e); }
        
        console.log('üéâ Todas las vistas actualizadas correctamente');
        
    } catch (error) {
        console.error('‚ùå Error general al actualizar vistas:', error);
        // No lanzar error, solo loguearlo para que no interrumpa la importaci√≥n
    }
}
function limpiarDatos(tipo) {
    let mensaje = '';
    let accion = '';
    
    switch(tipo) {
        case 'asistencias':
            mensaje = '¬øEliminar todas las asistencias registradas?';
            accion = () => {
                sistemaADAMS.asistenciasEstudiantes = [];
                localStorage.removeItem('asistenciasEntrenadores');
            };
            break;
        case 'pagos':
            mensaje = '¬øEliminar todos los pagos registrados?';
            accion = () => {
                sistemaADAMS.pagos = [];
            };
            break;
    }
    
    if (confirm(mensaje + ' Esta acci√≥n no se puede deshacer.')) {
        accion();
        guardarDatos();
        mostrarNotificacion(`${tipo.charAt(0).toUpperCase() + tipo.slice(1)} eliminadas exitosamente`, 'success');
        actualizarInfoSistema();
    }
}

function resetearSistema() {
    const confirmacion = prompt('Para resetear el sistema completo, escribe: RESETEAR ADAMS');
    if (confirmacion === 'RESETEAR ADAMS') {
        localStorage.clear();
        location.reload();
    } else if (confirmacion !== null) {
        mostrarNotificacion('Texto incorrecto. Reset cancelado.', 'error');
    }
}

function actualizarInfoSistema() {
    document.getElementById('ultima-actualizacion').textContent = new Date().toLocaleString();
    document.getElementById('info-total-estudiantes').textContent = sistemaADAMS.estudiantes.length;
    document.getElementById('info-total-entrenadores').textContent = sistemaADAMS.entrenadores.length;
    document.getElementById('info-total-pagos').textContent = sistemaADAMS.pagos ? sistemaADAMS.pagos.length : 0;
    
    const datosSize = new Blob([JSON.stringify(sistemaADAMS)]).size;
    document.getElementById('info-tamano-datos').textContent = (datosSize / 1024).toFixed(1) + ' KB';
}
function actualizarInfoBackups() {
    const stats = obtenerEstadisticasBackups();
    
    // Buscar los elementos en la interfaz y actualizarlos
    const ultimoBackupElement = document.getElementById('ultimo-backup-fecha');
    const proximoBackupElement = document.getElementById('proximo-backup-fecha');
    
    if (ultimoBackupElement) {
        ultimoBackupElement.textContent = stats.ultimoBackup;
    }
    
    if (proximoBackupElement) {
        proximoBackupElement.textContent = stats.proximoBackup;
    }
    // Actualizar autom√°ticamente cada 30 segundos
setTimeout(() => {
    actualizarInfoBackups();
}, 30000);
}

// Funci√≥n para habilitar/deshabilitar backup diario
function toggleBackupDiario(habilitar) {
    if (window.sistemaBackups) {
        window.sistemaBackups.configuracion.habilitarBackupDiario = habilitar;
        const mensaje = habilitar ? 'Backups diarios habilitados' : 'Backups diarios deshabilitados';
        mostrarNotificacion(mensaje, 'success');
    }
}

// Funci√≥n para habilitar/deshabilitar backup al cerrar
function toggleBackupAlCerrar(habilitar) {
    if (window.sistemaBackups) {
        window.sistemaBackups.configuracion.habilitarBackupAlCerrar = habilitar;
        const mensaje = habilitar ? 'Backup al cerrar habilitado' : 'Backup al cerrar deshabilitado';
        mostrarNotificacion(mensaje, 'success');
    }
}

// === FIN DEL M√ìDULO DE CONFIGURACI√ìN ===
// FUNCIONES HELPER PARA INFORMACI√ìN DE LA ACADEMIA
function obtenerNombreAcademia() {
    return sistemaADAMS.configuracionGeneral?.nombreAcademia || "Academia de Gimnasia ADAMS";
}

function obtenerDireccionAcademia() {
    return sistemaADAMS.configuracionGeneral?.direccion || "Six Flags Hurricane Harbor Oaxtepec, Morelos";
}

function obtenerTelefonoAcademia() {
    return sistemaADAMS.configuracionGeneral?.telefono || "5610488668";
}

function obtenerWhatsAppAcademia() {
    return sistemaADAMS.configuracionGeneral?.whatsapp || "5610488668";
}

function obtenerEmailAcademia() {
    // Intentar obtener de configuraci√≥n primero
    if (sistemaADAMS.configuracion && sistemaADAMS.configuracion.email) {
        return sistemaADAMS.configuracion.email;
    }
    
    // Si no est√° en configuraci√≥n o est√° vac√≠o, no mostrar email
    return '';
}

function obtenerInstagramAcademia() {
    return sistemaADAMS.configuracionGeneral?.instagram || "academiadegimnasiaolmpicaadams";
}

function obtenerInicialAcademia() {
    const nombre = obtenerNombreAcademia();
    return nombre.charAt(0).toUpperCase();
}

function actualizarHeaderSistema() {
    const headerElement = document.getElementById('header-nombre-academia');
    if (headerElement) {
        headerElement.textContent = obtenerNombreAcademia();
    }
}
// FIN DE FUNCIONES HELPER


        // Inicializaci√≥n del sistema
        // Funci√≥n para verificar el estado del sistema
function verificarSistema() {
    console.log('=== VERIFICACI√ìN DEL SISTEMA ===');
    console.log('Entrenadores:', sistemaADAMS.entrenadores);
    console.log('Total entrenadores:', sistemaADAMS.entrenadores.length);
    
    const tbody = document.getElementById('tabla-entrenadores');
    console.log('Elemento tabla-entrenadores existe:', !!tbody);
    
    if (sistemaADAMS.entrenadores.length > 0) {
        console.log('Primer entrenador:', sistemaADAMS.entrenadores[0]);
    }
}
        document.addEventListener('DOMContentLoaded', function() {
    console.log('Iniciando Sistema ADAMS v4.0 - M√≥dulo de Pagos Integrado...');
    
    // 1. Cargar datos del localStorage
    cargarDatos();
    
    // 2. Verificar que los datos se cargaron correctamente
    console.log('Entrenadores cargados:', sistemaADAMS.entrenadores.length);
    console.log('Estudiantes cargados:', sistemaADAMS.estudiantes.length);
    console.log('Pagos cargados:', sistemaADAMS.pagos ? sistemaADAMS.pagos.length : 0);
    
    // 3. Inicializar arrays si no existen
    if (!sistemaADAMS.estudiantes) {
        sistemaADAMS.estudiantes = [];
    }
    if (!sistemaADAMS.pagos) {
        sistemaADAMS.pagos = [];
    }
    if (!sistemaADAMS.productos) {
        sistemaADAMS.productos = [];
    }
    
    // 4. Inicializar m√≥dulos
    inicializarAsistencias();
    inicializarModuloPagos();
    
    // 5. Actualizar tablas principales
    console.log('Actualizando tabla de estudiantes...');
    actualizarTablaEstudiantes();
    console.log('Actualizando tabla de entrenadores...');
    actualizarTablaEntrenadores();
    console.log('Actualizando tabla de pagos...');
    actualizarTablaPagos();
    
    // 6. Cargar selectores y opciones
    cargarSelectoresEntrenadores();
    cargarEntrenadoresEnSelect();
    cargarDisciplinasEnHorarios();
    cargarConceptosEnSelect();
    
    // 7. Actualizar vistas finales
    actualizarDashboard();
    actualizarBotonesEliminarEstudiante();
    actualizarDisciplinasEnFormularios();
    
    console.log('Sistema ADAMS iniciado correctamente');
    // Inicializar sistema de backups autom√°ticos
// Inicializar sistema de backups con m√°s tiempo y verificaciones
setTimeout(() => {
    if (typeof SistemaBackups !== 'undefined' && window.sistemaADAMS) {
        window.sistemaBackups = new SistemaBackups();
        console.log('Sistema de backups autom√°ticos iniciado');
    } else {
        console.log('Reintentando inicializaci√≥n de backups en 5 segundos...');
        setTimeout(() => {
            if (typeof SistemaBackups !== 'undefined') {
                window.sistemaBackups = new SistemaBackups();
                console.log('Sistema de backups autom√°ticos iniciado (segundo intento)');
            }
        }, 5000);
    }
}, 5000);
});

// FUNCIONES PARA PER√çODO PERSONALIZADO
function validarFechasPersonalizadas() {
    const fechaInicio = document.getElementById('fecha-inicio-personalizada').value;
    const fechaFin = document.getElementById('fecha-fin-personalizada').value;
    const btnAplicar = document.getElementById('btn-aplicar-personalizado');
    
    if (fechaInicio && fechaFin) {
        const inicio = new Date(fechaInicio);
        const fin = new Date(fechaFin);
        
        if (inicio <= fin) {
            btnAplicar.disabled = false;
            btnAplicar.innerHTML = 'üìÖ Aplicar Per√≠odo';
            btnAplicar.className = 'btn btn-primary';
            
            // Mostrar informaci√≥n del per√≠odo seleccionado
            const dias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('fecha-inicio-personalizada').title = `Per√≠odo seleccionado: ${dias} d√≠as`;
            document.getElementById('fecha-fin-personalizada').title = `Per√≠odo seleccionado: ${dias} d√≠as`;
        } else {
            btnAplicar.disabled = true;
            btnAplicar.innerHTML = '‚ùå Fecha inv√°lida';
            btnAplicar.className = 'btn btn-danger';
            mostrarNotificacion('La fecha de inicio debe ser anterior a la fecha de fin', 'error');
        }
    } else {
        btnAplicar.disabled = true;
        btnAplicar.innerHTML = 'üìÖ Selecciona fechas';
        btnAplicar.className = 'btn btn-secondary';
    }
}

function aplicarPeriodoPersonalizado() {
    const fechaInicio = document.getElementById('fecha-inicio-personalizada').value;
    const fechaFin = document.getElementById('fecha-fin-personalizada').value;
    
    if (!fechaInicio || !fechaFin) {
        mostrarNotificacion('Selecciona ambas fechas', 'error');
        return;
    }
    
    const inicio = new Date(fechaInicio);
    const fin = new Date(fechaFin);
    
    if (inicio > fin) {
        mostrarNotificacion('La fecha de inicio debe ser anterior a la fecha de fin', 'error');
        return;
    }
    
    // Generar reporte con fechas personalizadas
    generarReportePersonalizado(fechaInicio, fechaFin);
    
    const dias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
    mostrarNotificacion(`Reporte generado para ${dias} d√≠as (${formatearFecha(inicio)} - ${formatearFecha(fin)})`, 'success');
}

function generarReportePersonalizado(fechaInicio, fechaFin) {
    if (!sistemaADAMS.pagos) sistemaADAMS.pagos = [];
    
    const fechas = calcularFechasPeriodo('personalizado', fechaInicio, fechaFin);
    const pagosDelPeriodo = sistemaADAMS.pagos.filter(pago => {
        const fechaPago = new Date(pago.fecha);
        return fechaPago >= fechas.inicio && fechaPago <= fechas.fin;
    });

    const resumen = calcularResumenFinanciero(pagosDelPeriodo, 'general');
    mostrarResumenFinancieroPersonalizado(resumen, fechaInicio, fechaFin, pagosDelPeriodo.length);
}

function mostrarResumenFinancieroPersonalizado(resumen, fechaInicio, fechaFin, totalPagos) {
    const container = document.getElementById('resumen-financiero');
    // Corregir el problema de zona horaria en las fechas
const [a√±oInicio, mesInicio, diaInicio] = fechaInicio.split('-');
const [a√±oFin, mesFin, diaFin] = fechaFin.split('-');
const inicio = new Date(parseInt(a√±oInicio), parseInt(mesInicio) - 1, parseInt(diaInicio));
const fin = new Date(parseInt(a√±oFin), parseInt(mesFin) - 1, parseInt(diaFin));
    const dias = Math.ceil((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
    
    // Calcular ingresos por cada concepto personalizado
    const ingresosPorConcepto = {};
    let totalIngresos = 0;
    
    // Inicializar todos los conceptos configurados
    sistemaADAMS.conceptosPago.forEach(concepto => {
        if (concepto.activo) {
            ingresosPorConcepto[concepto.tipo] = {
                nombre: concepto.nombre,
                total: 0,
                cantidad: 0
            };
        }
    });
    
    // Calcular totales por concepto desde los pagos del per√≠odo personalizado
    if (sistemaADAMS.pagos) {
        const pagosDelPeriodo = sistemaADAMS.pagos.filter(pago => {
            const fechaPago = new Date(pago.fecha);
            return fechaPago >= inicio && fechaPago <= fin;
        });
        
        pagosDelPeriodo.forEach(pago => {
            totalIngresos += pago.montoTotal;
            
            if (pago.conceptos && pago.conceptos.length > 0) {
                // Pagos con m√∫ltiples conceptos
                pago.conceptos.forEach(concepto => {
                    if (ingresosPorConcepto[concepto.tipo]) {
                        ingresosPorConcepto[concepto.tipo].total += concepto.total;
                        ingresosPorConcepto[concepto.tipo].cantidad += 1;
                    }
                });
            } else {
                // Pagos antiguos con un solo concepto
                if (ingresosPorConcepto[pago.concepto]) {
                    ingresosPorConcepto[pago.concepto].total += pago.montoTotal;
                    ingresosPorConcepto[pago.concepto].cantidad += 1;
                }
            }
        });
    }
    
    // Generar las tarjetas de conceptos din√°micamente
    const conceptosConIngresos = Object.entries(ingresosPorConcepto)
        .filter(([tipo, datos]) => datos.total > 0 || datos.cantidad > 0)
        .sort((a, b) => b[1].total - a[1].total); // Ordenar por monto descendente
    
    const conceptosAMostrar = conceptosConIngresos.length > 0 ? 
        conceptosConIngresos : 
        Object.entries(ingresosPorConcepto).slice(0, 6);
    
    const tarjetasHTML = conceptosAMostrar.map(([tipo, datos], index) => {
        const colores = [
            { bg: '#e8f5e8', color: '#2e7d32' }, // Verde
            { bg: '#e3f2fd', color: '#1976d2' }, // Azul
            { bg: '#fff3e0', color: '#f57c00' }, // Naranja
            { bg: '#fce4ec', color: '#c2185b' }, // Rosa
            { bg: '#f3e5f5', color: '#7b1fa2' }, // Morado
            { bg: '#e0f2f1', color: '#00695c' }  // Verde agua
        ];
        
        const colorIndex = index % colores.length;
        const { bg, color } = colores[colorIndex];
        
        return `
            <div style="text-align: center; padding: 15px; background: ${bg}; border-radius: 10px;">
                <h4 style="color: ${color}; font-size: 14px; margin-bottom: 8px;">${datos.nombre}</h4>
                <div style="font-size: 20px; font-weight: bold; color: ${color};">$${datos.total.toFixed(2)}</div>
                <small style="color: ${color}; opacity: 0.8;">${datos.cantidad} pago${datos.cantidad !== 1 ? 's' : ''}</small>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <!-- Informaci√≥n del per√≠odo personalizado -->
        <div style="grid-column: 1 / -1; text-align: center; padding: 20px; background: linear-gradient(135deg, #2196f3, #21cbf3); border-radius: 15px; margin-bottom: 20px;">
            <h3 style="color: white; margin-bottom: 10px;">üìÖ REPORTE PERSONALIZADO</h3>
            <div style="color: white; margin-bottom: 10px;">
                <strong>${inicio.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</strong>
                al
                <strong>${fin.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</strong>
            </div>
            <div style="font-size: 36px; font-weight: bold; color: white;">$${totalIngresos.toFixed(2)}</div>
            <small style="color: white; opacity: 0.9;">${dias} d√≠as ‚Ä¢ ${totalPagos} pagos registrados</small>
        </div>
        
        <!-- Grid de conceptos -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
            ${tarjetasHTML}
        </div>
        
        <!-- Estad√≠sticas del per√≠odo -->
        <div style="padding: 20px; background: #f5f5f5; border-radius: 10px;">
            <h4>üìä Estad√≠sticas del Per√≠odo Personalizado</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                <div>
                    <strong>Duraci√≥n del per√≠odo:</strong> ${dias} d√≠as
                </div>
                <div>
                    <strong>Promedio diario:</strong> $${dias > 0 ? (totalIngresos / dias).toFixed(2) : '0.00'}
                </div>
                <div>
                    <strong>Total de pagos:</strong> ${totalPagos}
                </div>
                <div>
                    <strong>Promedio por pago:</strong> $${totalPagos > 0 ? (totalIngresos / totalPagos).toFixed(2) : '0.00'}
                </div>
            </div>
        </div>
    `;
}
// Aplicar formato de nombre propio en tiempo real a los campos
// Aplicar formato de nombre propio en tiempo real a los campos
document.addEventListener('DOMContentLoaded', function() {
    // Funci√É¬≥n para aplicar formato cuando el usuario termina de escribir
    function aplicarFormatoNombre(event) {
        const campo = event.target;
        const valorFormateado = formatearNombrePropio(campo.value);
        if (campo.value !== valorFormateado) {
            campo.value = valorFormateado;
        }
    }
    
    // Lista de IDs de campos que deben tener formato de nombre
    const camposNombre = [
        'nombre',                    // Nombre del estudiante
        'tutor',                     // Nombre del tutor
        'entrenador-nombre',         // Nombre del entrenador
        'muestra-nombre'             // Nombre del prospecto de clase muestra
    ];
    
    // Aplicar evento a cada campo
    camposNombre.forEach(campoId => {
        const campo = document.getElementById(campoId);
        if (campo) {
            // Aplicar formato cuando el usuario sale del campo (blur)
            campo.addEventListener('blur', aplicarFormatoNombre);
            
            // Tambi√É¬©n aplicar formato cuando presiona Enter
            campo.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    aplicarFormatoNombre(event);
                }
            });
        }
    });
});
// ===== M√ìDULO DE REPORTES AVANZADOS =====

// Funci√≥n principal para actualizar todos los reportes
function actualizarTodosLosReportes() {
    mostrarNotificacion('Actualizando todos los reportes...', 'success');
    
    // Actualizar estad√≠sticas generales
    actualizarEstadisticasGenerales();
    
    // Actualizar gr√°ficos
    setTimeout(() => {
        generarGraficoDisciplinas();
        generarGraficoHorarios();
        generarResumenFinancieroRapido();
    }, 500);
    
    // Actualizar otros an√°lisis
    setTimeout(() => {
        generarAnalisisRetencion();
        generarAnalisisProductividad();
        generarAnalisisTendencias();
        generarProyeccionesFinancieras();
    }, 1000);
}

// Funci√≥n para actualizar estad√≠sticas generales
function actualizarEstadisticasGenerales() {
    const totalEstudiantes = sistemaADAMS.estudiantes.length;
    const estudiantesActivos = sistemaADAMS.estudiantes.filter(e => (e.estatus || 'activo') === 'activo').length;
    
    // Calcular nivel de ocupaci√≥n
    const capacidadTotal = sistemaADAMS.entrenadores.reduce((total, entrenador) => {
        const horasSemanales = entrenador.horarios.length;
        return total + (horasSemanales * 10); // 10 estudiantes por hora promedio
    }, 0);
    
    const nivelOcupacion = capacidadTotal > 0 ? Math.round((estudiantesActivos / capacidadTotal) * 100) : 0;
    
    // Calcular ingresos totales hist√≥ricos
    const ingresosTotales = sistemaADAMS.pagos ? 
        sistemaADAMS.pagos.reduce((total, pago) => total + pago.montoTotal, 0) : 0;
    
    // Actualizar elementos
    document.getElementById('reporte-total-estudiantes').textContent = totalEstudiantes;
    document.getElementById('reporte-estudiantes-activos').textContent = estudiantesActivos;
    document.getElementById('reporte-ocupacion').textContent = nivelOcupacion + '%';
    document.getElementById('reporte-ingresos-totales').textContent = '$' + ingresosTotales.toLocaleString();
}

// Funci√≥n para generar gr√°fico de disciplinas
function generarGraficoDisciplinas() {
    const disciplinas = {};
    
    // Contar estudiantes por disciplina
    sistemaADAMS.estudiantes.forEach(estudiante => {
        if ((estudiante.estatus || 'activo') === 'activo') {
            estudiante.disciplinas.forEach(disciplina => {
                disciplinas[disciplina] = (disciplinas[disciplina] || 0) + 1;
            });
        }
    });
    
    // Generar tabla de datos
    const tablaDisciplinas = document.getElementById('tabla-disciplinas');
    let tablaHTML = '<table class="table"><thead><tr><th>Disciplina</th><th>Estudiantes</th><th>Porcentaje</th></tr></thead><tbody>';
    
    const totalEstudiantes = Object.values(disciplinas).reduce((a, b) => a + b, 0);
    
    Object.entries(disciplinas).forEach(([disciplina, cantidad]) => {
        const porcentaje = totalEstudiantes > 0 ? ((cantidad / totalEstudiantes) * 100).toFixed(1) : 0;
        tablaHTML += `
            <tr>
                <td>${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</td>
                <td>${cantidad}</td>
                <td>${porcentaje}%</td>
            </tr>
        `;
    });
    
    tablaHTML += '</tbody></table>';
    tablaDisciplinas.innerHTML = tablaHTML;
    
    // Crear contenedor separado para gr√°fico y tabla
const canvas = document.getElementById('grafico-disciplinas');
if (canvas) {
    const contenedorPadre = canvas.parentElement;
    
    // Verificar que hay datos para mostrar
    if (Object.keys(disciplinas).length === 0) {
        contenedorPadre.innerHTML = `
            <h3>üìä Distribuci√≥n por Disciplinas</h3>
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                <p style="color: #666;">No hay datos de disciplinas disponibles</p>
            </div>
        `;
        return;
    }
    
    let graficoHTML = `
        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #9c27b0; margin-bottom: 20px; text-align: center;">üìä Distribuci√≥n por Disciplinas</h3>
            <div style="display: flex; align-items: end; height: 220px; gap: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; justify-content: center; overflow-x: auto;">
    `;
    
    const maxValor = Math.max(...Object.values(disciplinas));
    const colores = {
        'gimnasia': '#9c27b0',
        'parkour': '#2196f3', 
        'box': '#ff9800',
        'acrobacia': '#4caf50',
        'danza': '#e91e63'
    };
    
    Object.entries(disciplinas).forEach(([disciplina, cantidad], index) => {
        const altura = maxValor > 0 ? Math.max((cantidad / maxValor) * 120, 20) : 20;
        const color = colores[disciplina] || `hsl(${index * 60}, 70%, 50%)`;
        
        graficoHTML += `
            <div style="display: flex; flex-direction: column; align-items: center; min-width: 90px; margin: 0 5px;">
                <div style="font-weight: bold; margin-bottom: 10px; font-size: 16px; color: ${color};">${cantidad}</div>
                <div style="
                    width: 60px; 
                    height: ${altura}px; 
                    background: linear-gradient(to top, ${color}, ${color}dd); 
                    border-radius: 10px 10px 0 0; 
                    transition: all 0.3s ease; 
                    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                    position: relative;
                "></div>
                <div style="
                    margin-top: 20px; 
                    font-size: 12px; 
                    text-align: center; 
                    font-weight: 600; 
                    color: #333; 
                    white-space: nowrap;
                    max-width: 80px;
                ">
                    ${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}
                </div>
            </div>
        `;
    });
    
    graficoHTML += `
            </div>
        </div>
    `;
    
    // Insertar gr√°fico seguido de la tabla
    contenedorPadre.innerHTML = graficoHTML + `
        <div style="background: white; border-radius: 15px; padding: 20px 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 10px;">
            ${tablaDisciplinas.outerHTML}
        </div>
    `;
}
}

// Funci√≥n para generar gr√°fico de horarios
function generarGraficoHorarios() {
    const horarios = {};
    
    // Contar estudiantes por horario
    sistemaADAMS.estudiantes.forEach(estudiante => {
        if ((estudiante.estatus || 'activo') === 'activo') {
            estudiante.horarios.forEach(horario => {
                const horarioTexto = `${horario.horaInicio}-${horario.horaFin}`;
                horarios[horarioTexto] = (horarios[horarioTexto] || 0) + 1;
            });
        }
    });
    
    // Generar tabla de datos
    const tablaHorarios = document.getElementById('tabla-horarios');
    let tablaHTML = '<table class="table"><thead><tr><th>Horario</th><th>Estudiantes</th><th>Nivel</th></tr></thead><tbody>';
    
    Object.entries(horarios)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach(([horario, cantidad]) => {
            const nivel = cantidad >= 15 ? 'Alto' : cantidad >= 8 ? 'Medio' : 'Bajo';
            const colorNivel = cantidad >= 15 ? '#4caf50' : cantidad >= 8 ? '#ff9800' : '#f44336';
            
            tablaHTML += `
                <tr>
                    <td>${horario}</td>
                    <td>${cantidad}</td>
                    <td><span style="color: ${colorNivel}; font-weight: bold;">${nivel}</span></td>
                </tr>
            `;
        });
    
    tablaHTML += '</tbody></table>';
    tablaHorarios.innerHTML = tablaHTML;
    
    // Crear gr√°fico mejorado de horarios
const canvas = document.getElementById('grafico-horarios');
if (canvas) {
    const contenedorPadre = canvas.parentElement;
    
    // Verificar que hay datos
    if (Object.keys(horarios).length === 0) {
        contenedorPadre.innerHTML = `
            <h3>üïê Distribuci√≥n por Horarios</h3>
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                <p style="color: #666;">No hay datos de horarios disponibles</p>
            </div>
        `;
        return;
    }
    
    let graficoHTML = `
        <div style="background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <h3 style="color: #2196f3; margin-bottom: 20px; text-align: center;">üïê Distribuci√≥n por Horarios</h3>
            <div style="
    display: flex; 
    align-items: end; 
    height: 220px; 
    gap: 6px; 
    padding: 15px; 
    background: #f8f9fa; 
    border-radius: 10px; 
    overflow-x: auto;
    justify-content: flex-start;
    min-width: 100%;
">
    `;
    
    const maxValor = Math.max(...Object.values(horarios));
    
    Object.entries(horarios)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach(([horario, cantidad]) => {
           const altura = maxValor > 0 ? Math.max((cantidad / maxValor) * 120, 20) : 20;
            const color = cantidad >= 15 ? '#4caf50' : cantidad >= 8 ? '#ff9800' : '#f44336';
            
            graficoHTML += `
                <div style="
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    min-width: 53px; 
                    margin: 0 3px;
                    flex-shrink: 0;
                ">
                    <div style="
                        font-weight: bold; 
                        margin-bottom: 8px; 
                        font-size: 13px; 
                        color: ${color};
                        text-align: center;
                    ">${cantidad}</div>
                    <div style="
                        width: 40px; 
                        height: ${altura}px; 
                        background: linear-gradient(to top, ${color}, ${color}cc); 
                        border-radius: 8px 8px 0 0; 
                        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
                        transition: all 0.3s ease;
                    "></div>
                    <div style="
    margin-top: 12px; 
    font-size: 9px; 
    text-align: center; 
    color: #555; 
    font-weight: 600;
    white-space: nowrap;
    width: 45px;
    line-height: 1.2;
    padding: 2px;
    background: rgba(255,255,255,0.8);
    border-radius: 3px;
">
    ${horario}
</div>
                </div>
            `;
        });
    
    graficoHTML += `
            </div>
            <div style="
    margin-top: 20px; 
    text-align: center; 
    font-size: 11px;
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 8px 15px;
    background: rgba(255,255,255,0.5);
    border-radius: 8px;
">
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #4caf50; border-radius: 2px;"></div>
        <span>Alto (15+)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #ff9800; border-radius: 2px;"></div>
        <span>Medio (8-14)</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 12px; height: 12px; background: #f44336; border-radius: 2px;"></div>
        <span>Bajo (1-7)</span>
    </div>
</div>
        </div>
    `;
    
    // Insertar gr√°fico seguido de la tabla
    contenedorPadre.innerHTML = graficoHTML + `
        <div style="background: white; border-radius: 15px; padding: 20px 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 10px;">
            ${tablaHorarios.outerHTML}
        </div>
    `;
}
}

// Funci√≥n para generar resumen financiero r√°pido
function generarResumenFinancieroRapido() {
    const hoy = new Date();
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    
    // Calcular ingresos del mes actual
    const ingresosMes = sistemaADAMS.pagos ? 
        sistemaADAMS.pagos
            .filter(pago => new Date(pago.fecha) >= inicioMes)
            .reduce((total, pago) => total + pago.montoTotal, 0) : 0;
    
    // Calcular meta mensual estimada
    const estudiantesActivos = sistemaADAMS.estudiantes.filter(e => (e.estatus || 'activo') === 'activo').length;
    const metaMensual = 110000; // Meta fija mensual de $110,000

    
    // Calcular porcentaje de cumplimiento
    const porcentajeCumplimiento = metaMensual > 0 ? ((ingresosMes / metaMensual) * 100).toFixed(1) : 0;
    
    const container = document.getElementById('resumen-financiero-rapido');
    container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
            <div style="text-align: center; padding: 20px; background: #e8f5e8; border-radius: 10px;">
                <h4 style="color: #2e7d32; margin-bottom: 10px;">Ingresos del Mes</h4>
                <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">$${ingresosMes.toLocaleString()}</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #e3f2fd; border-radius: 10px;">
                <h4 style="color: #1976d2; margin-bottom: 10px;">Meta Mensual</h4>
                <div style="font-size: 24px; font-weight: bold; color: #1976d2;">$${metaMensual.toLocaleString()}</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #fff3e0; border-radius: 10px;">
                <h4 style="color: #f57c00; margin-bottom: 10px;">Cumplimiento</h4>
                <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${porcentajeCumplimiento}%</div>
            </div>
            <div style="text-align: center; padding: 20px; background: #f3e5f5; border-radius: 10px;">
                <h4 style="color: #7b1fa2; margin-bottom: 10px;">Proyecci√≥n</h4>
                <div style="font-size: 24px; font-weight: bold; color: #7b1fa2;">$${Math.round(ingresosMes * (30 / hoy.getDate())).toLocaleString()}</div>
            </div>
        </div>
    `;
}

// Funci√≥n para generar an√°lisis de tendencias
function generarAnalisisTendencias() {
    const periodo = document.getElementById('periodo-tendencias')?.value || '6-meses';
    const tipo = document.getElementById('tipo-tendencia')?.value || 'ingresos';
    
    const container = document.getElementById('container-analisis-tendencias');
    if (!container) return;
    
    // Calcular fechas seg√∫n per√≠odo
    const hoy = new Date();
    let fechaInicio;
    
    switch(periodo) {
        case '6-meses':
            fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth() - 6, 1);
            break;
        case '1-a√±o':
            fechaInicio = new Date(hoy.getFullYear() - 1, hoy.getMonth(), 1);
            break;
        case '2-a√±os':
            fechaInicio = new Date(hoy.getFullYear() - 2, hoy.getMonth(), 1);
            break;
        default:
            fechaInicio = new Date(2020, 0, 1); // Todo el historial
    }
    
    if (tipo === 'ingresos') {
        generarTendenciaIngresos(fechaInicio, hoy, container);
    } else if (tipo === 'estudiantes') {
        generarTendenciaEstudiantes(fechaInicio, hoy, container);
    }
}

// Funci√≥n para generar tendencia de ingresos
function generarTendenciaIngresos(fechaInicio, fechaFin, container) {
    const ingresosPorMes = {};
    
    // Agrupar pagos por mes
    if (sistemaADAMS.pagos) {
        sistemaADAMS.pagos
            .filter(pago => {
                const fechaPago = new Date(pago.fecha);
                return fechaPago >= fechaInicio && fechaPago <= fechaFin;
            })
            .forEach(pago => {
                const fechaPago = new Date(pago.fecha);
                const mesA√±o = `${fechaPago.getFullYear()}-${(fechaPago.getMonth() + 1).toString().padStart(2, '0')}`;
                ingresosPorMes[mesA√±o] = (ingresosPorMes[mesA√±o] || 0) + pago.montoTotal;
            });
    }
    
    // Generar visualizaci√≥n
    let htmlTendencia = '<div class="table-container"><h4>üìà Tendencia de Ingresos por Mes</h4>';
    htmlTendencia += '<div style="display: flex; align-items: end; height: 250px; gap: 5px; padding: 20px; background: #f8f9fa; border-radius: 10px; overflow-x: auto;">';
    
    const maxIngresos = Math.max(...Object.values(ingresosPorMes), 1);
    
    Object.entries(ingresosPorMes)
        .sort((a, b) => a[0].localeCompare(b[0]))
        .forEach(([mes, ingresos]) => {
            const altura = (ingresos / maxIngresos) * 200;
            const mesNombre = new Date(mes + '-01').toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
            
            htmlTendencia += `
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                    <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">$${(ingresos/1000).toFixed(0)}k</div>
                    <div style="width: 30px; height: ${altura}px; background: linear-gradient(to top, #9c27b0, #e91e63); border-radius: 5px 5px 0 0;"></div>
                    <div style="margin-top: 5px; font-size: 10px; transform: rotate(-45deg); margin-top: 15px;">
                        ${mesNombre}
                    </div>
                </div>
            `;
        });
    
    htmlTendencia += '</div></div>';
    
    // Calcular estad√≠sticas de tendencia
    const valores = Object.values(ingresosPorMes);
    const promedio = valores.length > 0 ? valores.reduce((a, b) => a + b, 0) / valores.length : 0;
    const ultimoMes = valores[valores.length - 1] || 0;
    const penultimoMes = valores[valores.length - 2] || 0;
    const crecimiento = penultimoMes > 0 ? ((ultimoMes - penultimoMes) / penultimoMes * 100).toFixed(1) : 0;
    
    htmlTendencia += `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
            <div style="text-align: center; padding: 15px; background: #e8f5e8; border-radius: 10px;">
                <h4 style="color: #2e7d32;">Promedio Mensual</h4>
                <div style="font-size: 20px; font-weight: bold; color: #2e7d32;">$${promedio.toLocaleString()}</div>
            </div>
            <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                <h4 style="color: #1976d2;">√öltimo Mes</h4>
                <div style="font-size: 20px; font-weight: bold; color: #1976d2;">$${ultimoMes.toLocaleString()}</div>
            </div>
            <div style="text-align: center; padding: 15px; background: ${crecimiento >= 0 ? '#e8f5e8' : '#ffebee'}; border-radius: 10px;">
                <h4 style="color: ${crecimiento >= 0 ? '#2e7d32' : '#d32f2f'};">Crecimiento</h4>
                <div style="font-size: 20px; font-weight: bold; color: ${crecimiento >= 0 ? '#2e7d32' : '#d32f2f'};">${crecimiento}%</div>
            </div>
        </div>
    `;
    
    container.innerHTML = htmlTendencia;
}

// Funci√≥n para generar an√°lisis de retenci√≥n
function generarAnalisisRetencion() {
    const hoy = new Date();
    const hace3Meses = new Date(hoy.getFullYear(), hoy.getMonth() - 3, 1);
    
    // Estudiantes que estaban activos hace 3 meses
    const estudiantesBase = sistemaADAMS.estudiantes.filter(estudiante => {
        const fechaRegistro = new Date(estudiante.fechaRegistro || '2023-01-01');
        return fechaRegistro <= hace3Meses;
    });
    
    // Estudiantes que siguen activos
    const estudiantesRetenidos = estudiantesBase.filter(estudiante => 
        (estudiante.estatus || 'activo') === 'activo'
    );
    
    const tasaRetencion = estudiantesBase.length > 0 ? 
        ((estudiantesRetenidos.length / estudiantesBase.length) * 100).toFixed(1) : 0;
    
    // Calcular tiempo promedio de permanencia
    let tiempoPromedio = 0;
    if (sistemaADAMS.estudiantes.length > 0) {
        const tiempos = sistemaADAMS.estudiantes.map(estudiante => {
            const fechaRegistro = new Date(estudiante.fechaRegistro || '2023-01-01');
            const fechaFin = (estudiante.estatus || 'activo') === 'activo' ? hoy : new Date(estudiante.fechaBaja || hoy);
            return Math.round((fechaFin - fechaRegistro) / (1000 * 60 * 60 * 24 * 30)); // meses
        });
        tiempoPromedio = Math.round(tiempos.reduce((a, b) => a + b, 0) / tiempos.length);
    }
    
    // Estudiantes en riesgo (m√°s de 3 faltas en el √∫ltimo mes)
    const estudiantesRiesgo = calcularEstudiantesEnRiesgo();
    
    // Nuevos estudiantes este mes
    const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
    const nuevosEsteMes = sistemaADAMS.estudiantes.filter(estudiante => {
        const fechaRegistro = new Date(estudiante.fechaRegistro || '2023-01-01');
        return fechaRegistro >= inicioMes;
    }).length;
    
    // Actualizar estad√≠sticas
    document.getElementById('tasa-retencion').textContent = tasaRetencion + '%';
    document.getElementById('tiempo-promedio').textContent = tiempoPromedio;
    document.getElementById('estudiantes-riesgo').textContent = estudiantesRiesgo.length;
    document.getElementById('nuevos-mes').textContent = nuevosEsteMes;
    
    // Generar tabla de retenci√≥n
    generarTablaRetencion();
    generarTablaRiesgoAbandono(estudiantesRiesgo);
}

// Funci√≥n para calcular estudiantes en riesgo
function calcularEstudiantesEnRiesgo() {
    const estudiantesRiesgo = [];
    const hoy = new Date();
    const haceUnMes = new Date(hoy.getFullYear(), hoy.getMonth() - 1, hoy.getDate());
    
    sistemaADAMS.estudiantes.forEach(estudiante => {
        if ((estudiante.estatus || 'activo') !== 'activo') return;
        
        // Contar asistencias del √∫ltimo mes
        const asistenciasUltimoMes = sistemaADAMS.asistenciasEstudiantes ?
            sistemaADAMS.asistenciasEstudiantes.filter(asistencia => {
                const fechaAsistencia = new Date(asistencia.fecha);
                return asistencia.estudianteId === estudiante.id && 
                       fechaAsistencia >= haceUnMes &&
                       fechaAsistencia <= hoy;
            }) : [];
        
        const ausencias = asistenciasUltimoMes.filter(a => a.estado === 'ausente').length;
        const totalClases = asistenciasUltimoMes.length;
        const porcentajeAsistencia = totalClases > 0 ? (asistenciasUltimoMes.filter(a => a.estado === 'presente' || a.estado === 'tardanza').length / totalClases * 100) : 100;
        
        // Criterios de riesgo
        if (ausencias >= 3 || porcentajeAsistencia < 70 || totalClases === 0) {
            estudiantesRiesgo.push({
                estudiante: estudiante,
                ausencias: ausencias,
                totalClases: totalClases,
                porcentajeAsistencia: porcentajeAsistencia.toFixed(1),
                riesgo: ausencias >= 5 ? 'Alto' : ausencias >= 3 ? 'Medio' : 'Bajo'
            });
        }
    });
    
    return estudiantesRiesgo;
}

// Funci√≥n para generar tabla de retenci√≥n detallada
function generarTablaRetencion() {
    const container = document.getElementById('tabla-retencion');
    if (!container) return;
    
    // An√°lisis por disciplina
    const retencionPorDisciplina = {};
    
    sistemaADAMS.configuracion.disciplinas.forEach(disciplina => {
        const estudiantes = sistemaADAMS.estudiantes.filter(e => e.disciplinas.includes(disciplina));
        const activos = estudiantes.filter(e => (e.estatus || 'activo') === 'activo');
        const tasa = estudiantes.length > 0 ? ((activos.length / estudiantes.length) * 100).toFixed(1) : 0;
        
        retencionPorDisciplina[disciplina] = {
            total: estudiantes.length,
            activos: activos.length,
            tasa: tasa
        };
    });
    
    let html = '<table class="table"><thead><tr><th>Disciplina</th><th>Total Hist√≥rico</th><th>Activos</th><th>Tasa de Retenci√≥n</th></tr></thead><tbody>';
    
    Object.entries(retencionPorDisciplina).forEach(([disciplina, datos]) => {
        const colorTasa = datos.tasa >= 80 ? '#4caf50' : datos.tasa >= 60 ? '#ff9800' : '#f44336';
        html += `
            <tr>
                <td>${disciplina.charAt(0).toUpperCase() + disciplina.slice(1)}</td>
                <td>${datos.total}</td>
                <td>${datos.activos}</td>
                <td><span style="color: ${colorTasa}; font-weight: bold;">${datos.tasa}%</span></td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Funci√≥n para generar tabla de riesgo de abandono
function generarTablaRiesgoAbandono(estudiantesRiesgo) {
    const container = document.getElementById('tabla-riesgo-abandono');
    if (!container) return;
    
    if (estudiantesRiesgo.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #4caf50; padding: 20px;">¬°Excelente! No hay estudiantes en riesgo de abandono</p>';
        return;
    }
    
    let html = '<table class="table"><thead><tr><th>Estudiante</th><th>Ausencias</th><th>% Asistencia</th><th>Nivel de Riesgo</th><th>Acciones</th></tr></thead><tbody>';
    
    estudiantesRiesgo
        .sort((a, b) => b.ausencias - a.ausencias)
        .forEach(item => {
            const colorRiesgo = item.riesgo === 'Alto' ? '#f44336' : item.riesgo === 'Medio' ? '#ff9800' : '#2196f3';
            
            html += `
                <tr>
                    <td>
                        <strong>${item.estudiante.nombre}</strong><br>
                        <small style="color: #666;">${item.estudiante.tutor} - ${item.estudiante.telefono}</small>
                    </td>
                    <td>${item.ausencias} de ${item.totalClases}</td>
                    <td>${item.porcentajeAsistencia}%</td>
                    <td><span style="color: ${colorRiesgo}; font-weight: bold;">${item.riesgo}</span></td>
                    <td>
                        <button class="btn btn-primary btn-small" onclick="contactarEstudiante(${item.estudiante.id})">
                            üìû Contactar
                        </button>
                    </td>
                </tr>
            `;
        });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

// Funci√≥n para generar an√°lisis de productividad de entrenadores
function generarAnalisisProductividad() {
    const container = document.getElementById('tabla-productividad-entrenadores');
    if (!container) return;
    
    const productividad = [];
    
    sistemaADAMS.entrenadores.forEach(entrenador => {
        if (entrenador.estado !== 'activo') return;
        
        // Contar estudiantes asignados
        const estudiantesAsignados = sistemaADAMS.estudiantes.filter(estudiante => 
            (estudiante.estatus || 'activo') === 'activo' &&
            estudiante.horarios.some(horario => horario.entrenadorId === entrenador.id)
        ).length;
        
        // Calcular ingresos generados
        const ingresosGenerados = sistemaADAMS.pagos ? 
            sistemaADAMS.pagos
                .filter(pago => {
                    const estudiante = sistemaADAMS.estudiantes.find(e => e.id === pago.estudianteId);
                    return estudiante && estudiante.horarios.some(h => h.entrenadorId === entrenador.id);
                })
                .reduce((total, pago) => total + pago.montoTotal, 0) : 0;
        
        // Calcular tasa de retenci√≥n
        const estudiantesHistoricos = sistemaADAMS.estudiantes.filter(estudiante =>
            estudiante.horarios.some(horario => horario.entrenadorId === entrenador.id)
        );
        
        const estudiantesRetenidos = estudiantesHistoricos.filter(estudiante =>
            (estudiante.estatus || 'activo') === 'activo'
        );
        
        const tasaRetencion = estudiantesHistoricos.length > 0 ?
            ((estudiantesRetenidos.length / estudiantesHistoricos.length) * 100).toFixed(1) : 0;
        
        productividad.push({
            entrenador: entrenador,
            estudiantesAsignados: estudiantesAsignados,
            ingresosGenerados: ingresosGenerados,
            tasaRetencion: tasaRetencion,
            horasSemanales: entrenador.horarios.length,
            ingresosPorHora: entrenador.horarios.length > 0 ? (ingresosGenerados / (entrenador.horarios.length * 4)).toFixed(0) : 0
        });
    });
    
    // Ordenar por ingresos generados
    productividad.sort((a, b) => b.ingresosGenerados - a.ingresosGenerados);
    
    let html = '<table class="table"><thead><tr><th>Entrenador</th><th>Estudiantes</th><th>Ingresos Generados</th><th>Tasa Retenci√≥n</th><th>Horas/Semana</th><th>$/Hora Prom.</th></tr></thead><tbody>';
    
    productividad.forEach((datos, index) => {
        const colorRetenci√≥n = datos.tasaRetencion >= 85 ? '#4caf50' : datos.tasaRetencion >= 70 ? '#ff9800' : '#f44336';
        const medalla = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
        
        html += `
            <tr>
                <td>
                    ${medalla} <strong>${datos.entrenador.nombre}</strong><br>
                    <small style="color: #666;">${datos.entrenador.disciplinas.join(', ')}</small>
                </td>
                <td>${datos.estudiantesAsignados}</td>
                <td><strong>$${datos.ingresosGenerados.toLocaleString()}</strong></td>
                <td><span style="color: ${colorRetenci√≥n}; font-weight: bold;">${datos.tasaRetencion}%</span></td>
                <td>${datos.horasSemanales}h</td>
                <td>$${datos.ingresosPorHora}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // Generar rankings
    generarRankingEntrenadores(productividad);
}

// Funci√≥n para generar ranking de entrenadores
function generarRankingEntrenadores(productividad) {
    // Top por retenci√≥n
    const containerRetencion = document.getElementById('ranking-entrenadores-retencion');
    if (containerRetencion) {
        const topRetencion = [...productividad]
            .sort((a, b) => b.tasaRetencion - a.tasaRetencion)
            .slice(0, 3);
        
        let htmlRetencion = '';
        topRetencion.forEach((datos, index) => {
            const medalla = ['ü•á', 'ü•à', 'ü•â'][index];
            htmlRetencion += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 8px;">
                    <div>
                        ${medalla} <strong>${datos.entrenador.nombre}</strong>
                    </div>
                    <div style="font-weight: bold; color: #4caf50;">
                        ${datos.tasaRetencion}%
                    </div>
                </div>
            `;
        });
        containerRetencion.innerHTML = htmlRetencion;
    }
    
    // Top por ingresos
    const containerIngresos = document.getElementById('ranking-entrenadores-ingresos');
    if (containerIngresos) {
        const topIngresos = productividad.slice(0, 3);
        
        let htmlIngresos = '';
        topIngresos.forEach((datos, index) => {
            const medalla = ['ü•á', 'ü•à', 'ü•â'][index];
            htmlIngresos += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 8px;">
                    <div>
                        ${medalla} <strong>${datos.entrenador.nombre}</strong>
                    </div>
                    <div style="font-weight: bold; color: #9c27b0;">
                        $${datos.ingresosGenerados.toLocaleString()}
                    </div>
                </div>
            `;
        });
        containerIngresos.innerHTML = htmlIngresos;
    }
}

// Funci√≥n para generar proyecciones financieras
function generarProyeccionesFinancieras() {
    const horizonte = document.getElementById('horizonte-proyeccion')?.value || '6-meses';
    const escenario = document.getElementById('escenario-proyeccion')?.value || 'realista';
    
    // Calcular ingresos promedio mensual de los √∫ltimos 6 meses
    const hoy = new Date();
    const hace6Meses = new Date(hoy.getFullYear(), hoy.getMonth() - 6, 1);
    
    const ingresosMensuales = [];
    if (sistemaADAMS.pagos) {
        for (let i = 0; i < 6; i++) {
            const mesInicio = new Date(hoy.getFullYear(), hoy.getMonth() - i, 1);
            const mesFin = new Date(hoy.getFullYear(), hoy.getMonth() - i + 1, 0);
            
            const ingresosMes = sistemaADAMS.pagos
                .filter(pago => {
                    const fechaPago = new Date(pago.fecha);
                    return fechaPago >= mesInicio && fechaPago <= mesFin;
                })
                .reduce((total, pago) => total + pago.montoTotal, 0);
            
            ingresosMensuales.push(ingresosMes);
        }
    }
    
    const promedioMensual = ingresosMensuales.length > 0 ?
        ingresosMensuales.reduce((a, b) => a + b, 0) / ingresosMensuales.length : 0;
    
    // Aplicar factor de escenario
    let factor = 1;
    switch(escenario) {
        case 'conservador': factor = 0.9; break;
        case 'optimista': factor = 1.2; break;
        case 'pesimista': factor = 0.75; break;
        default: factor = 1; // realista
    }
    
    // Calcular proyecciones
    const mesesProyeccion = horizonte === '3-meses' ? 3 : horizonte === '6-meses' ? 6 : horizonte === '1-a√±o' ? 12 : 24;
    const ingresosMensualesProyectados = promedioMensual * factor;
    const ingresosProyectados = ingresosMensualesProyectados * mesesProyeccion;
    
    // Proyectar estudiantes
    const estudiantesActuales = sistemaADAMS.estudiantes.filter(e => (e.estatus || 'activo') === 'activo').length;
    const crecimientoEstudiantes = factor - 1;
    const estudiantesProyectados = Math.round(estudiantesActuales * (1 + (crecimientoEstudiantes * mesesProyeccion / 12)));
    
    // Calcular ocupaci√≥n proyectada
    const capacidadTotal = sistemaADAMS.entrenadores.reduce((total, entrenador) => {
        return total + (entrenador.horarios.length * 10);
    }, 0);
    const ocupacionProyectada = capacidadTotal > 0 ? Math.min(100, Math.round((estudiantesProyectados / capacidadTotal) * 100)) : 0;
    
    // Actualizar elementos
    document.getElementById('proyeccion-ingresos').textContent = '$' + ingresosProyectados.toLocaleString();
    document.getElementById('proyeccion-estudiantes').textContent = estudiantesProyectados;
    document.getElementById('proyeccion-ocupacion').textContent = ocupacionProyectada + '%';
    document.getElementById('crecimiento-proyectado').textContent = (crecimientoEstudiantes * 100).toFixed(1) + '%';
    
    // Generar gr√°fico de proyecci√≥n
    generarGraficoProyeccion(ingresosMensuales, ingresosMensualesProyectados, mesesProyeccion);
}

// Funci√≥n para generar gr√°fico de proyecci√≥n
function generarGraficoProyeccion(historicos, proyectadoMensual, mesesProyeccion) {
    const container = document.getElementById('container-proyecciones');
    if (!container) return;
    
    // Crear datos combinados (hist√≥ricos + proyectados)
    const todosLosDatos = [...historicos.reverse()]; // Datos hist√≥ricos
    
    // Agregar datos proyectados
    for (let i = 1; i <= mesesProyeccion; i++) {
        todosLosDatos.push(proyectadoMensual);
    }
    
    const maxValor = Math.max(...todosLosDatos);
    
    let graficoHTML = '<div class="table-container"><h4>üìà Proyecci√≥n de Ingresos</h4>';
    graficoHTML += '<div style="display: flex; align-items: end; height: 300px; gap: 8px; padding: 20px; background: #f8f9fa; border-radius: 10px; overflow-x: auto;">';
    
    todosLosDatos.forEach((valor, index) => {
        const altura = maxValor > 0 ? (valor / maxValor) * 250 : 0;
        const esHistorico = index < historicos.length;
        const color = esHistorico ? '#9c27b0' : '#4caf50';
        const estilo = esHistorico ? 'solid' : 'dashed';
        
        // Calcular fecha
        const hoy = new Date();
        const fecha = new Date(hoy.getFullYear(), hoy.getMonth() - historicos.length + index + 1, 1);
        const mesTexto = fecha.toLocaleDateString('es-ES', { month: 'short', year: '2-digit' });
        
        graficoHTML += `
            <div style="display: flex; flex-direction: column; align-items: center; min-width: 40px;">
                <div style="font-size: 10px; font-weight: bold; margin-bottom: 5px;">$${(valor/1000).toFixed(0)}k</div>
                <div style="width: 25px; height: ${altura}px; background: ${color}; border: 2px ${estilo} ${color}; border-radius: 5px 5px 0 0; opacity: ${esHistorico ? '1' : '0.7'};"></div>
                <div style="margin-top: 5px; font-size: 9px; transform: rotate(-45deg); margin-top: 15px;">
                    ${mesTexto}
                </div>
            </div>
        `;
    });
    
    graficoHTML += '</div>';
    graficoHTML += '<div style="margin-top: 15px; text-align: center;">';
    graficoHTML += '<span style="color: #9c27b0;">‚ñ† Hist√≥rico</span> ';
    graficoHTML += '<span style="color: #4caf50;">‚ñ† Proyectado</span>';
    graficoHTML += '</div></div>';
    
    container.innerHTML = graficoHTML;
}

// Funci√≥n para exportar reportes completos
function exportarReportesCompletos() {
    try {
        console.log("Generando reporte completo del sistema...");
        
        const fecha = new Date().toISOString().split('T')[0];
        const timestamp = new Date().toISOString();
        
        if (!sistemaADAMS) {
            mostrarNotificacion('Sistema no disponible', 'error');
            return;
        }
        
        const estudiantes = sistemaADAMS.estudiantes || [];
        const entrenadores = sistemaADAMS.entrenadores || [];
        const pagos = sistemaADAMS.pagos || [];
        
        const reporteCompleto = {
            metadata: {
                titulo: 'REPORTE COMPLETO - Academia ADAMS',
                fechaGeneracion: timestamp,
                version: '1.0'
            },
            resumen: {
                totalEstudiantes: estudiantes.length,
                estudiantesActivos: estudiantes.filter(e => e.estatus === 'activo').length,
                estudiantesPendientes: estudiantes.filter(e => e.estatus === 'pendiente').length,
                totalEntrenadores: entrenadores.length,
                totalPagos: pagos.length,
                ingresoTotal: pagos.reduce((total, pago) => total + (pago.montoTotal || 0), 0)
            },
            estudiantes: estudiantes,
            entrenadores: entrenadores,
            pagos: pagos,
            configuracion: sistemaADAMS.configuracion || {}
        };
        
        descargarJSON(reporteCompleto, `Reporte_Completo_Academia_Adams_${fecha}.json`);
        mostrarNotificaci√≥n('Reporte completo descargado exitosamente', 'success');
        
    } catch (error) {
        console.error('Error al generar reporte completo:', error);
        mostrarNotificaci√≥n('Error al generar reporte completo', 'error');
    }
}

// Funci√≥n auxiliar para contactar estudiante
function contactarEstudiante(estudianteId) {
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (estudiante) {
        mostrarNotificacion(`Recordatorio enviado a ${estudiante.tutor} (${estudiante.telefono})`, 'success');
    }
}

// Inicializar reportes cuando se cambie a esa secci√≥n
function inicializarModuloReportes() {
    console.log('Inicializando m√≥dulo de reportes...');
    setTimeout(() => {
        actualizarTodosLosReportes();
    }, 500);
}

// Evento para inicializar cuando se abra la secci√≥n de reportes
document.addEventListener('DOMContentLoaded', function() {
    const reportesNav = document.querySelector('.nav-card[onclick*="reportes"]');
    if (reportesNav) {
        const originalOnClick = reportesNav.getAttribute('onclick');
        reportesNav.setAttribute('onclick', originalOnClick + '; inicializarModuloReportes()');
    }
});
function actualizarMontoInscripcion() {
    const monto = parseFloat(document.getElementById('monto-inscripcion').value) || 0;
    if (conceptoTemporal) {
        conceptoTemporal.total = monto;
    }
}
function actualizarTotalColegiaturaManual() {
    const totalManual = parseFloat(document.getElementById('total-concepto').value) || 0;
    if (conceptoTemporal) {
        conceptoTemporal.total = totalManual;
        // Recalcular el recargo basado en el total editado
        const montoBase = conceptoTemporal.montoBase || 0;
        const descuentoBeca = conceptoTemporal.descuentoBeca || 0;
        const recargoCalculado = totalManual - (montoBase - descuentoBeca);
        document.getElementById('recargo-concepto').value = Math.max(0, recargoCalculado).toFixed(2);
        conceptoTemporal.recargo = Math.max(0, recargoCalculado);
    }
}

// ===== FIN DEL M√ìDULO DE REPORTES AVANZADOS =====
// ===== SISTEMA DE BACKUPS AUTOM√ÅTICOS =====

class SistemaBackups {
    constructor() {
        this.configuracion = {
            intervaloBackup: 24 * 60 * 60 * 1000, // 24 horas
            habilitarBackupDiario: true,
            habilitarBackupAlCerrar: true
        };
        this.inicializar();
    }
    
    inicializar() {
        console.log('Iniciando sistema de backups autom√°ticos...');
        this.verificarUltimoBackup();
        
        if (this.configuracion.habilitarBackupDiario) {
            this.programarBackupDiario();
        }
        
        if (this.configuracion.habilitarBackupAlCerrar) {
            this.configurarBackupAlCerrar();
        }
    }
    
    verificarUltimoBackup() {
         // Verificar que sistemaADAMS est√© disponible antes de crear backup inicial
    if (!window.sistemaADAMS || !window.sistemaADAMS.estudiantes) {
        console.log('Esperando a que sistemaADAMS est√© completamente cargado...');
        setTimeout(() => this.verificarUltimoBackup(), 10000);
        return;
    }
        const ultimoBackup = localStorage.getItem('ultimoBackupAutomatico');
        const ahora = new Date().getTime();
        
        if (!ultimoBackup) {
            console.log('No hay backups previos, creando backup inicial...');
            this.crearBackupAutomatico('inicial');
        } else {
            const tiempoTranscurrido = ahora - parseInt(ultimoBackup);
            
            if (tiempoTranscurrido >= this.configuracion.intervaloBackup) {
                console.log('Ha pasado m√°s de 24 horas, creando backup autom√°tico...');
                this.crearBackupAutomatico('diario');
            }
        }
    }
    programarBackupDiario() {
    // Calcular tiempo hasta las 2:00 AM del siguiente d√≠a
    const ahora = new Date();
    const proximoBackup = new Date();
    proximoBackup.setDate(ahora.getDate() + 1);
    proximoBackup.setHours(2, 0, 0, 0); // 2:00 AM
    
    const tiempoHastaBackup = proximoBackup.getTime() - ahora.getTime();
    
    setTimeout(() => {
        this.crearBackupAutomatico('diario');
        
        // Programar backups cada 24 horas
        setInterval(() => {
            this.crearBackupAutomatico('diario');
        }, this.configuracion.intervaloBackup);
        
    }, tiempoHastaBackup);
    
    console.log(`Pr√≥ximo backup autom√°tico: ${proximoBackup.toLocaleString()}`);
}
configurarBackupAlCerrar() {
    window.addEventListener('beforeunload', (event) => {
        // Crear backup de emergencia al cerrar
        this.crearBackupSincronizado('emergencia');
    });
    
    // Tambi√©n al cambiar de p√°gina
    window.addEventListener('pagehide', (event) => {
        this.crearBackupSincronizado('emergencia');
    });
}
crearBackupAutomatico(tipo) {
    try {
        // Verificar que sistemaADAMS est√© disponible
        if (!window.sistemaADAMS) {
            console.log('Sistema ADAMS no est√° listo, postponiendo backup...');
            setTimeout(() => this.crearBackupAutomatico(tipo), 5000);
            return;
        }
        
        // Verificar que tenga datos m√≠nimos
        if (!window.sistemaADAMS.estudiantes) {
            console.log('Datos del sistema no est√°n completos, inicializando...');
            window.sistemaADAMS.estudiantes = window.sistemaADAMS.estudiantes || [];
            window.sistemaADAMS.entrenadores = window.sistemaADAMS.entrenadores || [];
            window.sistemaADAMS.pagos = window.sistemaADAMS.pagos || [];
        }
        
        const backup = this.generarBackup(tipo);
        this.descargarBackup(backup);
        
        localStorage.setItem('ultimoBackupAutomatico', new Date().getTime().toString());
        
        if (window.mostrarNotificacion) {
            window.mostrarNotificacion(`Backup ${tipo} creado autom√°ticamente`, 'success');
        }
        
    } catch (error) {
        console.error('Error al crear backup autom√°tico:', error);
        if (window.mostrarNotificacion) {
            window.mostrarNotificacion('Error al crear backup autom√°tico', 'error');
        }
    }
}

crearBackupSincronizado(tipo) {
    try {
        const backup = this.generarBackup(tipo);
        const dataStr = JSON.stringify(backup.datos, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = backup.nombreArchivo;
        link.style.display = 'none';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
        
    } catch (error) {
        console.error('Error en backup s√≠ncrono:', error);
    }
}
generarBackup(tipo) {
    const fecha = new Date();
    const timestamp = fecha.toISOString().replace(/[:.]/g, '-');
    
    const datosCompletos = {
        metadata: {
            version: "4.0",
            tipoBackup: tipo,
            fechaCreacion: fecha.toISOString(),
            timestamp: timestamp,
            navegador: navigator.userAgent,
            totalEstudiantes: window.sistemaADAMS.estudiantes?.length || 0,
            totalEntrenadores: window.sistemaADAMS.entrenadores?.length || 0,
            totalPagos: window.sistemaADAMS.pagos?.length || 0
        },
        
        sistemaADAMS: window.sistemaADAMS || {
    estudiantes: [],
    entrenadores: [],
    pagos: [],
    configuracion: {},
    productos: []
},
        
        datosAdicionales: {
            asistenciasEntrenadores: JSON.parse(localStorage.getItem('asistenciasEntrenadores') || '{}'),
            pagosRealizados: JSON.parse(localStorage.getItem('pagosRealizados') || '{}')
        }
    };
    
    const prefijo = tipo === 'diario' ? 'DIARIO' : 
                  tipo === 'emergencia' ? 'EMERGENCIA' : 
                  tipo === 'inicial' ? 'INICIAL' : 'AUTO';
    
    const nombreArchivo = `BACKUP_${prefijo}_Academia_Adams_${timestamp}.json`;
    
    return {
        datos: datosCompletos,
        nombreArchivo: nombreArchivo,
        tipo: tipo,
        fecha: fecha
    };
}
descargarBackup(backup) {
    const dataStr = JSON.stringify(backup.datos, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = backup.nombreArchivo;
    link.setAttribute('target', '_blank');
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    setTimeout(() => {
        URL.revokeObjectURL(link.href);
    }, 1000);
    
    console.log(`Backup descargado: ${backup.nombreArchivo}`);
    
}


// Cerrar la clase

}
// NUEVA FUNCI√ìN PARA OBTENER PAGOS POR MES ESPEC√çFICO
function obtenerPagosPorMes(a√±o, mes) {
    // Verificar que exista el array de pagos
    if (!sistemaADAMS.pagos) return [];
    
    // Filtrar pagos del mes y a√±o especificados
    return sistemaADAMS.pagos.filter(pago => {
        // Si el pago tiene mes de aplicaci√≥n espec√≠fico (pagos nuevos)
        if (pago.mesAplicacion && pago.a√±oAplicacion) {
            return pago.mesAplicacion === mes && pago.a√±oAplicacion === a√±o;
        }
        
        // Para pagos antiguos sin mes espec√≠fico, usar fecha del pago
        const fechaPago = new Date(pago.fecha);
        return fechaPago.getMonth() + 1 === mes && fechaPago.getFullYear() === a√±o;
    });
}
// NUEVA FUNCI√ìN PARA OBTENER ESTAD√çSTICAS DE UN MES
function obtenerEstadisticasMensuales(a√±o, mes) {
    // Obtener todos los pagos del mes
    const pagosDelMes = obtenerPagosPorMes(a√±o, mes);
    
    // Contar colegiaturas del mes
    const colegiaturas = pagosDelMes.filter(p => 
        p.concepto === 'colegiatura' || 
        (p.conceptos && p.conceptos.some(c => c.tipo === 'colegiatura'))
    );
    
    // Contar ajustes del mes
    const ajustes = pagosDelMes.filter(p => 
        p.concepto === 'ajuste-colegiatura' || 
        (p.conceptos && p.conceptos.some(c => c.tipo === 'ajuste-colegiatura'))
    );
    
    // Calcular monto total del mes
    const montoTotal = pagosDelMes.reduce((sum, p) => sum + p.montoTotal, 0);
    
    // Retornar estad√≠sticas completas
    return {
        totalPagos: pagosDelMes.length,
        colegiaturas: colegiaturas.length,
        ajustes: ajustes.length,
        montoTotal: montoTotal,
        pagos: pagosDelMes
    };
}
// NUEVA FUNCI√ìN PARA ACTUALIZAR ESTAD√çSTICAS EN EL DASHBOARD
function actualizarEstadisticasMesDashboard() {
    // Obtener fecha actual
    const hoy = new Date();
    const mesActual = hoy.getMonth() + 1; // getMonth() devuelve 0-11
    const a√±oActual = hoy.getFullYear();
    
    // Obtener estad√≠sticas del mes actual
    const estadisticas = obtenerEstadisticasMensuales(a√±oActual, mesActual);
    
    // Mostrar estad√≠sticas en la consola para verificar funcionamiento
    const nombreMes = hoy.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
    console.log(`Estad√≠sticas de ${nombreMes}:`, estadisticas);
    
    // Aqu√≠ podr√≠as agregar c√≥digo para mostrar estas estad√≠sticas en el dashboard
    // Por ejemplo, actualizar elementos espec√≠ficos del HTML
    
    return estadisticas;
}
// NUEVA FUNCI√ìN PARA GENERAR REPORTE DE UN MES ESPEC√çFICO
function generarReporteMensual(a√±o, mes) {
    const estadisticas = obtenerEstadisticasMensuales(a√±o, mes);
    const nombreMes = new Date(a√±o, mes - 1, 1).toLocaleDateString('es-ES', { 
        month: 'long', 
        year: 'numeric' 
    });
    
    console.log(`=== REPORTE MENSUAL DE ${nombreMes.toUpperCase()} ===`);
    console.log(`Total de pagos: ${estadisticas.totalPagos}`);
    console.log(`Colegiaturas: ${estadisticas.colegiaturas}`);
    console.log(`Ajustes: ${estadisticas.ajustes}`);
    console.log(`Monto total: $${estadisticas.montoTotal.toLocaleString()}`);
    
    return estadisticas;
}
// NUEVA FUNCI√ìN PARA VERIFICAR PAGOS ATRASADOS POR MES
function verificarPagosAtrasados() {
    const hoy = new Date();
    const a√±oActual = hoy.getFullYear();
    const mesActual = hoy.getMonth() + 1;
    
    const estudiantesAtrasados = [];
    
    // Revisar cada estudiante activo
    sistemaADAMS.estudiantes.forEach(estudiante => {
        if ((estudiante.estatus || 'activo') !== 'activo') return;
        
        // Verificar si tiene pago del mes actual
        const tienePagoMesActual = sistemaADAMS.pagos.some(pago => {
            if (pago.estudianteId !== estudiante.id) return false;
            
            // Verificar por mes de aplicaci√≥n o fecha de pago
            if (pago.mesAplicacion && pago.a√±oAplicacion) {
                return pago.mesAplicacion === mesActual && pago.a√±oAplicacion === a√±oActual;
            } else if (pago.concepto === 'colegiatura') {
                const fechaPago = new Date(pago.fecha);
                return fechaPago.getMonth() + 1 === mesActual && fechaPago.getFullYear() === a√±oActual;
            }
            return false;
        });
        
        if (!tienePagoMesActual) {
            estudiantesAtrasados.push(estudiante);
        }
    });
    
    console.log(`Estudiantes sin pago del mes actual (${mesActual}/${a√±oActual}):`, estudiantesAtrasados.length);
    return estudiantesAtrasados;
}
// ==================== FUNCIONES DE CARGA MASIVA ====================

// Variable global para almacenar datos del Excel
let datosExcelTemporal = [];

function mostrarCargaMasiva() {
    document.getElementById('modal-carga-masiva').style.display = 'flex';
    
    // Resetear estado
    document.getElementById('archivo-excel-masivo').value = '';
    document.getElementById('vista-previa-datos').style.display = 'none';
    document.getElementById('botones-carga').style.display = 'none';
    datosExcelTemporal = [];
}

function cerrarCargaMasiva() {
    document.getElementById('modal-carga-masiva').style.display = 'none';
    datosExcelTemporal = [];
}

function procesarArchivoExcel() {
    const archivo = document.getElementById('archivo-excel-masivo').files[0];
    
    if (!archivo) {
        mostrarNotificacion('Selecciona un archivo Excel', 'error');
        return;
    }
    
    // Verificar extensi√≥n
    const extension = archivo.name.split('.').pop().toLowerCase();
    if (!['xlsx', 'xls'].includes(extension)) {
        mostrarNotificacion('Solo se permiten archivos .xlsx o .xls', 'error');
        return;
    }
    
    mostrarNotificacion('Procesando archivo Excel...', 'success');
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            // Leer el archivo Excel usando SheetJS
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // Usar la primera hoja
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            
            // Convertir a JSON - IMPORTANTE: range: 1 para saltar solo la fila de encabezados
            const datosJson = XLSX.utils.sheet_to_json(worksheet, {
                header: ['nombre', 'fechaNacimiento', 'tutor', 'telefono', 'email'],
                range: 1 // Cambiar a 2 si tienes doble encabezado
            });
            
            console.log('Datos extra√≠dos del Excel:', datosJson);
            
            if (datosJson.length === 0) {
                mostrarNotificacion('El archivo Excel est√° vac√≠o o no tiene el formato correcto', 'error');
                return;
            }
            
            procesarDatosExcel(datosJson);
            
        } catch (error) {
            console.error('Error procesando Excel:', error);
            mostrarNotificacion('Error al leer el archivo Excel: ' + error.message, 'error');
        }
    };
    
    reader.readAsArrayBuffer(archivo);
}

function procesarDatosExcel(datosOriginales) {
    datosExcelTemporal = [];
    let validos = 0;
    let errores = 0;
    
    datosOriginales.forEach((fila, indice) => {
        const filaNumero = indice + 2; // +2 porque saltamos header y los arrays empiezan en 0
        
        // Limpiar y validar datos
        const datosLimpios = {
            nombre: limpiarTexto(fila.nombre),
            fechaNacimiento: procesarFecha(fila.fechaNacimiento),
            tutor: limpiarTexto(fila.tutor),
            telefono: limpiarTelefono(fila.telefono),
            email: limpiarEmail(fila.email),
            filaOriginal: filaNumero,
            errores: [],
            valido: true
        };
        
        // Validaciones m√≠nimas
// Validaciones MUY flexibles - solo el nombre es obligatorio
        if (!datosLimpios.nombre || datosLimpios.nombre.length < 2) {
            datosLimpios.errores.push('Nombre requerido');
            datosLimpios.valido = false;
        }
        
        // Los dem√°s campos son opcionales para carga masiva - solo advertencias
        if (!datosLimpios.fechaNacimiento) {
            datosLimpios.errores.push('Sin fecha de nacimiento');
            // NO marcamos como inv√°lido - solo advertencia
        }
        
        if (!datosLimpios.tutor || datosLimpios.tutor.length < 2) {
            datosLimpios.errores.push('Sin tutor asignado');
            // NO marcamos como inv√°lido - solo advertencia
        }
        
        if (!datosLimpios.telefono || datosLimpios.telefono.length < 10) {
            datosLimpios.errores.push('Sin tel√©fono v√°lido');
            // NO marcamos como inv√°lido - solo advertencia
        }
        
        // Verificar duplicados con estudiantes existentes
        const existeDuplicado = sistemaADAMS.estudiantes.find(e => 
            e.nombre.toLowerCase() === datosLimpios.nombre.toLowerCase() && 
            e.fechaNacimiento === datosLimpios.fechaNacimiento
        );
        
        if (existeDuplicado) {
            datosLimpios.errores.push('Ya existe un estudiante con este nombre y fecha');
            datosLimpios.valido = false;
        }
        
        datosExcelTemporal.push(datosLimpios);
        
        if (datosLimpios.valido) {
            validos++;
        } else {
            errores++;
        }
    });
    
    mostrarVistaPrevia(validos, errores);
}

// Funciones auxiliares para limpiar datos
function limpiarTexto(texto) {
    if (!texto) return '';
    return String(texto).trim().replace(/\s+/g, ' ');
}

function procesarFecha(fecha) {
    if (!fecha) return null;
    
    try {
        // Si ya es un objeto Date de Excel
        if (fecha instanceof Date) {
            return fecha.toISOString().split('T')[0];
        }
        
        // Si es un n√∫mero de serie de Excel
        if (typeof fecha === 'number') {
            const fechaExcel = new Date((fecha - 25569) * 86400 * 1000);
            return fechaExcel.toISOString().split('T')[0];
        }
        
        // Si es texto, intentar parsearlo
        const fechaString = String(fecha).trim();
        
        // Formato DD/MM/YYYY
        if (fechaString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
            const [dia, mes, a√±o] = fechaString.split('/');
            return `${a√±o}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
        }
        
        // Formato YYYY-MM-DD
        if (fechaString.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
            return fechaString;
        }
        
        // Intentar crear fecha directamente
        const fechaParsed = new Date(fechaString);
        if (!isNaN(fechaParsed.getTime())) {
            return fechaParsed.toISOString().split('T')[0];
        }
        
        return null;
    } catch (error) {
        console.error('Error procesando fecha:', fecha, error);
        return null;
    }
}

function limpiarTelefono(telefono) {
    if (!telefono) return '';
    // Mantener solo n√∫meros
    return String(telefono).replace(/[^\d]/g, '');
}

function limpiarEmail(email) {
    if (!email) return '';
    const emailLimpio = String(email).trim().toLowerCase();
    // Validaci√≥n b√°sica de email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(emailLimpio) ? emailLimpio : '';
}

function mostrarVistaPrevia(validos, errores) {
    // Actualizar resumen
    document.getElementById('resumen-carga').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
            <div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px;">
                <strong style="font-size: 24px;">${validos}</strong><br>
                <span>Registros v√°lidos</span>
            </div>
            <div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px;">
                <strong style="font-size: 24px;">${errores}</strong><br>
                <span>Registros con errores</span>
            </div>
            <div style="background: #e2e3e5; color: #383d41; padding: 15px; border-radius: 8px;">
                <strong style="font-size: 24px;">${datosExcelTemporal.length}</strong><br>
                <span>Total procesados</span>
            </div>
        </div>
    `;
    
    // Generar tabla de vista previa
    // Generar tabla de vista previa - TODOS los registros con nombre son v√°lidos
    const tbody = document.getElementById('tabla-vista-previa');
    tbody.innerHTML = datosExcelTemporal.map(dato => `
        <tr style="background: ${dato.valido ? '#f8fff8' : '#fff0f0'};">
            <td>
                ${dato.nombre}
                ${dato.errores.includes('Nombre requerido') ? '<br><small style="color: red;">‚ö† Nombre requerido</small>' : ''}
            </td>
            <td>
                ${dato.fechaNacimiento || '<span style="color: #ccc;">No v√°lida</span>'}
                ${dato.errores.includes('Fecha de nacimiento inv√°lida') ? '<br><small style="color: red;">‚ö† Fecha inv√°lida</small>' : ''}
            </td>
            <td>
                ${dato.tutor}
                ${dato.errores.includes('Nombre del tutor requerido') ? '<br><small style="color: red;">‚ö† Tutor requerido</small>' : ''}
            </td>
            <td>
                ${dato.telefono}
                ${dato.errores.includes('Tel√©fono inv√°lido (m√≠nimo 10 d√≠gitos)') ? '<br><small style="color: red;">‚ö† Tel√©fono inv√°lido</small>' : ''}
            </td>
            <td>${dato.email || '<span style="color: #ccc;">Sin email</span>'}</td>
            <td>
                ${dato.valido ? 
                    '<span style="color: green;">‚úÖ V√°lido</span>' : 
                    '<span style="color: red;">‚ùå Errores</span>'
                }
                ${dato.errores.includes('Ya existe un estudiante con este nombre y fecha') ? '<br><small style="color: orange;">‚ö† Duplicado</small>' : ''}
            </td>
        </tr>
    `).join('');
    
    // Mostrar vista previa y botones
    document.getElementById('vista-previa-datos').style.display = 'block';
    document.getElementById('botones-carga').style.display = 'block';
    
    // Habilitar/deshabilitar bot√≥n seg√∫n si hay registros v√°lidos
    const btnConfirmar = document.getElementById('btn-confirmar-carga');
    // Calcular cu√°ntos tienen al menos el nombre
    const conNombre = datosExcelTemporal.filter(dato => dato.nombre && dato.nombre.length >= 2).length;
    
    if (conNombre > 0) {
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = `‚úÖ Cargar ${conNombre} Estudiante${conNombre > 1 ? 's' : ''} (${conNombre - validos} como PENDIENTES)`;
    } else {
        btnConfirmar.disabled = true;
        btnConfirmar.innerHTML = '‚ùå No hay registros con nombre v√°lido';
    }
    
    mostrarNotificacion(`Procesados ${datosExcelTemporal.length} registros: ${validos} v√°lidos, ${errores} con errores`, 'success');
}

function cancelarCargaMasiva() {
    if (confirm('¬øSeguro que quieres cancelar la carga masiva?')) {
        cerrarCargaMasiva();
    }
}

function confirmarCargaMasiva() {
    // Ahora "v√°lidos" son todos los que tienen nombre
    const datosValidos = datosExcelTemporal.filter(dato => dato.nombre && dato.nombre.length >= 2);
    
    if (datosValidos.length === 0) {
        mostrarNotificacion('No hay registros v√°lidos para cargar', 'error');
        return;
    }
    
    if (!confirm(`¬øConfirmas la carga masiva de ${datosValidos.length} estudiante${datosValidos.length > 1 ? 's' : ''}?`)) {
        return;
    }
    
    // Procesar carga masiva
    let cargadosExitosamente = 0;
    
    datosValidos.forEach(dato => {
        try {
           // Calcular edad SOLO si hay fecha v√°lida
            let edad = 0;
            if (dato.fechaNacimiento) {
                try {
                    const fechaNacimiento = new Date(dato.fechaNacimiento);
                    const hoy = new Date();
                    if (!isNaN(fechaNacimiento.getTime())) {
                        edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
                        if (hoy.getMonth() < fechaNacimiento.getMonth() || 
                            (hoy.getMonth() === fechaNacimiento.getMonth() && hoy.getDate() < fechaNacimiento.getDate())) {
                            edad--;
                        }
                    }
                } catch (error) {
                    console.log('Error calculando edad para:', dato.nombre);
                    edad = 0;
                }
            }
            
            const nuevoEstudiante = {
                id: Date.now() + Math.random(), // ID √∫nico
                nombre: formatearNombrePropio(dato.nombre),
                edad: edad, // Puede ser 0 si no hay fecha v√°lida
                fechaNacimiento: dato.fechaNacimiento || '', // Puede estar vac√≠o
                curp: '', // Vac√≠o en carga masiva
                tutor: dato.tutor ? formatearNombrePropio(dato.tutor) : '', // Puede estar vac√≠o
                telefono: dato.telefono || '', // Puede estar vac√≠o
                email: dato.email || '', // Puede estar vac√≠o
                disciplinas: [], // Vac√≠o - se asignar√° despu√©s
                colegiatura: 900, // Colegiatura base por defecto
                horarios: [], // Vac√≠o - se asignar√° despu√©s
                esHermano: false,
                porcentajeBeca: 0,
                estatus: 'pendiente', // ESTADO PENDIENTE
                fechaRegistro: new Date().toISOString(),
                cargaMasiva: true, // Marcar como carga masiva
                filaOriginal: dato.filaOriginal
            };
            
            sistemaADAMS.estudiantes.push(nuevoEstudiante);
            cargadosExitosamente++;
            
        } catch (error) {
            console.error('Error cargando estudiante:', dato, error);
        }
    });
    
    // Guardar en localStorage
    guardarDatos();
    
    // Actualizar interfaz
    actualizarTablaEstudiantes();
    actualizarDashboard();
    
    // Cerrar modal y mostrar resultado
    cerrarCargaMasiva();
    
    mostrarNotificacion(
        `üéâ Carga masiva completada: ${cargadosExitosamente} estudiante${cargadosExitosamente > 1 ? 's' : ''} cargado${cargadosExitosamente > 1 ? 's' : ''} con estatus PENDIENTE`, 
        'success'
    );
    
    // Cambiar autom√°ticamente al filtro de pendientes para mostrar los nuevos
    document.getElementById('filtro-estatus-estudiante').value = 'pendiente';
    filtrarEstudiantes();
}

// Funci√≥n auxiliar para formatear nombres (si no existe)
function formatearNombrePropio(texto) {
    if (!texto) return '';
    return texto.split(' ')
        .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1).toLowerCase())
        .join(' ');
}
// FUNCIONES PARA ESTADO DE CUENTA
function mostrarFormularioEstadoCuenta() {
    document.getElementById('formulario-estado-cuenta').classList.add('show');
    cargarEstudiantesEnEstadoCuenta();
}

function ocultarFormularioEstadoCuenta() {
    document.getElementById('formulario-estado-cuenta').classList.remove('show');
    document.getElementById('form-estado-cuenta').reset();
    document.getElementById('fechas-personalizadas-estado').style.display = 'none';
}

function cargarEstudiantesEnEstadoCuenta() {
    const select = document.getElementById('estudiante-estado-cuenta');
    select.innerHTML = '<option value="">Seleccionar estudiante...</option>';
    
    // Ordenar estudiantes alfab√©ticamente
    const estudiantesOrdenados = sistemaADAMS.estudiantes
        .filter(e => e.estatus !== 'baja')
        .sort((a, b) => a.nombre.localeCompare(b.nombre));
    
    estudiantesOrdenados.forEach(estudiante => {
        select.innerHTML += `
            <option value="${estudiante.id}">${estudiante.nombre} - ${estudiante.tutor}</option>
        `;
    });
}

function toggleFechasPersonalizadas() {
    const periodo = document.getElementById('periodo-estado-cuenta').value;
    const fechasDiv = document.getElementById('fechas-personalizadas-estado');
    
    if (periodo === 'personalizado') {
        fechasDiv.style.display = 'block';
        document.getElementById('fecha-inicio-estado').required = true;
        document.getElementById('fecha-fin-estado').required = true;
    } else {
        fechasDiv.style.display = 'none';
        document.getElementById('fecha-inicio-estado').required = false;
        document.getElementById('fecha-fin-estado').required = false;
    }
}

function generarEstadoCuenta(event) {
    event.preventDefault();
    
    const estudianteId = document.getElementById('estudiante-estado-cuenta').value;
    const periodo = document.getElementById('periodo-estado-cuenta').value;
    
    if (!estudianteId) {
        mostrarNotificacion('Selecciona un estudiante', 'error');
        return;
    }
    
    const estudiante = sistemaADAMS.estudiantes.find(e => e.id == estudianteId);
    if (!estudiante) {
        mostrarNotificacion('Estudiante no encontrado', 'error');
        return;
    }
    
    const fechas = calcularFechasPeriodo(periodo);
    if (!fechas) return;
    
    const pagosEstudiante = sistemaADAMS.pagos.filter(pago => {
        if (pago.estudianteId != estudianteId) return false;
        const fechaPago = new Date(pago.fecha);
        return fechaPago >= fechas.inicio && fechaPago <= fechas.fin;
    });
    
    if (pagosEstudiante.length === 0) {
        mostrarNotificacion('No hay pagos en el per√≠odo seleccionado', 'error');
        return;
    }
    
    // Generar PDF directamente
    crearPDFEstadoCuenta(estudiante, pagosEstudiante, fechas);
    ocultarFormularioEstadoCuenta();
}

function crearPDFEstadoCuenta(estudiante, pagos, fechas) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Configuraci√≥n
    let yPos = 20;
    const leftMargin = 20;
    const rightMargin = 190;
    
    // Encabezado
    doc.setFontSize(20);
    doc.setTextColor(156, 39, 176);
    doc.text('Academia de Gimnasia ADAMS', leftMargin, yPos);
    yPos += 5;
    
    doc.setFontSize(16);
    doc.setTextColor(100, 100, 100);
    doc.text('Estado de Cuenta', leftMargin, yPos);
    yPos += 12;
    
    // L√≠nea divisoria
    doc.setDrawColor(156, 39, 176);
    doc.setLineWidth(1);
    doc.line(leftMargin, yPos, rightMargin, yPos);
    yPos += 12;
    
    // Datos del estudiante
    doc.setFontSize(14);
    doc.setTextColor(156, 39, 176);
    doc.text('Datos del Estudiante', leftMargin, yPos);
    yPos += 6;
    
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(`Nombre: ${estudiante.nombre}`, leftMargin, yPos);
    yPos += 5;
    doc.text(`Tutor: ${estudiante.tutor || 'No especificado'}`, leftMargin, yPos);
    yPos += 5;
    doc.text(`Tel√©fono: ${estudiante.telefono || 'No especificado'}`, leftMargin, yPos);
    yPos += 10;
    
    // Per√≠odo
    doc.setFontSize(12);
    doc.setTextColor(156, 39, 176);
    doc.text('Per√≠odo del Estado', leftMargin, yPos);
    yPos += 6;
    
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(`Desde: ${formatearFecha(fechas.inicio.toISOString())}`, leftMargin, yPos);
    yPos += 5;
    doc.text(`Hasta: ${formatearFecha(fechas.fin.toISOString())}`, leftMargin, yPos);
    yPos += 5;
    doc.text(`Total de Pagos: ${pagos.length}`, leftMargin, yPos);
    yPos += 15;
    
    // Tabla de pagos
    doc.setFontSize(14);
    doc.setTextColor(156, 39, 176);
    doc.text('Detalle de Pagos', leftMargin, yPos);
    yPos += 8;
    
    // Encabezados de tabla
    doc.setFillColor(156, 39, 176);
    doc.rect(leftMargin, yPos, 170, 8, 'F');
    
    doc.setFontSize(10);
    doc.setTextColor(255, 255, 255);
    doc.text('Fecha', leftMargin + 2, yPos + 6);
    doc.text('Concepto', leftMargin + 35, yPos + 6);
    doc.text('M√©todo', leftMargin + 100, yPos + 6);
    doc.text('Monto', leftMargin + 140, yPos + 6);
    yPos += 7;
    
    // Datos de pagos
    doc.setTextColor(0, 0, 0);
    let total = 0;
    
    pagos.forEach(pago => {
        const conceptoTexto = pago.conceptos && pago.conceptos.length > 0 
            ? pago.conceptos.map(c => c.descripcion || obtenerNombreConcepto(c.tipo)).join(', ')
            : obtenerNombreConcepto(pago.concepto);
        
        doc.text(formatearFecha(pago.fecha), leftMargin + 2, yPos + 6);
        doc.text(conceptoTexto.substring(0, 25), leftMargin + 35, yPos + 6);
        doc.text(pago.metodoPago, leftMargin + 100, yPos + 6);
        doc.text(`$${(pago.montoTotal || 0).toFixed(2)}`, leftMargin + 140, yPos + 6);
        
        total += (pago.montoTotal || 0);
        yPos += 7;
        
        // L√≠nea divisoria
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.1);
        doc.line(leftMargin, yPos, rightMargin, yPos);
    });
    
    yPos += 8;
    
    // Total
    doc.setFontSize(16);
    doc.setTextColor(156, 39, 176);
    doc.text(`Total Pagado: $${total.toFixed(2)}`, leftMargin + 100, yPos);
    
    // Footer
    yPos += 18;
    doc.setFontSize(9);
    doc.setTextColor(100, 100, 100);
    doc.text(`Estado de cuenta generado el ${formatearFecha(new Date().toISOString())}`, leftMargin, yPos);
    
    // Descargar
    const filename = `Estado_Cuenta_${estudiante.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    
    mostrarNotificacion('Estado de cuenta generado exitosamente', 'success');
}

// Eliminar las otras funciones que no usamos
function generarPDFEstadoCuenta() { /* Ya no se usa */ }
function descargarEstadoCuentaPDF() { /* Ya no se usa */ }
function generarHTMLEstadoCuenta() { /* Ya no se usa */ }


function calcularFechasPeriodo(periodo) {
    const hoy = new Date();
    let inicio, fin;
    
    switch(periodo) {
        case 'mes-actual':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
            break;
        case 'mes-anterior':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
            break;
        case 'trimestre':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 3, 1);
            fin = hoy;
            break;
        case 'semestre':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 6, 1);
            fin = hoy;
            break;
        case 'a√±o':
            inicio = new Date(hoy.getFullYear(), 0, 1);
            fin = hoy;
            break;
        case 'personalizado':
            const fechaInicioInput = document.getElementById('fecha-inicio-estado').value;
            const fechaFinInput = document.getElementById('fecha-fin-estado').value;
            
            if (!fechaInicioInput || !fechaFinInput) {
                mostrarNotificacion('Selecciona las fechas del per√≠odo personalizado', 'error');
                return null;
            }
            
            inicio = new Date(fechaInicioInput);
            fin = new Date(fechaFinInput);
            break;
        default:
            return null;
    }
    
    return { inicio, fin };
}

function generarPDFEstadoCuenta(estudiante, pagos, fechas) {
    // Crear HTML del estado de cuenta
    const estadoCuentaHTML = generarHTMLEstadoCuenta(estudiante, pagos, fechas);
    console.log("HTML generado:", estadoCuentaHTML);
console.log("Longitud del HTML:", estadoCuentaHTML.length);
    
    // Crear elemento temporal para PDF
    const tempDiv = document.createElement('div');
    tempDiv.id = 'estado-cuenta-temp-pdf';
    tempDiv.innerHTML = estadoCuentaHTML;
    tempDiv.style.position = 'absolute';
tempDiv.style.top = '-9999px';
tempDiv.style.left = '0';
tempDiv.style.width = '800px';
tempDiv.style.background = 'white';
tempDiv.style.padding = '20px';
tempDiv.style.visibility = 'hidden';
tempDiv.style.opacity = '0';
tempDiv.style.pointerEvents = 'none';
document.body.appendChild(tempDiv);
    
    // Generar PDF
    setTimeout(() => {
        descargarEstadoCuentaPDF('estado-cuenta-temp-pdf', estudiante.nombre, fechas);
    }, 1000);
}




// VERIFICACI√ìN DE FUNCIONES AGREGADAS
console.log('=== FUNCIONES DE MES DE COLEGIATURA CARGADAS ===');
console.log('‚úì obtenerPagosPorMes');
console.log('‚úì obtenerEstadisticasMensuales'); 
console.log('‚úì actualizarEstadisticasMesDashboard');
console.log('‚úì generarReporteMensual');
console.log('‚úì verificarPagosAtrasados');
console.log('===============================================');
    </script>
</body>
</html>
